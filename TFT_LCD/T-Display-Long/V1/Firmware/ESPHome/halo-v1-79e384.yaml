substitutions:
  # Device Configuration
  name: halo-v1-79e384  # Override Core's default 'halo' name
  # Home Assistant connection for HTTP API calls
  # Create a long-lived access token in HA: Profile → Security → Long-Lived Access Tokens
  ha_url: !secret ha_url  # Example: "http://homeassistant.local:8123"
  ha_token: !secret ha_token  # Your long-lived access token

  # Weather configuration (if enabled below)
  weather_entity_id: "weather.hhut"
  weather_daily_refresh_interval: "3600"  # 60 minutes for daily forecast
  weather_hourly_refresh_interval: "900"  # 15 minutes for hourly forecast
  current_temp_sensor: "sensor.st_00143056_temperature"  # Your actual sensor
  apparent_temp_sensor: "sensor.st_00143056_feels_like"  # Your actual sensor
  wind_speed_sensor: "sensor.st_00143056_wind_speed"  # Your actual sensor
  wind_direction_sensor: "sensor.st_00143056_wind_direction"  # Your actual sensor

  # Network Configuration
  wifi_ssid: !secret wifihome_ssid
  wifi_password: !secret wifihome_password

  # Security
  ota_password: !secret ota_password

  # API
  api_reboot_timeout: "30min"

esphome:
  friendly_name: Halo Air Quality Sensor Dev
  name_add_mac_suffix: false

  # # ⚠️ ONE-TIME: Clear Improv WiFi credentials on next boot
  # # REMOVE or comment out after one boot!
  # on_boot:
  #   - priority: 800  # Run very early, before WiFi
  #     then:
  #       - lambda: |-
  #           ESP_LOGW("main", "ONE-TIME: Clearing Improv WiFi credentials from NVS");
  #           auto pref = global_preferences->make_preference<uint8_t>(0x9B5A7C21);
  #           uint8_t dummy = 0;
  #           pref.save(&dummy);
  #           ESP_LOGI("main", "Improv WiFi credentials cleared! YAML WiFi will be used.");
  #           ESP_LOGW("main", "REMEMBER: Remove this on_boot code from YAML after this boot!");

  platformio_options:
    upload_speed: 921600
    board_build.flash_mode: qio
    board_build.psram_type: opi
    board_build.f_flash: 80000000L
    board_build.f_cpu: 240000000L

  min_version: 2025.10.3

  project:
    name: "yashmulgaonkar.Halo-v1"
    version: "${version}"

dashboard_import:
  package_import_url: github://truffshuff/halo/TFT_LCD/T-Display-Long/V1/Firmware/ESPHome/Halo-v1.yaml@modular
  import_full_config: true

ota:
  - platform: esphome
    id: ota_default

# safe_mode:
#   disabled: true

wifi:
  # Reduce WiFi transmission power to prevent brownouts during WiFi connection
  # ESP32 default is 20dBm which can cause power spikes and crashes
  # 8.5dBm is sufficient for most home networks and prevents brownout issues
  output_power: 8.5dB

  on_connect:
    - delay: 5s # Gives time for improv results to be transmitted

  # Enable fallback hotspot (captive portal) in case wifi connection fails
  ap:
    ssid: "Halo Hotspot"

logger:
  level: VERBOSE
  logs:
    component: INFO       # Suppress component setup messages
  #   wifi: INFO            # Suppress WiFi debug messages
  #   api: DEBUG             # Keep general API at INFO
  #   api.connection: INFO # But enable API connection debug for BLE proxy
    nimble_proxy: INFO 
    nimble_improv: INFO
    sensor: INFO
    lvgl: INFO
    display: INFO
    time_update: INFO
    display.qspi_dbi: INFO
  #   i2c.idf: INFO
  #   touchscreen: DEBUG
  #   axs15231: VERBOSE
    wireguard: INFO
    bme280.sensor: INFO
    mics_4514: INFO
    scd4x: INFO
  #   esp32.preferences: INFO

# ============================================================================
# HALO V1 - MODULAR CONFIGURATION
# ============================================================================
# ✅ PHASE 2 COMPLETE! (2025-11-15)
#
# All 7 capabilities successfully extracted from Core:
#   ✅ Clock, AirQ, WiFi Status, WireGuard, Diagnostics, Page Rotation, Weather
#   ✅ Core file reduced from 8,971 to 1,761 lines (80.4% reduction!)
#   ✅ All features working perfectly with runtime fixes applied
#
# CAPABILITY-BASED ORGANIZATION:
# - Each feature is self-contained (globals, scripts, sensors, pages)
# - Easy to enable/disable features by commenting out imports
# - Clear memory costs documented for each capability
# - Modular design for easy maintenance and updates
#
# See README.md files in each package directory for detailed documentation.
# ============================================================================

packages:
  remote_packages:
    url: https://github.com/truffshuff/halo/
    ref: modular
    files:

      # ============================================================================
      # GLOBAL VARIABLES (Must load FIRST)
      # ============================================================================
      # Global state variables used across all modules
      # IMPORTANT: Must be loaded before any module that references these globals
      - TFT_LCD/T-Display-Long/V1/Firmware/ESPHome/packages/base/globals.yaml

      # ============================================================================
      # SYSTEM MODULES (Required - ~238KB total)
      # ============================================================================
      # Core hardware & software - these are essential for basic operation.
      # DO NOT disable unless you know what you're doing.

      # Core ESP32 configuration (~5KB)
      # - ESP32-S3 board, PSRAM, external components, logger
      - TFT_LCD/T-Display-Long/V1/Firmware/ESPHome/packages/system/esphome_core.yaml

      # Display hardware (~15KB)
      # - Display driver, touchscreen, I2C/SPI buses, backlight, watchdog
      - TFT_LCD/T-Display-Long/V1/Firmware/ESPHome/packages/system/display_hardware.yaml

      # Networking (~8KB)
      # - WiFi configuration, captive portal, WiFi signal sensor
      - TFT_LCD/T-Display-Long/V1/Firmware/ESPHome/packages/system/networking.yaml

      # Fonts, colors, images (~200KB - fonts are the largest memory consumer)
      # - 9 Montserrat fonts, 6 Material Design Icon fonts, color palette
      - TFT_LCD/T-Display-Long/V1/Firmware/ESPHome/packages/system/fonts_colors.yaml

      # System management (~10KB)
      # - API, OTA, time sources, HTTP requests, system buttons
      - TFT_LCD/T-Display-Long/V1/Firmware/ESPHome/packages/system/system_management.yaml

      # ============================================================================
      # FEATURE MODULES (Optional - Pick what you need!)
      # ============================================================================
      # Each feature is self-contained. Comment out lines to disable features.
      # Memory savings are cumulative - disable multiple features to save more!

      # -------------------------
      # BLE WiFi Provisioning (~40KB - LARGEST optional feature)
      # -------------------------
      # Provides: Improv WiFi setup via phone app, Bluetooth proxy for HA
      # Memory: ~40KB (BLE stack)
      # Hardware: Built-in ESP32-S3 Bluetooth
      # Disable to: Save 40KB memory (biggest savings!)
      # Keep if: You need easy WiFi setup or Bluetooth proxy
      - TFT_LCD/T-Display-Long/V1/Firmware/ESPHome/packages/features/ble/ble_improv.yaml

      # -------------------------
      # Clock Feature (~5KB)
      # -------------------------
      # Provides: Large vertical time display, 12h/24h format, blinking colon
      # Memory: ~5KB
      # Hardware: None (uses system time)
      # Disable to: Save 5KB if you don't need clock display
      - TFT_LCD/T-Display-Long/V1/Firmware/ESPHome/packages/features/clock/clock_base.yaml
      - TFT_LCD/T-Display-Long/V1/Firmware/ESPHome/packages/features/clock/clock_page.yaml

      # -------------------------
      # Air Quality Monitoring (~15KB)
      # -------------------------
      # Provides: CO2, PM2.5, VOC, Temperature, Humidity, AQI calculation
      # Memory: ~15KB
      # Hardware: SCD40, SEN55, MICS4514, BME280 sensors (ALL required)
      # Disable to: Save 15KB if sensors not present
      - TFT_LCD/T-Display-Long/V1/Firmware/ESPHome/packages/features/airq/airq_base.yaml
      - TFT_LCD/T-Display-Long/V1/Firmware/ESPHome/packages/features/airq/airq_page.yaml

      # -------------------------
      # Weather Information (10-19KB depending on enabled pages)
      # -------------------------
      # Provides: Current conditions, forecasts, LED effects
      # Memory: Base ~8KB, +2KB per forecast module
      # Hardware: RGB LED optional (GPIO47), Home Assistant weather entity required
      # Disable to: Save memory (biggest savings: disable weather_hourly = 7KB!)

      # Weather base (REQUIRED for any weather features) - ~8KB
      - TFT_LCD/T-Display-Long/V1/Firmware/ESPHome/packages/features/weather/weather_base.yaml

      # Current conditions page (Recommended) - ~2KB
      - TFT_LCD/T-Display-Long/V1/Firmware/ESPHome/packages/features/weather/weather_page.yaml

      # 10-day daily forecast (Optional) - ~2KB
      - TFT_LCD/T-Display-Long/V1/Firmware/ESPHome/packages/features/weather/weather_daily.yaml

      # 24-hour detailed forecast - 8 pages (Optional - LARGEST weather component!) - ~7KB
      # Comment out to save 7KB! Use hourly_summary instead for compact view.
      - TFT_LCD/T-Display-Long/V1/Firmware/ESPHome/packages/features/weather/weather_hourly.yaml

      # 24-hour summary - 2 pages (Optional) - ~1.5KB
      - TFT_LCD/T-Display-Long/V1/Firmware/ESPHome/packages/features/weather/weather_hourly_summary.yaml

      # Weather-based LED effects (Optional) - ~0.5KB
      - TFT_LCD/T-Display-Long/V1/Firmware/ESPHome/packages/features/weather/weather_led_effects.yaml

      # -------------------------
      # WiFi Status Page (~3KB)
      # -------------------------
      # Provides: WiFi signal, IP address, SSID, HA connection status
      # Memory: ~3KB
      # Hardware: None (uses built-in WiFi)
      # Disable to: Save 3KB if you don't need WiFi info page
      - TFT_LCD/T-Display-Long/V1/Firmware/ESPHome/packages/features/wifi_status/wifi_page_base.yaml
      - TFT_LCD/T-Display-Long/V1/Firmware/ESPHome/packages/features/wifi_status/wifi_page.yaml

      # -------------------------
      # WireGuard VPN (Optional - ~8KB)
      # -------------------------
      # Provides: Encrypted VPN tunnel to home network
      # Memory: ~8KB
      # Hardware: None
      # Requirements: WireGuard server configured
      # Disable to: Save 8KB if you don't use VPN
      # IMPORTANT: Edit wireguard.yaml with your server details before enabling!
      - TFT_LCD/T-Display-Long/V1/Firmware/ESPHome/packages/features/wireguard/wireguard.yaml

      # -------------------------
      # Page Rotation (~2KB)
      # -------------------------
      # Provides: Automatic page rotation through enabled pages
      # Memory: ~2KB
      # Hardware: None
      # Disable to: Save 2KB, but lose auto-rotation (manual navigation still works)
      # IMPORTANT: Must be loaded AFTER all page modules!
      - TFT_LCD/T-Display-Long/V1/Firmware/ESPHome/packages/features/page_rotation/page_rotation.yaml

      # -------------------------
      # Diagnostics (Optional - ~5-10KB)
      # -------------------------
      # Provides: Heap monitoring, PSRAM tracking, display health, performance metrics
      # Memory: ~5-10KB
      # Hardware: None
      # Useful for: Debugging, development, monitoring device health
      # Disable to: Save 5-10KB in production deployments
      # - TFT_LCD/T-Display-Long/V1/Firmware/ESPHome/packages/features/diagnostics/diagnostics.yaml

      # ============================================================================
      # CORE CONFIGURATION (1,761 lines - reduced from 8,971!)
      # ============================================================================
      # Minimal core file now contains only:
      # - LVGL display initialization
      # - Remaining integration glue
      # - Navigation coordination
      # - Legacy components being phased out
      #
      # Most functionality has been extracted to capability modules above.
      - TFT_LCD/T-Display-Long/V1/Firmware/ESPHome/Halo-v1-Core.yaml
    refresh: Always

# ============================================================================
# MEMORY OPTIMIZATION GUIDE
# ============================================================================
# Current configuration memory usage:
#   System modules: ~238KB (required)
#   BLE: ~40KB (optional - BIGGEST savings if disabled!)
#   Clock: ~5KB
#   AirQ: ~15KB
#   Weather: ~10-19KB (depends on enabled forecast pages)
#   WiFi Status: ~3KB
#   WireGuard: ~8KB
#   Page Rotation: ~2KB
#   Diagnostics: ~5-10KB (if enabled)
#
# TOTAL (all features): ~326-335KB
#
# To save memory, disable features in this order:
# 1. BLE (saves 40KB) - if you don't need WiFi provisioning
# 2. Weather hourly (saves 7KB) - use hourly_summary instead
# 3. WireGuard (saves 8KB) - if you don't use VPN
# 4. Diagnostics (saves 5-10KB) - disable in production
# 5. AirQ (saves 15KB) - if sensors not present
# 6. Weather entirely (saves 10-19KB) - if not needed
#
# ============================================================================
    

# ============================================================================
# MEMORY OPTIMIZATION OVERRIDES
# ============================================================================
# Problem: Min free heap is 2KB (critical!) due to excessive stack/buffer allocation
# Core config allocates 128KB for stacks + 32KB+ for TCP buffers
# Solution: Reduce stack sizes and TCP buffers while maintaining functionality
# ============================================================================

esp32:
  framework:
    sdkconfig_options:
      # Reduce stack sizes from 64KB to 24KB each (saves 80KB RAM!)
      # 24KB is still plenty for LVGL operations without hourly forecast deep nesting
      CONFIG_ESP_MAIN_TASK_STACK_SIZE: "24576"    # Was 65536
      CONFIG_ARDUINO_LOOP_STACK_SIZE: "24576"     # Was 65536

      # Reduce TCP buffers (saves ~16KB RAM)
      CONFIG_LWIP_TCP_SND_BUF_DEFAULT: "8192"     # Was 16384
      CONFIG_LWIP_TCP_WND_DEFAULT: "8192"         # Was 16384
      CONFIG_LWIP_TCP_RECVMBOX_SIZE: "8"          # Was 12
      CONFIG_LWIP_TCPIP_RECVMBOX_SIZE: "32"       # Was 64

      # Keep PSRAM allocations internal for small objects (helps heap fragmentation)
      CONFIG_SPIRAM_MALLOC_ALWAYSINTERNAL: "8192" # Was 16384 (saves 8KB)

      # Target: Recover ~100KB of internal RAM
      # Expected min free heap after changes: 30-40KB (was 2KB)