# ============================================================================
# Halo Device Configuration Template
# ============================================================================
# Device: halo-v1-79e384
# Current Configuration: AirQ Only (Clock + AirQ monitoring + utilities)
#
# This file is configured as a comprehensive template with all options shown.
# To change features, simply comment/uncomment the appropriate package lines.
#
# Package Categories:
#   - UTILITY: Memory stats, WiFi display, WireGuard VPN
#   - FEATURES: AirQ, Weather, WiFi monitoring, BLE
#   - PAGES: LVGL display pages matching enabled features
#   - CORE: Essential Halo configuration (always include)
#
# Quick Start:
#   1. Update device name and friendly_name below
#   2. Choose utility packages (memory_stats, wifi_display, wireguard)
#   3. Choose which features to enable (uncomment the packages)
#   4. Choose matching LVGL pages package
#   5. Update the Default Page select options to match enabled pages
#   6. Adjust buffer_size based on enabled features (see memory table below)
# ============================================================================

esphome:
  name: halo-v1-79e384  # Change this to your device name
  friendly_name: Halo Air Quality Sensor Dev  # Change this to your display name
  name_add_mac_suffix: false
  platformio_options:
    upload_speed: 921600
    board_build.flash_mode: qio
    board_build.psram_type: opi
    board_build.f_flash: 80000000L
    board_build.f_cpu: 240000000L

  min_version: 2025.6.2

  project:
    name: "yashmulgaonkar.Halo-v1"
    version: "${version}"

dashboard_import:
  package_import_url: github://truffshuff/halo/TFT_LCD/T-Display-Long/V1/Firmware/ESPHome/Halo-v1.yaml@main
  import_full_config: true

ota:
  - platform: esphome
    id: ota_default
    # on_begin:
    #   then:
    #     - logger.log: "OTA Update starting - pausing display updates"
    #     - lambda: |-
    #         id(lily_display).set_update_interval(60000);  // Slow down to 1 update per minute during OTA
    # on_end:
    #   then:
    #     - logger.log: "OTA Update complete - display will resume after reboot"

wifi:
  on_connect:
    - delay: 5s # Gives time for improv results to be transmitted

  # Enable fallback hotspot (captive portal) in case wifi connection fails
  ap:
    ssid: "Halo Hotspot"
    ap_timeout: 0s  # Start AP immediately if no WiFi configured

# Override logger settings to reduce traffic and prevent crashes
logger:
  logs:
    weather_color: WARN
    time_update: WARN
    scd4x: WARN
    text: WARN
    sensor: WARN
    homeassistant.sensor: WARN
    page_rotation: WARN
    text_sensor: WARN
    homeassistant.text_sensor: WARN
    light: WARN
    binary_sensor: WARN
    number: WARN


#mqtt:
#  broker: 192.168.1.236
#  username: hhutmqttesp2
#  password: esp2mqtthhut
#  port: 1883
#  discovery: false
#  topic_prefix: esphome/halo

#  log_topic:
#    topic: esphome/halo/logs
#    level: ERROR

packages:
  # ========================================
  # UTILITY PACKAGES - System Features
  # ========================================

  # ----------------------------------------
  # Memory Statistics - Debugging/Monitoring
  # ----------------------------------------
  # OPTION 1: Memory Stats ENABLED (recommended for development/debugging)
  memory_stats:
    url: https://github.com/truffshuff/halo/
    ref: main
    files: [TFT_LCD/T-Display-Long/V1/Firmware/ESPHome/packages/memory-stats.yaml]
    refresh: always

  # OPTION 2: Memory Stats DISABLED (comment out above to disable)
  # Note: Saves a small amount of memory but loses diagnostic capability

  # ----------------------------------------
  # WiFi Display - Connection Info Display
  # ----------------------------------------
  # OPTION 1: WiFi Display DISABLED (current selection - requires wifi_core to be enabled)
  # Note: This displays WiFi connection info on pages like AirQ
  # Requires wifi_core package to be enabled, not compatible with wifi_stubs
  # wifi_display:
  #   url: https://github.com/truffshuff/halo/
  #   ref: main
  #   files: [TFT_LCD/T-Display-Long/V1/Firmware/ESPHome/packages/wifi-display.yaml]
  #   refresh: always

  # OPTION 2: WiFi Display ENABLED (uncomment above to enable)
  # WARNING: Only enable if wifi_core is enabled (not wifi_stubs)

  # ----------------------------------------
  # WireGuard VPN - Secure Remote Access
  # ----------------------------------------
  # OPTION 1: WireGuard DISABLED (current selection)
  # If disabled, Core uses time-update-basic.yaml

  # OPTION 2: WireGuard ENABLED (uncomment all 3 packages to enable)
  # wireguard:
  #   url: https://github.com/truffshuff/halo/
  #   ref: main
  #   files: [TFT_LCD/T-Display-Long/V1/Firmware/ESPHome/packages/wireguard.yaml]
  #   refresh: always
  # wireguard_display:
  #   url: https://github.com/truffshuff/halo/
  #   ref: main
  #   files: [TFT_LCD/T-Display-Long/V1/Firmware/ESPHome/packages/wireguard-display.yaml]
  #   refresh: always
  # time_update_wireguard:  # Overrides Core's time-update-basic.yaml
  #   url: https://github.com/truffshuff/halo/
  #   ref: main
  #   files: [TFT_LCD/T-Display-Long/V1/Firmware/ESPHome/packages/time-update-wireguard.yaml]
  #   refresh: always

  # ========================================
  # FEATURE PACKAGES - Enable/Disable Features
  # ========================================
  # IMPORTANT: For each feature, choose EITHER the core package OR the stubs package
  # - Core package = Feature ENABLED
  # - Stubs package = Feature DISABLED
  # Never include both core and stubs for the same feature!

  # ----------------------------------------
  # AirQ - Air Quality Monitoring
  # ----------------------------------------
  # OPTION 1: AirQ ENABLED (current selection)
  # Note: airq-display.yaml is included via lvgl_pages package, not here
  airq_core:
    url: https://github.com/truffshuff/halo/
    ref: main
    files: [TFT_LCD/T-Display-Long/V1/Firmware/ESPHome/packages/airq-core.yaml]
    refresh: always

  # OPTION 2: AirQ DISABLED (uncomment to disable, comment out above)
  # airq_stubs:
  #   url: https://github.com/truffshuff/halo/
  #   ref: main
  #   files: [TFT_LCD/T-Display-Long/V1/Firmware/ESPHome/packages/airq-stubs.yaml]
  #   refresh: always

  # ----------------------------------------
  # Weather - Weather Forecasting
  # ----------------------------------------
  # OPTION 1: Weather DISABLED (current selection)
  weather_stubs:
    url: https://github.com/truffshuff/halo/
    ref: main
    files: [TFT_LCD/T-Display-Long/V1/Firmware/ESPHome/packages/weather-stubs.yaml]
    refresh: always

  # OPTION 2: Weather ENABLED (uncomment all 3 packages to enable, comment out stubs above)
  # weather_core:
  #   url: https://github.com/truffshuff/halo/
  #   ref: main
  #   files: [TFT_LCD/T-Display-Long/V1/Firmware/ESPHome/packages/weather-core.yaml]
  #   refresh: always
  # weather_sensors:
  #   url: https://github.com/truffshuff/halo/
  #   ref: main
  #   files: [TFT_LCD/T-Display-Long/V1/Firmware/ESPHome/packages/weather-sensors.yaml]
  #   refresh: always
  # weather_fonts_text:
  #   url: https://github.com/truffshuff/halo/
  #   ref: main
  #   files: [TFT_LCD/T-Display-Long/V1/Firmware/ESPHome/packages/weather-fonts-text.yaml]
  #   refresh: always

  # ----------------------------------------
  # WiFi Monitoring - WiFi Statistics Page
  # ----------------------------------------
  # OPTION 1: WiFi Monitoring DISABLED (current selection)
  wifi_stubs:
    url: https://github.com/truffshuff/halo/
    ref: main
    files: [TFT_LCD/T-Display-Long/V1/Firmware/ESPHome/packages/wifi-stubs.yaml]
    refresh: always

  # OPTION 2: WiFi Monitoring ENABLED (uncomment to enable, comment out stubs above)
  # wifi_core:
  #   url: https://github.com/truffshuff/halo/
  #   ref: main
  #   files: [TFT_LCD/T-Display-Long/V1/Firmware/ESPHome/packages/wifi-core.yaml]
  #   refresh: always

  # ----------------------------------------
  # BLE - Bluetooth Low Energy
  # ----------------------------------------
  # OPTION 1: BLE DISABLED (current selection - RECOMMENDED)
  # WARNING: BLE can cause heap exhaustion! Only enable if absolutely needed.
  # If enabling BLE, reduce LVGL buffer_size to 15-20% (see below)
  ble_stubs:
    url: https://github.com/truffshuff/halo/
    ref: main
    files: [TFT_LCD/T-Display-Long/V1/Firmware/ESPHome/packages/ble-stubs.yaml]
    refresh: always

  # OPTION 2: BLE ENABLED (uncomment to enable - NOT RECOMMENDED, comment out stubs above)
  # ble_core:
  #   url: https://github.com/truffshuff/halo/
  #   ref: main
  #   files: [TFT_LCD/T-Display-Long/V1/Firmware/ESPHome/packages/ble-core.yaml]
  #   refresh: always

  # ========================================
  # CORE CONFIGURATION
  # ========================================
  # This imports the main Halo configuration
  # Always keep this included!
  remote_package:
    url: https://github.com/truffshuff/halo/
    ref: main
    files:
      - TFT_LCD/T-Display-Long/V1/Firmware/ESPHome/Halo-v1-Core.yaml
    refresh: always

  # ========================================
  # LVGL PAGES CONFIGURATION
  # ========================================
  # Choose ONE package that matches your enabled features above
  # The pages package determines which screens appear on the display
  #
  # Available Options:
  #   lvgl-pages-full.yaml          - All features (Clock, AirQ, WiFi, Weather)
  #   lvgl-pages-airq-weather.yaml  - Clock + AirQ + Weather
  #   lvgl-pages-airq-only.yaml     - Clock + AirQ (current selection)
  #   lvgl-pages-weather.yaml       - Clock + Weather
  #   lvgl-pages-clock-only.yaml    - Minimal clock only

  # CURRENT SELECTION: AirQ Only
  lvgl_pages:
    url: https://github.com/truffshuff/halo/
    ref: main
    files: [TFT_LCD/T-Display-Long/V1/Firmware/ESPHome/packages/lvgl-pages-airq-only.yaml]
    refresh: always

  # Uncomment ONE of these alternatives if you change features (comment out the above first):

  # Full-featured (all pages)
  # lvgl_pages:
  #   url: https://github.com/truffshuff/halo/
  #   ref: main
  #   files: [TFT_LCD/T-Display-Long/V1/Firmware/ESPHome/packages/lvgl-pages-full.yaml]
  #   refresh: always

  # AirQ + Weather
  # lvgl_pages:
  #   url: https://github.com/truffshuff/halo/
  #   ref: main
  #   files: [TFT_LCD/T-Display-Long/V1/Firmware/ESPHome/packages/lvgl-pages-airq-weather.yaml]
  #   refresh: always

  # Weather only
  # lvgl_pages:
  #   url: https://github.com/truffshuff/halo/
  #   ref: main
  #   files: [TFT_LCD/T-Display-Long/V1/Firmware/ESPHome/packages/lvgl-pages-weather.yaml]
  #   refresh: always

  # Clock only
  # lvgl_pages:
  #   url: https://github.com/truffshuff/halo/
  #   ref: main
  #   files: [TFT_LCD/T-Display-Long/V1/Firmware/ESPHome/packages/lvgl-pages-clock-only.yaml]
  #   refresh: always

# ============================================================================
# DEFAULT PAGE SELECTOR - Customize for Enabled Features
# ============================================================================
# Update the options list to match the pages you included in LVGL pages above
# Comment out options for pages that are disabled

select:
  - platform: template
    name: Default Page
    id: default_page_select_boot
    entity_category: "config"

    # CURRENT OPTIONS: AirQ Only (Clock + AirQ)
    options:
      - "Vertical Clock"  # Always available
      - "AirQ"            # Available when airq_core is enabled
      # - "WiFi"          # Available when wifi_core is enabled (currently disabled)
      # - "Weather"       # Available when weather_core is enabled (currently disabled)
      # - "Daily Forecast"   # Available when weather_core is enabled (currently disabled)
      # - "Hourly Forecast"  # Available when weather_core is enabled (currently disabled)

    # EXAMPLE OPTIONS for different configurations:
    #
    # Full-featured (all pages):
    # options:
    #   - "Vertical Clock"
    #   - "AirQ"
    #   - "WiFi"
    #   - "Weather"
    #   - "Daily Forecast"
    #   - "Hourly Forecast"
    #
    # AirQ + Weather:
    # options:
    #   - "Vertical Clock"
    #   - "AirQ"
    #   - "Weather"
    #   - "Daily Forecast"
    #   - "Hourly Forecast"
    #
    # Weather only:
    # options:
    #   - "Vertical Clock"
    #   - "Weather"
    #   - "Daily Forecast"
    #   - "Hourly Forecast"
    #
    # Clock only:
    # options:
    #   - "Vertical Clock"

    initial_option: "Vertical Clock"
    restore_value: true
    optimistic: true
    on_value:
      - lambda: |-
          int idx = 0;
          const std::string &choice = id(default_page_select_boot).state;

          // Page index mapping:
          // 0 = Vertical Clock (always available)
          // 1 = AirQ page
          // 2 = WiFi page
          // 3 = Weather page
          // 4 = Daily Forecast page
          // 5 = Hourly Forecast page

          if (choice == "Vertical Clock") idx = 0;
          else if (choice == "AirQ") idx = 1;
          else if (choice == "WiFi") idx = 2;
          else if (choice == "Weather") idx = 3;
          else if (choice == "Daily Forecast") idx = 4;
          else if (choice == "Hourly Forecast") idx = 5;

          id(default_page_index) = idx;

# ============================================================================
# LVGL BUFFER SIZE OPTIMIZATION
# ============================================================================
# Adjust buffer_size based on enabled features to optimize memory usage
#
# Memory Guidelines:
#   Clock only:             30-35% (maximum available)
#   Clock + AirQ:           28-32% (current: 30%)
#   Clock + Weather:        25-28%
#   Clock + AirQ + Weather: 26-28%
#   Full featured:          25%
#   With BLE enabled:       15-20% (BLE uses significant heap!)

lvgl:
  buffer_size: 30%  # Optimized for AirQ only configuration

# Uncomment and adjust if you change features:
# lvgl:
#   buffer_size: 27%  # For AirQ + Weather
# lvgl:
#   buffer_size: 25%  # For full-featured
# lvgl:
#   buffer_size: 35%  # For clock only
