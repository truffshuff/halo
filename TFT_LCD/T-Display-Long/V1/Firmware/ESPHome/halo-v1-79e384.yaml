# ============================================================================
# Halo V1 - Dynamic Configuration (ESPHome 2025.10.0+)
# ============================================================================
# This configuration uses Jinja2 ternary operators for automatic package
# selection based on feature flags. Just change a flag from "false" to "true"
# and the entire configuration updates automatically!
#
# ✅ BLE + WEATHER NOW POSSIBLE!
#   Old: BLE (60KB) + Weather sensors (75KB) = Too tight!
#   New: BLE (60KB) + HA Actions (3KB) = Plenty of room!
# ============================================================================

# ============================================================================
# FEATURE FLAGS - Enable/Disable Features
# ============================================================================
substitutions:
  # Device Identity
  name: "halo-v1-79e384"
  friendly_name: "Halo Air Quality Monitor Dev"

  # Display Features
  feature_clock: "true"              # Always true (core feature)
  feature_airq: "false"              # Air quality display page
  feature_wifi_page: "false"         # WiFi info display page
  feature_wireguard: "false"         # WireGuard VPN (requires wifi_page)

  # Weather Features (NEW - uses HA Actions!)
  feature_weather: "false"           # Enable weather via HA actions
  weather_entity_id: "weather.hhut"  # Your HA weather entity
  weather_refresh_interval: "900"    # Seconds (15 min default)

  # Connectivity Features
  feature_ble: "false"               # BLE presence detection

  # Memory Management
  feature_psram_optimization: "true" # Keep enabled for best performance
  feature_memory_stats: "true"       # Show memory usage stats

  # Network Configuration
  wifi_ssid: !secret wifihome_ssid
  wifi_password: !secret wifihome_password

  # Security
  api_encryption_key: "mLKXHYyBZgGLfMiXyWoo3Fzc/TpqbKpk0g+uYAwErMs="
  ota_password: "halo79e384"

  # ============================================================================
  # AUTOMATIC PACKAGE SELECTION (Jinja2)
  # ============================================================================
  # Change the feature flags above and packages auto-select!

  airq_package_file: '{{ "airq-display.yaml" if feature_airq | bool else "airq-stubs.yaml" }}'
  ble_package_file: '{{ "ble-core-simplified.yaml" if feature_ble | bool else "ble-stubs.yaml" }}'
  wifi_package_file: '{{ "wifi-display.yaml" if feature_wifi_page | bool else "wifi-stubs.yaml" }}'
  weather_package_file: '{{ "weather-ha-actions.yaml" if feature_weather | bool else "weather-stubs.yaml" }}'
  wireguard_package_file: '{{ "wireguard.yaml" if (feature_wireguard | bool and feature_wifi_page | bool) else "wireguard-stubs.yaml" }}'

  # LVGL pages - automatically picks the right combination!
  lvgl_pages_file: >-
    {%- set airq = feature_airq | bool -%}
    {%- set wifi = feature_wifi_page | bool -%}
    {%- set wg = feature_wireguard | bool -%}
    {%- set weather = feature_weather | bool -%}
    {%- if not airq and not wifi and not weather -%}
      lvgl-pages-clock-only.yaml
    {%- elif airq and not wifi and not weather -%}
      lvgl-pages-airq-only.yaml
    {%- elif not airq and wifi and not wg and not weather -%}
      lvgl-pages-wifi-only.yaml
    {%- elif not airq and wifi and wg and not weather -%}
      lvgl-pages-wifi-wireguard.yaml
    {%- elif airq and wifi and not wg and not weather -%}
      lvgl-pages-airq-wifi.yaml
    {%- elif not airq and not wifi and weather -%}
      lvgl-pages-weather-forecast-only.yaml
    {%- elif airq and not wifi and weather -%}
      lvgl-pages-airq-weather-forecast-only.yaml
    {%- elif not airq and wifi and weather -%}
      lvgl-pages-wifi-weather-forecast-only.yaml
    {%- elif airq and wifi and weather -%}
      lvgl-pages-airq-wifi-weather-forecast.yaml
    {%- else -%}
      lvgl-pages-clock-only.yaml
    {%- endif -%}

# ============================================================================
# PACKAGE IMPORTS
# ============================================================================
packages:
  # Core hardware/component configuration (includes nested packages)
  # NOTE: For HA dashboard compilation, copy Halo-v1-Core.yaml and packages/
  # directory to /config/esphome/ first
  halo_v1_core: !include Halo-v1-Core.yaml

  # Automatic feature packages (Jinja2 conditional loading)
  airq_auto: !include packages/${airq_package_file}
  ble_auto: !include packages/${ble_package_file}
  wifi_auto: !include packages/${wifi_package_file}
  weather_auto: !include packages/${weather_package_file}
  wireguard_auto: !include packages/${wireguard_package_file}
  lvgl_pages: !include packages/${lvgl_pages_file}

# ============================================================================
# DEVICE-SPECIFIC CONFIGURATION
# ============================================================================
# The halo_v1_core package provides: esphome, esp32, psram, logger, api, i2c,
# spi, display, touchscreen, lights, sensors, switches, scripts, intervals, etc.
# Only add device-specific settings or overrides below.

# WiFi credentials (not in core file - each device needs its own)
wifi:
  ssid: ${wifi_ssid}
  password: ${wifi_password}
  ap:
    ssid: "Halo-79e384-Fallback"
    password: "fallback12345"

# OTA password
ota:
  - platform: esphome
    password: ${ota_password}

# ============================================================================
# DEFAULT PAGE SELECTOR
# ============================================================================
select:
  - platform: template
    name: "Default Page at Boot"
    id: default_page_select_boot
    optimistic: true
    options:
      - "Vertical Clock"
      # Add options based on enabled features:
      # - "AirQ"          # if feature_airq
      # - "WiFi"          # if feature_wifi_page
      # - "Weather"       # if feature_weather
    initial_option: "Vertical Clock"
    restore_value: true

# ============================================================================
# MEMORY BUDGET GUIDE
# ============================================================================
# ESP32-S3 has ~210KB internal RAM available
#
# ✅ BLE Compatible (< 110KB total):
#    - Clock only: ~45KB
#    - Clock + AirQ: ~65KB
#    - Clock + WiFi: ~85KB
#    - Clock + Weather (HA Actions): ~105KB ← NEW! BLE compatible!
#
# ⚠️ NOT BLE Compatible (> 110KB total):
#    - Clock + AirQ + WiFi: ~125KB
#    - Clock + AirQ + Weather: ~130KB
#    - Clock + WiFi + Weather: ~135KB
#
# With HA Actions, you can have Clock + Weather + BLE!
# ============================================================================
