# ============================================================================
# Clock Capability - Base Configuration
# ============================================================================
# Everything needed for clock functionality (except LVGL page)
# Dependencies:
#   - system/esphome_core.yaml
#   - system/fonts_colors.yaml
#   - system/system_management.yaml (time sources)
#
# This module configures:
#   - Clock globals (colon blink, time update tracking)
#   - Time update script (renders clock on all pages)
#   - Colon blink animation script
#   - Clock control switches (24h format, colon blink)
#   - Page rotation controls for clock
#   - Navigation button
#
# Features:
#   - 12h/24h time format toggle
#   - Blinking colon animation (configurable)
#   - Multi-page time display (clock, airq pages)
#   - Page rotation integration
#   - Performance tracking
#
# MEMORY IMPACT: ~5KB
# ============================================================================

# ============================================================================
# Clock Globals
# ============================================================================
globals:
  # Colon blink state for clock display
  # Toggles every second to create blinking colon animation (:)
  - id: colon_blink_state
    type: bool
    restore_value: no
    initial_value: 'true'

  # Time update performance tracking
  - id: time_update_last_started
    type: int
    restore_value: no
    initial_value: '0'

  - id: time_update_last_duration
    type: int
    restore_value: no
    initial_value: '0'

  - id: time_update_last_text
    type: std::string
    restore_value: no
    initial_value: ""

  - id: time_update_needs_render
    type: bool
    restore_value: no
    initial_value: 'false'

  # Page rotation settings for clock page
  - id: page_rotation_vertical_clock_enabled
    type: bool
    restore_value: yes
    initial_value: 'true'

  - id: page_rotation_vertical_clock_order
    type: int
    restore_value: yes
    initial_value: '1'

# ============================================================================
# Clock Scripts
# ============================================================================
script:
  # Update colon widget (blink animation)
  - id: update_colon_widget
    mode: restart
    then:
      - if:
          condition:
            lambda: 'return id(colon_blink_state);'
          then:
            - lvgl.label.update:
                id: vclock_colon
                text: ":"
          else:
            - lvgl.label.update:
                id: vclock_colon
                text: " "

  # Main time update script
  # Updates time display on ALL pages that show time (vertical_clock, airq)
  - id: time_update
    mode: restart
    then:
      - lambda: |-
          id(time_update_last_started) = millis();
          id(time_update_needs_render) = false;
      - lambda: |-
          auto now = id(wireguard_enabled).state ? id(sntp_time).now() : id(ha_time).now();
          if (!now.is_valid()) {
            ESP_LOGW("time_update", "Time source unavailable, skipping label update");
            return;
          }
          bool is_pm = now.hour >= 12;
          int hour_12 = now.hour % 12;
          if (hour_12 == 0) {
            hour_12 = 12;
          }
          char time_buf[17];
          if (id(time_format).state) {
            snprintf(time_buf, sizeof(time_buf), "%02d:%02d", now.hour, now.minute);
          } else {
            snprintf(time_buf, sizeof(time_buf), "%2d:%02d%s", hour_12, now.minute, is_pm ? "PM" : "AM");
          }
          std::string new_text(time_buf);
          if (new_text != id(time_update_last_text)) {
            id(time_update_last_text) = new_text;
            id(time_update_needs_render) = true;
          }
      # Update AirQ page time display
      - if:
          condition:
            lambda: 'return id(time_update_needs_render) && id(current_page_name) == "airq";'
          then:
            - lvgl.label.update:
                id: timeVal
                text: !lambda 'return id(time_update_last_text);'
      # Update vertical clock page
      - if:
          condition:
            lambda: 'return id(time_update_needs_render) && id(current_page_name) == "vertical_clock";'
          then:
            - lvgl.label.update:
                id: vclock_hours
                text: !lambda |-
                  auto now = id(wireguard_enabled).state ? id(sntp_time).now() : id(ha_time).now();
                  if (!now.is_valid()) return std::string("--");
                  bool is_pm = now.hour >= 12;
                  int hour_12 = now.hour % 12;
                  if (hour_12 == 0) hour_12 = 12;
                  char buf[3];
                  if (id(time_format).state) {
                    snprintf(buf, sizeof(buf), "%02d", now.hour);
                  } else {
                    snprintf(buf, sizeof(buf), "%2d", hour_12);
                  }
                  return std::string(buf);
            - lvgl.label.update:
                id: vclock_minutes
                text: !lambda |-
                  auto now = id(wireguard_enabled).state ? id(sntp_time).now() : id(ha_time).now();
                  if (!now.is_valid()) return std::string("--");
                  char buf[3];
                  snprintf(buf, sizeof(buf), "%02d", now.minute);
                  return std::string(buf);
            - lvgl.label.update:
                id: vclock_ampm
                text: !lambda |-
                  auto now = id(wireguard_enabled).state ? id(sntp_time).now() : id(ha_time).now();
                  if (!now.is_valid()) return std::string("");
                  if (id(time_format).state) return std::string("");
                  bool is_pm = now.hour >= 12;
                  return std::string(is_pm ? "PM" : "AM");
            - lvgl.label.update:
                id: vclock_date
                text: !lambda |-
                  auto now = id(wireguard_enabled).state ? id(sntp_time).now() : id(ha_time).now();
                  if (!now.is_valid()) return std::string("--");
                  static const char* months[] = {"Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"};
                  char buf[20];
                  snprintf(buf, sizeof(buf), "%s %d", months[now.month - 1], now.day_of_month);
                  return std::string(buf);
            - lvgl.label.update:
                id: vclock_day_top
                text: !lambda |-
                  auto now = id(wireguard_enabled).state ? id(sntp_time).now() : id(ha_time).now();
                  if (!now.is_valid()) return std::string("--");
                  static const char* days[] = {"Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"};
                  return std::string(days[now.day_of_week - 1]);
      - script.execute: update_colon_widget
      - lambda: |-
          const uint32_t now = millis();
          const uint32_t elapsed = now - id(time_update_last_started);
          id(time_update_last_duration) = elapsed;
          const bool rendered = id(time_update_needs_render);

          // Update watchdog timer ONLY if we actually rendered something
          if (rendered) {
            id(last_display_update_time) = now;
            ESP_LOGV("time_update", "Display watchdog updated (rendered)");
          }

          ESP_LOGV("time_update", "Execution: %ums, rendered=%s, on_page=%s",
                   elapsed,
                   rendered ? "yes" : "no",
                   id(current_page_name).c_str());

# ============================================================================
# Clock Intervals
# ============================================================================
interval:
  # Update time display every 2 seconds
  - interval: 2s
    then:
      - if:
          condition:
            lambda: 'return id(boot_complete);'
          then:
            - script.execute: time_update

  # Toggle colon blink state every 1 second
  - interval: 1s
    then:
      - if:
          condition:
            lambda: 'return id(boot_complete) && id(colon_blink_enabled).state;'
          then:
            - lambda: 'id(colon_blink_state) = !id(colon_blink_state);'
            - script.execute: update_colon_widget

# ============================================================================
# Clock Control Switches
# ============================================================================
switch:
  # 24-hour clock format toggle
  - platform: template
    name: "24h Clock Format"
    id: time_format
    icon: mdi:clock-digital
    restore_mode: RESTORE_DEFAULT_OFF
    optimistic: true
    entity_category: "config"

  # Colon blink animation toggle
  - platform: template
    name: "Clock Colon Blink"
    id: colon_blink_enabled
    icon: mdi:timer-outline
    restore_mode: RESTORE_DEFAULT_ON
    optimistic: true
    entity_category: "config"

  # Page rotation enable/disable for clock page
  - platform: template
    name: "Page Rotation: Vertical Clock Page"
    id: page_rotation_vertical_clock_switch
    icon: mdi:clock-outline
    restore_mode: RESTORE_DEFAULT_ON
    optimistic: true
    entity_category: "config"
    on_turn_on:
      - lambda: 'id(page_rotation_vertical_clock_enabled) = true;'
      - logger.log: "Vertical clock page enabled in rotation"
    on_turn_off:
      - lambda: 'id(page_rotation_vertical_clock_enabled) = false;'
      - logger.log: "Vertical clock page disabled in rotation"

# ============================================================================
# Clock Control Numbers
# ============================================================================
number:
  # Page order for rotation
  - platform: template
    name: "Page Order: Vertical Clock Page"
    id: page_order_vertical_clock
    icon: mdi:numeric
    restore_value: true
    initial_value: 1
    min_value: 1
    max_value: 7
    entity_category: "config"
    optimistic: true
    step: 1
    on_value:
      - lambda: 'id(page_rotation_vertical_clock_order) = (int)x;'

# ============================================================================
# Clock Navigation Button
# ============================================================================
button:
  - platform: template
    name: "Go to Clock Page"
    id: goto_clock_page
    icon: mdi:clock-outline
    on_press:
      - logger.log: "Navigating to Clock page"
      - lambda: |-
          id(current_page_name) = "vertical_clock";
          id(last_auto_rotation_time) = millis();
      - lvgl.page.show:
          id: vertical_clock_page

# ============================================================================
# Clock Diagnostic Sensors
# ============================================================================
sensor:
  - platform: template
    name: "Time Update Duration"
    id: time_update_duration_sensor
    internal: true  # Don't send to Home Assistant - internal diagnostic only
    unit_of_measurement: "ms"
    accuracy_decimals: 0
    icon: "mdi:timer-outline"
    entity_category: "diagnostic"
    update_interval: never
