# ============================================================================
# Weather Daily - Daily Forecast Display
# ============================================================================
# Part of Phase 2 modular refactoring
#
# This module provides the daily forecast display scripts:
#   - update_daily_forecast_display script (updates all 10 days)
#
# Dependencies:
#   - packages/features/weather/weather_base.yaml (for globals and data)
#   - packages/base/hardware.yaml (for LVGL display)
#   - packages/weather/daily-forecast-pages.yaml (for LVGL pages - to be moved)
#
# Required IDs from other modules:
#   - current_page_name (from page_rotation)
#   - weather_forecast_* globals (from weather_base)
#   - sntp_time (from esphome_base)
#
# Notes:
#   - Displays 10-day forecast with high/low temps, conditions, precipitation
#   - Only updates when on daily forecast page to reduce SPI traffic
#   - Uses weather_helpers namespace for formatting
# ============================================================================

script:
  - id: update_daily_forecast_display
    mode: single  # Queue if already running to prevent restart overhead
    then:
      # Skip if not on daily forecast page to reduce SPI traffic
      - if:
          condition:
            lambda: 'return id(current_page_name) != "daily_forecast";'
          then:
            - logger.log: "Skipping daily forecast update (not on daily forecast page)"
            - script.stop: update_daily_forecast_display
      # Feed watchdog before long LVGL operation
      - lambda: 'App.feed_wdt();'
      - logger.log: "Updating daily forecast display..."
      # Update Day 2
      - lvgl.label.update:
          id: lbl_forecast_day2_header
          text: !lambda |-
            if (id(weather_forecast_datetime)[1].empty()) return std::string("Day +2 (--/--)");
            // Parse datetime string (format: "2024-11-01T00:00:00+00:00")
            std::string dt = id(weather_forecast_datetime)[1];
            if (dt.length() >= 19) {
              // Parse the datetime components
              int year = std::stoi(dt.substr(0, 4));
              int month = std::stoi(dt.substr(5, 2));
              int day = std::stoi(dt.substr(8, 2));
              int hour = std::stoi(dt.substr(11, 2));
              
              // Parse timezone offset if present
              if (dt.length() >= 25 && (dt[19] == '+' || dt[19] == '-')) {
                int offset_hours = std::stoi(dt.substr(20, 2));
                if (dt[19] == '-') offset_hours = -offset_hours;
                
                // Get local timezone offset
                auto now = id(sntp_time).now();
                if (now.is_valid()) {
                  time_t utc_time = now.timestamp;
                  struct tm *utc_tm = gmtime(&utc_time);
                  struct tm *local_tm = localtime(&utc_time);
                  int utc_hour = utc_tm->tm_hour;
                  int local_hour = local_tm->tm_hour;
                  int local_offset = local_hour - utc_hour;
                  
                  // Handle day boundary crossing in offset calculation
                  if (local_offset > 12) local_offset -= 24;
                  if (local_offset < -12) local_offset += 24;
                  
                  // Adjust hour for timezone difference
                  hour += (local_offset - offset_hours);
                  
                  // Handle day boundary crossing
                  if (hour < 0) {
                    day--;
                    if (day < 1) {
                      month--;
                      if (month < 1) {
                        month = 12;
                        year--;
                      }
                      // Get days in previous month (simplified)
                      int days_in_month[] = {31,28,31,30,31,30,31,31,30,31,30,31};
                      if (month == 2 && (year % 4 == 0 && (year % 100 != 0 || year % 400 == 0))) {
                        day = 29;
                      } else {
                        day = days_in_month[month-1];
                      }
                    }
                  } else if (hour >= 24) {
                    day++;
                    int days_in_month[] = {31,28,31,30,31,30,31,31,30,31,30,31};
                    int max_days = days_in_month[month-1];
                    if (month == 2 && (year % 4 == 0 && (year % 100 != 0 || year % 400 == 0))) {
                      max_days = 29;
                    }
                    if (day > max_days) {
                      day = 1;
                      month++;
                      if (month > 12) {
                        month = 1;
                        year++;
                      }
                    }
                  }
                }
              }
              
              char buf[32];
              snprintf(buf, sizeof(buf), "Day +2 (%02d/%02d)", month, day);
              return std::string(buf);
            }
            return std::string("Day +2 (--/--)");
      - lvgl.label.update:
          id: lbl_forecast_day2_icon
          text: !lambda 'return weather_helpers::get_weather_icon(id(weather_forecast_condition)[1]);'
          text_color: !lambda 'return lv_color_hex(weather_helpers::get_weather_icon_color(id(weather_forecast_condition)[1]));'
      - lvgl.label.update:
          id: lbl_forecast_day2_temps
          text: !lambda |-
            char buf[64];
            float high = id(weather_forecast_temp_high)[1];
            float low = id(weather_forecast_temp_low)[1];
            if (isnan(high) || isnan(low)) {
              return std::string("H:--° L:--°");
            }
            snprintf(buf, sizeof(buf), "#FF0000 H:%.0f°# #00DFFF L:%.0f°#", high, low);
            return std::string(buf);
      - lvgl.label.update:
          id: lbl_forecast_day2_precip_prob
          text: !lambda |-
            if (isnan(id(weather_forecast_precip_prob)[1])) return std::string("Rain: --%");
            char buf[32];
            snprintf(buf, sizeof(buf), "Chance: %.0f%%", id(weather_forecast_precip_prob)[1]);
            return std::string(buf);
      - lvgl.label.update:
          id: lbl_forecast_day2_condition
          text: !lambda |-
            if (id(weather_forecast_condition)[1].empty()) return std::string("---");
            // Format condition text to be more readable
            std::string condition = id(weather_forecast_condition)[1];
            if (condition == "clear-night") return std::string("Clear Night");
            if (condition == "cloudy") return std::string("Cloudy");
            if (condition == "exceptional") return std::string("Exceptional");
            if (condition == "fog") return std::string("Fog");
            if (condition == "hail") return std::string("Hail");
            if (condition == "lightning") return std::string("Lightning");
            if (condition == "lightning-rainy") return std::string("Lightning & Rain");
            if (condition == "partlycloudy") return std::string("Partly Cloudy");
            if (condition == "pouring") return std::string("Pouring");
            if (condition == "rainy") return std::string("Rainy");
            if (condition == "snowy") return std::string("Snowy");
            if (condition == "snowy-rainy") return std::string("Sleet");
            if (condition == "sunny") return std::string("Sunny");
            if (condition == "windy") return std::string("Windy");
            if (condition == "windy-variant") return std::string("Windy Windy");
            // Return capitalized version if not matched
            if (!condition.empty()) {
              condition[0] = toupper(condition[0]);
            }
            return condition;

      # Small delay to prevent system overload
      - delay: 30ms

      # Update Day 3
      - lvgl.label.update:
          id: lbl_forecast_day3_header
          text: !lambda |-
            if (id(weather_forecast_datetime)[2].empty()) return std::string("Day +3 (--/--)");
            std::string dt = id(weather_forecast_datetime)[2];
            if (dt.length() >= 19) {
              int year = std::stoi(dt.substr(0, 4));
              int month = std::stoi(dt.substr(5, 2));
              int day = std::stoi(dt.substr(8, 2));
              int hour = std::stoi(dt.substr(11, 2));
              
              if (dt.length() >= 25 && (dt[19] == '+' || dt[19] == '-')) {
                int offset_hours = std::stoi(dt.substr(20, 2));
                if (dt[19] == '-') offset_hours = -offset_hours;
                
                auto now = id(sntp_time).now();
                if (now.is_valid()) {
                  time_t utc_time = now.timestamp;
                  struct tm *utc_tm = gmtime(&utc_time);
                  struct tm *local_tm = localtime(&utc_time);
                  int utc_hour = utc_tm->tm_hour;
                  int local_hour = local_tm->tm_hour;
                  int local_offset = local_hour - utc_hour;
                  
                  // Handle day boundary crossing in offset calculation
                  if (local_offset > 12) local_offset -= 24;
                  if (local_offset < -12) local_offset += 24;
                  hour += (local_offset - offset_hours);
                  
                  if (hour < 0) {
                    day--;
                    if (day < 1) {
                      month--;
                      if (month < 1) {
                        month = 12;
                        year--;
                      }
                      int days_in_month[] = {31,28,31,30,31,30,31,31,30,31,30,31};
                      if (month == 2 && (year % 4 == 0 && (year % 100 != 0 || year % 400 == 0))) {
                        day = 29;
                      } else {
                        day = days_in_month[month-1];
                      }
                    }
                  } else if (hour >= 24) {
                    day++;
                    int days_in_month[] = {31,28,31,30,31,30,31,31,30,31,30,31};
                    int max_days = days_in_month[month-1];
                    if (month == 2 && (year % 4 == 0 && (year % 100 != 0 || year % 400 == 0))) {
                      max_days = 29;
                    }
                    if (day > max_days) {
                      day = 1;
                      month++;
                      if (month > 12) {
                        month = 1;
                        year++;
                      }
                    }
                  }
                }
              }
              
              char buf[32];
              snprintf(buf, sizeof(buf), "Day +3 (%02d/%02d)", month, day);
              return std::string(buf);
            }
            return std::string("Day +3 (--/--)");
      - lvgl.label.update:
          id: lbl_forecast_day3_icon
          text: !lambda 'return weather_helpers::get_weather_icon(id(weather_forecast_condition)[2]);'
          text_color: !lambda 'return lv_color_hex(weather_helpers::get_weather_icon_color(id(weather_forecast_condition)[2]));'
      - lvgl.label.update:
          id: lbl_forecast_day3_temps
          text: !lambda |-
            char buf[64];
            float high = id(weather_forecast_temp_high)[2];
            float low = id(weather_forecast_temp_low)[2];
            if (isnan(high) || isnan(low)) {
              return std::string("H:--° L:--°");
            }
            snprintf(buf, sizeof(buf), "#FF0000 H:%.0f°# #00DFFF L:%.0f°#", high, low);
            return std::string(buf);
      - lvgl.label.update:
          id: lbl_forecast_day3_precip_prob
          text: !lambda |-
            if (isnan(id(weather_forecast_precip_prob)[2])) return std::string("Rain: --%");
            char buf[32];
            snprintf(buf, sizeof(buf), "Chance: %.0f%%", id(weather_forecast_precip_prob)[2]);
            return std::string(buf);
      - lvgl.label.update:
          id: lbl_forecast_day3_condition
          text: !lambda |-
            if (id(weather_forecast_condition)[2].empty()) return std::string("---");
            // Format condition text to be more readable
            std::string condition = id(weather_forecast_condition)[2];
            if (condition == "clear-night") return std::string("Clear Night");
            if (condition == "cloudy") return std::string("Cloudy");
            if (condition == "exceptional") return std::string("Exceptional");
            if (condition == "fog") return std::string("Fog");
            if (condition == "hail") return std::string("Hail");
            if (condition == "lightning") return std::string("Lightning");
            if (condition == "lightning-rainy") return std::string("Lightning & Rain");
            if (condition == "partlycloudy") return std::string("Partly Cloudy");
            if (condition == "pouring") return std::string("Pouring");
            if (condition == "rainy") return std::string("Rainy");
            if (condition == "snowy") return std::string("Snowy");
            if (condition == "snowy-rainy") return std::string("Sleet");
            if (condition == "sunny") return std::string("Sunny");
            if (condition == "windy") return std::string("Windy");
            if (condition == "windy-variant") return std::string("Windy Windy");
            // Return capitalized version if not matched
            if (!condition.empty()) {
              condition[0] = toupper(condition[0]);
            }
            return condition;

      - delay: 30ms
      # Update Day 4
      - lvgl.label.update:
          id: lbl_forecast_day4_header
          text: !lambda |-
            if (id(weather_forecast_datetime)[3].empty()) return std::string("Day +4 (--/--)");
            std::string dt = id(weather_forecast_datetime)[3];
            if (dt.length() >= 19) {
              int year = std::stoi(dt.substr(0, 4));
              int month = std::stoi(dt.substr(5, 2));
              int day = std::stoi(dt.substr(8, 2));
              int hour = std::stoi(dt.substr(11, 2));
              
              if (dt.length() >= 25 && (dt[19] == '+' || dt[19] == '-')) {
                int offset_hours = std::stoi(dt.substr(20, 2));
                if (dt[19] == '-') offset_hours = -offset_hours;
                
                auto now = id(sntp_time).now();
                if (now.is_valid()) {
                  time_t utc_time = now.timestamp;
                  struct tm *utc_tm = gmtime(&utc_time);
                  struct tm *local_tm = localtime(&utc_time);
                  int utc_hour = utc_tm->tm_hour;
                  int local_hour = local_tm->tm_hour;
                  int local_offset = local_hour - utc_hour;
                  
                  // Handle day boundary crossing in offset calculation
                  if (local_offset > 12) local_offset -= 24;
                  if (local_offset < -12) local_offset += 24;
                  hour += (local_offset - offset_hours);
                  
                  if (hour < 0) {
                    day--;
                    if (day < 1) {
                      month--;
                      if (month < 1) {
                        month = 12;
                        year--;
                      }
                      int days_in_month[] = {31,28,31,30,31,30,31,31,30,31,30,31};
                      if (month == 2 && (year % 4 == 0 && (year % 100 != 0 || year % 400 == 0))) {
                        day = 29;
                      } else {
                        day = days_in_month[month-1];
                      }
                    }
                  } else if (hour >= 24) {
                    day++;
                    int days_in_month[] = {31,28,31,30,31,30,31,31,30,31,30,31};
                    int max_days = days_in_month[month-1];
                    if (month == 2 && (year % 4 == 0 && (year % 100 != 0 || year % 400 == 0))) {
                      max_days = 29;
                    }
                    if (day > max_days) {
                      day = 1;
                      month++;
                      if (month > 12) {
                        month = 1;
                        year++;
                      }
                    }
                  }
                }
              }
              
              char buf[32];
              snprintf(buf, sizeof(buf), "Day +4 (%02d/%02d)", month, day);
              return std::string(buf);
            }
            return std::string("Day +4 (--/--)");
      - lvgl.label.update:
          id: lbl_forecast_day4_icon
          text: !lambda 'return weather_helpers::get_weather_icon(id(weather_forecast_condition)[3]);'
          text_color: !lambda 'return lv_color_hex(weather_helpers::get_weather_icon_color(id(weather_forecast_condition)[3]));'
      - lvgl.label.update:
          id: lbl_forecast_day4_temps
          text: !lambda |-
            char buf[64];
            float high = id(weather_forecast_temp_high)[3];
            float low = id(weather_forecast_temp_low)[3];
            if (isnan(high) || isnan(low)) {
              return std::string("H:--° L:--°");
            }
            snprintf(buf, sizeof(buf), "#FF0000 H:%.0f°# #00DFFF L:%.0f°#", high, low);
            return std::string(buf);
      - lvgl.label.update:
          id: lbl_forecast_day4_precip_prob
          text: !lambda |-
            if (isnan(id(weather_forecast_precip_prob)[3])) return std::string("Rain: --%");
            char buf[32];
            snprintf(buf, sizeof(buf), "Chance: %.0f%%", id(weather_forecast_precip_prob)[3]);
            return std::string(buf);
      - lvgl.label.update:
          id: lbl_forecast_day4_condition
          text: !lambda |-
            if (id(weather_forecast_condition)[3].empty()) return std::string("---");
            // Format condition text to be more readable
            std::string condition = id(weather_forecast_condition)[3];
            if (condition == "clear-night") return std::string("Clear Night");
            if (condition == "cloudy") return std::string("Cloudy");
            if (condition == "exceptional") return std::string("Exceptional");
            if (condition == "fog") return std::string("Fog");
            if (condition == "hail") return std::string("Hail");
            if (condition == "lightning") return std::string("Lightning");
            if (condition == "lightning-rainy") return std::string("Lightning & Rain");
            if (condition == "partlycloudy") return std::string("Partly Cloudy");
            if (condition == "pouring") return std::string("Pouring");
            if (condition == "rainy") return std::string("Rainy");
            if (condition == "snowy") return std::string("Snowy");
            if (condition == "snowy-rainy") return std::string("Sleet");
            if (condition == "sunny") return std::string("Sunny");
            if (condition == "windy") return std::string("Windy");
            if (condition == "windy-variant") return std::string("Windy Windy");
            // Return capitalized version if not matched
            if (!condition.empty()) {
              condition[0] = toupper(condition[0]);
            }
            return condition;

      - delay: 30ms
      # Update Day 5
      - lvgl.label.update:
          id: lbl_forecast_day5_header
          text: !lambda |-
            if (id(weather_forecast_datetime)[4].empty()) return std::string("Day +5 (--/--)");
            std::string dt = id(weather_forecast_datetime)[4];
            if (dt.length() >= 19) {
              int year = std::stoi(dt.substr(0, 4));
              int month = std::stoi(dt.substr(5, 2));
              int day = std::stoi(dt.substr(8, 2));
              int hour = std::stoi(dt.substr(11, 2));
              
              if (dt.length() >= 25 && (dt[19] == '+' || dt[19] == '-')) {
                int offset_hours = std::stoi(dt.substr(20, 2));
                if (dt[19] == '-') offset_hours = -offset_hours;
                
                auto now = id(sntp_time).now();
                if (now.is_valid()) {
                  time_t utc_time = now.timestamp;
                  struct tm *utc_tm = gmtime(&utc_time);
                  struct tm *local_tm = localtime(&utc_time);
                  int utc_hour = utc_tm->tm_hour;
                  int local_hour = local_tm->tm_hour;
                  int local_offset = local_hour - utc_hour;
                  
                  // Handle day boundary crossing in offset calculation
                  if (local_offset > 12) local_offset -= 24;
                  if (local_offset < -12) local_offset += 24;
                  hour += (local_offset - offset_hours);
                  
                  if (hour < 0) {
                    day--;
                    if (day < 1) {
                      month--;
                      if (month < 1) {
                        month = 12;
                        year--;
                      }
                      int days_in_month[] = {31,28,31,30,31,30,31,31,30,31,30,31};
                      if (month == 2 && (year % 4 == 0 && (year % 100 != 0 || year % 400 == 0))) {
                        day = 29;
                      } else {
                        day = days_in_month[month-1];
                      }
                    }
                  } else if (hour >= 24) {
                    day++;
                    int days_in_month[] = {31,28,31,30,31,30,31,31,30,31,30,31};
                    int max_days = days_in_month[month-1];
                    if (month == 2 && (year % 4 == 0 && (year % 100 != 0 || year % 400 == 0))) {
                      max_days = 29;
                    }
                    if (day > max_days) {
                      day = 1;
                      month++;
                      if (month > 12) {
                        month = 1;
                        year++;
                      }
                    }
                  }
                }
              }
              
              char buf[32];
              snprintf(buf, sizeof(buf), "Day +5 (%02d/%02d)", month, day);
              return std::string(buf);
            }
            return std::string("Day +5 (--/--)");
      - lvgl.label.update:
          id: lbl_forecast_day5_icon
          text: !lambda 'return weather_helpers::get_weather_icon(id(weather_forecast_condition)[4]);'
          text_color: !lambda 'return lv_color_hex(weather_helpers::get_weather_icon_color(id(weather_forecast_condition)[4]));'
      - lvgl.label.update:
          id: lbl_forecast_day5_temps
          text: !lambda |-
            char buf[64];
            float high = id(weather_forecast_temp_high)[4];
            float low = id(weather_forecast_temp_low)[4];
            if (isnan(high) || isnan(low)) {
              return std::string("H:--° L:--°");
            }
            snprintf(buf, sizeof(buf), "#FF0000 H:%.0f°# #00DFFF L:%.0f°#", high, low);
            return std::string(buf);
      - lvgl.label.update:
          id: lbl_forecast_day5_precip_prob
          text: !lambda |-
            if (isnan(id(weather_forecast_precip_prob)[4])) return std::string("Rain: --%");
            char buf[32];
            snprintf(buf, sizeof(buf), "Chance: %.0f%%", id(weather_forecast_precip_prob)[4]);
            return std::string(buf);
      - lvgl.label.update:
          id: lbl_forecast_day5_condition
          text: !lambda |-
            if (id(weather_forecast_condition)[4].empty()) return std::string("---");
            // Format condition text to be more readable
            std::string condition = id(weather_forecast_condition)[4];
            if (condition == "clear-night") return std::string("Clear Night");
            if (condition == "cloudy") return std::string("Cloudy");
            if (condition == "exceptional") return std::string("Exceptional");
            if (condition == "fog") return std::string("Fog");
            if (condition == "hail") return std::string("Hail");
            if (condition == "lightning") return std::string("Lightning");
            if (condition == "lightning-rainy") return std::string("Lightning & Rain");
            if (condition == "partlycloudy") return std::string("Partly Cloudy");
            if (condition == "pouring") return std::string("Pouring");
            if (condition == "rainy") return std::string("Rainy");
            if (condition == "snowy") return std::string("Snowy");
            if (condition == "snowy-rainy") return std::string("Sleet");
            if (condition == "sunny") return std::string("Sunny");
            if (condition == "windy") return std::string("Windy");
            if (condition == "windy-variant") return std::string("Windy Windy");
            // Return capitalized version if not matched
            if (!condition.empty()) {
              condition[0] = toupper(condition[0]);
            }
            return condition;

      - delay: 30ms
      # Update Day 6
      - lvgl.label.update:
          id: lbl_forecast_day6_header
          text: !lambda |-
            if (id(weather_forecast_datetime)[5].empty()) return std::string("Day +6 (--/--)");
            std::string dt = id(weather_forecast_datetime)[5];
            if (dt.length() >= 19) {
              int year = std::stoi(dt.substr(0, 4));
              int month = std::stoi(dt.substr(5, 2));
              int day = std::stoi(dt.substr(8, 2));
              int hour = std::stoi(dt.substr(11, 2));
              
              if (dt.length() >= 25 && (dt[19] == '+' || dt[19] == '-')) {
                int offset_hours = std::stoi(dt.substr(20, 2));
                if (dt[19] == '-') offset_hours = -offset_hours;
                
                auto now = id(sntp_time).now();
                if (now.is_valid()) {
                  time_t utc_time = now.timestamp;
                  struct tm *utc_tm = gmtime(&utc_time);
                  struct tm *local_tm = localtime(&utc_time);
                  int utc_hour = utc_tm->tm_hour;
                  int local_hour = local_tm->tm_hour;
                  int local_offset = local_hour - utc_hour;
                  
                  // Handle day boundary crossing in offset calculation
                  if (local_offset > 12) local_offset -= 24;
                  if (local_offset < -12) local_offset += 24;
                  hour += (local_offset - offset_hours);
                  
                  if (hour < 0) {
                    day--;
                    if (day < 1) {
                      month--;
                      if (month < 1) {
                        month = 12;
                        year--;
                      }
                      int days_in_month[] = {31,28,31,30,31,30,31,31,30,31,30,31};
                      if (month == 2 && (year % 4 == 0 && (year % 100 != 0 || year % 400 == 0))) {
                        day = 29;
                      } else {
                        day = days_in_month[month-1];
                      }
                    }
                  } else if (hour >= 24) {
                    day++;
                    int days_in_month[] = {31,28,31,30,31,30,31,31,30,31,30,31};
                    int max_days = days_in_month[month-1];
                    if (month == 2 && (year % 4 == 0 && (year % 100 != 0 || year % 400 == 0))) {
                      max_days = 29;
                    }
                    if (day > max_days) {
                      day = 1;
                      month++;
                      if (month > 12) {
                        month = 1;
                        year++;
                      }
                    }
                  }
                }
              }
              
              char buf[32];
              snprintf(buf, sizeof(buf), "Day +6 (%02d/%02d)", month, day);
              return std::string(buf);
            }
            return std::string("Day +6 (--/--)");
      - lvgl.label.update:
          id: lbl_forecast_day6_icon
          text: !lambda 'return weather_helpers::get_weather_icon(id(weather_forecast_condition)[5]);'
          text_color: !lambda 'return lv_color_hex(weather_helpers::get_weather_icon_color(id(weather_forecast_condition)[5]));'
      - lvgl.label.update:
          id: lbl_forecast_day6_temps
          text: !lambda |-
            char buf[64];
            float high = id(weather_forecast_temp_high)[5];
            float low = id(weather_forecast_temp_low)[5];
            if (isnan(high) || isnan(low)) {
              return std::string("H:--° L:--°");
            }
            snprintf(buf, sizeof(buf), "#FF0000 H:%.0f°# #00DFFF L:%.0f°#", high, low);
            return std::string(buf);
      - lvgl.label.update:
          id: lbl_forecast_day6_precip_prob
          text: !lambda |-
            if (isnan(id(weather_forecast_precip_prob)[5])) return std::string("Rain: --%");
            char buf[32];
            snprintf(buf, sizeof(buf), "Chance: %.0f%%", id(weather_forecast_precip_prob)[5]);
            return std::string(buf);
      - lvgl.label.update:
          id: lbl_forecast_day6_condition
          text: !lambda |-
            if (id(weather_forecast_condition)[5].empty()) return std::string("---");
            // Format condition text to be more readable
            std::string condition = id(weather_forecast_condition)[5];
            if (condition == "clear-night") return std::string("Clear Night");
            if (condition == "cloudy") return std::string("Cloudy");
            if (condition == "exceptional") return std::string("Exceptional");
            if (condition == "fog") return std::string("Fog");
            if (condition == "hail") return std::string("Hail");
            if (condition == "lightning") return std::string("Lightning");
            if (condition == "lightning-rainy") return std::string("Lightning & Rain");
            if (condition == "partlycloudy") return std::string("Partly Cloudy");
            if (condition == "pouring") return std::string("Pouring");
            if (condition == "rainy") return std::string("Rainy");
            if (condition == "snowy") return std::string("Snowy");
            if (condition == "snowy-rainy") return std::string("Sleet");
            if (condition == "sunny") return std::string("Sunny");
            if (condition == "windy") return std::string("Windy");
            if (condition == "windy-variant") return std::string("Windy Windy");
            // Return capitalized version if not matched
            if (!condition.empty()) {
              condition[0] = toupper(condition[0]);
            }
            return condition;

      - delay: 30ms
      # Update Day 7
      - lvgl.label.update:
          id: lbl_forecast_day7_header
          text: !lambda |-
            if (id(weather_forecast_datetime)[6].empty()) return std::string("Day +7 (--/--)");
            std::string dt = id(weather_forecast_datetime)[6];
            if (dt.length() >= 19) {
              int year = std::stoi(dt.substr(0, 4));
              int month = std::stoi(dt.substr(5, 2));
              int day = std::stoi(dt.substr(8, 2));
              int hour = std::stoi(dt.substr(11, 2));
              
              if (dt.length() >= 25 && (dt[19] == '+' || dt[19] == '-')) {
                int offset_hours = std::stoi(dt.substr(20, 2));
                if (dt[19] == '-') offset_hours = -offset_hours;
                
                auto now = id(sntp_time).now();
                if (now.is_valid()) {
                  time_t utc_time = now.timestamp;
                  struct tm *utc_tm = gmtime(&utc_time);
                  struct tm *local_tm = localtime(&utc_time);
                  int utc_hour = utc_tm->tm_hour;
                  int local_hour = local_tm->tm_hour;
                  int local_offset = local_hour - utc_hour;
                  
                  // Handle day boundary crossing in offset calculation
                  if (local_offset > 12) local_offset -= 24;
                  if (local_offset < -12) local_offset += 24;
                  hour += (local_offset - offset_hours);
                  
                  if (hour < 0) {
                    day--;
                    if (day < 1) {
                      month--;
                      if (month < 1) {
                        month = 12;
                        year--;
                      }
                      int days_in_month[] = {31,28,31,30,31,30,31,31,30,31,30,31};
                      if (month == 2 && (year % 4 == 0 && (year % 100 != 0 || year % 400 == 0))) {
                        day = 29;
                      } else {
                        day = days_in_month[month-1];
                      }
                    }
                  } else if (hour >= 24) {
                    day++;
                    int days_in_month[] = {31,28,31,30,31,30,31,31,30,31,30,31};
                    int max_days = days_in_month[month-1];
                    if (month == 2 && (year % 4 == 0 && (year % 100 != 0 || year % 400 == 0))) {
                      max_days = 29;
                    }
                    if (day > max_days) {
                      day = 1;
                      month++;
                      if (month > 12) {
                        month = 1;
                        year++;
                      }
                    }
                  }
                }
              }
              
              char buf[32];
              snprintf(buf, sizeof(buf), "Day +7 (%02d/%02d)", month, day);
              return std::string(buf);
            }
            return std::string("Day +7 (--/--)");
      - lvgl.label.update:
          id: lbl_forecast_day7_icon
          text: !lambda 'return weather_helpers::get_weather_icon(id(weather_forecast_condition)[6]);'
          text_color: !lambda 'return lv_color_hex(weather_helpers::get_weather_icon_color(id(weather_forecast_condition)[6]));'
      - lvgl.label.update:
          id: lbl_forecast_day7_temps
          text: !lambda |-
            char buf[64];
            float high = id(weather_forecast_temp_high)[6];
            float low = id(weather_forecast_temp_low)[6];
            if (isnan(high) || isnan(low)) {
              return std::string("H:--° L:--°");
            }
            snprintf(buf, sizeof(buf), "#FF0000 H:%.0f°# #00DFFF L:%.0f°#", high, low);
            return std::string(buf);
      - lvgl.label.update:
          id: lbl_forecast_day7_precip_prob
          text: !lambda |-
            if (isnan(id(weather_forecast_precip_prob)[6])) return std::string("Rain: --%");
            char buf[32];
            snprintf(buf, sizeof(buf), "Chance: %.0f%%", id(weather_forecast_precip_prob)[6]);
            return std::string(buf);
      - lvgl.label.update:
          id: lbl_forecast_day7_condition
          text: !lambda |-
            if (id(weather_forecast_condition)[6].empty()) return std::string("---");
            // Format condition text to be more readable
            std::string condition = id(weather_forecast_condition)[6];
            if (condition == "clear-night") return std::string("Clear Night");
            if (condition == "cloudy") return std::string("Cloudy");
            if (condition == "exceptional") return std::string("Exceptional");
            if (condition == "fog") return std::string("Fog");
            if (condition == "hail") return std::string("Hail");
            if (condition == "lightning") return std::string("Lightning");
            if (condition == "lightning-rainy") return std::string("Lightning & Rain");
            if (condition == "partlycloudy") return std::string("Partly Cloudy");
            if (condition == "pouring") return std::string("Pouring");
            if (condition == "rainy") return std::string("Rainy");
            if (condition == "snowy") return std::string("Snowy");
            if (condition == "snowy-rainy") return std::string("Sleet");
            if (condition == "sunny") return std::string("Sunny");
            if (condition == "windy") return std::string("Windy");
            if (condition == "windy-variant") return std::string("Windy Windy");
            // Return capitalized version if not matched
            if (!condition.empty()) {
              condition[0] = toupper(condition[0]);
            }
            return condition;

      - delay: 30ms
      # Update Day 8
      - lvgl.label.update:
          id: lbl_forecast_day8_header
          text: !lambda |-
            if (id(weather_forecast_datetime)[7].empty()) return std::string("Day +8 (--/--)");
            std::string dt = id(weather_forecast_datetime)[7];
            if (dt.length() >= 19) {
              int year = std::stoi(dt.substr(0, 4));
              int month = std::stoi(dt.substr(5, 2));
              int day = std::stoi(dt.substr(8, 2));
              int hour = std::stoi(dt.substr(11, 2));
              
              if (dt.length() >= 25 && (dt[19] == '+' || dt[19] == '-')) {
                int offset_hours = std::stoi(dt.substr(20, 2));
                if (dt[19] == '-') offset_hours = -offset_hours;
                
                auto now = id(sntp_time).now();
                if (now.is_valid()) {
                  time_t utc_time = now.timestamp;
                  struct tm *utc_tm = gmtime(&utc_time);
                  struct tm *local_tm = localtime(&utc_time);
                  int utc_hour = utc_tm->tm_hour;
                  int local_hour = local_tm->tm_hour;
                  int local_offset = local_hour - utc_hour;
                  
                  // Handle day boundary crossing in offset calculation
                  if (local_offset > 12) local_offset -= 24;
                  if (local_offset < -12) local_offset += 24;
                  hour += (local_offset - offset_hours);
                  
                  if (hour < 0) {
                    day--;
                    if (day < 1) {
                      month--;
                      if (month < 1) {
                        month = 12;
                        year--;
                      }
                      int days_in_month[] = {31,28,31,30,31,30,31,31,30,31,30,31};
                      if (month == 2 && (year % 4 == 0 && (year % 100 != 0 || year % 400 == 0))) {
                        day = 29;
                      } else {
                        day = days_in_month[month-1];
                      }
                    }
                  } else if (hour >= 24) {
                    day++;
                    int days_in_month[] = {31,28,31,30,31,30,31,31,30,31,30,31};
                    int max_days = days_in_month[month-1];
                    if (month == 2 && (year % 4 == 0 && (year % 100 != 0 || year % 400 == 0))) {
                      max_days = 29;
                    }
                    if (day > max_days) {
                      day = 1;
                      month++;
                      if (month > 12) {
                        month = 1;
                        year++;
                      }
                    }
                  }
                }
              }
              
              char buf[32];
              snprintf(buf, sizeof(buf), "Day +8 (%02d/%02d)", month, day);
              return std::string(buf);
            }
            return std::string("Day +8 (--/--)");
      - lvgl.label.update:
          id: lbl_forecast_day8_icon
          text: !lambda 'return weather_helpers::get_weather_icon(id(weather_forecast_condition)[7]);'
          text_color: !lambda 'return lv_color_hex(weather_helpers::get_weather_icon_color(id(weather_forecast_condition)[7]));'
      - lvgl.label.update:
          id: lbl_forecast_day8_temps
          text: !lambda |-
            char buf[64];
            float high = id(weather_forecast_temp_high)[7];
            float low = id(weather_forecast_temp_low)[7];
            if (isnan(high) || isnan(low)) {
              return std::string("H:--° L:--°");
            }
            snprintf(buf, sizeof(buf), "#FF0000 H:%.0f°# #00DFFF L:%.0f°#", high, low);
            return std::string(buf);
      - lvgl.label.update:
          id: lbl_forecast_day8_precip_prob
          text: !lambda |-
            if (isnan(id(weather_forecast_precip_prob)[7])) return std::string("Rain: --%");
            char buf[32];
            snprintf(buf, sizeof(buf), "Chance: %.0f%%", id(weather_forecast_precip_prob)[7]);
            return std::string(buf);
      - lvgl.label.update:
          id: lbl_forecast_day8_condition
          text: !lambda |-
            if (id(weather_forecast_condition)[7].empty()) return std::string("---");
            // Format condition text to be more readable
            std::string condition = id(weather_forecast_condition)[7];
            if (condition == "clear-night") return std::string("Clear Night");
            if (condition == "cloudy") return std::string("Cloudy");
            if (condition == "exceptional") return std::string("Exceptional");
            if (condition == "fog") return std::string("Fog");
            if (condition == "hail") return std::string("Hail");
            if (condition == "lightning") return std::string("Lightning");
            if (condition == "lightning-rainy") return std::string("Lightning & Rain");
            if (condition == "partlycloudy") return std::string("Partly Cloudy");
            if (condition == "pouring") return std::string("Pouring");
            if (condition == "rainy") return std::string("Rainy");
            if (condition == "snowy") return std::string("Snowy");
            if (condition == "snowy-rainy") return std::string("Sleet");
            if (condition == "sunny") return std::string("Sunny");
            if (condition == "windy") return std::string("Windy");
            if (condition == "windy-variant") return std::string("Windy Windy");
            // Return capitalized version if not matched
            if (!condition.empty()) {
              condition[0] = toupper(condition[0]);
            }
            return condition;

      - delay: 30ms
      # Update Day 9
      - lvgl.label.update:
          id: lbl_forecast_day9_header
          text: !lambda |-
            if (id(weather_forecast_datetime)[8].empty()) return std::string("Day +9 (--/--)");
            std::string dt = id(weather_forecast_datetime)[8];
            if (dt.length() >= 19) {
              int year = std::stoi(dt.substr(0, 4));
              int month = std::stoi(dt.substr(5, 2));
              int day = std::stoi(dt.substr(8, 2));
              int hour = std::stoi(dt.substr(11, 2));
              
              if (dt.length() >= 25 && (dt[19] == '+' || dt[19] == '-')) {
                int offset_hours = std::stoi(dt.substr(20, 2));
                if (dt[19] == '-') offset_hours = -offset_hours;
                
                auto now = id(sntp_time).now();
                if (now.is_valid()) {
                  time_t utc_time = now.timestamp;
                  struct tm *utc_tm = gmtime(&utc_time);
                  struct tm *local_tm = localtime(&utc_time);
                  int utc_hour = utc_tm->tm_hour;
                  int local_hour = local_tm->tm_hour;
                  int local_offset = local_hour - utc_hour;
                  
                  // Handle day boundary crossing in offset calculation
                  if (local_offset > 12) local_offset -= 24;
                  if (local_offset < -12) local_offset += 24;
                  hour += (local_offset - offset_hours);
                  
                  if (hour < 0) {
                    day--;
                    if (day < 1) {
                      month--;
                      if (month < 1) {
                        month = 12;
                        year--;
                      }
                      int days_in_month[] = {31,28,31,30,31,30,31,31,30,31,30,31};
                      if (month == 2 && (year % 4 == 0 && (year % 100 != 0 || year % 400 == 0))) {
                        day = 29;
                      } else {
                        day = days_in_month[month-1];
                      }
                    }
                  } else if (hour >= 24) {
                    day++;
                    int days_in_month[] = {31,28,31,30,31,30,31,31,30,31,30,31};
                    int max_days = days_in_month[month-1];
                    if (month == 2 && (year % 4 == 0 && (year % 100 != 0 || year % 400 == 0))) {
                      max_days = 29;
                    }
                    if (day > max_days) {
                      day = 1;
                      month++;
                      if (month > 12) {
                        month = 1;
                        year++;
                      }
                    }
                  }
                }
              }
              
              char buf[32];
              snprintf(buf, sizeof(buf), "Day +9 (%02d/%02d)", month, day);
              return std::string(buf);
            }
            return std::string("Day +9 (--/--)");
      - lvgl.label.update:
          id: lbl_forecast_day9_icon
          text: !lambda 'return weather_helpers::get_weather_icon(id(weather_forecast_condition)[8]);'
          text_color: !lambda 'return lv_color_hex(weather_helpers::get_weather_icon_color(id(weather_forecast_condition)[8]));'
      - lvgl.label.update:
          id: lbl_forecast_day9_temps
          text: !lambda |-
            char buf[64];
            float high = id(weather_forecast_temp_high)[8];
            float low = id(weather_forecast_temp_low)[8];
            if (isnan(high) || isnan(low)) {
              return std::string("H:--° L:--°");
            }
            snprintf(buf, sizeof(buf), "#FF0000 H:%.0f°# #00DFFF L:%.0f°#", high, low);
            return std::string(buf);
      - lvgl.label.update:
          id: lbl_forecast_day9_precip_prob
          text: !lambda |-
            if (isnan(id(weather_forecast_precip_prob)[8])) return std::string("Rain: --%");
            char buf[32];
            snprintf(buf, sizeof(buf), "Chance: %.0f%%", id(weather_forecast_precip_prob)[8]);
            return std::string(buf);
      - lvgl.label.update:
          id: lbl_forecast_day9_condition
          text: !lambda |-
            if (id(weather_forecast_condition)[8].empty()) return std::string("---");
            // Format condition text to be more readable
            std::string condition = id(weather_forecast_condition)[8];
            if (condition == "clear-night") return std::string("Clear Night");
            if (condition == "cloudy") return std::string("Cloudy");
            if (condition == "exceptional") return std::string("Exceptional");
            if (condition == "fog") return std::string("Fog");
            if (condition == "hail") return std::string("Hail");
            if (condition == "lightning") return std::string("Lightning");
            if (condition == "lightning-rainy") return std::string("Lightning & Rain");
            if (condition == "partlycloudy") return std::string("Partly Cloudy");
            if (condition == "pouring") return std::string("Pouring");
            if (condition == "rainy") return std::string("Rainy");
            if (condition == "snowy") return std::string("Snowy");
            if (condition == "snowy-rainy") return std::string("Sleet");
            if (condition == "sunny") return std::string("Sunny");
            if (condition == "windy") return std::string("Windy");
            if (condition == "windy-variant") return std::string("Windy Windy");
            // Return capitalized version if not matched
            if (!condition.empty()) {
              condition[0] = toupper(condition[0]);
            }
            return condition;

      # Update Day 10
      - lvgl.label.update:
          id: lbl_forecast_day10_header
          text: !lambda |-
            if (id(weather_forecast_datetime)[9].empty()) return std::string("Day +10 (--/--)");
            std::string dt = id(weather_forecast_datetime)[9];
            if (dt.length() >= 10) {
              std::string month_str = dt.substr(5, 2);
              std::string day_str = dt.substr(8, 2);
              char buf[32];
              snprintf(buf, sizeof(buf), "Day +10 (%s/%s)", month_str.c_str(), day_str.c_str());
              return std::string(buf);
            }
            return std::string("Day +10 (--/--)");
      - lvgl.label.update:
          id: lbl_forecast_day10_icon
          text: !lambda 'return weather_helpers::get_weather_icon(id(weather_forecast_condition)[9]);'
          text_color: !lambda 'return lv_color_hex(weather_helpers::get_weather_icon_color(id(weather_forecast_condition)[9]));'
      - lvgl.label.update:
          id: lbl_forecast_day10_temps
          text: !lambda |-
            char buf[64];
            float high = id(weather_forecast_temp_high)[9];
            float low = id(weather_forecast_temp_low)[9];
            if (isnan(high) || isnan(low)) {
              return std::string("H:--° L:--°");
            }
            snprintf(buf, sizeof(buf), "#FF0000 H:%.0f°# #00DFFF L:%.0f°#", high, low);
            return std::string(buf);
      - lvgl.label.update:
          id: lbl_forecast_day10_precip_prob
          text: !lambda |-
            if (isnan(id(weather_forecast_precip_prob)[9])) return std::string("Rain: --%");
            char buf[32];
            snprintf(buf, sizeof(buf), "Chance: %.0f%%", id(weather_forecast_precip_prob)[9]);
            return std::string(buf);
      - lvgl.label.update:
          id: lbl_forecast_day10_condition
          text: !lambda |-
            if (id(weather_forecast_condition)[9].empty()) return std::string("---");
            // Format condition text to be more readable
            std::string condition = id(weather_forecast_condition)[9];
            if (condition == "clear-night") return std::string("Clear Night");
            if (condition == "cloudy") return std::string("Cloudy");
            if (condition == "exceptional") return std::string("Exceptional");
            if (condition == "fog") return std::string("Fog");
            if (condition == "hail") return std::string("Hail");
            if (condition == "lightning") return std::string("Lightning");
            if (condition == "lightning-rainy") return std::string("Lightning & Rain");
            if (condition == "partlycloudy") return std::string("Partly Cloudy");
            if (condition == "pouring") return std::string("Pouring");
            if (condition == "rainy") return std::string("Rainy");
            if (condition == "snowy") return std::string("Snowy");
            if (condition == "snowy-rainy") return std::string("Sleet");
            if (condition == "sunny") return std::string("Sunny");
            if (condition == "windy") return std::string("Windy");
            if (condition == "windy-variant") return std::string("Windy Windy");
            // Return capitalized version if not matched
            if (!condition.empty()) {
              condition[0] = toupper(condition[0]);
            }
            return condition;

      - logger.log: "✓ Daily forecast display updated (page 5)"
