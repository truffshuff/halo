# ============================================================================
# BLE WiFi Provisioning Capability
# ============================================================================
# NimBLE stack + Improv WiFi provisioning
# Dependencies:
#   - system/esphome_core.yaml (PSRAM needed for BLE)
#   - system/networking.yaml (provisions WiFi)
#
# This module configures:
#   - NimBLE Bluetooth stack
#   - Improv WiFi provisioning service
#   - Bluetooth proxy for Home Assistant
#   - Startup RGB LED blink animation
#
# Features:
#   - Complete GATT service with all 5 Improv characteristics
#   - BLE advertising as "Halo Improv" with Improv service UUID
#   - WiFi provisioning flow (receive credentials → connect → send IP)
#   - Auto-authorization on connection (no button press required)
#   - Device info response (firmware, version, hardware, name)
#   - State management and error handling
#
# Usage:
#   1. Open https://www.improv-wifi.com/ in Chrome browser
#   2. Click "Connect device via Improv"
#   3. Select "Halo Improv" from BLE devices
#   4. Enter WiFi credentials and provision
#
# Compatible with standard Improv protocol clients
# Protocol spec: https://www.improv-wifi.com/
#
# MEMORY IMPACT: ~40KB (BLE stack)
# ============================================================================

# Note: cycleCounter global remains in base/globals.yaml due to load order dependency
# It's used by both networking.yaml (WiFi events) and this BLE module (LED effects)
# Since networking.yaml loads before this module, cycleCounter cannot be moved here

# ============================================================================
# NimBLE Base Stack
# ============================================================================
# Base NimBLE stack - required before nimble_improv can be used
# Also defined in base/hardware.yaml (duplicate is intentional for Phase 1)
# ============================================================================
nimble_base:

# ============================================================================
# NimBLE Improv WiFi Provisioning
# ============================================================================
# Allows WiFi reconfiguration via BLE using the Improv protocol
# Uses ESP-IDF native NimBLE stack for compatibility with nimble_proxy
# ============================================================================
nimble_improv:
  authorized_duration: 2min  # How long authorization lasts
  wifi_timeout: 1min         # Timeout for WiFi connection attempts

# ============================================================================
# Bluetooth Proxy for Home Assistant
# ============================================================================
# Allows Home Assistant to use this device as a Bluetooth proxy
# NOTE: BLE advertisements are sent over the API connection in bursts
# TCP buffer optimizations in esphome_core.yaml help prevent buffer overflow
# ============================================================================
bluetooth_proxy:
  active: true

nimble_proxy:
  active: true
  max_connections: 3

# ============================================================================
# Startup Light Blink Animation
# ============================================================================
# Rainbow effect for 30 seconds on startup/WiFi disconnect
# ============================================================================

# Note: startup_light_blink switch is defined in Halo-v1-Core.yaml (legacy)
# It will be moved here in Phase 2 when Core is broken down.

# Note: RGB light component and startup blink intervals are defined in
# weather/weather-led-effects.yaml as they share the same RGB LED hardware.
# In Phase 2, these will be reorganized into the BLE module or a separate LED module.
