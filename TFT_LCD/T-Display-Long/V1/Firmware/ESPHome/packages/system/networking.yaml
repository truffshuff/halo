# ============================================================================
# Networking Configuration
# ============================================================================
# WiFi base configuration (without WireGuard)
# Dependencies: system/esphome_core.yaml
#
# This module configures:
#   - WiFi connection
#   - Captive portal (AP fallback)
#   - WiFi signal sensor
#
# CREDENTIALS: Stored in device YAML as substitutions or secrets.yaml
#   wifi_ssid: "YourNetworkName"
#   wifi_password: "YourNetworkPassword"
#
# SECURITY: WiFi credentials are stored in plaintext in compiled firmware
#           Use WPA2/WPA3 encryption on your access point
#           Consider using secrets file for sensitive deployments
# ============================================================================

# ============================================================================
# WiFi Configuration
# ============================================================================
wifi:
  ssid: ${wifi_ssid}
  password: ${wifi_password}

  # Reset startup light blink when WiFi disconnects
  # This allows the rainbow effect to restart when connection is lost
  on_disconnect:
    - lambda: |-
        id(cycleCounter) = 0;
        ESP_LOGI("wifi", "WiFi disconnected - resetting startup blink counter");

  # Ensure startup blink stops when WiFi reconnects
  on_connect:
    - lambda: |-
        if (id(cycleCounter) < 30) {
          id(cycleCounter) = 30;
          ESP_LOGI("wifi", "WiFi connected - stopping startup blink");
        }

# Note: Captive portal is defined in base/hardware.yaml (legacy)
# It will be moved here in Phase 2 when hardware.yaml is deprecated.

# Note: WiFi signal sensor and IP address sensor will be added
# in Phase 2 when they are extracted from the Core file.

# ============================================================================
# Startup Light Blink Animation
# ============================================================================
# Rainbow effect for 30 seconds when not connected to Home Assistant
# Uses cycleCounter global (from base/globals.yaml) and startup_light_blink switch (from diagnostics.yaml)
# Controlled by WiFi connection state and HA connection state
# ============================================================================
interval:
  # First interval: Turn on rainbow effect for first 30 seconds
  - interval: 1s
    then:
      - if:
          condition:
            - binary_sensor.is_off: ink_ha_connected
            - lambda: 'return id(cycleCounter) < 30;'
            - switch.is_on: startup_light_blink

          then:
            - light.turn_on:
                id: rgb_light
                effect: "Addressable Rainbow"
            - lambda: 'id(cycleCounter) += 1;'

  # Second interval: Turn off light after 30 seconds
  - interval: 1s
    then:
      - if:
          condition:
            - binary_sensor.is_off: ink_ha_connected
            - lambda: 'return id(cycleCounter) > 30;'
            - lambda: 'return id(cycleCounter) < 31;'
            - switch.is_on: startup_light_blink

          then:
            - light.turn_off:
                id: rgb_light
            - lambda: 'id(cycleCounter) += 1;'
