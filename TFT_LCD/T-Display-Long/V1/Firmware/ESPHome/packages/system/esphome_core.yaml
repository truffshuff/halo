# ============================================================================
# ESPHome Core Configuration
# ============================================================================
# Core ESP32 hardware and ESPHome configuration
# Dependencies: None
#
# This module configures:
#   - ESP32-S3 board, PSRAM, CPU frequency
#   - ESPHome framework configuration
#   - Memory management (PSRAM, stack sizes)
# ============================================================================

# Note: Logger is defined in base/esphome_base.yaml (legacy)
# It will be moved here in Phase 2 when esphome_base.yaml is deprecated.

# ============================================================================
# External Components
# ============================================================================
# Custom hardware drivers and BLE components
# MUST be defined early so other modules can use these components
# ============================================================================
external_components:
  - source: github://truffshuff/esphome-components@main
    components: [axs15231, sy6970, nimble_base, nimble_proxy, bluetooth_proxy, nimble_improv, weather_helpers]
    refresh: Always

# ============================================================================
# PSRAM Configuration
# ============================================================================
# ESP32-S3 has 8MB external PSRAM (Pseudo Static RAM) for expanded memory.
# This is critical for memory-intensive operations:
#   - BLE/Bluetooth operations
#   - LVGL graphics buffers
#   - 125+ weather sensor entities
#   - Large HTTP response buffering
#
# mode: octal - Uses 8 data lines for maximum bandwidth
# speed: 80MHz - Highest stable speed (120MHz can cause instability with BLE)
# ============================================================================
psram:
  mode: octal
  speed: 80MHz

# ============================================================================
# ESP32 Board Configuration
# ============================================================================
api:
  batch_delay: 200ms  # Reduce latency for real-time applications
  listen_backlog: 8  # Allow 2 pending connections in queue
  max_connections: 10  # Allow up to 6 simultaneous connections
  max_send_queue: 32  # Maximum queued messages per connection before disconnect
  encryption:
    key: !secret api_encryption_key

esp32:
  board: esp32-s3-devkitc-1
  flash_size: 16MB
  cpu_frequency: 240MHz  # Maximum performance

  framework:
    type: esp-idf
    # Use ESPHome-supported framework channels. Options: recommended (default), latest, dev
    # Switch to 'dev' to pick up the very latest ESP-IDF/NimBLE fixes sooner.
    version: recommended
    sdkconfig_options:
      # ============================================================================
      # Bluetooth Configuration - NimBLE Stack
      # ============================================================================
      # Enable NimBLE stack (completely disable Bluedroid)
      # Note: BLE components (nimble_improv, bluetooth_proxy) are in features/ble/
      CONFIG_BT_ENABLED: "y"
      CONFIG_BT_BLUEDROID_ENABLED: "n"
      CONFIG_BT_NIMBLE_ENABLED: "y"

      # Explicitly disable ALL Bluedroid sub-components to prevent compilation
      # This fixes "esp_bt_defs.h: No such file or directory" errors
      CONFIG_BT_BLE_ENABLED: "n"           # Bluedroid BLE (not NimBLE BLE)
      CONFIG_BT_CLASSIC_ENABLED: "n"       # Classic Bluetooth (BR/EDR)
      CONFIG_BT_SPP_ENABLED: "n"           # Serial Port Profile
      CONFIG_BT_HFP_ENABLE: "n"            # Hands-Free Profile
      CONFIG_BT_A2DP_ENABLE: "n"           # Advanced Audio Distribution Profile
      CONFIG_BT_BLUFI_ENABLE: "n"          # BluFi WiFi provisioning (causes esp_blufi_api.c errors)
      CONFIG_BT_GATTS_ENABLE: "n"          # GATT Server (Bluedroid)
      CONFIG_BT_GATTC_ENABLE: "n"          # GATT Client (Bluedroid)

      # NimBLE configuration (working with nimble_proxy)
      CONFIG_BT_NIMBLE_MAX_CONNECTIONS: "3"
      CONFIG_BT_NIMBLE_ROLE_CENTRAL: "y"
      CONFIG_BT_NIMBLE_ROLE_PERIPHERAL: "y"
      CONFIG_BT_NIMBLE_MEM_ALLOC_MODE_EXTERNAL: "y"  # Use PSRAM
      CONFIG_BT_NIMBLE_TASK_STACK_SIZE: "4096"  # Increased from default
      CONFIG_BT_RELEASE_IRAM_ON_SLEEP: "n"  # Keep BT memory accessible

      # Increase ATT MTU (browser commonly negotiates 185/247)
      CONFIG_BT_NIMBLE_ATT_PREFERRED_MTU: "247"
      # Allow more concurrent GATT procedures and prep entries
      CONFIG_BT_NIMBLE_GATT_MAX_PROCS: "16"
      CONFIG_BT_NIMBLE_GATT_PREP_WRITE_COUNT: "16"
      # More CCCDs (we have multiple notifies)
      CONFIG_BT_NIMBLE_MAX_CCCDS: "16"
      # Optional: extra NimBLE debug logging
      CONFIG_BT_NIMBLE_LOG_LEVEL: "DEBUG"

      # ============================================================================
      # Memory Management
      # ============================================================================
      # Memory management - allow heap allocation in PSRAM
      CONFIG_SPIRAM_USE_MALLOC: "y"  # Allow malloc() to use PSRAM
      CONFIG_SPIRAM_MALLOC_ALWAYSINTERNAL: "16384"  # Keep <16KB allocations in internal RAM

      # Stack size configuration - prevent stack overflow in LVGL updates
      # Default loop task stack is 8192 bytes, increase to handle deep call chains
      # CRITICAL: 64KB required for hourly forecast updates (240+ LVGL label updates in single script)
      # Even with PSRAM-allocated buffers, the deep call chain requires large stack
      CONFIG_ESP_MAIN_TASK_STACK_SIZE: "65536"  # Main task stack (8x from default 8192)
      CONFIG_ARDUINO_LOOP_STACK_SIZE: "65536"   # Arduino loop task stack (8x from 8192)

      # ============================================================================
      # Network Configuration
      # ============================================================================
      # TCP/IP Configuration for better API throughput
      # Increase buffers to handle BLE advertisement bursts during concurrent operations
      CONFIG_LWIP_TCP_SND_BUF_DEFAULT: "32768"  # TCP send buffer (increased to handle BLE bursts)
      CONFIG_LWIP_TCP_WND_DEFAULT: "32768"      # TCP receive window (increased for throughput)
      CONFIG_LWIP_TCP_RECVMBOX_SIZE: "16"       # TCP mailbox size (increased from 12)
      CONFIG_LWIP_TCPIP_RECVMBOX_SIZE: "128"    # TCPIP task mailbox (doubled to handle bursts)

      # Additional TCP optimizations for BLE proxy traffic
      CONFIG_LWIP_TCP_MSS: "1436"               # Maximum Segment Size (default: 1436)
      CONFIG_LWIP_TCP_OVERSIZE_MSS: "y"         # Allow TCP to send full MSS segments

      # Watchdog timeout for HTTP operations and JSON parsing
      # Increased from 20s to 30s to accommodate large weather JSON parsing
      # deserializeJson() can block for extended periods on complex data
      CONFIG_ESP_TASK_WDT_TIMEOUT_S: "30"
