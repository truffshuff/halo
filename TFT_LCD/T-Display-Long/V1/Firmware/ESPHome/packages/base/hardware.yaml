# ============================================================================
# Hardware Configuration - Display, Sensors, Interfaces
# ============================================================================
# Physical hardware drivers and bus configuration
# Dependencies: None
#
# This module configures:
#   - ESP32-S3 board and PSRAM
#   - SPI and I2C buses
#   - Display driver (AXS15231 AMOLED)
#   - Touchscreen driver
#   - External components
#   - Backlight output
#   - BLE/NimBLE stack
# ============================================================================

# ============================================================================
# PSRAM Configuration
# ============================================================================
# ESP32-S3 has 8MB external PSRAM (Pseudo Static RAM) for expanded memory.
# This is critical for memory-intensive operations:
#   - BLE/Bluetooth operations
#   - LVGL graphics buffers
#   - 125+ weather sensor entities
#   - Large HTTP response buffering
#
# mode: octal - Uses 8 data lines for maximum bandwidth
# speed: 80MHz - Highest stable speed (120MHz can cause instability with BLE)
# ============================================================================
psram:
  mode: octal
  speed: 80MHz

# ============================================================================
# ESP32 Board Configuration
# ============================================================================
esp32:
  board: esp32-s3-devkitc-1
  flash_size: 16MB
  cpu_frequency: 240MHz  # Maximum performance

  framework:
    type: esp-idf
    # Use ESPHome-supported framework channels. Options: recommended (default), latest, dev
    # Switch to 'dev' to pick up the very latest ESP-IDF/NimBLE fixes sooner.
    version: recommended
    sdkconfig_options:
      # Enable NimBLE stack (completely disable Bluedroid)
      CONFIG_BT_ENABLED: "y"
      CONFIG_BT_BLUEDROID_ENABLED: "n"
      CONFIG_BT_NIMBLE_ENABLED: "y"

      # Explicitly disable ALL Bluedroid sub-components to prevent compilation
      # This fixes "esp_bt_defs.h: No such file or directory" errors
      CONFIG_BT_BLE_ENABLED: "n"           # Bluedroid BLE (not NimBLE BLE)
      CONFIG_BT_CLASSIC_ENABLED: "n"       # Classic Bluetooth (BR/EDR)
      CONFIG_BT_SPP_ENABLED: "n"           # Serial Port Profile
      CONFIG_BT_HFP_ENABLE: "n"            # Hands-Free Profile
      CONFIG_BT_A2DP_ENABLE: "n"           # Advanced Audio Distribution Profile
      CONFIG_BT_BLUFI_ENABLE: "n"          # BluFi WiFi provisioning (causes esp_blufi_api.c errors)

      # NimBLE configuration (working with nimble_proxy)
      CONFIG_BT_NIMBLE_MAX_CONNECTIONS: "3"
      CONFIG_BT_NIMBLE_ROLE_CENTRAL: "y"
      CONFIG_BT_NIMBLE_ROLE_PERIPHERAL: "y"
      CONFIG_BT_NIMBLE_MEM_ALLOC_MODE_EXTERNAL: "y"  # Use PSRAM
      CONFIG_BT_NIMBLE_TASK_STACK_SIZE: "4096"  # Increased from default
      CONFIG_BT_RELEASE_IRAM_ON_SLEEP: "n"  # Keep BT memory accessible

      # Memory management - allow heap allocation in PSRAM
      CONFIG_SPIRAM_USE_MALLOC: "y"  # Allow malloc() to use PSRAM
      CONFIG_SPIRAM_MALLOC_ALWAYSINTERNAL: "16384"  # Keep <16KB allocations in internal RAM

      # Stack size configuration - prevent stack overflow in LVGL updates
      # Default loop task stack is 8192 bytes, increase to handle deep call chains
      # CRITICAL: 64KB required for hourly forecast updates (240+ LVGL label updates in single script)
      # Even with PSRAM-allocated buffers, the deep call chain requires large stack
      CONFIG_ESP_MAIN_TASK_STACK_SIZE: "65536"  # Main task stack (8x from default 8192)
      CONFIG_ARDUINO_LOOP_STACK_SIZE: "65536"   # Arduino loop task stack (8x from 8192)

      # TCP/IP Configuration for better API throughput
      # Increase buffers to handle BLE advertisement bursts during concurrent operations
      CONFIG_LWIP_TCP_SND_BUF_DEFAULT: "16384"  # TCP send buffer (default: 5744)
      CONFIG_LWIP_TCP_WND_DEFAULT: "16384"      # TCP receive window (default: 5744)
      CONFIG_LWIP_TCP_RECVMBOX_SIZE: "12"       # TCP mailbox size (default: 6)
      CONFIG_LWIP_TCPIP_RECVMBOX_SIZE: "64"     # TCPIP task mailbox (default: 32)

      # Watchdog timeout for HTTP operations and JSON parsing
      # Increased from 20s to 30s to accommodate large weather JSON parsing
      # deserializeJson() can block for extended periods on complex data
      CONFIG_ESP_TASK_WDT_TIMEOUT_S: "30"

      # Increase ATT MTU (browser commonly negotiates 185/247)
      CONFIG_BT_NIMBLE_ATT_PREFERRED_MTU: "247"
      # Allow more concurrent GATT procedures and prep entries
      CONFIG_BT_NIMBLE_GATT_MAX_PROCS: "16"
      CONFIG_BT_NIMBLE_GATT_PREP_WRITE_COUNT: "16"
      # More CCCDs (we have multiple notifies)
      CONFIG_BT_NIMBLE_MAX_CCCDS: "16"
      # Optional: extra NimBLE debug logging
      CONFIG_BT_NIMBLE_LOG_LEVEL: "DEBUG"

# ============================================================================
# External Components
# ============================================================================
# Custom hardware drivers and BLE components
# ============================================================================
external_components:
  - source: github://truffshuff/esphome-components@main
    components: [axs15231, sy6970, nimble_base, nimble_proxy, bluetooth_proxy, nimble_improv, weather_helpers]
    # Pin refresh to a reasonable interval to avoid excessive repo checks during editor validation
    refresh: Always

# ============================================================================
# SPI Bus Configuration
# ============================================================================
# Quad SPI for high-speed display communication
# ============================================================================
spi:
  id: lily_spi
  type: quad
  clk_pin: 17
  data_pins:
    - 13
    - 18
    - 21
    - 14

# ============================================================================
# I2C Bus Configuration
# ============================================================================
# Two I2C buses for sensors and touchscreen
# ============================================================================
i2c:
  - sda: 9
    scl: 48
    id: lily_i2c
  - sda: 15
    scl: 10
    id: touch_i2c
    frequency: 400kHz

# ============================================================================
# Display Output (Backlight)
# ============================================================================
# LEDC PWM for display backlight control
# ============================================================================
output:
  - platform: ledc
    pin: 1
    id: backlight
    frequency: 100Hz  # Datasheet suggests low-frequency PWM. Should prevent stability issues.

# ============================================================================
# Display Driver - AXS15231 AMOLED
# ============================================================================
# LilyGo T-Display-Long AMOLED display (180x640 pixels)
# ============================================================================
display:
  - platform: qspi_dbi
    id: lily_display
    model: AXS15231
    data_rate: 5MHz
    spi_id: lily_spi
    dimensions:
      height: 640
      width: 180
    cs_pin: 12
    reset_pin: 16
    rotation: 0
    auto_clear_enabled: false

# ============================================================================
# Touchscreen Driver - AXS15231
# ============================================================================
# Touchscreen configuration optimized for responsiveness:
# - Fast 50ms polling for immediate touch detection
# - Interrupt pin for hardware-triggered events
# - Coordinate validation to reject invalid touches
# - Auto-rotation reset on touch for better UX
# ============================================================================
touchscreen:
  - platform: axs15231
    id: lily_touch
    display: lily_display
    i2c_id: touch_i2c
    interrupt_pin: GPIO11
    update_interval: never  # Fast polling for responsive touch detection (was: never)
    transform:
      mirror_x: false
      mirror_y: false
      swap_xy: false
    on_touch:
      - lambda: |-
          // Validate touch coordinates - filter out spurious/phantom touches
          if (touch.x < 0 || touch.x > 180 || touch.y < 0 || touch.y > 640) {
            ESP_LOGW("touch", "Invalid touch coordinates: x=%d, y=%d - ignoring", touch.x, touch.y);
            return;
          }
          ESP_LOGI("touch", "Touch at x=%d, y=%d", touch.x, touch.y);

          // Reset auto-rotation timer on any valid touch to prevent interruption during manual navigation
          id(last_auto_rotation_time) = millis();
          ESP_LOGD("touch", "Auto-rotation timer reset");

# ============================================================================
# NimBLE Base & Weather Helpers
# ============================================================================
# Base NimBLE stack and weather formatting helper library
# ============================================================================
nimble_base:

weather_helpers:

# ============================================================================
# NimBLE Improv WiFi Provisioning - FULLY IMPLEMENTED
# ============================================================================
# Allows WiFi reconfiguration via BLE using the Improv protocol
# Uses ESP-IDF native NimBLE stack for compatibility with nimble_proxy
#
# Features:
#   - Complete GATT service with all 5 Improv characteristics
#   - BLE advertising as "Halo Improv" with Improv service UUID
#   - WiFi provisioning flow (receive credentials → connect → send IP)
#   - Auto-authorization on connection (no button press required)
#   - Device info response (firmware, version, hardware, name)
#   - State management and error handling
#
# Usage:
#   1. Open https://www.improv-wifi.com/ in Chrome browser
#   2. Click "Connect device via Improv"
#   3. Select "Halo Improv" from BLE devices
#   4. Enter WiFi credentials and provision
#
# Compatible with standard Improv protocol clients
# Protocol spec: https://www.improv-wifi.com/
# ============================================================================
nimble_improv:
  authorized_duration: 2min  # How long authorization lasts
  wifi_timeout: 1min         # Timeout for WiFi connection attempts

# ============================================================================
# Captive Portal
# ============================================================================
# Fallback WiFi configuration portal
# ============================================================================
captive_portal:

# ============================================================================
# Bluetooth Proxy
# ============================================================================
# Allows Home Assistant to use this device as a Bluetooth proxy
# ============================================================================
bluetooth_proxy:

nimble_proxy:
