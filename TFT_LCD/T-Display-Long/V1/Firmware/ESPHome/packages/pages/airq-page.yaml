# ============================================================================
# Air Quality Page Module
# ============================================================================
# Comprehensive air quality monitoring display
#
# Dependencies:
#   - base/globals.yaml (current_page_name, time_update_last_text, airq_wifi_stat_connected_state, etc.)
#   - base/sensors.yaml (co2, no2, co, h2, ch4, ethanol, nh3, pm sensors, computed_halo_aqi, etc.)
#   - Hardware: Display, touchscreen, various gas and particulate sensors
#   - Scripts: page_transition_cleanup, time_update (in Core)
#
# Features:
#   - Header with logo, time, and WiFi status
#   - Color-coded AQI banner (visual alert)
#   - Temperature display
#   - CO2 monitoring with color-coded values
#   - Particulate matter (PM1.0, PM2.5, PM4.0, PM10)
#   - VOC (Volatile Organic Compounds) index
#   - Gas monitoring (CO, Ethanol, H2, NO2, NH3, CH4)
#   - Relative humidity
#   - Navigation touch button
#   - Auto-updates sensor values on page load
# ============================================================================

# ============================================================================
# LVGL Pages - Air Quality Display
# ============================================================================
lvgl:
  pages:
    # ------------------------------------------------------------------------
    # Air Quality Page
    # ------------------------------------------------------------------------
    # Comprehensive sensor monitoring dashboard
    # Shows all air quality metrics with color-coded values
    # Updates immediately on page load with latest sensor readings
    # ------------------------------------------------------------------------
    - id: AirQ_page
      bg_color: my_black
      scrollbar_mode: "OFF"
      on_load:
        - script.execute: page_transition_cleanup
        - lambda: |-
            id(current_page_name) = "airq";
            id(time_update_last_text).clear();
        - script.execute: time_update
        # Immediately update WiFi indicator when page loads
        - if:
            condition:
              wifi.connected:
            then:
              - lvgl.widget.update:
                  id: wifi_stat
                  text_color: my_green
              - lambda: 'id(airq_wifi_stat_connected_state) = true;'
            else:
              - lvgl.widget.update:
                  id: wifi_stat
                  text_color: my_red
              - lambda: 'id(airq_wifi_stat_connected_state) = false;'
        # Force immediate update of all sensor values on page load
        # DISABLED - CO2 sensor disabled due to I2C errors
        - if:
            condition:
              lambda: 'return id(co2).has_state();'
            then:
              - lvgl.label.update:
                  id: co2_value
                  text: !lambda |-
                    static char buffer[10];
                    snprintf(buffer, sizeof(buffer), "%d", (int)id(co2).state);
                    return buffer;
              - lvgl.label.update:
                  id: co2_value
                  text_color: !lambda |-
                    float co2_val = id(co2).state;
                    if (co2_val <= 600) return id(my_green);
                    else if (co2_val <= 1000) return id(my_yellow);
                    else if (co2_val <= 1500) return id(my_orange);
                    else return id(my_red);
        - if:
            condition:
              lambda: 'return id(no2).has_state();'
            then:
              - lvgl.label.update:
                  id: no2_value
                  text: !lambda |-
                    static char buffer[10];
                    snprintf(buffer, sizeof(buffer), "%.02f", id(no2).state);
                    return buffer;
              - lvgl.label.update:
                  id: no2_value
                  text_color: !lambda |-
                    float no2_val = id(no2).state;
                    if (no2_val <= 0.03) return id(my_green);
                    else if (no2_val <= 0.06) return id(my_yellow);
                    else if (no2_val <= 0.1) return id(my_orange);
                    else return id(my_red);
        - if:
            condition:
              lambda: 'return id(co).has_state();'
            then:
              - lvgl.label.update:
                  id: co_value
                  text: !lambda |-
                    static char buffer[10];
                    snprintf(buffer, sizeof(buffer), "%.02f", id(co).state);
                    return buffer;
              - lvgl.label.update:
                  id: co_value
                  text_color: !lambda |-
                    float co_val = id(co).state;
                    if (co_val <= 15) return id(my_green);
                    else if (co_val <= 30) return id(my_yellow);
                    else if (co_val <= 36) return id(my_orange);
                    else return id(my_red);
        - if:
            condition:
              lambda: 'return id(h2).has_state();'
            then:
              - lvgl.label.update:
                  id: h2_value
                  text: !lambda |-
                    static char buffer[10];
                    snprintf(buffer, sizeof(buffer), "%.02f", id(h2).state);
                    return buffer;
              - lvgl.label.update:
                  id: h2_value
                  text_color: !lambda |-
                    float h2_val = id(h2).state;
                    if (h2_val <= 0.4) return id(my_green);
                    else if (h2_val <= 1.0) return id(my_yellow);
                    else if (h2_val <= 2.0) return id(my_orange);
                    else return id(my_red);
        - if:
            condition:
              lambda: 'return id(ch4).has_state();'
            then:
              - lvgl.label.update:
                  id: ch4_value
                  text: !lambda |-
                    static char buffer[10];
                    snprintf(buffer, sizeof(buffer), "%.02f", id(ch4).state);
                    return buffer;
              - lvgl.label.update:
                  id: ch4_value
                  text_color: !lambda |-
                    float ch4_val = id(ch4).state;
                    if (ch4_val <= 2.0) return id(my_green);
                    else if (ch4_val <= 10.0) return id(my_yellow);
                    else return id(my_red);
        - if:
            condition:
              lambda: 'return id(ethanol).has_state();'
            then:
              - lvgl.label.update:
                  id: ethanol_value
                  text: !lambda |-
                    static char buffer[10];
                    snprintf(buffer, sizeof(buffer), "%.02f", id(ethanol).state);
                    return buffer;
              - lvgl.label.update:
                  id: ethanol_value
                  text_color: !lambda |-
                    float ethanol_val = id(ethanol).state;
                    if (ethanol_val <= 0.5) return id(my_green);
                    else if (ethanol_val <= 1.5) return id(my_yellow);
                    else if (ethanol_val <= 3.0) return id(my_orange);
                    else return id(my_red);
        - if:
            condition:
              lambda: 'return id(nh3).has_state();'
            then:
              - lvgl.label.update:
                  id: nh3_value
                  text: !lambda |-
                    static char buffer[10];
                    snprintf(buffer, sizeof(buffer), "%.02f", id(nh3).state);
                    return buffer;
              - lvgl.label.update:
                  id: nh3_value
                  text_color: !lambda |-
                    float nh3_val = id(nh3).state;
                    if (nh3_val <= 0.5) return id(my_green);
                    else if (nh3_val <= 1.0) return id(my_yellow);
                    else if (nh3_val <= 2.0) return id(my_orange);
                    else return id(my_red);
        - if:
            condition:
              lambda: 'return id(pm_1_0).has_state();'
            then:
              - lvgl.label.update:
                  id: pm1_value
                  text: !lambda |-
                    static char buffer[10];
                    snprintf(buffer, sizeof(buffer), "%.01f", id(pm_1_0).state);
                    return buffer;
        - if:
            condition:
              lambda: 'return id(pm_2_5).has_state();'
            then:
              - lvgl.label.update:
                  id: pm25_value
                  text: !lambda |-
                    static char buffer[10];
                    snprintf(buffer, sizeof(buffer), "%.01f", id(pm_2_5).state);
                    return buffer;
        - if:
            condition:
              lambda: 'return id(pm_4_0).has_state();'
            then:
              - lvgl.label.update:
                  id: pm4_value
                  text: !lambda |-
                    static char buffer[10];
                    snprintf(buffer, sizeof(buffer), "%.01f", id(pm_4_0).state);
                    return buffer;
        - if:
            condition:
              lambda: 'return id(pm_10_0).has_state();'
            then:
              - lvgl.label.update:
                  id: pm10_value
                  text: !lambda |-
                    static char buffer[10];
                    snprintf(buffer, sizeof(buffer), "%.01f", id(pm_10_0).state);
                    return buffer;
        - if:
            condition:
              lambda: 'return id(computed_halo_aqi).has_state();'
            then:
              - lvgl.label.update:
                  id: aqi_value
                  text: !lambda |-
                    static char buffer[10];
                    snprintf(buffer, sizeof(buffer), "%d", (int)id(computed_halo_aqi).state);
                    return buffer;
              - lvgl.widget.update:
                  id: aqi_widget
                  bg_color: !lambda |-
                    float aqi = id(computed_halo_aqi).state;
                    if (aqi <= 50) return id(my_green);
                    else if (aqi <= 100) return id(my_yellow);
                    else if (aqi <= 150) return id(my_orange);
                    else if (aqi <= 200) return id(my_red);
                    // For purple (300) and maroon (>300), use hex since they're not defined
                    else if (aqi <= 300) return lv_color_hex(0x800080);
                    else return lv_color_hex(0x800000);
        - logger.log: "Forced sensor UI update on AirQ page load"
      widgets:
        # Header: Logo, Time, WiFi Status
        - image:
            id: ym_image
            src: ym_logo
            align: CENTER
            x: 80
            y: -309
        - label:
            id: timeVal
            align: LEFT_MID
            text_font: montserrat_18
            text_color: my_white
            x: 2
            y: -309
            text: "00:00AM"
        - label:
            id: wifi_stat
            align: CENTER
            text_font: montserrat_18
            text_color: my_gray
            x: 42
            y: -309
            text: "\uF1EB"

        # AQI Widget (Color-coded banner)
        - obj:
            id: aqi_widget
            x: 0
            y: 24
            width: 180
            height: 42
            bg_color: 0x76fa76
            border_width: 0
        - label:
            id: aqi_label
            align: LEFT_MID
            text_font: montserrat_28
            text_color: my_black
            long_mode: WRAP
            x: 2
            y: -275
            text: "AQI:"
        - label:
            id: aqi_value
            align: LEFT_MID
            text_font: montserrat_28
            text_color: my_black
            long_mode: WRAP
            x: 90
            y: -275
            text: "000"

        # Temperature Section
        - label:
            id: temperature_label
            align: LEFT_MID
            text_font: montserrat_14
            text_color: my_white
            long_mode: WRAP
            x: 2
            y: -246
            text: "TEMP:"
        - label:
            id: temperature_value
            align: CENTER
            text_font: montserrat_28
            text_color: my_white
            long_mode: WRAP
            x: 0
            y: -234
            text: "000.0"
        - label:
            id: temperature_units
            align: RIGHT_MID
            text_font: montserrat_14
            text_color: my_white
            long_mode: WRAP
            x: -8
            y: -234
            text: "\u00B0F"
        - line:
            points:
              - 0, 106
              - 180, 106
            line_width: 1
            line_color: 0x00dfff

        # CO2 Section
        - label:
            id: co2_label
            align: LEFT_MID
            text_font: montserrat_14
            text_color: my_white
            long_mode: WRAP
            x: 2
            y: -205
            text: "CO2:"
        - label:
            id: co2_value
            align: CENTER
            text_font: montserrat_28
            text_color: my_white
            long_mode: WRAP
            x: 0
            y: -193
            text: "0000"
        - label:
            id: co2_units
            align: RIGHT_MID
            text_font: montserrat_14
            text_color: my_white
            long_mode: WRAP
            x: -2
            y: -193
            text: "PPM"
        - line:
            points:
              - 0, 147
              - 180, 147
            line_width: 1
            line_color: 0x00dfff

        # PM1.0 Section
        - label:
            id: pm1_label
            align: LEFT_MID
            text_font: montserrat_14
            text_color: my_white
            long_mode: WRAP
            x: 2
            y: -164
            text: "PM1:"
        - label:
            id: pm1_value
            align: RIGHT_MID
            text_font: montserrat_28
            text_color: my_white
            long_mode: WRAP
            x: -51
            y: -152
            text: "000.0"
        - label:
            id: pm1_units
            align: RIGHT_MID
            text_font: montserrat_14
            text_color: my_white
            long_mode: WRAP
            x: -2
            y: -152
            text: "ug/m3"
        - line:
            points:
              - 0, 188
              - 180, 188
            line_width: 1
            line_color: 0x00dfff

        # PM2.5 Section
        - label:
            id: pm25_label
            align: LEFT_MID
            text_font: montserrat_14
            text_color: my_white
            long_mode: WRAP
            x: 2
            y: -123
            text: "PM2.5:"
        - label:
            id: pm25_value
            align: RIGHT_MID
            text_font: montserrat_28
            text_color: my_white
            long_mode: WRAP
            x: -51
            y: -111
            text: "000.0"
        - label:
            id: pm25_units
            align: RIGHT_MID
            text_font: montserrat_14
            text_color: my_white
            long_mode: WRAP
            x: -2
            y: -111
            text: "ug/m3"
        - line:
            points:
              - 0, 229
              - 180, 229
            line_width: 1
            line_color: 0x00dfff

        # PM4.0 Section
        - label:
            id: pm4_label
            align: LEFT_MID
            text_font: montserrat_14
            text_color: my_white
            long_mode: WRAP
            x: 2
            y: -82
            text: "PM4:"
        - label:
            id: pm4_value
            align: RIGHT_MID
            text_font: montserrat_28
            text_color: my_white
            long_mode: WRAP
            x: -51
            y: -70
            text: "000.0"
        - label:
            id: pm4_units
            align: RIGHT_MID
            text_font: montserrat_14
            text_color: my_white
            long_mode: WRAP
            x: -2
            y: -70
            text: "ug/m3"
        - line:
            points:
              - 0, 270
              - 180, 270
            line_width: 1
            line_color: 0x00dfff

        # PM10 Section
        - label:
            id: pm10_label
            align: LEFT_MID
            text_font: montserrat_14
            text_color: my_white
            long_mode: WRAP
            x: 2
            y: -41
            text: "PM10:"
        - label:
            id: pm10_value
            align: RIGHT_MID
            text_font: montserrat_28
            text_color: my_white
            long_mode: WRAP
            x: -51
            y: -29
            text: "000.0"
        - label:
            id: pm10_units
            align: RIGHT_MID
            text_font: montserrat_14
            text_color: my_white
            long_mode: WRAP
            x: -2
            y: -29
            text: "ug/m3"
        - line:
            points:
              - 0, 311
              - 180, 311
            line_width: 1
            line_color: 0x00dfff

        # VOC Section
        - label:
            id: voc_label
            align: LEFT_MID
            text_font: montserrat_14
            text_color: my_white
            long_mode: WRAP
            x: 2
            y: 0
            text: "VOC:"
        - label:
            id: voc_value
            align: RIGHT_MID
            text_font: montserrat_28
            text_color: my_white
            long_mode: WRAP
            x: -51
            y: 12
            text: "000.0"
        - label:
            id: voc_units
            align: RIGHT_MID
            text_font: montserrat_14
            text_color: my_white
            long_mode: WRAP
            x: -2
            y: 12
            text: "IDX"
        - line:
            points:
              - 0, 352
              - 180, 352
            line_width: 1
            line_color: 0x00dfff

        # CO Section
        - label:
            id: co_label
            align: LEFT_MID
            text_font: montserrat_14
            text_color: my_white
            long_mode: WRAP
            x: 2
            y: 41
            text: "CO:"
        - label:
            id: co_value
            align: RIGHT_MID
            text_font: montserrat_28
            text_color: my_white
            long_mode: WRAP
            x: -51
            y: 53
            text: "000.0"
        - label:
            id: co_units
            align: RIGHT_MID
            text_font: montserrat_14
            text_color: my_white
            long_mode: WRAP
            x: -2
            y: 53
            text: "PPM"
        - line:
            points:
              - 0, 393
              - 180, 393
            line_width: 1
            line_color: 0x00dfff

        # Ethanol Section
        - label:
            id: ethanol_label
            align: LEFT_MID
            text_font: montserrat_14
            text_color: my_white
            long_mode: SCROLL
            width: 40
            x: 2
            y: 82
            text: "C2H5OH:"
        - label:
            id: ethanol_value
            align: RIGHT_MID
            text_font: montserrat_28
            text_color: my_white
            long_mode: WRAP
            x: -51
            y: 94
            text: "000.0"
        - label:
            id: ethanol_units
            align: RIGHT_MID
            text_font: montserrat_14
            text_color: my_white
            long_mode: WRAP
            x: -2
            y: 94
            text: "PPM"
        - line:
            points:
              - 0, 434
              - 180, 434
            line_width: 1
            line_color: 0x00dfff

        # Hydrogen Section
        - label:
            id: h2_label
            align: LEFT_MID
            text_font: montserrat_14
            text_color: my_white
            long_mode: WRAP
            x: 2
            y: 124
            text: "H2:"
        - label:
            id: h2_value
            align: RIGHT_MID
            text_font: montserrat_28
            text_color: my_white
            long_mode: WRAP
            x: -51
            y: 135
            text: "000.0"
        - label:
            id: h2_units
            align: RIGHT_MID
            text_font: montserrat_14
            text_color: my_white
            long_mode: WRAP
            x: -2
            y: 135
            text: "PPM"
        - line:
            points:
              - 0, 475
              - 180, 475
            line_width: 1
            line_color: 0x00dfff

        # NO2 Section
        - label:
            id: no2_label
            align: LEFT_MID
            text_font: montserrat_14
            text_color: my_white
            long_mode: WRAP
            x: 2
            y: 165
            text: "NO2:"
        - label:
            id: no2_value
            align: RIGHT_MID
            text_font: montserrat_28
            text_color: my_white
            long_mode: WRAP
            x: -51
            y: 176
            text: "000.0"
        - label:
            id: no2_units
            align: RIGHT_MID
            text_font: montserrat_14
            text_color: my_white
            long_mode: WRAP
            x: -2
            y: 176
            text: "PPM"
        - line:
            points:
              - 0, 516
              - 180, 516
            line_width: 1
            line_color: 0x00dfff

        # NH3 Section
        - label:
            id: nh3_label
            align: LEFT_MID
            text_font: montserrat_14
            text_color: my_white
            long_mode: WRAP
            x: 2
            y: 206
            text: "NH3:"
        - label:
            id: nh3_value
            align: RIGHT_MID
            text_font: montserrat_28
            text_color: my_white
            long_mode: WRAP
            x: -51
            y: 217
            text: "000.0"
        - label:
            id: nh3_units
            align: RIGHT_MID
            text_font: montserrat_14
            text_color: my_white
            long_mode: WRAP
            x: -2
            y: 217
            text: "PPM"
        - line:
            points:
              - 0, 557
              - 180, 557
            line_width: 1
            line_color: 0x00dfff

        # CH4 Section
        - label:
            id: ch4_label
            align: LEFT_MID
            text_font: montserrat_14
            text_color: my_white
            long_mode: WRAP
            x: 2
            y: 247
            text: "CH4:"
        - label:
            id: ch4_value
            align: RIGHT_MID
            text_font: montserrat_28
            text_color: my_white
            long_mode: WRAP
            x: -51
            y: 258
            text: "000.0"
        - label:
            id: ch4_units
            align: RIGHT_MID
            text_font: montserrat_14
            text_color: my_white
            long_mode: WRAP
            x: -2
            y: 258
            text: "PPM"
        - line:
            points:
              - 0, 598
              - 180, 598
            line_width: 1
            line_color: 0x00dfff

        # RH (Relative Humidity) Section
        - label:
            id: rh_label
            align: LEFT_MID
            text_font: montserrat_14
            text_color: my_white
            long_mode: WRAP
            x: 2
            y: 287
            text: "RH:"
        - label:
            id: rh_value
            align: RIGHT_MID
            text_font: montserrat_28
            text_color: my_white
            long_mode: WRAP
            x: -51
            y: 299
            text: "000.0"
        - label:
            id: rh_units
            align: RIGHT_MID
            text_font: montserrat_14
            text_color: my_white
            long_mode: WRAP
            x: -2
            y: 299
            text: "%"

        # Navigation Button (top-right corner touch area)
        - obj:
            id: nav_button_AirQ
            align: TOP_RIGHT
            x: 0
            y: 0
            width: 180
            height: 150
            bg_opa: 0
            border_width: 0
            clickable: true
            on_release:
              - logger.log: "AirQ page nav button RELEASED!"
              - lambda: |-
                  ESP_LOGI("touch", "Navigation button touched");
                  id(last_auto_rotation_time) = millis();
                  ESP_LOGD("touch", "Auto-rotation timer reset");
              - lvgl.page.next:
                  animation: OUT_LEFT
                  time: 300ms
