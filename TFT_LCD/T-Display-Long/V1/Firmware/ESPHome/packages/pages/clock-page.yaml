# ============================================================================
# Clock Page Module
# ============================================================================
# Vertical clock display with large time and date
#
# Dependencies:
#   - base/globals.yaml (time_update_last_text, colon_blink_state, current_page_name, etc.)
#   - Hardware: Display, touchscreen, time sources (sntp_time, ha_time)
#   - Switches: time_format, wireguard_enabled
#   - Scripts: page_transition_cleanup (from base)
#
# Features:
#   - Large vertical time display (hours, colon, minutes)
#   - Blinking colon animation
#   - AM/PM indicator (12-hour) or 24-hour format
#   - Current date display
#   - Day of week display
#   - Navigation touch button
# ============================================================================

script:
  # --------------------------------------------------------------------------
  # update_colon_widget
  # --------------------------------------------------------------------------
  # Handles the blinking colon animation for the clock display
  # Uses global colon_blink_state to toggle visibility
  # --------------------------------------------------------------------------
  - id: update_colon_widget
    mode: restart
    then:
      - if:
          condition:
            lambda: 'return id(colon_blink_state);'
          then:
            - lvgl.label.update:
                id: vclock_colon
                text: ":"
          else:
            - lvgl.label.update:
                id: vclock_colon
                text: " "

  # --------------------------------------------------------------------------
  # time_update
  # --------------------------------------------------------------------------
  # Updates time displays across all pages
  # Handles both 12-hour and 24-hour formats
  # Updates only when time changes (dirty flag optimization)
  # --------------------------------------------------------------------------
  - id: time_update
    mode: restart
    then:
      - lambda: |-
          id(time_update_last_started) = millis();
          id(time_update_needs_render) = false;
      - lambda: |-
          auto now = id(wireguard_enabled).state ? id(sntp_time).now() : id(ha_time).now();
          if (!now.is_valid()) {
            ESP_LOGW("time_update", "Time source unavailable, skipping label update");
            return;
          }
          bool is_pm = now.hour >= 12;
          int hour_12 = now.hour % 12;
          if (hour_12 == 0) {
            hour_12 = 12;
          }
          char time_buf[17];
          if (id(time_format).state) {
            snprintf(time_buf, sizeof(time_buf), "%02d:%02d", now.hour, now.minute);
          } else {
            snprintf(time_buf, sizeof(time_buf), "%2d:%02d%s", hour_12, now.minute, is_pm ? "PM" : "AM");
          }
          std::string new_text(time_buf);
          if (new_text != id(time_update_last_text)) {
            id(time_update_last_text) = new_text;
            id(time_update_needs_render) = true;
          }
      # Update Air Quality page time display
      - if:
          condition:
            lambda: 'return id(time_update_needs_render) && id(current_page_name) == "airq";'
          then:
            - lvgl.label.update:
                id: timeVal
                text: !lambda 'return id(time_update_last_text);'
      # Update Vertical Clock page
      - if:
          condition:
            lambda: 'return id(time_update_needs_render) && id(current_page_name) == "vertical_clock";'
          then:
            - lvgl.label.update:
                id: vclock_hours
                text: !lambda |-
                  auto now = id(wireguard_enabled).state ? id(sntp_time).now() : id(ha_time).now();
                  if (!now.is_valid()) return std::string("--");
                  bool is_pm = now.hour >= 12;
                  int hour_12 = now.hour % 12;
                  if (hour_12 == 0) hour_12 = 12;
                  char buf[3];
                  if (id(time_format).state) {
                    snprintf(buf, sizeof(buf), "%02d", now.hour);
                  } else {
                    snprintf(buf, sizeof(buf), "%2d", hour_12);
                  }
                  return std::string(buf);
            - lvgl.label.update:
                id: vclock_minutes
                text: !lambda |-
                  auto now = id(wireguard_enabled).state ? id(sntp_time).now() : id(ha_time).now();
                  if (!now.is_valid()) return std::string("--");
                  char buf[3];
                  snprintf(buf, sizeof(buf), "%02d", now.minute);
                  return std::string(buf);
            - lvgl.label.update:
                id: vclock_ampm
                text: !lambda |-
                  auto now = id(wireguard_enabled).state ? id(sntp_time).now() : id(ha_time).now();
                  if (!now.is_valid()) return std::string("");
                  if (id(time_format).state) return std::string("");
                  bool is_pm = now.hour >= 12;
                  return std::string(is_pm ? "PM" : "AM");
            - lvgl.label.update:
                id: vclock_date
                text: !lambda |-
                  auto now = id(wireguard_enabled).state ? id(sntp_time).now() : id(ha_time).now();
                  if (!now.is_valid()) return std::string("--");
                  static const char* months[] = {"Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"};
                  char buf[20];
                  snprintf(buf, sizeof(buf), "%s %d", months[now.month - 1], now.day_of_month);
                  return std::string(buf);
            - lvgl.label.update:
                id: vclock_day_top
                text: !lambda |-
                  auto now = id(wireguard_enabled).state ? id(sntp_time).now() : id(ha_time).now();
                  if (!now.is_valid()) return std::string("--");
                  static const char* days[] = {"Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"};
                  return std::string(days[now.day_of_week - 1]);
      - script.execute: update_colon_widget
      - lambda: |-
          const uint32_t now = millis();
          const uint32_t elapsed = now - id(time_update_last_started);
          id(time_update_last_duration) = elapsed;
          // Removed publish_state to prevent TCP buffer overflow - store in global instead
          // id(time_update_duration_sensor).publish_state(elapsed);
          const bool rendered = id(time_update_needs_render);

          // Update watchdog timer ONLY if we actually rendered something
          if (rendered) {
            id(last_display_update_time) = now;
            ESP_LOGV("time_update", "Display watchdog updated (rendered)");
          }

          ESP_LOGV("time_update", "Execution: %ums, rendered=%s, on_page=%s",
                   elapsed,
                   rendered ? "yes" : "no",
                   id(current_page_name).c_str());

# ============================================================================
# Display Configuration - Clock Page
# ============================================================================
# This merges into the existing display component defined in hardware.yaml
# ============================================================================
display:
  - id: lily_display
    pages:
      # ------------------------------------------------------------------------
      # Vertical Clock Page
      # ------------------------------------------------------------------------
      # Large vertical time display with blinking colon
      # Shows: Hours | Colon | Minutes | AM/PM | Date | Day
      # Auto-updates every second via time_update script
      # ------------------------------------------------------------------------
      - id: vertical_clock_page
        bg_color: 0x000000
        bg_opa: COVER
        scrollbar_mode: "OFF"
        on_load:
          - script.execute: page_transition_cleanup
          - lambda: |-
              id(current_page_name) = "vertical_clock";
              id(time_update_last_text).clear();
              id(colon_blink_state) = true;  // Ensure colon is visible when page loads
          - script.execute: time_update
          - script.execute: update_colon_widget
        widgets:
          # Large time display vertically centered
          - label:
              id: vclock_hours
              align: CENTER
              text_font: montserrat_80
              text_color: my_white
              x: 0
              y: -120
              text: "12"

          - label:
              id: vclock_colon
              align: CENTER
              text_font: montserrat_80
              text_color: my_white
              x: 0
              y: -20
              text: ":"

          - label:
              id: vclock_minutes
              align: CENTER
              text_font: montserrat_80
              text_color: my_white
              x: 0
              y: 80
              text: "00"

          - label:
              id: vclock_ampm
              align: CENTER
              text_font: montserrat_50
              text_color: my_white
              x: 0
              y: 180
              text: "AM"

          # Date below time
          - label:
              id: vclock_date
              align: CENTER
              text_font: montserrat_24
              text_color: my_gray
              x: 0
              y: 250
              text: "Mon, Jan 1"

          # Day of week at top
          - label:
              id: vclock_day_top
              align: TOP_MID
              text_font: montserrat_24
              text_color: my_gray
              x: 0
              y: 20
              text: "Monday"

          # Navigation button (top right corner)
          - obj:
              id: nav_button_vclock
              align: TOP_RIGHT
              x: 0
              y: 0
              width: 180
              height: 150
              bg_opa: 0
              border_width: 0
              clickable: true
              on_release:
                - logger.log: "Vertical Clock page nav button RELEASED!"
                - lambda: |-
                    ESP_LOGI("touch", "Navigation button touched");
                    id(last_auto_rotation_time) = millis();
                    ESP_LOGD("touch", "Auto-rotation timer reset");
                - lvgl.page.next:
                    animation: OUT_LEFT
                    time: 300ms
