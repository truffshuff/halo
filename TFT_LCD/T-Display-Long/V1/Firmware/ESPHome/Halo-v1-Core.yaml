# ============================================================================
# HALO v1 - Core ESPHome Configuration
# ============================================================================
# ESP32-S3 Air Quality Monitor with LVGL Display
#
# Hardware: LilyGo T-Display-Long (ESP32-S3, 180x640 AMOLED display)
# Features: Air quality monitoring, weather display, WiFi stats, WireGuard VPN
# Dependencies: Requires device-specific file (e.g., halo-v1-79e384.yaml)
#              Requires secrets file with WiFi, HA, and WireGuard credentials
#
# Version: 25.11.11.0731
# Last Updated: November 11, 2025
# ============================================================================

substitutions:
  name: halo
  version: "25.11.11.0731"
  device_description: ${name} - v${version}.
  
# ============================================================================
# Configuration Architecture - Monolithic Design
# ============================================================================
# This is a MONOLITHIC configuration file containing all features in one place.
# All components (AirQ sensors, weather, WiFi stats, WireGuard VPN, LVGL UI)
# are defined directly in this file rather than using separate package files.
#
# ADVANTAGES:
#   - Everything in one place for easy editing
#   - No need to track multiple package files
#   - Simpler deployment (just one YAML file + secrets)
#   - Easier to search and find configurations
#
# CONSIDERATIONS:
#   - Large file size (8000+ lines)
#   - Cannot selectively disable features without commenting out sections
#   - Longer compile times compared to modular package-based approach
# ============================================================================

# ============================================================================
# Feature Components - All Defined in This File
# ============================================================================
# This monolithic file includes ALL features enabled by default:
#
# INCLUDED FEATURES:
#   ✓ Air Quality Monitoring (SCD40, SEN55, AGS10 sensors)
#   ✓ Weather Display (current conditions + 10-day forecast + 24-hour forecast)
#   ✓ WiFi Status Page (signal strength, IP, Home Assistant connection)
#   ✓ WireGuard VPN (encrypted tunnel to home network)
#   ✓ BLE (Bluetooth Low Energy scanning)
#   ✓ LVGL UI (all pages: vertical clock, AirQ, WiFi, weather)
#   ✓ RGB LED effects (AQI-based color, weather-based, manual effects)
#
# To disable a feature, you would need to comment out the relevant sections
# throughout this file (sensors, globals, LVGL pages, etc.)
#
# DEPENDENCIES:
#   - secrets.yaml: WiFi credentials, HA token, WireGuard keys
#   - fonts/materialdesignicons-webfont.ttf: Weather icons
# ============================================================================

globals:
  # Current page tracking using string name
  - id: current_page_name
    type: std::string
    restore_value: no
    initial_value: '"vertical_clock"'

  # Page rotation settings - which pages are included
  - id: page_rotation_vertical_clock_enabled
    type: bool
    restore_value: yes
    initial_value: 'true'

  # Page rotation order (1-6, 0 means disabled)
  - id: page_rotation_vertical_clock_order
    type: int
    restore_value: yes
    initial_value: '6'

  # Colon blink state for clock display
  # Toggles every second to create blinking colon animation (:)
  - id: colon_blink_state
    type: bool
    restore_value: no
    initial_value: 'true'

  # Startup light blink cycle counter
  # Tracks how many 1-second intervals have passed during startup LED animation
  # Used to stop rainbow effect after 30 seconds and turn off light
  - id: cycleCounter
    type: int
    restore_value: no
    initial_value: '0'

  # Display watchdog - tracks last LVGL update to detect black screen
  - id: last_display_update_time
    type: uint32_t
    restore_value: no
    initial_value: '0'

  # Display watchdog enabled flag
  - id: display_watchdog_enabled
    type: bool
    restore_value: yes
    initial_value: 'true'

  - id: weather_fetch_lock
    type: bool
    initial_value: 'false'

  # Temperature unit change flag
  # Set to true when user changes display temperature unit (F/C/K)
  # Triggers UI refresh to show values in new units
  - id: temp_unit_changed
    type: bool
    initial_value: "true"

  # Last touch time tracking
  # Records timestamp (milliseconds) of last touchscreen interaction
  # Used to reset auto-rotation timer when user touches the display
  - id: last_touch_time
    type: int
    initial_value: '0'

  # Auto page rotation master enable/disable
  # When true, device automatically cycles through enabled pages
  # Controllable via Home Assistant switch
  - id: auto_page_rotation_enabled
    type: bool
    restore_value: yes
    initial_value: 'true'

  # Auto page rotation interval (seconds)
  # How long to display each page before rotating to next
  # Default: 30 seconds. Adjustable via Home Assistant
  - id: auto_page_rotation_interval
    type: int
    restore_value: yes
    initial_value: '30'

  # Last auto-rotation timestamp
  # Tracks when last page rotation occurred (in milliseconds)
  # Used to calculate when next rotation should happen
  - id: last_auto_rotation_time
    type: unsigned long
    restore_value: no
    initial_value: '0'

  # ============================================================================
  # Page Rotation Configuration Globals
  # ============================================================================
  # These globals control which pages appear in the rotation and their order.
  # - *_enabled: Set to true/false to include/exclude page from rotation
  # - *_order: Numeric order (1-6, lower numbers appear first)
  #
  # All page rotation settings are defined in this file.
  # Adjust values here or via Home Assistant switches at runtime.
  # ============================================================================
  - id: default_page_index
    type: int
    restore_value: yes
    initial_value: '0'
  # current_page_index replaced with current_page_name (defined at top of globals)
  # Using string page IDs instead of numeric indices for flexibility
  - id: boot_complete
    type: bool
    restore_value: no
    initial_value: 'false'
  - id: ota_in_progress
    type: bool
    restore_value: no
    initial_value: 'false'  # Set to true during OTA or other critical operations
  - id: time_update_last_started
    type: int
    restore_value: no
    initial_value: '0'
  - id: time_update_last_duration
    type: int
    restore_value: no
    initial_value: '0'
  - id: time_update_last_text
    type: std::string
    restore_value: no
    initial_value: ""
  - id: time_update_needs_render
    type: bool
    restore_value: no
    initial_value: 'false'

  # Display backlight state tracking
  # Used to prevent redundant backlight on/off commands
  - id: display_backlight_is_on
    type: bool
    restore_value: no
    initial_value: 'true'

  # ============================================================================
  # Sensor UI Update Batching
  # ============================================================================
  # To prevent excessive LVGL rendering and reduce SPI bus contention,
  # sensor value updates are batched and refreshed at 2-second intervals
  # instead of updating the display on every sensor change.
  #
  # - sensor_ui_dirty: Set when any sensor value changes
  # - last_sensor_ui_update: Timestamp of last batch UI refresh (in milliseconds)
  # ============================================================================
  - id: sensor_ui_dirty
    type: bool
    restore_value: no
    initial_value: 'false'
  - id: last_sensor_ui_update
    type: uint32_t
    restore_value: no
    initial_value: '0'

  # ============================================================================
  # Weather Page Rotation Settings
  # ============================================================================
  # Weather feature includes 3 pages: Current, Daily Forecast, Hourly Forecast
  # Each can be independently enabled/disabled and ordered in rotation
  # ============================================================================

  # Weather page rotation enabled flags
  - id: page_rotation_weather_enabled
    type: bool
    restore_value: yes
    initial_value: 'true'
  - id: page_rotation_daily_forecast_enabled
    type: bool
    restore_value: yes
    initial_value: 'true'
  - id: page_rotation_hourly_forecast_enabled
    type: bool
    restore_value: yes
    initial_value: 'true'
  # Hourly summary page rotation flag (compact 12-hour view)
  - id: page_rotation_hourly_summary_enabled
    type: bool
    restore_value: yes
    initial_value: 'true'

  - id: page_rotation_hourly_summary_order
    type: int
    restore_value: yes
    initial_value: '6'

  # Weather page rotation order (1-6, lower numbers show first)
  - id: page_rotation_weather_order
    type: int
    restore_value: yes
    initial_value: '3'
  - id: page_rotation_daily_forecast_order
    type: int
    restore_value: yes
    initial_value: '4'
  - id: page_rotation_hourly_forecast_order
    type: int
    restore_value: yes
    initial_value: '5'

  # ============================================================================
  # Weather Data Storage
  # ============================================================================

  # --- Performance Tracking ---
  # Used to measure and log weather update operation timing
  - id: weather_last_started
    type: int
    restore_value: no
    initial_value: '0'
  - id: weather_last_duration
    type: int
    restore_value: no
    initial_value: '0'
  - id: weather_last_condition
    type: std::string
    restore_value: no
    initial_value: ""
  - id: weather_needs_render
    type: bool
    restore_value: no
    initial_value: 'false'

  # --- Current Weather State ---
  # Real-time weather conditions from Home Assistant
  - id: weather_current_temp
    type: float
    restore_value: no
    initial_value: 'NAN'
  - id: weather_current_apparent_temp
    type: float
    restore_value: no
    initial_value: 'NAN'
  - id: weather_current_condition
    type: std::string
    restore_value: no
    initial_value: '""'
  - id: weather_current_humidity
    type: float
    restore_value: no
    initial_value: 'NAN'

  # --- Daily Forecast Data (10 days) ---
  # Arrays store forecast data fetched from Home Assistant weather.get_forecasts API
  # Index 0 = today, Index 1 = tomorrow, etc.
  - id: weather_forecast_temp_high
    type: float[10]
    restore_value: no
  - id: weather_forecast_temp_low
    type: float[10]
    restore_value: no
  - id: weather_forecast_condition
    type: std::string[10]
    restore_value: no
  - id: weather_forecast_precip_prob
    type: float[10]
    restore_value: no
  - id: weather_forecast_datetime
    type: std::string[10]
    restore_value: no

  # --- Hourly Forecast Data (24 hours) ---
  # Arrays store hourly forecast from Home Assistant
  # Index 0 = current hour, Index 1 = next hour, etc.
  - id: weather_hourly_temp
    type: float[24]
    restore_value: no

  - id: weather_hourly_apparent_temp
    type: float[24]
    restore_value: no

  - id: weather_hourly_condition
    type: std::string[24]
    restore_value: no

  - id: weather_hourly_precip_prob
    type: float[24]
    restore_value: no

  - id: weather_hourly_datetime
    type: std::string[24]
    restore_value: no

  - id: weather_hourly_humidity
    type: float[24]
    restore_value: no

  - id: weather_hourly_precipitation
    type: float[24]
    restore_value: no

  - id: weather_hourly_pressure
    type: float[24]
    restore_value: no

  - id: weather_hourly_uv_index
    type: float[24]
    restore_value: no

  - id: weather_hourly_wind_speed
    type: float[24]
    restore_value: no

  - id: weather_hourly_wind_bearing
    type: float[24]
    restore_value: no

  # Tracking
  - id: weather_last_update
    type: unsigned long
    restore_value: no
    initial_value: '0'
  
  # Separate tracking for daily vs hourly forecasts
  - id: weather_daily_last_update
    type: unsigned long
    restore_value: no
    initial_value: '0'
  
  - id: weather_hourly_last_update
    type: unsigned long
    restore_value: no
    initial_value: '0'

  - id: weather_on_weather_page
    type: bool
    restore_value: no
    initial_value: 'false'

  # Page rotation settings - which pages are included
  - id: page_rotation_AirQ_enabled
    type: bool
    restore_value: yes
    initial_value: 'true'

  - id: page_rotation_AirQ_order
    type: int
    restore_value: yes
    initial_value: '1'

  # WiFi status indicator state for AirQ page
  - id: airq_wifi_stat_connected_state
    type: bool
    restore_value: no
    initial_value: 'false'

  - id: page_rotation_wifi_enabled
    type: bool
    restore_value: yes
    initial_value: 'true'

  # Page rotation order (1-6, lower numbers show first)
  - id: page_rotation_wifi_order
    type: int
    restore_value: yes
    initial_value: '2'

  - id: wifi_logo_visible
    type: bool
    restore_value: no
    initial_value: 'false'
  - id: wifi_signal_last_text
    type: std::string
    restore_value: no
    initial_value: ""
  - id: wifi_signal_needs_render
    type: bool
    restore_value: no
    initial_value: 'false'
  - id: wifi_signal_bar_last_value
    type: float
    restore_value: no
    initial_value: '-200.0'
  - id: wifi_signal_bar_needs_render
    type: bool
    restore_value: no
    initial_value: 'false'
  - id: wifi_ssid_last_text
    type: std::string
    restore_value: no
    initial_value: ""
  - id: wifi_ssid_needs_render
    type: bool
    restore_value: no
    initial_value: 'false'
  - id: wifi_ip_last_text
    type: std::string
    restore_value: no
    initial_value: ""
  - id: wifi_ip_needs_render
    type: bool
    restore_value: no
    initial_value: 'false'
  - id: ha_status_last_state
    type: bool
    restore_value: no
    initial_value: 'false'
  - id: ha_status_needs_render
    type: bool
    restore_value: no
    initial_value: 'false'

  - id: wg_status_last_text
    type: std::string
    restore_value: no
    initial_value: ""
  - id: wg_status_needs_render
    type: bool
    restore_value: no
    initial_value: 'false'
  - id: wg_status_connected_state
    type: bool
    restore_value: no
    initial_value: 'false'
  - id: wg_status_color_needs_render
    type: bool
    restore_value: no
    initial_value: 'false'
  - id: wg_address_last_text
    type: std::string
    restore_value: no
    initial_value: ""
  - id: wg_address_needs_render
    type: bool
    restore_value: no
    initial_value: 'false'
  - id: wg_handshake_last_text
    type: std::string
    restore_value: no
    initial_value: ""
  - id: wg_handshake_needs_render
    type: bool
    restore_value: no
    initial_value: 'false'
  - id: wg_endpoint_initialized
    type: bool
    restore_value: no
    initial_value: 'false'

  - id: calibration_pending
    type: bool
    initial_value: 'false'
  - id: calibration_confirm_time
    type: uint32_t
    initial_value: '0'

# ============================================================================
# Font Definitions
# ============================================================================
# Fonts are defined with various sizes for different UI elements across pages.
# bpp: 4 provides anti-aliasing for smooth text rendering on TFT display.
#
# OPTIMIZATION: All fonts use the same comprehensive glyph set.
# This improves ESPHome's font caching and reduces duplicate rasterization.
# Flash savings: ~30-50KB compared to unique glyph sets per font.
# ============================================================================

# Comprehensive glyph set used by all Montserrat fonts
# Includes: uppercase, lowercase, digits, common punctuation, degree symbol
font:
  - file: "gfonts://Montserrat"
    id: montserrat_80
    size: 80
    bpp: 4
    glyphs: '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz ,.:-°%"'

  - file: "gfonts://Montserrat"
    id: montserrat_50
    size: 50
    bpp: 4
    glyphs: '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz ,.:-°%"'

  - file: "gfonts://Montserrat"
    id: montserrat_28
    size: 28
    bpp: 4
    glyphs: '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz ,.:-°%"'

  - file: "gfonts://Montserrat"
    id: montserrat_24
    size: 24
    bpp: 4
    glyphs: '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz ,.:-°%"'

  - file: "gfonts://Montserrat"
    id: montserrat_20
    size: 20
    bpp: 4
    glyphs: '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz ,.:-°%"'

  - file: "gfonts://Montserrat"
    id: montserrat_18
    size: 18
    bpp: 4
    glyphs: '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz ,.:-°%"'

  - file: "gfonts://Montserrat"
    id: montserrat_16
    size: 16
    bpp: 4
    glyphs: '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz ,.:-°%"'

  - file: "gfonts://Montserrat"
    id: montserrat_14
    size: 14
    bpp: 4
    glyphs: '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz ,.:-°%"'

  - file: "gfonts://Montserrat"
    id: montserrat_10
    size: 10
    bpp: 4
    glyphs: '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz ,.:-°%"'

  - file: "fonts/materialdesignicons-webfont.ttf"
    id: icons_100
    size: 100
    bpp: 4
    glyphs: [
      "\U000F0594", # clear-night
      "\U000F0590", # cloudy
      "\U000F0F2F", # exceptional
      "\U000F0591", # fog
      "\U000F0592", # hail
      "\U000F0593", # lightning
      "\U000F067E", # lightning-rainy
      "\U000F0595", # partlycloudy
      "\U000F0596", # pouring
      "\U000F0597", # rainy
      "\U000F0598", # snowy
      "\U000F067F", # snowy-rainy
      "\U000F0599", # sunny
      "\U000F059D", # windy
      "\U000F059E", # windy-variant
      "\U000F14E4", # sunny-off
      
      ]

  - file: "fonts/materialdesignicons-webfont.ttf"
    id: icons_80
    size: 80
    bpp: 4
    glyphs: [
      "\U000F0594", # clear-night
      "\U000F0590", # cloudy
      "\U000F0F2F", # exceptional
      "\U000F0591", # fog
      "\U000F0592", # hail
      "\U000F0593", # lightning
      "\U000F067E", # lightning-rainy
      "\U000F0595", # partlycloudy
      "\U000F0596", # pouring
      "\U000F0597", # rainy
      "\U000F0598", # snowy
      "\U000F067F", # snowy-rainy
      "\U000F0599", # sunny
      "\U000F059D", # windy
      "\U000F059E", # windy-variant
      "\U000F14E4", # sunny-off
      "\U000F07D0", # home-assistant icon
      ]

  - file: "fonts/materialdesignicons-webfont.ttf"
    id: icons_50
    size: 50
    bpp: 4
    glyphs: [
      "\U000F0594", # clear-night
      "\U000F0590", # cloudy
      "\U000F0F2F", # exceptional
      "\U000F0591", # fog
      "\U000F0592", # hail
      "\U000F0593", # lightning
      "\U000F067E", # lightning-rainy
      "\U000F0595", # partlycloudy
      "\U000F0596", # pouring
      "\U000F0597", # rainy
      "\U000F0598", # snowy
      "\U000F067F", # snowy-rainy
      "\U000F0599", # sunny
      "\U000F059D", # windy
      "\U000F059E", # windy-variant
      "\U000F14E4", # sunny-off
      ]

  - file: "fonts/materialdesignicons-webfont.ttf"
    id: icons_40
    size: 40
    bpp: 4
    glyphs: [
      "\U000F0594", # clear-night
      "\U000F0590", # cloudy
      "\U000F0F2F", # exceptional
      "\U000F0591", # fog
      "\U000F0592", # hail
      "\U000F0593", # lightning
      "\U000F067E", # lightning-rainy
      "\U000F0595", # partlycloudy
      "\U000F0596", # pouring
      "\U000F0597", # rainy
      "\U000F0598", # snowy
      "\U000F067F", # snowy-rainy
      "\U000F0599", # sunny
      "\U000F059D", # windy
      "\U000F059E", # windy-variant
      "\U000F14E4", # sunny-off
      ]

  - file: "fonts/materialdesignicons-webfont.ttf"
    id: icons_20
    size: 20
    bpp: 4
    glyphs: [
      "\U000F0594", # clear-night
      "\U000F0590", # cloudy
      "\U000F0F2F", # exceptional
      "\U000F0591", # fog
      "\U000F0592", # hail
      "\U000F0593", # lightning
      "\U000F067E", # lightning-rainy
      "\U000F0595", # partlycloudy
      "\U000F0596", # pouring
      "\U000F0597", # rainy
      "\U000F0F36", # snowy
      "\U000F067F", # snowy-rainy
      "\U000F0598", # sunny
      "\U000F14E4", # sunny-off
      "\U000F059D", # windy
      "\U000F059E", # windy-variant
      ]

  - file: "fonts/materialdesignicons-webfont.ttf"
    id: icons_28
    size: 28
    bpp: 4
    glyphs: [
      "\U000F0594", # clear-night
      "\U000F0590", # cloudy
      "\U000F0F2F", # exceptional
      "\U000F0591", # fog
      "\U000F0592", # hail
      "\U000F0593", # lightning
      "\U000F067E", # lightning-rainy
      "\U000F0595", # partlycloudy
      "\U000F0596", # pouring
      "\U000F0597", # rainy
      "\U000F0F36", # snowy
      "\U000F067F", # snowy-rainy
      "\U000F0598", # sunny
      "\U000F14E4", # sunny-off
      "\U000F059D", # windy
      "\U000F059E", # windy-variant
      ]

# ============================================================================
# PSRAM Configuration
# ============================================================================
# ESP32-S3 has 8MB external PSRAM (Pseudo Static RAM) for expanded memory.
# This is critical for memory-intensive operations:
#   - BLE/Bluetooth operations
#   - LVGL graphics buffers
#   - 125+ weather sensor entities
#   - Large HTTP response buffering
#
# mode: octal - Uses 8 data lines for maximum bandwidth
# speed: 80MHz - Highest stable speed (120MHz can cause instability with BLE)
# ============================================================================
psram:
  mode: octal
  speed: 80MHz

# ============================================================================
# ESP32 Board Configuration
# ============================================================================
esp32:
  board: esp32-s3-devkitc-1
  flash_size: 16MB
  cpu_frequency: 240MHz  # Maximum performance

  framework:
    type: esp-idf
    # Use ESPHome-supported framework channels. Options: recommended (default), latest, dev
    # Switch to 'dev' to pick up the very latest ESP-IDF/NimBLE fixes sooner.
    version: recommended
    sdkconfig_options:
      # Enable NimBLE stack (completely disable Bluedroid)
      CONFIG_BT_ENABLED: "y"
      CONFIG_BT_BLUEDROID_ENABLED: "n"
      CONFIG_BT_NIMBLE_ENABLED: "y"

      # Explicitly disable ALL Bluedroid sub-components to prevent compilation
      # This fixes "esp_bt_defs.h: No such file or directory" errors
      CONFIG_BT_BLE_ENABLED: "n"           # Bluedroid BLE (not NimBLE BLE)
      CONFIG_BT_CLASSIC_ENABLED: "n"       # Classic Bluetooth (BR/EDR)
      CONFIG_BT_SPP_ENABLED: "n"           # Serial Port Profile
      CONFIG_BT_HFP_ENABLE: "n"            # Hands-Free Profile
      CONFIG_BT_A2DP_ENABLE: "n"           # Advanced Audio Distribution Profile
      CONFIG_BT_BLUFI_ENABLE: "n"          # BluFi WiFi provisioning (causes esp_blufi_api.c errors)

      # NimBLE configuration (working with nimble_proxy)
      CONFIG_BT_NIMBLE_MAX_CONNECTIONS: "3"
      CONFIG_BT_NIMBLE_ROLE_CENTRAL: "y"
      CONFIG_BT_NIMBLE_ROLE_PERIPHERAL: "y"
      CONFIG_BT_NIMBLE_MEM_ALLOC_MODE_EXTERNAL: "y"  # Use PSRAM
      CONFIG_BT_NIMBLE_TASK_STACK_SIZE: "4096"  # Increased from default
      CONFIG_BT_RELEASE_IRAM_ON_SLEEP: "n"  # Keep BT memory accessible
      
      # Memory management - allow heap allocation in PSRAM
      CONFIG_SPIRAM_USE_MALLOC: "y"  # Allow malloc() to use PSRAM
      CONFIG_SPIRAM_MALLOC_ALWAYSINTERNAL: "16384"  # Keep <16KB allocations in internal RAM

      # Stack size configuration - prevent stack overflow in LVGL updates
      # Default loop task stack is 8192 bytes, increase to handle deep call chains
      # CRITICAL: 64KB required for hourly forecast updates (240+ LVGL label updates in single script)
      # Even with PSRAM-allocated buffers, the deep call chain requires large stack
      CONFIG_ESP_MAIN_TASK_STACK_SIZE: "65536"  # Main task stack (8x from default 8192)
      CONFIG_ARDUINO_LOOP_STACK_SIZE: "65536"   # Arduino loop task stack (8x from 8192)

      # TCP/IP Configuration for better API throughput
      # Increase buffers to handle BLE advertisement bursts during concurrent operations
      CONFIG_LWIP_TCP_SND_BUF_DEFAULT: "16384"  # TCP send buffer (default: 5744)
      CONFIG_LWIP_TCP_WND_DEFAULT: "16384"      # TCP receive window (default: 5744)
      CONFIG_LWIP_TCP_RECVMBOX_SIZE: "12"       # TCP mailbox size (default: 6)
      CONFIG_LWIP_TCPIP_RECVMBOX_SIZE: "64"     # TCPIP task mailbox (default: 32)

      # Watchdog timeout for HTTP operations and JSON parsing
      # Increased from 20s to 30s to accommodate large weather JSON parsing
      # deserializeJson() can block for extended periods on complex data
      CONFIG_ESP_TASK_WDT_TIMEOUT_S: "30"

      # Increase ATT MTU (browser commonly negotiates 185/247)
      CONFIG_BT_NIMBLE_ATT_PREFERRED_MTU: "247"
      # Allow more concurrent GATT procedures and prep entries
      CONFIG_BT_NIMBLE_GATT_MAX_PROCS: "16"
      CONFIG_BT_NIMBLE_GATT_PREP_WRITE_COUNT: "16"
      # More CCCDs (we have multiple notifies)
      CONFIG_BT_NIMBLE_MAX_CCCDS: "16"
      # Optional: extra NimBLE debug logging
      CONFIG_BT_NIMBLE_LOG_LEVEL: "DEBUG"

external_components:
  - source: github://truffshuff/esphome-components@main
    components: [axs15231, sy6970, nimble_base, nimble_proxy, bluetooth_proxy, nimble_improv, weather_helpers]
    # Pin refresh to a reasonable interval to avoid excessive repo checks during editor validation
    refresh: Always

  # # NimBLE compatibility and proxy components
  # - source:
  #     type: git
  #     url: https://github.com/truffshuff/halo
  #     ref: Test
  #   components: [nimble_proxy, bluetooth_proxy]
  #   refresh: always

  # - source: github://pr#7770 # RMT driver, remove rmt_channel when using esp-idf
  #   components: [ remote_base, remote_receiver, remote_transmitter, esp32_rmt, esp32_rmt_led_strip ]
  #   refresh: 0s

  # NimBLE compatibility component removed - using native ESP-IDF NimBLE
  # nimble_compat:

spi:
  id: lily_spi
  type: quad
  clk_pin: 17
  data_pins:
    - 13
    - 18
    - 21
    - 14

captive_portal:

# ============================================================================
# NimBLE Improv WiFi Provisioning - FULLY IMPLEMENTED ✅
# ============================================================================
# Allows WiFi reconfiguration via BLE using the Improv protocol
# Uses ESP-IDF native NimBLE stack for compatibility with nimble_proxy
#
# Features:
#   ✅ Complete GATT service with all 5 Improv characteristics
#   ✅ BLE advertising as "Halo Improv" with Improv service UUID
#   ✅ WiFi provisioning flow (receive credentials → connect → send IP)
#   ✅ Auto-authorization on connection (no button press required)
#   ✅ Device info response (firmware, version, hardware, name)
#   ✅ State management and error handling
#
# Usage:
#   1. Open https://www.improv-wifi.com/ in Chrome browser
#   2. Click "Connect device via Improv"
#   3. Select "Halo Improv" from BLE devices
#   4. Enter WiFi credentials and provision
#
# Compatible with standard Improv protocol clients
# Protocol spec: https://www.improv-wifi.com/
# ============================================================================
nimble_base:

weather_helpers:

nimble_improv:
  authorized_duration: 2min  # How long authorization lasts
  wifi_timeout: 1min         # Timeout for WiFi connection attempts

logger:
  level: INFO

switch:
  - platform: template
    name: "Auto Page Rotation"
    id: auto_page_rotation
    icon: mdi:rotate-3d-variant
    restore_mode: RESTORE_DEFAULT_ON
    optimistic: true
    entity_category: "config"
    on_turn_on:
      - lambda: 'id(auto_page_rotation_enabled) = true;'
      - logger.log: "Auto page rotation enabled"
    on_turn_off:
      - lambda: 'id(auto_page_rotation_enabled) = false;'
      - logger.log: "Auto page rotation disabled"

  - platform: template
    name: "Display Watchdog (Auto Recovery)"
    id: display_watchdog_switch
    icon: mdi:monitor-eye
    restore_mode: RESTORE_DEFAULT_ON
    optimistic: true
    entity_category: "config"
    on_turn_on:
      - lambda: |-
          id(display_watchdog_enabled) = true;
          id(last_display_update_time) = millis();  // Reset timer
      - logger.log: "Display watchdog enabled - will auto-recover from black screens"
    on_turn_off:
      - lambda: 'id(display_watchdog_enabled) = false;'
      - logger.log: "Display watchdog disabled"

  - platform: template
    name: "Startup Light Blink"
    id: startup_light_blink
    icon: mdi:lightbulb
    restore_mode: RESTORE_DEFAULT_ON
    optimistic: true
    entity_category: "config"

  # Page rotation selection switches
  # Note: "24h Clock Format" switch is defined in vertical-clock-core.yaml
  # Note: "Clock Colon Blink" switch is defined in vertical-clock-core.yaml
  # Note: "Page Rotation: Vertical Clock Page" switch is defined in vertical-clock-core.yaml
  # Note: "Page Rotation: AirQ Page" switch is defined in airq-core.yaml
  # Note: "Page Rotation: WiFi Page" switch is defined in wifi-core.yaml

  # Page rotation selection switches
  - platform: template
    name: "Page Rotation: Vertical Clock Page"
    id: page_rotation_vertical_clock_switch
    icon: mdi:clock-outline
    restore_mode: RESTORE_DEFAULT_ON
    optimistic: true
    entity_category: "config"
    on_turn_on:
      - lambda: 'id(page_rotation_vertical_clock_enabled) = true;'
      - logger.log: "Vertical clock page enabled in rotation"
    on_turn_off:
      - lambda: 'id(page_rotation_vertical_clock_enabled) = false;'
      - logger.log: "Vertical clock page disabled in rotation"

  # Clock format and display options
  - platform: template
    name: "24h Clock Format"
    id: time_format
    icon: mdi:clock-digital
    restore_mode: RESTORE_DEFAULT_OFF
    optimistic: true
    entity_category: "config"

  - platform: template
    name: "Clock Colon Blink"
    id: colon_blink_enabled
    icon: mdi:timer-outline
    restore_mode: RESTORE_DEFAULT_ON
    optimistic: true
    entity_category: "config"
  
  - platform: template
    name: "Page Rotation: Weather Page"
    id: page_rotation_weather_switch
    icon: mdi:weather-partly-cloudy
    restore_mode: RESTORE_DEFAULT_ON
    optimistic: true
    entity_category: "config"
    on_turn_on:
      - lambda: 'id(page_rotation_weather_enabled) = true;'
      - logger.log: "Weather page enabled in rotation"
      # Force immediate display update when page rotation is enabled
      - if:
          condition:
            lambda: 'return id(current_page_name) == "weather";'
          then:
            - script.execute: update_weather_icon_color
    on_turn_off:
      - lambda: 'id(page_rotation_weather_enabled) = false;'
      - logger.log: "Weather page disabled in rotation"

  - platform: template
    name: "Page Rotation: Daily Forecast Page"
    id: page_rotation_daily_forecast_switch
    icon: mdi:calendar-today
    restore_mode: RESTORE_DEFAULT_ON
    optimistic: true
    entity_category: "config"
    on_turn_on:
      - lambda: 'id(page_rotation_daily_forecast_enabled) = true;'
      - logger.log: "Daily forecast page enabled in rotation"
      # Force immediate display update when page rotation is enabled
      - if:
          condition:
            lambda: 'return id(current_page_name) == "daily_forecast";'
          then:
            - script.execute: update_weather_icon_color
    on_turn_off:
      - lambda: 'id(page_rotation_daily_forecast_enabled) = false;'
      - logger.log: "Daily forecast page disabled in rotation"

  - platform: template
    name: "Page Rotation: Hourly Forecast Page"
    id: page_rotation_hourly_forecast_switch
    icon: mdi:clock-time-eight-outline
    restore_mode: RESTORE_DEFAULT_ON
    optimistic: true
    entity_category: "config"
    on_turn_on:
      - lambda: 'id(page_rotation_hourly_forecast_enabled) = true;'
      - logger.log: "Hourly forecast page enabled in rotation"
      # Force immediate display update when page rotation is enabled
      - if:
          condition:
            lambda: 'return id(current_page_name) == "hourly_forecast";'
          then:
            - script.execute: update_weather_icon_color
    on_turn_off:
      - lambda: 'id(page_rotation_hourly_forecast_enabled) = false;'
      - logger.log: "Hourly forecast page disabled in rotation"

  - platform: template
    name: "Page Rotation: AirQ Page"
    id: page_rotation_AirQ_switch
    icon: mdi:view-dashboard
    restore_mode: RESTORE_DEFAULT_ON
    optimistic: true
    entity_category: "config"
    on_turn_on:
      - lambda: 'id(page_rotation_AirQ_enabled) = true;'
      - logger.log: "AirQ page enabled in rotation"
    on_turn_off:
      - lambda: 'id(page_rotation_AirQ_enabled) = false;'
      - logger.log: "AirQ page disabled in rotation"

  - platform: template
    name: "Page Rotation: WiFi Page"
    id: page_rotation_wifi_switch
    icon: mdi:wifi
    restore_mode: RESTORE_DEFAULT_ON
    optimistic: true
    entity_category: "config"
    on_turn_on:
      - lambda: 'id(page_rotation_wifi_enabled) = true;'
      - logger.log: "WiFi page enabled in rotation"
      # Force immediate display update when page rotation is enabled
      # Note: WireGuard-specific flags removed - they're handled by wireguard-display.yaml
      - if:
          condition:
            lambda: 'return id(current_page_name) == "wifi";'
          then:
            - lambda: |-
                id(wifi_signal_needs_render) = true;
                id(wifi_signal_bar_needs_render) = true;
                id(wifi_ssid_needs_render) = true;
                id(wifi_ip_needs_render) = true;
                id(ha_status_needs_render) = true;
    on_turn_off:
      - lambda: 'id(page_rotation_wifi_enabled) = false;'
      - logger.log: "WiFi page disabled in rotation"

  - platform: template
    name: "Enable WireGuard"
    id: wireguard_enabled
    icon: mdi:vpn
    restore_mode: RESTORE_DEFAULT_OFF
    optimistic: true
    entity_category: "config"
    on_turn_on:
      - logger.log: "WireGuard switch turned ON - enabling WireGuard"
      - delay: 500ms
      - wireguard.enable:
          id: wg0
      - logger.log: "✓ WireGuard enabled"
    on_turn_off:
      - logger.log: "WireGuard switch turned OFF - disabling WireGuard"
      - wireguard.disable:
          id: wg0
      - logger.log: "✓ WireGuard disabled"

select:
  - platform: template
    name: Display Temperature Unit
    id: display_temperature_unit
    entity_category: "Config"
    options:
     - "Fahrenheit"
     - "Celsius"
     - "Kelvin"
    initial_option: "Fahrenheit"
    restore_value: true
    optimistic: true
    on_value:
      - globals.set:
          id: temp_unit_changed
          value: "true"

  - platform: template
    name: LED Effect
    id: led_effect_select
    entity_category: "Config"
    options:
      - "None"
      - "Rainbow Effect With Custom Values"
      - "Addressable Rainbow"
      - "Color Wipe"
      - "Scan"
      - "Twinkle"
      - "Fireworks"
      - "Strobe"
      - "Random Twinkle"
      - "Pink Lightning"
      - "AQI Color"
      - "Weather Condition"
      - "Auto Context"
      # Note: "AQI Color" requires airq-core.yaml to be enabled. When disabled (airq-stubs), selecting it safely turns light off
      # Note: "Weather Condition" and "Auto Context" require weather-core.yaml to be enabled. When disabled, selecting them safely turns light off
    initial_option: "None"
    restore_value: true
    optimistic: true
    on_value:
      - lambda: |-
          // Don't apply effects during boot - let startup_light_blink handle it
          if (!id(boot_complete)) return;

          std::string effect = id(led_effect_select).state;
          if (effect == "None") {
            auto call = id(rgb_light).turn_off();
            call.perform();
          } else if (effect == "AQI Color") {
            float aqi = id(computed_halo_aqi).state;
            if (std::isnan(aqi) || aqi <= 50) {
              auto call = id(rgb_light).turn_off();
              call.perform();
            } else {
              Color color;
              if (aqi <= 100) color = Color(255, 255, 0); // yellow
              else if (aqi <= 150) color = Color(255, 165, 0); // orange
              else if (aqi <= 200) color = Color(255, 0, 0); // red
              else if (aqi <= 300) color = Color(128, 0, 128); // purple
              else color = Color(128, 0, 0); // maroon
              auto call = id(rgb_light).turn_on();
              call.set_rgb(color.red / 255.0f, color.green / 255.0f, color.blue / 255.0f);
              call.perform();
            }
          } else if (effect == "Weather Condition" || effect == "Auto Context") {
            // Lambda-based effects - activate them
            auto call = id(rgb_light).turn_on();
            call.set_effect(effect);
            call.perform();
          } else {
            // Standard effects
            auto call = id(rgb_light).turn_on();
            call.set_effect(effect);
            call.perform();
          }
  
  - platform: template
    name: "Default Page at Boot"
    id: default_page_select_boot
    optimistic: true
    options:
      - "Vertical Clock"
      # Uncomment based on enabled features:
      # - "AirQ"          # if airq_enabled
      # - "WiFi"          # if wifi_enabled
      - "Weather"       # if weather_enabled
    initial_option: "Vertical Clock"
    restore_value: true

# ============================================================================
# DEFAULT PAGE SELECTOR
# ============================================================================
# Note: The default page selector must be defined in device-specific files
# (e.g., halo-v1-79e384.yaml) to match the enabled LVGL pages for that device.
# This allows each device to have only the page options that are actually available.

interval:
  - interval: 2s  # Reduced from 3s for faster UI updates
    then:
      - if:
          condition:
            lambda: 'return id(boot_complete);'
          then:
            - script.execute: time_update
            # Note: Watchdog timer is updated inside time_update script only when rendering occurs

  # Note: 1s interval for colon blink is defined in vertical-clock-core.yaml

  - interval: 1s
    then:
      - if:
          condition:
            - binary_sensor.is_off: ink_ha_connected
            - lambda: 'return id(cycleCounter) < 30;'
            - switch.is_on: startup_light_blink

          then:
            - light.turn_on:
                id: rgb_light
                effect: "Addressable Rainbow"
            - lambda: 'id(cycleCounter) += 1;'

  - interval: 1s
    then:
      - if:
          condition:
            - binary_sensor.is_off: ink_ha_connected
            - lambda: 'return id(cycleCounter) > 30;'
            - lambda: 'return id(cycleCounter) < 31;'
            - switch.is_on: startup_light_blink

          then:
            - light.turn_off:
                id: rgb_light
            - lambda: 'id(cycleCounter) += 1;'

  # Batched sensor UI update - prevents LVGL cascade rendering
  # NOTE: This is legacy code - sensor_ui_dirty is never set in current config
  # Kept for potential future use
  - interval: 2s
    then:
      - lambda: |-
          // Only update if sensors changed since last batch
          if (id(sensor_ui_dirty)) {
            const uint32_t now = millis();
            // Ensure minimum 2s between UI refreshes
            if ((now - id(last_sensor_ui_update)) >= 2000) {
              ESP_LOGD("sensor_batch", "Batched sensor UI update triggered");
              id(sensor_ui_dirty) = false;
              id(last_sensor_ui_update) = now;
              // Watchdog timer updated by actual LVGL rendering, not here
            }
          }

  # Display Watchdog - Automatic Black Screen Recovery
  # Checks every 30 seconds if display has been updating
  # If no updates for 60 seconds, performs automatic recovery
  - interval: 30s
    then:
      - if:
          condition:
            lambda: |-
              // Only run watchdog if enabled and boot is complete
              if (!id(display_watchdog_enabled) || !id(boot_complete)) {
                ESP_LOGV("display_watchdog", "Watchdog check skipped (enabled=%s, boot_complete=%s)",
                         id(display_watchdog_enabled) ? "true" : "false",
                         id(boot_complete) ? "true" : "false");
                return false;
              }

              const uint32_t now = millis();
              const uint32_t time_since_update = now - id(last_display_update_time);

              // Log watchdog check for debugging
              ESP_LOGD("display_watchdog", "Watchdog check: %u seconds since last display update", time_since_update / 1000);

              // If display hasn't updated in 60 seconds, trigger recovery
              if (time_since_update > 60000) {
                ESP_LOGW("display_watchdog", "Display frozen detected! No updates for %u seconds", time_since_update / 1000);
                return true;
              }
              return false;
          then:
            - logger.log: "=== WATCHDOG: AUTOMATIC DISPLAY RECOVERY TRIGGERED ==="
            - output.turn_off: backlight
            - delay: 500ms
            - lvgl.pause:
            - delay: 300ms
            # Properly reset and re-initialize the display controller
            - lambda: |-
                ESP_LOGI("display_watchdog", "Resetting and re-initializing display hardware...");
                auto *display = id(lily_display);
                if (display != nullptr) {
                  display->setup();  // This re-initializes the display controller completely
                }
            - delay: 500ms
            - lvgl.resume:
            - delay: 300ms
            - output.turn_on: backlight
            - delay: 200ms
            - lambda: |-
                // Update watchdog timestamp
                id(last_display_update_time) = millis();

                // Increment recovery counter
                static int recoveries = 0;
                recoveries++;
                id(display_recovery_count).publish_state(recoveries);

                ESP_LOGI("display_watchdog", "=== AUTOMATIC RECOVERY COMPLETE === (Recovery #%d)", recoveries);

  # Periodic Display Controller Health Check
  # The AXS15231 display controller can lose sync even while LVGL continues running
  # This periodically reinitializes the display to prevent black screen issues
  # Runs every 10 minutes as a preventive measure
  - interval: 10min
    then:
      - if:
          condition:
            lambda: |-
              // Only run if watchdog is enabled and boot complete
              if (!id(display_watchdog_enabled) || !id(boot_complete)) return false;

              ESP_LOGI("display_health", "Performing periodic display controller health check");
              return true;
          then:
            - logger.log: "=== PERIODIC DISPLAY HEALTH CHECK ==="
            - output.turn_off: backlight
            - delay: 300ms
            - lvgl.pause:
            - delay: 200ms
            # Reinitialize display controller
            - lambda: |-
                ESP_LOGI("display_health", "Reinitializing display controller...");
                auto *display = id(lily_display);
                if (display != nullptr) {
                  display->setup();
                }
            - delay: 300ms
            - lvgl.resume:
            - delay: 200ms
            - output.turn_on: backlight
            - delay: 100ms
            - lambda: |-
                id(last_display_update_time) = millis();
                ESP_LOGI("display_health", "=== DISPLAY HEALTH CHECK COMPLETE ===");

  # Automatic page rotation - controllable via Home Assistant with custom page selection and order
  - interval: 1s
    then:
      - if:
          condition:
            lambda: |-
              if (!id(boot_complete)) return false;
              // Only rotate if auto rotation is enabled
              if (!id(auto_page_rotation_enabled)) return false;

              const uint32_t now = millis();
              const uint32_t interval_ms = id(auto_page_rotation_interval) * 1000;

              // Check if enough time has passed since last rotation
              if ((now - id(last_auto_rotation_time)) < interval_ms) return false;

              // Build separate parallel arrays for page info
              std::vector<int> page_orders;
              std::vector<std::string> page_ids;  // Maps to the page ID in sorted order

              // Collect enabled pages with their orders (use string ID to identify page)
              // Page IDs: vertical_clock, airq, wifi, weather, hourly_forecast, daily_forecast

              // Core pages
              if (id(page_rotation_vertical_clock_enabled)) {
                page_orders.push_back(id(page_rotation_vertical_clock_order));
                page_ids.push_back("vertical_clock");
              }
              // AirQ page (conditionally available based on AirQ package)
              // This global is provided by either airq-core.yaml or airq-stubs.yaml
              if (id(page_rotation_AirQ_enabled)) {
                page_orders.push_back(id(page_rotation_AirQ_order));
                page_ids.push_back("airq");
              }
              // WiFi page (conditionally available based on WiFi package)
              // This global is provided by either wifi-core.yaml or wifi-stubs.yaml
              if (id(page_rotation_wifi_enabled)) {
                page_orders.push_back(id(page_rotation_wifi_order));
                page_ids.push_back("wifi");
              }

              // Weather pages (conditionally available based on weather package)
              // These globals are provided by either weather-core.yaml or weather-stubs.yaml
              if (id(page_rotation_weather_enabled)) {
                page_orders.push_back(id(page_rotation_weather_order));
                page_ids.push_back("weather");
              }
              if (id(page_rotation_hourly_forecast_enabled)) {
                page_orders.push_back(id(page_rotation_hourly_forecast_order));
                page_ids.push_back("hourly_forecast");
              }
              // Compact hourly summary page
              if (id(page_rotation_hourly_summary_enabled)) {
                page_orders.push_back(id(page_rotation_hourly_summary_order));
                page_ids.push_back("hourly_summary");
              }
              if (id(page_rotation_daily_forecast_enabled)) {
                page_orders.push_back(id(page_rotation_daily_forecast_order));
                page_ids.push_back("daily_forecast");
              }

              // If no pages are enabled, don't rotate
              if (page_orders.empty()) {
                ESP_LOGW("page_rotation", "No pages enabled for rotation");
                return false;
              }

              // Sort IDs based on their order numbers (bubble sort for simplicity)
              for (size_t i = 0; i < page_orders.size(); i++) {
                for (size_t j = i + 1; j < page_orders.size(); j++) {
                  if (page_orders[j] < page_orders[i]) {
                    std::swap(page_orders[i], page_orders[j]);
                    std::swap(page_ids[i], page_ids[j]);
                  }
                }
              }

              // Use a static variable to track position in rotation sequence
              static int rotation_position = 0;

              // Make sure rotation_position is within bounds
              if (rotation_position >= page_ids.size()) {
                rotation_position = 0;
              }

              // Get the next page to show
              std::string next_page_id = page_ids[rotation_position];

              // Store the next page ID in current_page_name for the action to use
              id(current_page_name) = next_page_id;

              // Advance rotation position for next time (wrap around)
              rotation_position = (rotation_position + 1) % page_ids.size();

              // Show the next page
              ESP_LOGD("page_rotation", "Rotating to page '%s' (order: %d)",
                       next_page_id.c_str(), page_orders[rotation_position > 0 ? rotation_position - 1 : page_orders.size() - 1]);

              id(last_auto_rotation_time) = now;
              return true;
          then:
            # Note: Core no longer shows pages - device files must handle this
            # The rotation logic above sets current_page_name, but device files
            # must implement their own interval to actually show the pages
            - logger.log:
                format: "Core: Rotation scheduled to page '%s'"
                args: ['id(current_page_name).c_str()']
                level: DEBUG

  # Colon blink and wind updates - combined interval
  - interval: 1s
    then:
      # Colon blink - runs every second when on vertical clock page
      - if:
          condition:
            lambda: 'return id(boot_complete) && id(current_page_name) == "vertical_clock";'
          then:
            - lambda: |-
                if (id(colon_blink_enabled).state) {
                  id(colon_blink_state) = !id(colon_blink_state);
                } else if (!id(colon_blink_state)) {
                  id(colon_blink_state) = true;
                }
            - script.execute: update_colon_widget

  # NOTE: Wind sensor updates removed - now handled by on_value callbacks in sensor definitions
  # Wind data from Home Assistant updates automatically when values change (passive, not polled)
  # Display updates only occur when on weather page - see wind_speed_sensor and wind_direction_sensor

  # Auto-refresh DAILY forecast periodically (independent of which page is displayed)
  # Checks every hour if data is stale (>60 min) and refreshes if needed
  - interval: ${weather_daily_refresh_interval}s
    then:
      - if:
          condition:
            lambda: |-
              // Check if fetch is already in progress
              if (id(weather_fetch_lock)) {
                ESP_LOGW("weather", "Daily forecast fetch already in progress, skipping");
                return false;
              }
              
              // Calculate time since last daily forecast update
              unsigned long current_time = millis();
              unsigned long time_since_last_update = (current_time - id(weather_daily_last_update)) / 1000;
              
              // Only fetch if data is stale (older than refresh interval)
              if (time_since_last_update > ${weather_daily_refresh_interval}) {
                ESP_LOGI("weather", "Background daily forecast refresh triggered (data age: %d minutes)", 
                        time_since_last_update / 60);
                return true;
              }
              return false;
          then:
            - lambda: 'id(weather_fetch_lock) = true;'
            - script.execute: fetch_daily_forecast

  # Auto-refresh HOURLY forecast periodically (independent of which page is displayed)
  # Checks every 15 minutes if data is stale (>15 min) and refreshes if needed
  - interval: ${weather_hourly_refresh_interval}s
    then:
      - if:
          condition:
            lambda: |-
              // Check if fetch is already in progress
              if (id(weather_fetch_lock)) {
                ESP_LOGW("weather", "Hourly forecast fetch already in progress, skipping");
                return false;
              }
              
              // Calculate time since last hourly forecast update
              unsigned long current_time = millis();
              unsigned long time_since_last_update = (current_time - id(weather_hourly_last_update)) / 1000;
              
              // Only fetch if data is stale (older than refresh interval)
              if (time_since_last_update > ${weather_hourly_refresh_interval}) {
                ESP_LOGI("weather", "Background hourly forecast refresh triggered (data age: %d minutes)", 
                        time_since_last_update / 60);
                return true;
              }
              return false;
          then:
            - lambda: 'id(weather_fetch_lock) = true;'
            - script.execute: fetch_hourly_forecast

  - interval: 100ms  # Check frequently for page index changes
    then:
      - if:
          condition:
            lambda: |-
              static std::string last_displayed_page = "";

              // Don't do anything until boot is complete
              if (!id(boot_complete)) return false;

              // Check if page ID has changed
              std::string current = id(current_page_name);
              if (current == last_displayed_page) return false;

              // Page ID changed
              last_displayed_page = current;
              ESP_LOGD("page_rotation", "Page changed to '%s'", current.c_str());
              return true;
          then:
            # Vertical Clock
            - if:
                condition:
                  lambda: 'return id(current_page_name) == "vertical_clock";'
                then:
                  - logger.log: "Page rotation: Showing Vertical Clock"
                  - lvgl.page.show:
                      id: vertical_clock_page
                      animation: OUT_LEFT
                      time: 300ms
                else:
                  # AirQ
                  - if:
                      condition:
                        lambda: 'return id(current_page_name) == "airq";'
                      then:
                        - logger.log: "Page rotation: Showing AirQ page"
                        - lvgl.page.show:
                            id: AirQ_page
                            animation: OUT_LEFT
                            time: 300ms
                      else:
                        # WiFi
                        - if:
                            condition:
                              lambda: 'return id(current_page_name) == "wifi";'
                            then:
                              - logger.log: "Page rotation: Showing WiFi page"
                              - lvgl.page.show:
                                  id: wifi_page
                                  animation: OUT_LEFT
                                  time: 300ms
                            else:
                              # Weather (Current)
                              - if:
                                  condition:
                                    lambda: 'return id(current_page_name) == "weather";'
                                  then:
                                    - logger.log: "Page rotation: Showing Weather page"
                                    - lvgl.page.show:
                                        id: weather_forecast_page
                                        animation: OUT_LEFT
                                        time: 300ms
                                  else:
                                    # Hourly Forecast
                                    - if:
                                        condition:
                                          lambda: 'return id(current_page_name) == "hourly_forecast";'
                                        then:
                                          - logger.log: "Page rotation: Showing Hourly Forecast page"
                                          - lvgl.page.show:
                                              id: hourly_forecast_page
                                              animation: OUT_LEFT
                                              time: 300ms
                                        else:
                                          # Daily Forecast
                                          - if:
                                              condition:
                                                lambda: 'return id(current_page_name) == "daily_forecast";'
                                              then:
                                                - logger.log: "Page rotation: Showing Daily Forecast page"
                                                - lvgl.page.show:
                                                    id: daily_forecast_page
                                                    animation: OUT_LEFT
                                                    time: 300ms
                                              else:
                                                # Unknown page - fall back to vertical clock
                                                - logger.log:
                                                    format: "Page rotation: Page '%s' not available, falling back to Vertical Clock"
                                                    args: ['id(current_page_name).c_str()']
                                                    level: WARN
                                                - lvgl.page.show:
                                                          id: vertical_clock_page
                                                          animation: OUT_LEFT
                                                          time: 300ms


  - interval: 1s  # Reduced from 5s for faster WiFi stats updates
    then:
      - if:
          condition:
            lambda: 'return id(boot_complete);'
          then:
            - if:
                condition:
                  wifi.connected:
                then:
                  - lambda: |-
                      char buffer[32];
                      snprintf(buffer, sizeof(buffer), "Signal: %.0f dBm", id(wifi_signal_db).state);
                      std::string new_text(buffer);
                      if (new_text != id(wifi_signal_last_text)) {
                        id(wifi_signal_last_text) = new_text;
                        id(wifi_signal_needs_render) = true;
                      }
                  - if:
                      condition:
                        lambda: 'return id(current_page_name) == "wifi";'
                      then:
                        - lvgl.label.update:
                            id: wifi_signal_label
                            text: !lambda 'return id(wifi_signal_last_text);'
                        - lambda: 'id(wifi_signal_needs_render) = false;'
                  # Update WiFi signal bar
                  - lambda: |-
                      float signal = id(wifi_signal_db).state;
                      if (std::isnan(signal)) {
                        signal = -200.0f;
                      }
                      if (signal != id(wifi_signal_bar_last_value)) {
                        id(wifi_signal_bar_last_value) = signal;
                        id(wifi_signal_bar_needs_render) = true;
                      }
                  - if:
                      condition:
                        lambda: 'return id(current_page_name) == "wifi";'
                      then:
                        - lvgl.bar.update:
                            id: wifi_signal_bar
                            value: !lambda 'return id(wifi_signal_bar_last_value);'
                        - lambda: 'id(wifi_signal_bar_needs_render) = false;'
                  # Update WiFi SSID
                  - lambda: |-
                      std::string ssid = esphome::wifi::global_wifi_component->wifi_ssid();
                      std::string new_text = std::string("SSID: ") + ssid;
                      if (new_text != id(wifi_ssid_last_text)) {
                        id(wifi_ssid_last_text) = new_text;
                        id(wifi_ssid_needs_render) = true;
                      }
                  - if:
                      condition:
                        lambda: 'return id(wifi_ssid_needs_render) && id(current_page_name) == "wifi";'
                      then:
                        - lvgl.label.update:
                            id: wifi_ssid_label
                            text: !lambda 'return id(wifi_ssid_last_text);'
                        - lambda: 'id(wifi_ssid_needs_render) = false;'
                  # Update WiFi IP address
                  - lambda: |-
                      auto addresses = esphome::wifi::global_wifi_component->get_ip_addresses();
                      std::string ip_text = "IP: Not assigned";
                      if (!addresses.empty()) {
                        ip_text = std::string("IP: ") + addresses[0].str();
                      }
                      if (ip_text != id(wifi_ip_last_text)) {
                        id(wifi_ip_last_text) = ip_text;
                        id(wifi_ip_needs_render) = true;
                      }
                  - if:
                      condition:
                        lambda: 'return id(wifi_ip_needs_render) && id(current_page_name) == "wifi";'
                      then:
                        - lvgl.label.update:
                            id: wifi_ip_label
                            text: !lambda 'return id(wifi_ip_last_text);'
                        - lambda: 'id(wifi_ip_needs_render) = false;'
                  # Update Home Assistant connection status icon
                  - lambda: |-
                      bool ha_connected = id(ink_ha_connected).state;
                      if (ha_connected != id(ha_status_last_state)) {
                        id(ha_status_last_state) = ha_connected;
                        id(ha_status_needs_render) = true;
                      }
                  - if:
                      condition:
                        lambda: 'return id(ha_status_needs_render) && id(current_page_name) == "wifi";'
                      then:
                        - lvgl.widget.update:
                            id: ha_status_icon
                            text_color: !lambda 'return id(ink_ha_connected).state ? id(my_green) : id(my_gray);'
                        - lambda: 'id(ha_status_needs_render) = false;'
                else:
                  # WiFi disconnected - hide WiFi logo on AirQ page (only if AirQ page exists)
                  # This is guarded to avoid errors in wifi-only mode
                  # - if:
                  #     condition:
                  #       lambda: 'return id(wifi_logo_visible) && id(current_page_name) == "airq";'
                  #     then:
                  #       - lvgl.widget.hide:
                  #           id: ym_image
                  # - if:
                  #     condition:
                  #       lambda: 'return id(wifi_logo_visible);'
                  #     then:
                  #       - lambda: 'id(wifi_logo_visible) = false;'
                  # Update disconnected signal text
                  - lambda: |-
                      const std::string new_text = "Signal: --";
                      if (new_text != id(wifi_signal_last_text)) {
                        id(wifi_signal_last_text) = new_text;
                        id(wifi_signal_needs_render) = true;
                      }
                  - if:
                      condition:
                        lambda: 'return id(wifi_signal_needs_render) && id(current_page_name) == "wifi";'
                      then:
                        - lvgl.label.update:
                            id: wifi_signal_label
                            text: !lambda 'return id(wifi_signal_last_text);'
                        - lambda: 'id(wifi_signal_needs_render) = false;'
                  # Update disconnected signal bar
                  - lambda: |-
                      float new_value = -200.0f;
                      if (new_value != id(wifi_signal_bar_last_value)) {
                        id(wifi_signal_bar_last_value) = new_value;
                        id(wifi_signal_bar_needs_render) = true;
                      }
                  - if:
                      condition:
                        lambda: 'return id(wifi_signal_bar_needs_render) && id(current_page_name) == "wifi";'
                      then:
                        - lvgl.bar.update:
                            id: wifi_signal_bar
                            value: !lambda 'return id(wifi_signal_bar_last_value);'
                        - lambda: 'id(wifi_signal_bar_needs_render) = false;'
                  # Update disconnected SSID
                  - lambda: |-
                      const std::string ssid_text = "SSID: Not connected";
                      if (ssid_text != id(wifi_ssid_last_text)) {
                        id(wifi_ssid_last_text) = ssid_text;
                        id(wifi_ssid_needs_render) = true;
                      }
                  - if:
                      condition:
                        lambda: 'return id(wifi_ssid_needs_render) && id(current_page_name) == "wifi";'
                      then:
                        - lvgl.label.update:
                            id: wifi_ssid_label
                            text: !lambda 'return id(wifi_ssid_last_text);'
                        - lambda: 'id(wifi_ssid_needs_render) = false;'
                  # Update disconnected IP
                  - lambda: |-
                      const std::string ip_text = "IP: Not connected";
                      if (ip_text != id(wifi_ip_last_text)) {
                        id(wifi_ip_last_text) = ip_text;
                        id(wifi_ip_needs_render) = true;
                      }
                  - if:
                      condition:
                        lambda: 'return id(wifi_ip_needs_render) && id(current_page_name) == "wifi";'
                      then:
                        - lvgl.label.update:
                            id: wifi_ip_label
                            text: !lambda 'return id(wifi_ip_last_text);'
                        - lambda: 'id(wifi_ip_needs_render) = false;'
                  - if:
                      condition:
                        lambda: 'return id(wg_address_needs_render) && id(current_page_name) == "wifi";'
                      then:
                        - lvgl.label.update:
                            id: wg_address_label
                            text: !lambda 'return id(wg_address_last_text);'
                        - lambda: 'id(wg_address_needs_render) = false;'
                  - lambda: |-
                      const std::string handshake_text = "Handshake: \nUnavailable";
                      if (handshake_text != id(wg_handshake_last_text)) {
                        id(wg_handshake_last_text) = handshake_text;
                        id(wg_handshake_needs_render) = true;
                      }
                  - if:
                      condition:
                        lambda: 'return id(wg_handshake_needs_render) && id(current_page_name) == "wifi";'
                      then:
                        - lvgl.label.update:
                            id: wg_handshake_label
                            text: !lambda 'return id(wg_handshake_last_text);'
                        - lambda: 'id(wg_handshake_needs_render) = false;'

  # Optional: API watchdog for automatic recovery
  # Monitors Home Assistant API connection and reboots if disconnected for 30+ minutes
  # This provides automatic recovery from API failures while still allowing HA restarts
  - interval: 5min
    then:
      - if:
          condition:
            lambda: |-
              static uint32_t last_connected = millis();
              if (id(ink_ha_connected).state) {
                last_connected = millis();
                return false;
              }
              return (millis() - last_connected) > 1800000; // 30 min
          then:
            - logger.log: "API disconnected for 30+ minutes, triggering automatic reboot..."
            - button.press: esp_reboot_button  # Trigger ESP restart

# ============================================================================
# Home Assistant API Configuration
# ============================================================================
# Handles communication with Home Assistant for sensors, switches, and services
#
# reboot_timeout: 0s - CRITICAL SETTING
#   Disables automatic device reboot when HA connection is lost
#   WHY: During HA restarts or network issues, device should keep running
#        and attempt reconnection rather than rebooting repeatedly
#   RISK: If API breaks, device won't auto-recover without manual intervention
# ============================================================================
api:
  reboot_timeout: ${api_reboot_timeout}  # Set to 0s to disable auto-reboot on API disconnect
  listen_backlog: 8
  max_connections: 16
  max_send_queue: 32  # Increased from default 256KB to handle larger data bursts
  # Optimized settings for improved switch responsiveness and connection stability
  # These reduce latency and ensure faster state updates between device and Home Assistant
  on_client_connected:
      - delay: 1s  # Brief delay for API stabilization
      - lambda: 'id(cycleCounter) = 30;'  # Stop startup rainbow animation
      - lambda: 'id(boot_complete) = true;'  # Enable normal operation

      # ========================================================================
      # Restore User LED Effect Selection
      # ========================================================================
      # WHY: During boot, startup_light_blink takes control of RGB light
      #      When HA connects, we restore user's saved effect preference
      # DELAY: 2s ensures rainbow effect fully stops before applying new effect
      # ========================================================================
      - delay: 2s
      - lambda: |-
          std::string effect = id(led_effect_select).state;
          if (effect == "None") {
            auto call = id(rgb_light).turn_off();
            call.perform();
          } else if (effect == "AQI Color") {
            float aqi = id(computed_halo_aqi).state;
            if (std::isnan(aqi) || aqi <= 50) {
              auto call = id(rgb_light).turn_off();
              call.perform();
            } else {
              Color color;
              if (aqi <= 100) color = Color(255, 255, 0);
              else if (aqi <= 150) color = Color(255, 165, 0);
              else if (aqi <= 200) color = Color(255, 0, 0);
              else if (aqi <= 300) color = Color(128, 0, 128);
              else color = Color(128, 0, 0);
              auto call = id(rgb_light).turn_on();
              call.set_rgb(color.red / 255.0f, color.green / 255.0f, color.blue / 255.0f);
              call.perform();
            }
          } else if (effect == "Weather Condition" || effect == "Auto Context") {
            // New lambda effects - activate them
            auto call = id(rgb_light).turn_on();
            call.set_effect(effect);
            call.perform();
          } else {
            auto call = id(rgb_light).turn_on();
            call.set_effect(effect);
            call.perform();
          }
      # BLE scanning disabled (using NimBLE instead of Bluedroid)
      # - delay: 500ms
      # - esp32_ble_tracker.start_scan:
      #     continuous: true
  # ============================================================================
  # Custom Services (callable from Home Assistant)
  # ============================================================================

  on_client_disconnected:
    # BLE scanning disabled (using NimBLE instead of Bluedroid)
    # - esp32_ble_tracker.stop_scan:
    then:
      - logger.log: "Home Assistant disconnected"
  
  services:
    # CO2 Sensor Calibration
    # USAGE: esphome.halo_calibrate_co2_value co2_ppm: 420
    # WHEN: Perform outdoors or in well-ventilated area with known CO2 level
    # WARNING: Incorrect calibration will give permanently wrong readings!
    #          Outdoor air is ~400-420ppm. Indoor air is typically 600-1000ppm.
    - service: calibrate_co2_value
      variables:
        co2_ppm: float
      then:
        - scd4x.perform_forced_calibration:
            value: !lambda "return co2_ppm;"
            id: scd40

    # SEN55 Fan Cleaning
    # Runs fan at high speed for 10 seconds to remove dust from sensor
    # USAGE: esphome.halo_sen55_clean
    # WHEN: If PM readings seem abnormally high, run this service
    - service: sen55_clean
      then:
        - sen5x.start_fan_autoclean: sen55
      # Note: BLE tracker start/stop logic would be defined in BLE section below

i2c:
  - sda: 9
    scl: 48
    id: lily_i2c
  - sda: 15
    scl: 10
    id: touch_i2c
    frequency: 400kHz

output:
  - platform: ledc
    pin: 1
    id: backlight
    frequency: 100Hz  #Datasheet suggests low-frequency PWM. Should prevent stability issues.
    
# sy6970:
#   i2c_id: touch_i2c
#   state_led_enable: false  # To turn off the blinking green status LED

display:
  - platform: qspi_dbi
    id: lily_display
    model: AXS15231
    data_rate: 5MHz
    spi_id: lily_spi
    dimensions:
      height: 640
      width: 180
    cs_pin: 12
    reset_pin: 16
    rotation: 0
    auto_clear_enabled: false

# Touchscreen configuration optimized for responsiveness:
# - Fast 50ms polling for immediate touch detection
# - Interrupt pin for hardware-triggered events
# - Coordinate validation to reject invalid touches
# - Auto-rotation reset on touch for better UX
touchscreen:
  - platform: axs15231
    id: lily_touch
    display: lily_display
    i2c_id: touch_i2c
    interrupt_pin: GPIO11
    update_interval: never  # Fast polling for responsive touch detection (was: never)
    transform:
      mirror_x: false
      mirror_y: false
      swap_xy: false
    on_touch:
      - lambda: |-
          // Validate touch coordinates - filter out spurious/phantom touches
          if (touch.x < 0 || touch.x > 180 || touch.y < 0 || touch.y > 640) {
            ESP_LOGW("touch", "Invalid touch coordinates: x=%d, y=%d - ignoring", touch.x, touch.y);
            return;
          }
          ESP_LOGI("touch", "Touch at x=%d, y=%d", touch.x, touch.y);

          // Reset auto-rotation timer on any valid touch to prevent interruption during manual navigation
          id(last_auto_rotation_time) = millis();
          ESP_LOGD("touch", "Auto-rotation timer reset");

web_server:
  port: 80

image:
  - file: https://yashmulgaonkar.github.io/assets/YM.png
    id: ym_logo
    resize: 25x25
    type: RGB565
    transparency: alpha_channel

color:
  - id: my_red
    red: 100%
    green: 0%
    blue: 0%
  - id: my_yellow
    red: 100%
    green: 100%
    blue: 0%
  - id: my_green
    red: 0%
    green: 100%
    blue: 0%
  - id: my_blue
    red: 0%
    green: 0%
    blue: 100%
  - id: my_gray
    red: 50%
    green: 50%
    blue: 50%
  - id: my_orange
    red: 100%
    green: 50%
    blue: 0%
  - id: my_teal
    red: 0%
    green: 100%
    blue: 100%
  - id: my_white
    red: 100%
    green: 100%
    blue: 100%
  - id: my_black
    red: 0%
    green: 0%
    blue: 0%

# HTTP Request component for calling HA REST API
# Streaming response handling; moderate buffers
http_request:
  useragent: esphome/halo
  timeout: 30s  # Increased timeout for large weather responses
  buffer_size_rx: 1024  # 1KB RX buffer; smaller to reduce memory pressure
  buffer_size_tx: 1024  # 1KB transmit buffer for POST requests

time:
  - platform: homeassistant
    id: ha_time
    on_time_sync:
      - script.execute: time_update
  - platform: sntp
    id: sntp_time
    timezone: America/New_York
    servers:
      - 0.pool.ntp.org
      - 1.pool.ntp.org
      - 2.pool.ntp.org
    on_time_sync:
      - script.execute: time_update

script:
  - id: page_transition_cleanup
    mode: queued  # Queue executions instead of warning about duplicates
    max_runs: 2   # Allow up to 2 queued runs
    then:
      - if:
          condition:
            lambda: 'return id(boot_complete) && !id(ota_in_progress);'
          then:
            - delay: 50ms  # Small delay to prevent rapid successive calls
            - lambda: |-
                // Safety check: Only run if LVGL is fully initialized
                lv_obj_t *scr = lv_scr_act();
                if (scr == NULL) {
                  return;  // Silently skip if not initialized
                }

                // Log current memory state before cleanup
                ESP_LOGD("lvgl", "Page transition cleanup - Free heap: %d", esp_get_free_heap_size());

                // Clear all cached strings to free memory
                id(time_update_last_text).clear();
                id(weather_last_condition).clear();

                // Force LVGL to invalidate current screen and redraw
                lv_obj_invalidate(scr);

                // Force immediate display flush to prevent buffer buildup
                lv_refr_now(NULL);

  - id: update_colon_widget
    mode: restart
    then:
      - if:
          condition:
            lambda: 'return id(colon_blink_state);'
          then:
            - lvgl.label.update:
                id: vclock_colon
                text: ":"
          else:
            - lvgl.label.update:
                id: vclock_colon
                text: " "

  - id: update_weather_icon_color
    mode: restart
    then:
      - lambda: |-
          id(weather_last_started) = millis();
          id(weather_needs_render) = false;
      - lambda: |-
          std::string condition = id(weather_current_condition);
          ESP_LOGD("weather_color", "Current condition: '%s'", condition.c_str());
          if (condition.empty()) {
            return;
          }
          std::string normalized = condition;
          std::transform(normalized.begin(), normalized.end(), normalized.begin(), ::tolower);
          if (normalized != id(weather_last_condition)) {
            id(weather_last_condition) = normalized;
            id(weather_needs_render) = true;
          }
      - if:
          condition:
            lambda: 'return id(weather_needs_render);'
          then:
            - lvgl.label.update:
                id: lbl_weather_forecast_condition_icon
                text: !lambda |-
                  // Map normalized condition to Material Design Icon glyph
                  const std::string condition = id(weather_last_condition);
                  // Specific combos first
                  if (condition.find("lightning-rainy") != std::string::npos) {
                    return std::string("\U000F067E");
                  } else if (condition.find("snowy-rainy") != std::string::npos) {
                    return std::string("\U000F067F");
                  } else if (condition.find("clear-night") != std::string::npos) {
                    return std::string("\U000F0594");
                  } else if (condition.find("partlycloudy") != std::string::npos) {
                    return std::string("\U000F0595");
                  } else if (condition.find("pouring") != std::string::npos) {
                    return std::string("\U000F0596");
                  } else if (condition.find("lightning") != std::string::npos) {
                    return std::string("\U000F0593");
                  } else if (condition.find("snowy") != std::string::npos) {
                    return std::string("\U000F0598");
                  } else if (condition.find("rainy") != std::string::npos) {
                    return std::string("\U000F0597");
                  } else if (condition.find("hail") != std::string::npos) {
                    return std::string("\U000F0592");
                  } else if (condition.find("fog") != std::string::npos) {
                    return std::string("\U000F0591");
                  } else if (condition.find("windy-variant") != std::string::npos) {
                    return std::string("\U000F059E");
                  } else if (condition.find("windy") != std::string::npos) {
                    return std::string("\U000F059D");
                  } else if (condition.find("cloudy") != std::string::npos) {
                    return std::string("\U000F0590");
                  } else if (condition.find("sunny") != std::string::npos || condition.find("clear") != std::string::npos) {
                    return std::string("\U000F0599");
                  } else if (condition.find("exceptional") != std::string::npos) {
                    return std::string("\U000F0F2F");
                  }
                  // Default/fallback icon
                  return std::string("\U000F14E4");
                text_color: !lambda |-
                  const std::string condition = id(weather_last_condition);
                  ESP_LOGD("weather_color", "Applying color for condition: '%s'", condition.c_str());
                  if (condition.find("clear-night") != std::string::npos) {
                    ESP_LOGD("weather_color", "Setting Slate Blue color (night)");
                    return lv_color_hex(0x6A5ACD);
                  } else if (condition.find("sunny") != std::string::npos || condition.find("clear") != std::string::npos) {
                    ESP_LOGD("weather_color", "Setting Gold color");
                    return lv_color_hex(0xFFD700);
                  } else if (condition.find("snowy-rainy") != std::string::npos) {
                    ESP_LOGD("weather_color", "Setting Light Cyan color (mixed precipitation)");
                    return lv_color_hex(0xAFEEEE);
                  } else if (condition.find("lightning-rainy") != std::string::npos || condition.find("lightning") != std::string::npos) {
                    ESP_LOGD("weather_color", "Setting Deep Pink color");
                    return lv_color_hex(0xFF1493);
                  } else if (condition.find("partlycloudy") != std::string::npos) {
                    ESP_LOGD("weather_color", "Setting Light Sky Blue color");
                    return lv_color_hex(0x87CEFA);
                  } else if (condition.find("cloudy") != std::string::npos) {
                    ESP_LOGD("weather_color", "Setting Dark Gray color");
                    return lv_color_hex(0xA9A9A9);
                  } else if (condition.find("rainy") != std::string::npos) {
                    ESP_LOGD("weather_color", "Setting Royal Blue color");
                    return lv_color_hex(0x4169E1);
                  } else if (condition.find("snowy") != std::string::npos) {
                    ESP_LOGD("weather_color", "Setting Gainsboro color");
                    return lv_color_hex(0xDCDCDC);
                  } else if (condition.find("fog") != std::string::npos) {
                    ESP_LOGD("weather_color", "Setting Light Steel Blue color");
                    return lv_color_hex(0xB0C4DE);
                  } else if (condition.find("windy") != std::string::npos) {
                    ESP_LOGD("weather_color", "Setting Light Green color");
                    return lv_color_hex(0x90EE90);
                  } else {
                    ESP_LOGD("weather_color", "Setting White color (default)");
                    return lv_color_hex(0xFFFFFF);
                  }
      - lambda: |-
          const uint32_t elapsed = millis() - id(weather_last_started);
          id(weather_last_duration) = elapsed;
          const bool rendered = id(weather_needs_render);
          if (elapsed > 80) {
            ESP_LOGW("weather_color", "update_weather_icon_color took %u ms (rendered=%s)", elapsed, rendered ? "true" : "false");
          } else {
            ESP_LOGD("weather_color", "update_weather_icon_color took %u ms (rendered=%s)", elapsed, rendered ? "true" : "false");
          }
          id(weather_needs_render) = false;

  # ============================================================================
  # WORKAROUND: HTTP-based weather fetch for HA 2025.10.x compatibility
  # ============================================================================
  # ESPHome 2025.10.3's homeassistant.action with capture_response doesn't work
  # with HA 2025.10.x's new weather.get_forecasts action format.
  # GitHub Issue: https://github.com/esphome/issues/issues/XXXXX (to be filed)
  # 
  # This uses direct HTTP calls to HA's REST API instead.
  # Requires: ha_url and ha_token in substitutions
  # 
  # OPTIMIZATION: Split into two scripts for better efficiency
  # - fetch_daily_forecast: Daily forecast (60 min refresh recommended)
  # - fetch_hourly_forecast: Hourly forecast (15 min refresh recommended)
  # ============================================================================

  # Script to fetch DAILY forecast data via HA REST API
  - id: fetch_daily_forecast
    mode: single
    then:
      - lambda: |-
          // Ensure lock is set
          id(weather_fetch_lock) = true;

      - logger.log: "Fetching daily forecast from Home Assistant via HTTP..." 
        
      # Feed watchdog before long operation
      - lambda: |-
          App.feed_wdt();
          ESP_LOGI("weather", "Free heap before daily fetch: %d bytes", esp_get_free_heap_size());
          ESP_LOGD("main", "Fetching daily forecast from Home Assistant via HTTP...");
      # Fetch daily forecast
      - http_request.post:
          url: !lambda |-
            return "${ha_url}/api/services/weather/get_forecasts?return_response=true";
          request_headers:
            Content-Type: application/json
            Authorization: !lambda |-
              return "Bearer ${ha_token}";
          body: !lambda |-
            return "{\"entity_id\":\"${weather_entity_id}\",\"type\":\"daily\"}";
          on_response:
            then:
              - lambda: |-
                  // Feed watchdog at start of processing
                  App.feed_wdt();
                  
                  ESP_LOGI("weather", "Free heap at daily response: %d bytes", esp_get_free_heap_size());
                  
                  // Guard against unexpectedly large payloads (>32KB)
                  if (response->content_length > 32768) {
                    ESP_LOGE("weather", "Daily forecast too large: %d bytes", (int)response->content_length);
                    // Drain the body without storing to keep connection sane
                    uint8_t drain_buf[256];
                    while (response->get_bytes_read() < response->content_length) {
                      int r = response->read(drain_buf, sizeof(drain_buf));
                      if (r <= 0) break;
                      App.feed_wdt();
                    }
                    return;
                  }
                  
                  // Read response body first (for both success and error cases)
                  std::string body_str;
                  // Reserve a smaller amount to reduce fragmentation
                  size_t reserve_sz = response->content_length;
                  if (reserve_sz > 12288) reserve_sz = 12288; // cap to 12KB for daily
                  body_str.reserve(reserve_sz);
                  uint8_t buffer[256];  // Smaller buffer
                  while (response->get_bytes_read() < response->content_length) {
                    int read_len = response->read(buffer, sizeof(buffer));
                    if (read_len > 0) {
                      // Cap body accumulation to 24KB for safety
                      if (body_str.size() + (size_t)read_len > 24576) {
                        ESP_LOGW("weather", "Daily body truncated at %u bytes", (unsigned)body_str.size());
                        break;
                      }
                      body_str.append((char*)buffer, read_len);
                    }
                    // Feed watchdog during long reads
                    if (body_str.length() % 4096 == 0) {
                      App.feed_wdt();
                    }
                  }

                  // response is already provided by ESPHome http_request
                  if (response->status_code != 200) {
                    ESP_LOGE("weather", "✗ Daily forecast HTTP failed: %d", response->status_code);
                    ESP_LOGE("weather", "Error response body: %s", body_str.c_str());
                    return;
                  }

                  ESP_LOGI("weather", "✓ Daily forecast HTTP response received (%d bytes)", body_str.length());
                  ESP_LOGI("weather", "Free heap before daily JSON parse: %d bytes", esp_get_free_heap_size());
                  
                  // Feed watchdog before JSON parsing
                  App.feed_wdt();
                  
                  // Log memory state before JSON parsing (PSRAM vs Internal RAM)
                  ESP_LOGI("memory", "Before JSON parse - Internal RAM free: %d, PSRAM free: %d", 
                           heap_caps_get_free_size(MALLOC_CAP_INTERNAL),
                           heap_caps_get_free_size(MALLOC_CAP_SPIRAM));
                  
                  // CRITICAL: Allocate JsonDocument explicitly from PSRAM to avoid internal RAM pressure
                  // Using heap_caps_malloc with MALLOC_CAP_SPIRAM forces allocation to PSRAM
                  // This keeps the 60KB+ JSON buffer out of limited internal RAM
                  void* json_buffer = heap_caps_malloc(sizeof(JsonDocument), MALLOC_CAP_SPIRAM | MALLOC_CAP_8BIT);
                  if (json_buffer == nullptr) {
                    ESP_LOGE("weather", "Failed to allocate JSON buffer in PSRAM!");
                    return;
                  }
                  JsonDocument *doc = new (json_buffer) JsonDocument;  // Placement new in PSRAM
                  
                  DeserializationError error = deserializeJson(
                      *doc, body_str, DeserializationOption::NestingLimit(10));
                  
                  if (error) {
                    ESP_LOGE("weather", "JSON parse error: %s", error.c_str());
                    doc->~JsonDocument();  // Call destructor
                    heap_caps_free(json_buffer);  // Free PSRAM
                    return;
                  }

                  // Response format: {"service_response": {"weather.hhut": {"forecast": [...]}}}
                  const char *entity_key = "${weather_entity_id}";
                  
                  if (!(*doc)["service_response"].is<JsonObject>()) {
                    ESP_LOGE("weather", "No 'service_response' key in response");
                    doc->~JsonDocument();
                    heap_caps_free(json_buffer);
                    return;
                  }

                  JsonObject service_response = (*doc)["service_response"];
                  
                  if (!service_response[entity_key].is<JsonObject>()) {
                    ESP_LOGE("weather", "Entity '%s' not found in service_response", entity_key);
                    doc->~JsonDocument();
                    heap_caps_free(json_buffer);
                    return;
                  }

                  JsonObject entity_data = service_response[entity_key];
                  
                  if (!entity_data["forecast"].is<JsonArray>()) {
                    ESP_LOGW("weather", "No 'forecast' key in daily response");
                    doc->~JsonDocument();
                    heap_caps_free(json_buffer);
                    return;
                  }

                  JsonArray forecast_array = entity_data["forecast"];
                  int day_count = std::min((int)forecast_array.size(), 10);
                  ESP_LOGI("weather", "Found %d days of forecast data", day_count);
                  
                  // Feed watchdog before processing loop
                  App.feed_wdt();

                  for (int i = 0; i < day_count; i++) {
                    JsonObject day = forecast_array[i];

                    // Feed watchdog every 3 days to prevent timeout during processing
                    if (i > 0 && i % 3 == 0) {
                      App.feed_wdt();
                    }

                    if (day["temperature"].is<float>()) {
                      id(weather_forecast_temp_high)[i] = day["temperature"].as<float>();
                    }

                    if (day["templow"].is<float>()) {
                      id(weather_forecast_temp_low)[i] = day["templow"].as<float>();
                    }

                    if (day["condition"].is<const char*>()) {
                      id(weather_forecast_condition)[i] = day["condition"].as<std::string>();
                    }

                    if (day["precipitation_probability"].is<float>()) {
                      id(weather_forecast_precip_prob)[i] = day["precipitation_probability"].as<float>();
                    }

                    if (day["datetime"].is<const char*>()) {
                      id(weather_forecast_datetime)[i] = day["datetime"].as<std::string>();
                    }

                    // Extract "current" weather from today's forecast (day 0)
                    if (i == 0) {
                      if (day["condition"].is<const char*>()) {
                        id(weather_current_condition) = day["condition"].as<std::string>();
                        ESP_LOGI("weather", "Current condition from forecast: %s", id(weather_current_condition).c_str());
                      }
                    }
                  }
                  ESP_LOGI("weather", "✓ Daily forecast stored successfully");
                  
                  // Clean up PSRAM-allocated JSON document
                  doc->~JsonDocument();  // Call destructor
                  heap_caps_free(json_buffer);  // Free PSRAM buffer
                  
                  ESP_LOGI("weather", "Free heap after parse - Internal: %d, PSRAM: %d", 
                           heap_caps_get_free_size(MALLOC_CAP_INTERNAL),
                           heap_caps_get_free_size(MALLOC_CAP_SPIRAM));
                  
                  // Update daily forecast timestamp
                  id(weather_daily_last_update) = millis();
                  id(weather_last_update) = millis();  // Keep for backward compatibility
                  
              # Small delay to allow memory cleanup
              - delay: 100ms
              
              # Update display after fetching (with delays to prevent SPI contention)
              - script.execute: update_weather_display
              - delay: 50ms
              - script.execute: update_weather_icon_color
              - delay: 50ms
              - script.execute: update_daily_forecast_display

      - lambda: |-
          // Always clear the lock when done (success or failure)
          id(weather_fetch_lock) = false;

  # Script to fetch HOURLY forecast data via HA REST API
  - id: fetch_hourly_forecast
    mode: single
    then:
      - lambda: |-
          // Ensure lock is set
          id(weather_fetch_lock) = true;

      - logger.log: "Fetching hourly forecast from Home Assistant via HTTP..."
      
      # Feed watchdog before long operation
      - lambda: |-      
          App.feed_wdt();
          ESP_LOGI("weather", "Free heap before fetch: %d bytes", esp_get_free_heap_size());
          ESP_LOGD("main", "Fetching hourly forecast from Home Assistant via HTTP...");

      # Fetch hourly forecast
      - http_request.post:
          url: !lambda |-
            return "${ha_url}/api/services/weather/get_forecasts?return_response=true";
          request_headers:
            Content-Type: application/json
            Authorization: !lambda |-
              return "Bearer ${ha_token}";
          body: !lambda |-
            return "{\"entity_id\":\"${weather_entity_id}\",\"type\":\"hourly\"}";
          on_response:
            then:
              - lambda: |-
                  // Feed watchdog at start of processing
                  App.feed_wdt();
                  
                  ESP_LOGI("weather", "Free heap at response: %d bytes", esp_get_free_heap_size());
                  
                  // Read response body first (for both success and error cases)
                  std::string body_str;
                  // Reserve a smaller amount to reduce memory pressure
                  size_t reserve_sz2 = response->content_length;
                  if (reserve_sz2 > 16384) reserve_sz2 = 16384; // cap to 16KB for hourly
                  body_str.reserve(reserve_sz2);
                  uint8_t buffer[256];  // Smaller buffer to reduce stack usage
                  while (response->get_bytes_read() < response->content_length) {
                    int read_len = response->read(buffer, sizeof(buffer));
                    if (read_len > 0) {
                      body_str.append((char*)buffer, read_len);
                    }
                    // Feed watchdog during long reads
                    if (body_str.length() % 4096 == 0) {
                      App.feed_wdt();
                    }
                  }

                  // response is already provided by ESPHome http_request
                  if (response->status_code != 200) {
                    ESP_LOGE("weather", "✗ Hourly forecast HTTP failed: %d", response->status_code);
                    ESP_LOGE("weather", "Error response body: %s", body_str.c_str());
                    return;
                  }

                  ESP_LOGI("weather", "✓ Hourly forecast HTTP response received (%d bytes)", body_str.length());
                  
                  // Feed watchdog before JSON parsing
                  App.feed_wdt();
                  
                  // Log memory state before JSON parsing (PSRAM vs Internal RAM)
                  ESP_LOGI("memory", "Before hourly JSON parse - Internal RAM free: %d, PSRAM free: %d", 
                           heap_caps_get_free_size(MALLOC_CAP_INTERNAL),
                           heap_caps_get_free_size(MALLOC_CAP_SPIRAM));
                  
                  // CRITICAL FIX: Allocate JsonDocument explicitly from PSRAM to prevent stack overflow
                  // The 57KB JSON payload would overflow the stack if allocated there
                  // Using heap_caps_malloc forces allocation to 8MB PSRAM instead of limited internal RAM
                  void* json_buffer = heap_caps_malloc(sizeof(JsonDocument), MALLOC_CAP_SPIRAM | MALLOC_CAP_8BIT);
                  if (json_buffer == nullptr) {
                    ESP_LOGE("weather", "Failed to allocate JSON buffer in PSRAM!");
                    return;
                  }
                  JsonDocument *doc = new (json_buffer) JsonDocument;  // Placement new in PSRAM
                  
                  DeserializationError error = deserializeJson(
                      *doc, body_str, DeserializationOption::NestingLimit(10));
                  
                  if (error) {
                    ESP_LOGE("weather", "JSON parse error: %s", error.c_str());
                    doc->~JsonDocument();  // Call destructor
                    heap_caps_free(json_buffer);  // Free PSRAM
                    return;
                  }

                  // Response format: {"service_response": {"weather.hhut": {"forecast": [...]}}}
                  const char *entity_key = "${weather_entity_id}";
                  
                  if (!(*doc)["service_response"].is<JsonObject>()) {
                    ESP_LOGE("weather", "No 'service_response' key in response");
                    doc->~JsonDocument();
                    heap_caps_free(json_buffer);
                    return;
                  }

                  JsonObject service_response = (*doc)["service_response"];
                  
                  if (!service_response[entity_key].is<JsonObject>()) {
                    ESP_LOGE("weather", "Entity '%s' not found in service_response", entity_key);
                    doc->~JsonDocument();
                    heap_caps_free(json_buffer);
                    return;
                  }

                  JsonObject entity_data = service_response[entity_key];
                  
                  if (!entity_data["forecast"].is<JsonArray>()) {
                    ESP_LOGW("weather", "No 'forecast' key in hourly response");
                    doc->~JsonDocument();
                    heap_caps_free(json_buffer);
                    return;
                  }

                  JsonArray forecast_array = entity_data["forecast"];
                  int hour_count = std::min((int)forecast_array.size(), 24);
                  ESP_LOGI("weather", "Found %d hours of forecast data", hour_count);
                  
                  // Feed watchdog before processing loop
                  App.feed_wdt();

                  for (int i = 0; i < hour_count; i++) {
                    JsonObject hour = forecast_array[i];

                    // Feed watchdog every 6 hours to prevent timeout during processing
                    if (i > 0 && i % 6 == 0) {
                      App.feed_wdt();
                    }

                    if (hour["temperature"].is<float>()) {
                      id(weather_hourly_temp)[i] = hour["temperature"].as<float>();
                    }

                    if (hour["apparent_temperature"].is<float>()) {
                      id(weather_hourly_apparent_temp)[i] = hour["apparent_temperature"].as<float>();
                    }

                    if (hour["condition"].is<const char*>()) {
                      id(weather_hourly_condition)[i] = hour["condition"].as<std::string>();
                    }

                    if (hour["precipitation_probability"].is<float>()) {
                      id(weather_hourly_precip_prob)[i] = hour["precipitation_probability"].as<float>();
                    }

                    if (hour["datetime"].is<const char*>()) {
                      id(weather_hourly_datetime)[i] = hour["datetime"].as<std::string>();
                    }

                    // Additional hourly data fields
                    if (hour["humidity"].is<float>()) {
                      id(weather_hourly_humidity)[i] = hour["humidity"].as<float>();
                    }

                    if (hour["precipitation"].is<float>()) {
                      id(weather_hourly_precipitation)[i] = hour["precipitation"].as<float>();
                    }

                    if (hour["pressure"].is<float>()) {
                      id(weather_hourly_pressure)[i] = hour["pressure"].as<float>();
                    }

                    if (hour["uv_index"].is<float>()) {
                      id(weather_hourly_uv_index)[i] = hour["uv_index"].as<float>();
                    }

                    if (hour["wind_speed"].is<float>()) {
                      id(weather_hourly_wind_speed)[i] = hour["wind_speed"].as<float>();
                    }

                    if (hour["wind_bearing"].is<float>()) {
                      id(weather_hourly_wind_bearing)[i] = hour["wind_bearing"].as<float>();
                    }
                  }
                  ESP_LOGI("weather", "✓ Hourly forecast stored successfully");

                  // Clean up PSRAM-allocated JSON document to free memory
                  doc->~JsonDocument();  // Call destructor
                  heap_caps_free(json_buffer);  // Free PSRAM buffer
                  
                  ESP_LOGI("memory", "After hourly parse - Internal RAM: %d, PSRAM: %d", 
                           heap_caps_get_free_size(MALLOC_CAP_INTERNAL),
                           heap_caps_get_free_size(MALLOC_CAP_SPIRAM));
                  ESP_LOGI("weather", "✓ JSON document cleaned up");

                  // Update hourly forecast timestamp
                  id(weather_hourly_last_update) = millis();
                  id(weather_last_update) = millis();  // Keep for backward compatibility

              # Small delay to allow memory to be freed before display update
              - delay: 100ms

              # Update display after fetching (only if on hourly forecast page)
              # With lazy loading, page-specific on_load handlers will update when navigated to
              - if:
                  condition:
                    lambda: 'return id(current_page_name) == "hourly_forecast";'
                  then:
                    - script.execute: update_hourly_page_1  # Update page 1 if currently viewing
  
      - lambda: |-
          // Always clear the lock when done (success or failure)
          id(weather_fetch_lock) = false;
  # Legacy script for backward compatibility - fetches both
  - id: fetch_weather_data
    mode: single
    then:
      - logger.log: "Fetching both daily and hourly forecasts..."
      - script.execute: fetch_daily_forecast
      - script.wait: fetch_daily_forecast
      - delay: 500ms  # Brief pause between fetches
      - script.execute: fetch_hourly_forecast

  # Script to update LVGL display with fetched data
  - id: update_weather_display
    mode: single
    then:
      # Skip if not on weather page (index 3) to reduce SPI traffic
      - if:
          condition:
            lambda: 'return id(current_page_name) != "weather";'
          then:
            - logger.log: "Skipping weather display update (not on page 3)"
            - script.stop: update_weather_display
      # Update main weather page labels
      - lvgl.label.update:
          id: lbl_weather_today_header
          text: !lambda |-
            if (id(weather_forecast_datetime)[0].empty()) return std::string("Today");
            std::string dt = id(weather_forecast_datetime)[0];
            if (dt.length() >= 19) {
                    int year = std::stoi(dt.substr(0, 4));
                    int month = std::stoi(dt.substr(5, 2));
                    int day = std::stoi(dt.substr(8, 2));
                    int hour = std::stoi(dt.substr(11, 2));
                    
                    if (dt.length() >= 25 && (dt[19] == '+' || dt[19] == '-')) {
                      int offset_hours = std::stoi(dt.substr(20, 2));
                      if (dt[19] == '-') offset_hours = -offset_hours;
                      
                      // Get local time to calculate timezone offset
                      auto now = id(sntp_time).now();
                      if (now.is_valid()) {
                        // Calculate local offset by comparing UTC hour with local hour
                        time_t utc_time = now.timestamp;
                        struct tm *utc_tm = gmtime(&utc_time);
                        struct tm *local_tm = localtime(&utc_time);
                        
                        int utc_hour = utc_tm->tm_hour;
                        int local_hour = local_tm->tm_hour;
                        int local_offset = local_hour - utc_hour;
                        
                        // Handle day boundary crossing in offset calculation
                        if (local_offset > 12) local_offset -= 24;
                        if (local_offset < -12) local_offset += 24;
                        
                        hour += (local_offset - offset_hours);
                        
                        if (hour < 0) {
                          day--;
                          if (day < 1) {
                            month--;
                            if (month < 1) {
                              month = 12;
                              year--;
                            }
                            int days_in_month[] = {31,28,31,30,31,30,31,31,30,31,30,31};
                            if (month == 2 && (year % 4 == 0 && (year % 100 != 0 || year % 400 == 0))) {
                              day = 29;
                            } else {
                              day = days_in_month[month-1];
                            }
                          }
                        } else if (hour >= 24) {
                          day++;
                          int days_in_month[] = {31,28,31,30,31,30,31,31,30,31,30,31};
                          int max_days = days_in_month[month-1];
                          if (month == 2 && (year % 4 == 0 && (year % 100 != 0 || year % 400 == 0))) {
                            max_days = 29;
                          }
                          if (day > max_days) {
                            day = 1;
                            month++;
                            if (month > 12) {
                              month = 1;
                              year++;
                            }
                          }
                        }
                      }
                    }
                    
                    char buf[32];
                    snprintf(buf, sizeof(buf), "Today (%02d/%02d)", month, day);
                    return std::string(buf);
                  }
                  return std::string("Today");
      - lvgl.label.update:
          id: lbl_weather_forecast_condition_name
          text: !lambda |-
            if (id(weather_current_condition).empty()) {
              return std::string("Unknown");
            }
            // Format condition text to be more readable
            std::string condition = id(weather_current_condition);
            if (condition == "clear-night") return std::string("Clear Night");
            if (condition == "cloudy") return std::string("Cloudy");
            if (condition == "exceptional") return std::string("Exceptional");
            if (condition == "fog") return std::string("Fog");
            if (condition == "hail") return std::string("Hail");
            if (condition == "lightning") return std::string("Lightning");
            if (condition == "lightning-rainy") return std::string("Lightning & Rain");
            if (condition == "partlycloudy") return std::string("Partly Cloudy");
            if (condition == "pouring") return std::string("Pouring");
            if (condition == "rainy") return std::string("Rainy");
            if (condition == "snowy") return std::string("Snowy");
            if (condition == "snowy-rainy") return std::string("Sleet");
            if (condition == "sunny") return std::string("Sunny");
            if (condition == "windy") return std::string("Windy");
            if (condition == "windy-variant") return std::string("Windy Windy");
            // Return capitalized version if not matched
            if (!condition.empty()) {
              condition[0] = toupper(condition[0]);
            }
            return condition;

      - lvgl.label.update:
          id: lbl_weather_today_outdoor_temp
          text: !lambda |-
            if (isnan(id(weather_current_temp))) {
              return std::string("--.- °F");
            }
            char buf[16];
            snprintf(buf, sizeof(buf), "%.1f °F", id(weather_current_temp));
            return std::string(buf);

      - lvgl.label.update:
          id: lbl_weather_today_tempap
          text: !lambda |-
            if (isnan(id(weather_current_apparent_temp))) {
              return std::string("--°");
            }
            char buf[16];
            snprintf(buf, sizeof(buf), "%.0f°", id(weather_current_apparent_temp));
            return std::string(buf);

      - lvgl.label.update:
          id: lbl_weather_forecast_temphi
          text: !lambda |-
            if (isnan(id(weather_forecast_temp_high)[0])) {
              return std::string("H: --°");
            }
            char buf[16];
            snprintf(buf, sizeof(buf), "H: %.0f°", id(weather_forecast_temp_high)[0]);
            return std::string(buf);

      - lvgl.label.update:
          id: lbl_weather_forecast_templo
          text: !lambda |-
            if (isnan(id(weather_forecast_temp_low)[0])) {
              return std::string("L: --°");
            }
            char buf[16];
            snprintf(buf, sizeof(buf), "L: %.0f°", id(weather_forecast_temp_low)[0]);
            return std::string(buf);

      - lvgl.label.update:
          id: lbl_weather_today_dailyprecipprob
          text: !lambda |-
            if (isnan(id(weather_forecast_precip_prob)[0])) {
              return std::string("Chance: --%");
            }
            char buf[32];
            snprintf(buf, sizeof(buf), "Chance: %.0f%%", id(weather_forecast_precip_prob)[0]);
            return std::string(buf);

      - lvgl.label.update:
          id: lbl_wind_speed
          text: !lambda |-
            if (std::isnan(id(wind_speed_sensor).state)) return std::string("-- mph");
            char buf_ws[24];
            snprintf(buf_ws, sizeof(buf_ws), "%.0f mph", id(wind_speed_sensor).state);
            return std::string(buf_ws);
      - lvgl.label.update:
          id: lbl_wind_direction_text
          text: !lambda |-
            float b = id(wind_direction_sensor).state;
            if (std::isnan(b)) return std::string("--");
            const char* dir;
            if (b >= 337.5 || b < 22.5) dir = "N";
            else if (b >= 22.5 && b < 67.5) dir = "NE";
            else if (b >= 67.5 && b < 112.5) dir = "E";
            else if (b >= 112.5 && b < 157.5) dir = "SE";
            else if (b >= 157.5 && b < 202.5) dir = "S";
            else if (b >= 202.5 && b < 247.5) dir = "SW";
            else if (b >= 247.5 && b < 292.5) dir = "W";
            else dir = "NW";
            return std::string(dir);
      - lvgl.indicator.update:
          id: wind_compass_needle
          value: !lambda |-
            float b = id(wind_direction_sensor).state;
            if (std::isnan(b)) return 0;
            return (int)b;

      # Calculate and update weather gauge percentage locally
      # Formula: ((apparent - low) / (high - low)) * 100
      # This replaces the need for a Home Assistant template sensor
      - lambda: |-
          float apparent = id(weather_current_apparent_temp);
          float high = id(weather_forecast_temp_high)[0];
          float low = id(weather_forecast_temp_low)[0];
          
          // Only calculate if we have valid values
          if (!isnan(apparent) && !isnan(high) && !isnan(low)) {
            float range = high - low;
            
            // Prevent division by zero
            if (range == 0) {
              range = 1.0;
            }
            
            // Calculate percentage
            float pct = ((apparent - low) / range) * 100.0;
            
            // Clamp between 0 and 100
            if (pct < 0) pct = 0;
            if (pct > 100) pct = 100;
            
            // Round to nearest integer
            int gauge_value = (int)(pct + 0.5);
            
            // Update the gauge
            auto call = id(weather_gauge_value).make_call();
            call.set_value(gauge_value);
            call.perform();
            
            ESP_LOGI("weather", "Gauge calculation: apparent=%.1f, high=%.1f, low=%.1f, pct=%d%%", 
                     apparent, high, low, gauge_value);
          } else {
            ESP_LOGW("weather", "Cannot calculate gauge value - missing data (apparent=%.1f, high=%.1f, low=%.1f)", 
                     apparent, high, low);
          }

      - logger.log: "✓ Weather display labels updated (page 3)"
      # NOTE: Hourly and daily forecast updates are now handled by their respective
      # page on_load handlers to prevent stack overflow from deep call chains

  # ============================================================================
  # HOURLY FORECAST PAGE UPDATE SCRIPTS - Lazy Loading Implementation
  # ============================================================================
  # These scripts update only the labels for their specific page to prevent
  # stack overflow. Each page's on_load handler calls its corresponding script.
  #
  # Page distribution:
  #   - Page 1: Hours 1-3
  #   - Page 2: Hours 4-6
  #   - Page 3: Hours 7-9
  #   - Page 4: Hours 10-12
  #   - Page 5: Hours 13-15
  #   - Page 6: Hours 16-24
  # ============================================================================

  # Update script for Page 1 (Hours 1-3)
  - id: update_hourly_page_1
    mode: single
    then:
      - lambda: 'App.feed_wdt();'
      - logger.log: "Updating hourly forecast page 1 (hours 1-3)..."
      
      - lvgl.label.update:
          id: lbl_hourly_hour1_header
          text: !lambda |-
            using namespace weather_helpers;
            if (id(weather_hourly_datetime)[0].empty()) return std::string("Hour +1");
            auto now = id(sntp_time).now();
            if (!now.is_valid()) return std::string("Hour +1");
            int hour = convert_to_local_hour(id(weather_hourly_datetime)[0], now.timezone_offset());
            return format_hour(hour);
      
      - lvgl.label.update:
          id: lbl_hourly_hour1_icon
          text: !lambda |-
            using namespace weather_helpers;
            return get_weather_icon(id(weather_hourly_condition)[0]);
          text_color: !lambda |-
            using namespace weather_helpers;
            return lv_color_hex(get_weather_icon_color(id(weather_hourly_condition)[0]));
      
      - lvgl.label.update:
          id: lbl_hourly_hour1_temp
          text: !lambda 'return weather_helpers::format_temp(id(weather_hourly_temp)[0]);'
      
      - lvgl.label.update:
          id: lbl_hourly_hour1_feels
          text: !lambda 'return weather_helpers::format_temp(id(weather_hourly_apparent_temp)[0]);'
      
      - lvgl.label.update:
          id: lbl_hourly_hour1_precip
          text: !lambda 'return weather_helpers::format_percent(id(weather_hourly_precip_prob)[0]);'
      
      - lvgl.label.update:
          id: lbl_hourly_hour1_humid
          text: !lambda 'return weather_helpers::format_percent(id(weather_hourly_humidity)[0]);'
      
      - lvgl.label.update:
          id: lbl_hourly_hour1_precip_amt
          text: !lambda 'return weather_helpers::format_precipitation(id(weather_hourly_precipitation)[0]);'
      
      - lvgl.label.update:
          id: lbl_hourly_hour1_pressure
          text: !lambda 'return weather_helpers::format_numeric(id(weather_hourly_pressure)[0]);'
      
      - lvgl.label.update:
          id: lbl_hourly_hour1_uv
          text: !lambda 'return weather_helpers::format_numeric(id(weather_hourly_uv_index)[0]);'
      
      - lvgl.label.update:
          id: lbl_hourly_hour1_wind
          text: !lambda |-
            if (std::isnan(id(weather_hourly_wind_speed)[0])) return std::string("--");
            char buf[16];
            snprintf(buf, sizeof(buf), "%.0f mph", id(weather_hourly_wind_speed)[0]);
            return std::string(buf);
      
      - lvgl.label.update:
          id: lbl_hourly_hour1_wind_dir
          text: !lambda 'return weather_helpers::bearing_to_direction(id(weather_hourly_wind_bearing)[0]);'

      # Stack unwind: delay + watchdog feed to prevent overflow
      - delay: 50ms
      - lambda: 'App.feed_wdt();'

      # Update Hour 2
      - lvgl.label.update:
          id: lbl_hourly_hour2_header
          text: !lambda |-
            using namespace weather_helpers;
            if (id(weather_hourly_datetime)[1].empty()) return std::string("Hour +2");
            auto now = id(sntp_time).now();
            if (!now.is_valid()) return std::string("Hour +2");
            int hour = convert_to_local_hour(id(weather_hourly_datetime)[1], now.timezone_offset());
            return format_hour(hour);

      - lvgl.label.update:
          id: lbl_hourly_hour2_icon
          text: !lambda |-
            using namespace weather_helpers;
            return get_weather_icon(id(weather_hourly_condition)[1]);
          text_color: !lambda |-
            using namespace weather_helpers;
            return lv_color_hex(get_weather_icon_color(id(weather_hourly_condition)[1]));

      - lvgl.label.update:
          id: lbl_hourly_hour2_temp
          text: !lambda 'return weather_helpers::format_temp(id(weather_hourly_temp)[1]);'

      - lvgl.label.update:
          id: lbl_hourly_hour2_feels
          text: !lambda 'return weather_helpers::format_temp(id(weather_hourly_apparent_temp)[1]);'

      - lvgl.label.update:
          id: lbl_hourly_hour2_precip
          text: !lambda 'return weather_helpers::format_percent(id(weather_hourly_precip_prob)[1]);'

      - lvgl.label.update:
          id: lbl_hourly_hour2_humid
          text: !lambda 'return weather_helpers::format_percent(id(weather_hourly_humidity)[1]);'

      - lvgl.label.update:
          id: lbl_hourly_hour2_precip_amt
          text: !lambda 'return weather_helpers::format_precipitation(id(weather_hourly_precipitation)[1]);'

      - lvgl.label.update:
          id: lbl_hourly_hour2_pressure
          text: !lambda 'return weather_helpers::format_numeric(id(weather_hourly_pressure)[1]);'

      - lvgl.label.update:
          id: lbl_hourly_hour2_uv
          text: !lambda 'return weather_helpers::format_numeric(id(weather_hourly_uv_index)[1]);'

      - lvgl.label.update:
          id: lbl_hourly_hour2_wind
          text: !lambda |-
            if (std::isnan(id(weather_hourly_wind_speed)[1])) return std::string("--");
            char buf[16];
            snprintf(buf, sizeof(buf), "%.0f mph", id(weather_hourly_wind_speed)[1]);
            return std::string(buf);

      - lvgl.label.update:
          id: lbl_hourly_hour2_wind_dir
          text: !lambda 'return weather_helpers::bearing_to_direction(id(weather_hourly_wind_bearing)[1]);'

      # Stack unwind: delay + watchdog feed to prevent overflow
      - delay: 50ms
      - lambda: 'App.feed_wdt();'

      # Update Hour 3
      - lvgl.label.update:
          id: lbl_hourly_hour3_header
          text: !lambda |-
            using namespace weather_helpers;
            if (id(weather_hourly_datetime)[2].empty()) return std::string("Hour +3");
            auto now = id(sntp_time).now();
            if (!now.is_valid()) return std::string("Hour +3");
            int hour = convert_to_local_hour(id(weather_hourly_datetime)[2], now.timezone_offset());
            return format_hour(hour);

      - lvgl.label.update:
          id: lbl_hourly_hour3_icon
          text: !lambda |-
            using namespace weather_helpers;
            return get_weather_icon(id(weather_hourly_condition)[2]);
          text_color: !lambda |-
            using namespace weather_helpers;
            return lv_color_hex(get_weather_icon_color(id(weather_hourly_condition)[2]));

      - lvgl.label.update:
          id: lbl_hourly_hour3_temp
          text: !lambda 'return weather_helpers::format_temp(id(weather_hourly_temp)[2]);'

      - lvgl.label.update:
          id: lbl_hourly_hour3_feels
          text: !lambda 'return weather_helpers::format_temp(id(weather_hourly_apparent_temp)[2]);'

      - lvgl.label.update:
          id: lbl_hourly_hour3_precip
          text: !lambda 'return weather_helpers::format_percent(id(weather_hourly_precip_prob)[2]);'

      - lvgl.label.update:
          id: lbl_hourly_hour3_humid
          text: !lambda 'return weather_helpers::format_percent(id(weather_hourly_humidity)[2]);'

      - lvgl.label.update:
          id: lbl_hourly_hour3_precip_amt
          text: !lambda 'return weather_helpers::format_precipitation(id(weather_hourly_precipitation)[2]);'

      - lvgl.label.update:
          id: lbl_hourly_hour3_pressure
          text: !lambda 'return weather_helpers::format_numeric(id(weather_hourly_pressure)[2]);'

      - lvgl.label.update:
          id: lbl_hourly_hour3_uv
          text: !lambda 'return weather_helpers::format_numeric(id(weather_hourly_uv_index)[2]);'

      - lvgl.label.update:
          id: lbl_hourly_hour3_wind
          text: !lambda |-
            if (std::isnan(id(weather_hourly_wind_speed)[2])) return std::string("--");
            char buf[16];
            snprintf(buf, sizeof(buf), "%.0f mph", id(weather_hourly_wind_speed)[2]);
            return std::string(buf);

      - lvgl.label.update:
          id: lbl_hourly_hour3_wind_dir
          text: !lambda 'return weather_helpers::bearing_to_direction(id(weather_hourly_wind_bearing)[2]);'

      - delay: 50ms
      - lambda: 'App.feed_wdt();'
      - logger.log: "✓ Hourly page 1 (hours 1-3) updated successfully"

  # Update script for Page 2 (Hours 4-6)
  - id: update_hourly_page_2
    mode: single
    then:
      - lambda: 'App.feed_wdt();'
      - logger.log: "Updating hourly forecast page 2 (hours 4-6)..."

      # Update Hour 4
      - lvgl.label.update:
          id: lbl_hourly_hour4_header
          text: !lambda |-
            using namespace weather_helpers;
            if (id(weather_hourly_datetime)[3].empty()) return std::string("Hour +4");
            auto now = id(sntp_time).now();
            if (!now.is_valid()) return std::string("Hour +4");
            int hour = convert_to_local_hour(id(weather_hourly_datetime)[3], now.timezone_offset());
            return format_hour(hour);

      - lvgl.label.update:
          id: lbl_hourly_hour4_icon
          text: !lambda |-
            using namespace weather_helpers;
            return get_weather_icon(id(weather_hourly_condition)[3]);
          text_color: !lambda |-
            using namespace weather_helpers;
            return lv_color_hex(get_weather_icon_color(id(weather_hourly_condition)[3]));

      - lvgl.label.update:
          id: lbl_hourly_hour4_temp
          text: !lambda 'return weather_helpers::format_temp(id(weather_hourly_temp)[3]);'

      - lvgl.label.update:
          id: lbl_hourly_hour4_feels
          text: !lambda 'return weather_helpers::format_temp(id(weather_hourly_apparent_temp)[3]);'

      - lvgl.label.update:
          id: lbl_hourly_hour4_precip
          text: !lambda 'return weather_helpers::format_percent(id(weather_hourly_precip_prob)[3]);'

      - lvgl.label.update:
          id: lbl_hourly_hour4_humid
          text: !lambda 'return weather_helpers::format_percent(id(weather_hourly_humidity)[3]);'

      - lvgl.label.update:
          id: lbl_hourly_hour4_precip_amt
          text: !lambda 'return weather_helpers::format_precipitation(id(weather_hourly_precipitation)[3]);'

      - lvgl.label.update:
          id: lbl_hourly_hour4_pressure
          text: !lambda 'return weather_helpers::format_numeric(id(weather_hourly_pressure)[3]);'

      - lvgl.label.update:
          id: lbl_hourly_hour4_uv
          text: !lambda 'return weather_helpers::format_numeric(id(weather_hourly_uv_index)[3]);'

      - lvgl.label.update:
          id: lbl_hourly_hour4_wind
          text: !lambda |-
            if (std::isnan(id(weather_hourly_wind_speed)[3])) return std::string("--");
            char buf[16];
            snprintf(buf, sizeof(buf), "%.0f mph", id(weather_hourly_wind_speed)[3]);
            return std::string(buf);

      - lvgl.label.update:
          id: lbl_hourly_hour4_wind_dir
          text: !lambda 'return weather_helpers::bearing_to_direction(id(weather_hourly_wind_bearing)[3]);'

      - delay: 50ms
      - lambda: 'App.feed_wdt();'

      # Update Hour 5
      - lvgl.label.update:
          id: lbl_hourly_hour5_header
          text: !lambda |-
            using namespace weather_helpers;
            if (id(weather_hourly_datetime)[4].empty()) return std::string("Hour +5");
            auto now = id(sntp_time).now();
            if (!now.is_valid()) return std::string("Hour +5");
            int hour = convert_to_local_hour(id(weather_hourly_datetime)[4], now.timezone_offset());
            return format_hour(hour);

      - lvgl.label.update:
          id: lbl_hourly_hour5_icon
          text: !lambda |-
            using namespace weather_helpers;
            return get_weather_icon(id(weather_hourly_condition)[4]);
          text_color: !lambda |-
            using namespace weather_helpers;
            return lv_color_hex(get_weather_icon_color(id(weather_hourly_condition)[4]));

      - lvgl.label.update:
          id: lbl_hourly_hour5_temp
          text: !lambda 'return weather_helpers::format_temp(id(weather_hourly_temp)[4]);'

      - lvgl.label.update:
          id: lbl_hourly_hour5_feels
          text: !lambda 'return weather_helpers::format_temp(id(weather_hourly_apparent_temp)[4]);'

      - lvgl.label.update:
          id: lbl_hourly_hour5_precip
          text: !lambda 'return weather_helpers::format_percent(id(weather_hourly_precip_prob)[4]);'

      - lvgl.label.update:
          id: lbl_hourly_hour5_humid
          text: !lambda 'return weather_helpers::format_percent(id(weather_hourly_humidity)[4]);'

      - lvgl.label.update:
          id: lbl_hourly_hour5_precip_amt
          text: !lambda 'return weather_helpers::format_precipitation(id(weather_hourly_precipitation)[4]);'

      - lvgl.label.update:
          id: lbl_hourly_hour5_pressure
          text: !lambda 'return weather_helpers::format_numeric(id(weather_hourly_pressure)[4]);'

      - lvgl.label.update:
          id: lbl_hourly_hour5_uv
          text: !lambda 'return weather_helpers::format_numeric(id(weather_hourly_uv_index)[4]);'

      - lvgl.label.update:
          id: lbl_hourly_hour5_wind
          text: !lambda |-
            if (std::isnan(id(weather_hourly_wind_speed)[4])) return std::string("--");
            char buf[16];
            snprintf(buf, sizeof(buf), "%.0f mph", id(weather_hourly_wind_speed)[4]);
            return std::string(buf);

      - lvgl.label.update:
          id: lbl_hourly_hour5_wind_dir
          text: !lambda 'return weather_helpers::bearing_to_direction(id(weather_hourly_wind_bearing)[4]);'

      - delay: 50ms
      - lambda: 'App.feed_wdt();'

      # Update Hour 6
      - lvgl.label.update:
          id: lbl_hourly_hour6_header
          text: !lambda |-
            using namespace weather_helpers;
            if (id(weather_hourly_datetime)[5].empty()) return std::string("Hour +6");
            auto now = id(sntp_time).now();
            if (!now.is_valid()) return std::string("Hour +6");
            int hour = convert_to_local_hour(id(weather_hourly_datetime)[5], now.timezone_offset());
            return format_hour(hour);

      - lvgl.label.update:
          id: lbl_hourly_hour6_icon
          text: !lambda |-
            using namespace weather_helpers;
            return get_weather_icon(id(weather_hourly_condition)[5]);
          text_color: !lambda |-
            using namespace weather_helpers;
            return lv_color_hex(get_weather_icon_color(id(weather_hourly_condition)[5]));

      - lvgl.label.update:
          id: lbl_hourly_hour6_temp
          text: !lambda 'return weather_helpers::format_temp(id(weather_hourly_temp)[5]);'

      - lvgl.label.update:
          id: lbl_hourly_hour6_feels
          text: !lambda 'return weather_helpers::format_temp(id(weather_hourly_apparent_temp)[5]);'

      - lvgl.label.update:
          id: lbl_hourly_hour6_precip
          text: !lambda 'return weather_helpers::format_percent(id(weather_hourly_precip_prob)[5]);'

      - lvgl.label.update:
          id: lbl_hourly_hour6_humid
          text: !lambda 'return weather_helpers::format_percent(id(weather_hourly_humidity)[5]);'

      - lvgl.label.update:
          id: lbl_hourly_hour6_precip_amt
          text: !lambda 'return weather_helpers::format_precipitation(id(weather_hourly_precipitation)[5]);'

      - lvgl.label.update:
          id: lbl_hourly_hour6_pressure
          text: !lambda 'return weather_helpers::format_numeric(id(weather_hourly_pressure)[5]);'

      - lvgl.label.update:
          id: lbl_hourly_hour6_uv
          text: !lambda 'return weather_helpers::format_numeric(id(weather_hourly_uv_index)[5]);'

      - lvgl.label.update:
          id: lbl_hourly_hour6_wind
          text: !lambda |-
            if (std::isnan(id(weather_hourly_wind_speed)[5])) return std::string("--");
            char buf[16];
            snprintf(buf, sizeof(buf), "%.0f mph", id(weather_hourly_wind_speed)[5]);
            return std::string(buf);

      - lvgl.label.update:
          id: lbl_hourly_hour6_wind_dir
          text: !lambda 'return weather_helpers::bearing_to_direction(id(weather_hourly_wind_bearing)[5]);'

      - delay: 50ms
      - lambda: 'App.feed_wdt();'
      - logger.log: "✓ Hourly page 2 (hours 4-6) updated successfully"

  # Update script for Page 3 (Hours 7-9)
  - id: update_hourly_page_3
    mode: single
    then:
      - lambda: 'App.feed_wdt();'
      - logger.log: "Updating hourly forecast page 3 (hours 7-9)..."

      # Update Hour 7
      - lvgl.label.update:
          id: lbl_hourly_hour7_header
          text: !lambda |-
            using namespace weather_helpers;
            if (id(weather_hourly_datetime)[6].empty()) return std::string("Hour +7");
            auto now = id(sntp_time).now();
            if (!now.is_valid()) return std::string("Hour +7");
            int hour = convert_to_local_hour(id(weather_hourly_datetime)[6], now.timezone_offset());
            return format_hour(hour);

      - lvgl.label.update:
          id: lbl_hourly_hour7_icon
          text: !lambda |-
            using namespace weather_helpers;
            return get_weather_icon(id(weather_hourly_condition)[6]);
          text_color: !lambda |-
            using namespace weather_helpers;
            return lv_color_hex(get_weather_icon_color(id(weather_hourly_condition)[6]));

      - lvgl.label.update:
          id: lbl_hourly_hour7_temp
          text: !lambda 'return weather_helpers::format_temp(id(weather_hourly_temp)[6]);'

      - lvgl.label.update:
          id: lbl_hourly_hour7_feels
          text: !lambda 'return weather_helpers::format_temp(id(weather_hourly_apparent_temp)[6]);'

      - lvgl.label.update:
          id: lbl_hourly_hour7_precip
          text: !lambda 'return weather_helpers::format_percent(id(weather_hourly_precip_prob)[6]);'

      - lvgl.label.update:
          id: lbl_hourly_hour7_humid
          text: !lambda 'return weather_helpers::format_percent(id(weather_hourly_humidity)[6]);'

      - lvgl.label.update:
          id: lbl_hourly_hour7_precip_amt
          text: !lambda 'return weather_helpers::format_precipitation(id(weather_hourly_precipitation)[6]);'

      - lvgl.label.update:
          id: lbl_hourly_hour7_pressure
          text: !lambda 'return weather_helpers::format_numeric(id(weather_hourly_pressure)[6]);'

      - lvgl.label.update:
          id: lbl_hourly_hour7_uv
          text: !lambda 'return weather_helpers::format_numeric(id(weather_hourly_uv_index)[6]);'

      - lvgl.label.update:
          id: lbl_hourly_hour7_wind
          text: !lambda |-
            if (std::isnan(id(weather_hourly_wind_speed)[6])) return std::string("--");
            char buf[16];
            snprintf(buf, sizeof(buf), "%.0f mph", id(weather_hourly_wind_speed)[6]);
            return std::string(buf);

      - lvgl.label.update:
          id: lbl_hourly_hour7_wind_dir
          text: !lambda 'return weather_helpers::bearing_to_direction(id(weather_hourly_wind_bearing)[6]);'

      - delay: 50ms
      - lambda: 'App.feed_wdt();'

      # Update Hour 8
      - lvgl.label.update:
          id: lbl_hourly_hour8_header
          text: !lambda |-
            using namespace weather_helpers;
            if (id(weather_hourly_datetime)[7].empty()) return std::string("Hour +8");
            auto now = id(sntp_time).now();
            if (!now.is_valid()) return std::string("Hour +8");
            int hour = convert_to_local_hour(id(weather_hourly_datetime)[7], now.timezone_offset());
            return format_hour(hour);

      - lvgl.label.update:
          id: lbl_hourly_hour8_icon
          text: !lambda |-
            using namespace weather_helpers;
            return get_weather_icon(id(weather_hourly_condition)[7]);
          text_color: !lambda |-
            using namespace weather_helpers;
            return lv_color_hex(get_weather_icon_color(id(weather_hourly_condition)[7]));

      - lvgl.label.update:
          id: lbl_hourly_hour8_temp
          text: !lambda 'return weather_helpers::format_temp(id(weather_hourly_temp)[7]);'

      - lvgl.label.update:
          id: lbl_hourly_hour8_feels
          text: !lambda 'return weather_helpers::format_temp(id(weather_hourly_apparent_temp)[7]);'

      - lvgl.label.update:
          id: lbl_hourly_hour8_precip
          text: !lambda 'return weather_helpers::format_percent(id(weather_hourly_precip_prob)[7]);'

      - lvgl.label.update:
          id: lbl_hourly_hour8_humid
          text: !lambda 'return weather_helpers::format_percent(id(weather_hourly_humidity)[7]);'

      - lvgl.label.update:
          id: lbl_hourly_hour8_precip_amt
          text: !lambda 'return weather_helpers::format_precipitation(id(weather_hourly_precipitation)[7]);'

      - lvgl.label.update:
          id: lbl_hourly_hour8_pressure
          text: !lambda 'return weather_helpers::format_numeric(id(weather_hourly_pressure)[7]);'

      - lvgl.label.update:
          id: lbl_hourly_hour8_uv
          text: !lambda 'return weather_helpers::format_numeric(id(weather_hourly_uv_index)[7]);'

      - lvgl.label.update:
          id: lbl_hourly_hour8_wind
          text: !lambda |-
            if (std::isnan(id(weather_hourly_wind_speed)[7])) return std::string("--");
            char buf[16];
            snprintf(buf, sizeof(buf), "%.0f mph", id(weather_hourly_wind_speed)[7]);
            return std::string(buf);

      - lvgl.label.update:
          id: lbl_hourly_hour8_wind_dir
          text: !lambda 'return weather_helpers::bearing_to_direction(id(weather_hourly_wind_bearing)[7]);'

      - delay: 50ms
      - lambda: 'App.feed_wdt();'

      # Update Hour 9
      - lvgl.label.update:
          id: lbl_hourly_hour9_header
          text: !lambda |-
            using namespace weather_helpers;
            if (id(weather_hourly_datetime)[8].empty()) return std::string("Hour +9");
            auto now = id(sntp_time).now();
            if (!now.is_valid()) return std::string("Hour +9");
            int hour = convert_to_local_hour(id(weather_hourly_datetime)[8], now.timezone_offset());
            return format_hour(hour);

      - lvgl.label.update:
          id: lbl_hourly_hour9_icon
          text: !lambda |-
            using namespace weather_helpers;
            return get_weather_icon(id(weather_hourly_condition)[8]);
          text_color: !lambda |-
            using namespace weather_helpers;
            return lv_color_hex(get_weather_icon_color(id(weather_hourly_condition)[8]));

      - lvgl.label.update:
          id: lbl_hourly_hour9_temp
          text: !lambda 'return weather_helpers::format_temp(id(weather_hourly_temp)[8]);'

      - lvgl.label.update:
          id: lbl_hourly_hour9_feels
          text: !lambda 'return weather_helpers::format_temp(id(weather_hourly_apparent_temp)[8]);'

      - lvgl.label.update:
          id: lbl_hourly_hour9_precip
          text: !lambda 'return weather_helpers::format_percent(id(weather_hourly_precip_prob)[8]);'

      - lvgl.label.update:
          id: lbl_hourly_hour9_humid
          text: !lambda 'return weather_helpers::format_percent(id(weather_hourly_humidity)[8]);'

      - lvgl.label.update:
          id: lbl_hourly_hour9_precip_amt
          text: !lambda 'return weather_helpers::format_precipitation(id(weather_hourly_precipitation)[8]);'

      - lvgl.label.update:
          id: lbl_hourly_hour9_pressure
          text: !lambda 'return weather_helpers::format_numeric(id(weather_hourly_pressure)[8]);'

      - lvgl.label.update:
          id: lbl_hourly_hour9_uv
          text: !lambda 'return weather_helpers::format_numeric(id(weather_hourly_uv_index)[8]);'

      - lvgl.label.update:
          id: lbl_hourly_hour9_wind
          text: !lambda |-
            if (std::isnan(id(weather_hourly_wind_speed)[8])) return std::string("--");
            char buf[16];
            snprintf(buf, sizeof(buf), "%.0f mph", id(weather_hourly_wind_speed)[8]);
            return std::string(buf);

      - lvgl.label.update:
          id: lbl_hourly_hour9_wind_dir
          text: !lambda 'return weather_helpers::bearing_to_direction(id(weather_hourly_wind_bearing)[8]);'

      - delay: 50ms
      - lambda: 'App.feed_wdt();'
      - logger.log: "✓ Hourly page 3 (hours 7-9) updated successfully"

  # Update script for Page 4 (Hours 10-12)
  - id: update_hourly_page_4
    mode: single
    then:
      - lambda: 'App.feed_wdt();'
      - logger.log: "Updating hourly forecast page 4 (hours 10-12)..."

      # Update Hour 10
      - lvgl.label.update:
          id: lbl_hourly_hour10_header
          text: !lambda |-
            using namespace weather_helpers;
            if (id(weather_hourly_datetime)[9].empty()) return std::string("Hour +10");
            auto now = id(sntp_time).now();
            if (!now.is_valid()) return std::string("Hour +10");
            int hour = convert_to_local_hour(id(weather_hourly_datetime)[9], now.timezone_offset());
            return format_hour(hour);

      - lvgl.label.update:
          id: lbl_hourly_hour10_icon
          text: !lambda |-
            using namespace weather_helpers;
            return get_weather_icon(id(weather_hourly_condition)[9]);
          text_color: !lambda |-
            using namespace weather_helpers;
            return lv_color_hex(get_weather_icon_color(id(weather_hourly_condition)[9]));

      - lvgl.label.update:
          id: lbl_hourly_hour10_temp
          text: !lambda 'return weather_helpers::format_temp(id(weather_hourly_temp)[9]);'

      - lvgl.label.update:
          id: lbl_hourly_hour10_feels
          text: !lambda 'return weather_helpers::format_temp(id(weather_hourly_apparent_temp)[9]);'

      - lvgl.label.update:
          id: lbl_hourly_hour10_precip
          text: !lambda 'return weather_helpers::format_percent(id(weather_hourly_precip_prob)[9]);'

      - lvgl.label.update:
          id: lbl_hourly_hour10_humid
          text: !lambda 'return weather_helpers::format_percent(id(weather_hourly_humidity)[9]);'

      - lvgl.label.update:
          id: lbl_hourly_hour10_precip_amt
          text: !lambda 'return weather_helpers::format_precipitation(id(weather_hourly_precipitation)[9]);'

      - lvgl.label.update:
          id: lbl_hourly_hour10_pressure
          text: !lambda 'return weather_helpers::format_numeric(id(weather_hourly_pressure)[9]);'

      - lvgl.label.update:
          id: lbl_hourly_hour10_uv
          text: !lambda 'return weather_helpers::format_numeric(id(weather_hourly_uv_index)[9]);'

      - lvgl.label.update:
          id: lbl_hourly_hour10_wind
          text: !lambda |-
            if (std::isnan(id(weather_hourly_wind_speed)[9])) return std::string("--");
            char buf[16];
            snprintf(buf, sizeof(buf), "%.0f mph", id(weather_hourly_wind_speed)[9]);
            return std::string(buf);

      - lvgl.label.update:
          id: lbl_hourly_hour10_wind_dir
          text: !lambda 'return weather_helpers::bearing_to_direction(id(weather_hourly_wind_bearing)[9]);'

      - delay: 50ms
      - lambda: 'App.feed_wdt();'

      # Update Hour 11
      - lvgl.label.update:
          id: lbl_hourly_hour11_header
          text: !lambda |-
            using namespace weather_helpers;
            if (id(weather_hourly_datetime)[10].empty()) return std::string("Hour +11");
            auto now = id(sntp_time).now();
            if (!now.is_valid()) return std::string("Hour +11");
            int hour = convert_to_local_hour(id(weather_hourly_datetime)[10], now.timezone_offset());
            return format_hour(hour);

      - lvgl.label.update:
          id: lbl_hourly_hour11_icon
          text: !lambda |-
            using namespace weather_helpers;
            return get_weather_icon(id(weather_hourly_condition)[10]);
          text_color: !lambda |-
            using namespace weather_helpers;
            return lv_color_hex(get_weather_icon_color(id(weather_hourly_condition)[10]));

      - lvgl.label.update:
          id: lbl_hourly_hour11_temp
          text: !lambda 'return weather_helpers::format_temp(id(weather_hourly_temp)[10]);'

      - lvgl.label.update:
          id: lbl_hourly_hour11_feels
          text: !lambda 'return weather_helpers::format_temp(id(weather_hourly_apparent_temp)[10]);'

      - lvgl.label.update:
          id: lbl_hourly_hour11_precip
          text: !lambda 'return weather_helpers::format_percent(id(weather_hourly_precip_prob)[10]);'

      - lvgl.label.update:
          id: lbl_hourly_hour11_humid
          text: !lambda 'return weather_helpers::format_percent(id(weather_hourly_humidity)[10]);'

      - lvgl.label.update:
          id: lbl_hourly_hour11_precip_amt
          text: !lambda 'return weather_helpers::format_precipitation(id(weather_hourly_precipitation)[10]);'

      - lvgl.label.update:
          id: lbl_hourly_hour11_pressure
          text: !lambda 'return weather_helpers::format_numeric(id(weather_hourly_pressure)[10]);'

      - lvgl.label.update:
          id: lbl_hourly_hour11_uv
          text: !lambda 'return weather_helpers::format_numeric(id(weather_hourly_uv_index)[10]);'

      - lvgl.label.update:
          id: lbl_hourly_hour11_wind
          text: !lambda |-
            if (std::isnan(id(weather_hourly_wind_speed)[10])) return std::string("--");
            char buf[16];
            snprintf(buf, sizeof(buf), "%.0f mph", id(weather_hourly_wind_speed)[10]);
            return std::string(buf);

      - lvgl.label.update:
          id: lbl_hourly_hour11_wind_dir
          text: !lambda 'return weather_helpers::bearing_to_direction(id(weather_hourly_wind_bearing)[10]);'

      - delay: 50ms
      - lambda: 'App.feed_wdt();'

      # Update Hour 12
      - lvgl.label.update:
          id: lbl_hourly_hour12_header
          text: !lambda |-
            using namespace weather_helpers;
            if (id(weather_hourly_datetime)[11].empty()) return std::string("Hour +12");
            auto now = id(sntp_time).now();
            if (!now.is_valid()) return std::string("Hour +12");
            int hour = convert_to_local_hour(id(weather_hourly_datetime)[11], now.timezone_offset());
            return format_hour(hour);

      - lvgl.label.update:
          id: lbl_hourly_hour12_icon
          text: !lambda |-
            using namespace weather_helpers;
            return get_weather_icon(id(weather_hourly_condition)[11]);
          text_color: !lambda |-
            using namespace weather_helpers;
            return lv_color_hex(get_weather_icon_color(id(weather_hourly_condition)[11]));

      - lvgl.label.update:
          id: lbl_hourly_hour12_temp
          text: !lambda 'return weather_helpers::format_temp(id(weather_hourly_temp)[11]);'

      - lvgl.label.update:
          id: lbl_hourly_hour12_feels
          text: !lambda 'return weather_helpers::format_temp(id(weather_hourly_apparent_temp)[11]);'

      - lvgl.label.update:
          id: lbl_hourly_hour12_precip
          text: !lambda 'return weather_helpers::format_percent(id(weather_hourly_precip_prob)[11]);'

      - lvgl.label.update:
          id: lbl_hourly_hour12_humid
          text: !lambda 'return weather_helpers::format_percent(id(weather_hourly_humidity)[11]);'

      - lvgl.label.update:
          id: lbl_hourly_hour12_precip_amt
          text: !lambda 'return weather_helpers::format_precipitation(id(weather_hourly_precipitation)[11]);'

      - lvgl.label.update:
          id: lbl_hourly_hour12_pressure
          text: !lambda 'return weather_helpers::format_numeric(id(weather_hourly_pressure)[11]);'

      - lvgl.label.update:
          id: lbl_hourly_hour12_uv
          text: !lambda 'return weather_helpers::format_numeric(id(weather_hourly_uv_index)[11]);'

      - lvgl.label.update:
          id: lbl_hourly_hour12_wind
          text: !lambda |-
            if (std::isnan(id(weather_hourly_wind_speed)[11])) return std::string("--");
            char buf[16];
            snprintf(buf, sizeof(buf), "%.0f mph", id(weather_hourly_wind_speed)[11]);
            return std::string(buf);

      - lvgl.label.update:
          id: lbl_hourly_hour12_wind_dir
          text: !lambda 'return weather_helpers::bearing_to_direction(id(weather_hourly_wind_bearing)[11]);'

      - delay: 50ms
      - lambda: 'App.feed_wdt();'
      - logger.log: "✓ Hourly page 4 (hours 10-12) updated successfully"

  # Update script for Page 5 (Hours 13-15)
  - id: update_hourly_page_5
    mode: single
    then:
      - lambda: 'App.feed_wdt();'
      - logger.log: "Updating hourly forecast page 5 (hours 13-15)..."

      # Update Hour 13
      - lvgl.label.update:
          id: lbl_hourly_hour13_header
          text: !lambda |-
            using namespace weather_helpers;
            if (id(weather_hourly_datetime)[12].empty()) return std::string("Hour +13");
            auto now = id(sntp_time).now();
            if (!now.is_valid()) return std::string("Hour +13");
            int hour = convert_to_local_hour(id(weather_hourly_datetime)[12], now.timezone_offset());
            return format_hour(hour);

      - lvgl.label.update:
          id: lbl_hourly_hour13_icon
          text: !lambda |-
            using namespace weather_helpers;
            return get_weather_icon(id(weather_hourly_condition)[12]);
          text_color: !lambda |-
            using namespace weather_helpers;
            return lv_color_hex(get_weather_icon_color(id(weather_hourly_condition)[12]));

      - lvgl.label.update:
          id: lbl_hourly_hour13_temp
          text: !lambda 'return weather_helpers::format_temp(id(weather_hourly_temp)[12]);'

      - lvgl.label.update:
          id: lbl_hourly_hour13_feels
          text: !lambda 'return weather_helpers::format_temp(id(weather_hourly_apparent_temp)[12]);'

      - lvgl.label.update:
          id: lbl_hourly_hour13_precip
          text: !lambda 'return weather_helpers::format_percent(id(weather_hourly_precip_prob)[12]);'

      - lvgl.label.update:
          id: lbl_hourly_hour13_humid
          text: !lambda 'return weather_helpers::format_percent(id(weather_hourly_humidity)[12]);'

      - lvgl.label.update:
          id: lbl_hourly_hour13_precip_amt
          text: !lambda 'return weather_helpers::format_precipitation(id(weather_hourly_precipitation)[12]);'

      - lvgl.label.update:
          id: lbl_hourly_hour13_pressure
          text: !lambda 'return weather_helpers::format_numeric(id(weather_hourly_pressure)[12]);'

      - lvgl.label.update:
          id: lbl_hourly_hour13_uv
          text: !lambda 'return weather_helpers::format_numeric(id(weather_hourly_uv_index)[12]);'

      - lvgl.label.update:
          id: lbl_hourly_hour13_wind
          text: !lambda |-
            if (std::isnan(id(weather_hourly_wind_speed)[12])) return std::string("--");
            char buf[16];
            snprintf(buf, sizeof(buf), "%.0f mph", id(weather_hourly_wind_speed)[12]);
            return std::string(buf);

      - lvgl.label.update:
          id: lbl_hourly_hour13_wind_dir
          text: !lambda 'return weather_helpers::bearing_to_direction(id(weather_hourly_wind_bearing)[12]);'

      - delay: 50ms
      - lambda: 'App.feed_wdt();'

      # Update Hour 14
      - lvgl.label.update:
          id: lbl_hourly_hour14_header
          text: !lambda |-
            using namespace weather_helpers;
            if (id(weather_hourly_datetime)[13].empty()) return std::string("Hour +14");
            auto now = id(sntp_time).now();
            if (!now.is_valid()) return std::string("Hour +14");
            int hour = convert_to_local_hour(id(weather_hourly_datetime)[13], now.timezone_offset());
            return format_hour(hour);

      - lvgl.label.update:
          id: lbl_hourly_hour14_icon
          text: !lambda |-
            using namespace weather_helpers;
            return get_weather_icon(id(weather_hourly_condition)[13]);
          text_color: !lambda |-
            using namespace weather_helpers;
            return lv_color_hex(get_weather_icon_color(id(weather_hourly_condition)[13]));

      - lvgl.label.update:
          id: lbl_hourly_hour14_temp
          text: !lambda 'return weather_helpers::format_temp(id(weather_hourly_temp)[13]);'

      - lvgl.label.update:
          id: lbl_hourly_hour14_feels
          text: !lambda 'return weather_helpers::format_temp(id(weather_hourly_apparent_temp)[13]);'

      - lvgl.label.update:
          id: lbl_hourly_hour14_precip
          text: !lambda 'return weather_helpers::format_percent(id(weather_hourly_precip_prob)[13]);'

      - lvgl.label.update:
          id: lbl_hourly_hour14_humid
          text: !lambda 'return weather_helpers::format_percent(id(weather_hourly_humidity)[13]);'

      - lvgl.label.update:
          id: lbl_hourly_hour14_precip_amt
          text: !lambda 'return weather_helpers::format_precipitation(id(weather_hourly_precipitation)[13]);'

      - lvgl.label.update:
          id: lbl_hourly_hour14_pressure
          text: !lambda 'return weather_helpers::format_numeric(id(weather_hourly_pressure)[13]);'

      - lvgl.label.update:
          id: lbl_hourly_hour14_uv
          text: !lambda 'return weather_helpers::format_numeric(id(weather_hourly_uv_index)[13]);'

      - lvgl.label.update:
          id: lbl_hourly_hour14_wind
          text: !lambda |-
            if (std::isnan(id(weather_hourly_wind_speed)[13])) return std::string("--");
            char buf[16];
            snprintf(buf, sizeof(buf), "%.0f mph", id(weather_hourly_wind_speed)[13]);
            return std::string(buf);

      - lvgl.label.update:
          id: lbl_hourly_hour14_wind_dir
          text: !lambda 'return weather_helpers::bearing_to_direction(id(weather_hourly_wind_bearing)[13]);'

      - delay: 50ms
      - lambda: 'App.feed_wdt();'

      # Update Hour 15
      - lvgl.label.update:
          id: lbl_hourly_hour15_header
          text: !lambda |-
            using namespace weather_helpers;
            if (id(weather_hourly_datetime)[14].empty()) return std::string("Hour +15");
            auto now = id(sntp_time).now();
            if (!now.is_valid()) return std::string("Hour +15");
            int hour = convert_to_local_hour(id(weather_hourly_datetime)[14], now.timezone_offset());
            return format_hour(hour);

      - lvgl.label.update:
          id: lbl_hourly_hour15_icon
          text: !lambda |-
            using namespace weather_helpers;
            return get_weather_icon(id(weather_hourly_condition)[14]);
          text_color: !lambda |-
            using namespace weather_helpers;
            return lv_color_hex(get_weather_icon_color(id(weather_hourly_condition)[14]));

      - lvgl.label.update:
          id: lbl_hourly_hour15_temp
          text: !lambda 'return weather_helpers::format_temp(id(weather_hourly_temp)[14]);'

      - lvgl.label.update:
          id: lbl_hourly_hour15_feels
          text: !lambda 'return weather_helpers::format_temp(id(weather_hourly_apparent_temp)[14]);'

      - lvgl.label.update:
          id: lbl_hourly_hour15_precip
          text: !lambda 'return weather_helpers::format_percent(id(weather_hourly_precip_prob)[14]);'

      - lvgl.label.update:
          id: lbl_hourly_hour15_humid
          text: !lambda 'return weather_helpers::format_percent(id(weather_hourly_humidity)[14]);'

      - lvgl.label.update:
          id: lbl_hourly_hour15_precip_amt
          text: !lambda 'return weather_helpers::format_precipitation(id(weather_hourly_precipitation)[14]);'

      - lvgl.label.update:
          id: lbl_hourly_hour15_pressure
          text: !lambda 'return weather_helpers::format_numeric(id(weather_hourly_pressure)[14]);'

      - lvgl.label.update:
          id: lbl_hourly_hour15_uv
          text: !lambda 'return weather_helpers::format_numeric(id(weather_hourly_uv_index)[14]);'

      - lvgl.label.update:
          id: lbl_hourly_hour15_wind
          text: !lambda |-
            if (std::isnan(id(weather_hourly_wind_speed)[14])) return std::string("--");
            char buf[16];
            snprintf(buf, sizeof(buf), "%.0f mph", id(weather_hourly_wind_speed)[14]);
            return std::string(buf);

      - lvgl.label.update:
          id: lbl_hourly_hour15_wind_dir
          text: !lambda 'return weather_helpers::bearing_to_direction(id(weather_hourly_wind_bearing)[14]);'

      - delay: 50ms
      - lambda: 'App.feed_wdt();'
      - logger.log: "✓ Hourly page 5 (hours 13-15) updated successfully"

  # Update script for Page 6 (Hours 16-24)
  - id: update_hourly_page_6
    mode: single
    then:
      - lambda: 'App.feed_wdt();'
      - logger.log: "Updating hourly forecast page 6 (hours 16-18)..."

      # Update Hour 16
      - lvgl.label.update:
          id: lbl_hourly_hour16_header
          text: !lambda |-
            using namespace weather_helpers;
            if (id(weather_hourly_datetime)[15].empty()) return std::string("Hour +16");
            auto now = id(sntp_time).now();
            if (!now.is_valid()) return std::string("Hour +16");
            int hour = convert_to_local_hour(id(weather_hourly_datetime)[15], now.timezone_offset());
            return format_hour(hour);

      - lvgl.label.update:
          id: lbl_hourly_hour16_icon
          text: !lambda |-
            using namespace weather_helpers;
            return get_weather_icon(id(weather_hourly_condition)[15]);
          text_color: !lambda |-
            using namespace weather_helpers;
            return lv_color_hex(get_weather_icon_color(id(weather_hourly_condition)[15]));

      - lvgl.label.update:
          id: lbl_hourly_hour16_temp
          text: !lambda 'return weather_helpers::format_temp(id(weather_hourly_temp)[15]);'

      - lvgl.label.update:
          id: lbl_hourly_hour16_feels
          text: !lambda 'return weather_helpers::format_temp(id(weather_hourly_apparent_temp)[15]);'

      - lvgl.label.update:
          id: lbl_hourly_hour16_precip
          text: !lambda 'return weather_helpers::format_percent(id(weather_hourly_precip_prob)[15]);'

      - lvgl.label.update:
          id: lbl_hourly_hour16_humid
          text: !lambda 'return weather_helpers::format_percent(id(weather_hourly_humidity)[15]);'

      - lvgl.label.update:
          id: lbl_hourly_hour16_precip_amt
          text: !lambda 'return weather_helpers::format_precipitation(id(weather_hourly_precipitation)[15]);'

      - lvgl.label.update:
          id: lbl_hourly_hour16_pressure
          text: !lambda 'return weather_helpers::format_numeric(id(weather_hourly_pressure)[15]);'

      - lvgl.label.update:
          id: lbl_hourly_hour16_uv
          text: !lambda 'return weather_helpers::format_numeric(id(weather_hourly_uv_index)[15]);'

      - lvgl.label.update:
          id: lbl_hourly_hour16_wind
          text: !lambda |-
            if (std::isnan(id(weather_hourly_wind_speed)[15])) return std::string("--");
            char buf[16];
            snprintf(buf, sizeof(buf), "%.0f mph", id(weather_hourly_wind_speed)[15]);
            return std::string(buf);

      - lvgl.label.update:
          id: lbl_hourly_hour16_wind_dir
          text: !lambda 'return weather_helpers::bearing_to_direction(id(weather_hourly_wind_bearing)[15]);'

      - delay: 50ms
      - lambda: 'App.feed_wdt();'

      # Update Hour 17
      - lvgl.label.update:
          id: lbl_hourly_hour17_header
          text: !lambda |-
            using namespace weather_helpers;
            if (id(weather_hourly_datetime)[16].empty()) return std::string("Hour +17");
            auto now = id(sntp_time).now();
            if (!now.is_valid()) return std::string("Hour +17");
            int hour = convert_to_local_hour(id(weather_hourly_datetime)[16], now.timezone_offset());
            return format_hour(hour);

      - lvgl.label.update:
          id: lbl_hourly_hour17_icon
          text: !lambda |-
            using namespace weather_helpers;
            return get_weather_icon(id(weather_hourly_condition)[16]);
          text_color: !lambda |-
            using namespace weather_helpers;
            return lv_color_hex(get_weather_icon_color(id(weather_hourly_condition)[16]));

      - lvgl.label.update:
          id: lbl_hourly_hour17_temp
          text: !lambda 'return weather_helpers::format_temp(id(weather_hourly_temp)[16]);'

      - lvgl.label.update:
          id: lbl_hourly_hour17_feels
          text: !lambda 'return weather_helpers::format_temp(id(weather_hourly_apparent_temp)[16]);'

      - lvgl.label.update:
          id: lbl_hourly_hour17_precip
          text: !lambda 'return weather_helpers::format_percent(id(weather_hourly_precip_prob)[16]);'

      - lvgl.label.update:
          id: lbl_hourly_hour17_humid
          text: !lambda 'return weather_helpers::format_percent(id(weather_hourly_humidity)[16]);'

      - lvgl.label.update:
          id: lbl_hourly_hour17_precip_amt
          text: !lambda 'return weather_helpers::format_precipitation(id(weather_hourly_precipitation)[16]);'

      - lvgl.label.update:
          id: lbl_hourly_hour17_pressure
          text: !lambda 'return weather_helpers::format_numeric(id(weather_hourly_pressure)[16]);'

      - lvgl.label.update:
          id: lbl_hourly_hour17_uv
          text: !lambda 'return weather_helpers::format_numeric(id(weather_hourly_uv_index)[16]);'

      - lvgl.label.update:
          id: lbl_hourly_hour17_wind
          text: !lambda |-
            if (std::isnan(id(weather_hourly_wind_speed)[16])) return std::string("--");
            char buf[16];
            snprintf(buf, sizeof(buf), "%.0f mph", id(weather_hourly_wind_speed)[16]);
            return std::string(buf);

      - lvgl.label.update:
          id: lbl_hourly_hour17_wind_dir
          text: !lambda 'return weather_helpers::bearing_to_direction(id(weather_hourly_wind_bearing)[16]);'

      - delay: 50ms
      - lambda: 'App.feed_wdt();'

      # Update Hour 18
      - lvgl.label.update:
          id: lbl_hourly_hour18_header
          text: !lambda |-
            using namespace weather_helpers;
            if (id(weather_hourly_datetime)[17].empty()) return std::string("Hour +18");
            auto now = id(sntp_time).now();
            if (!now.is_valid()) return std::string("Hour +18");
            int hour = convert_to_local_hour(id(weather_hourly_datetime)[17], now.timezone_offset());
            return format_hour(hour);

      - lvgl.label.update:
          id: lbl_hourly_hour18_icon
          text: !lambda |-
            using namespace weather_helpers;
            return get_weather_icon(id(weather_hourly_condition)[17]);
          text_color: !lambda |-
            using namespace weather_helpers;
            return lv_color_hex(get_weather_icon_color(id(weather_hourly_condition)[17]));

      - lvgl.label.update:
          id: lbl_hourly_hour18_temp
          text: !lambda 'return weather_helpers::format_temp(id(weather_hourly_temp)[17]);'

      - lvgl.label.update:
          id: lbl_hourly_hour18_feels
          text: !lambda 'return weather_helpers::format_temp(id(weather_hourly_apparent_temp)[17]);'

      - lvgl.label.update:
          id: lbl_hourly_hour18_precip
          text: !lambda 'return weather_helpers::format_percent(id(weather_hourly_precip_prob)[17]);'

      - lvgl.label.update:
          id: lbl_hourly_hour18_humid
          text: !lambda 'return weather_helpers::format_percent(id(weather_hourly_humidity)[17]);'

      - lvgl.label.update:
          id: lbl_hourly_hour18_precip_amt
          text: !lambda 'return weather_helpers::format_precipitation(id(weather_hourly_precipitation)[17]);'

      - lvgl.label.update:
          id: lbl_hourly_hour18_pressure
          text: !lambda 'return weather_helpers::format_numeric(id(weather_hourly_pressure)[17]);'

      - lvgl.label.update:
          id: lbl_hourly_hour18_uv
          text: !lambda 'return weather_helpers::format_numeric(id(weather_hourly_uv_index)[17]);'

      - lvgl.label.update:
          id: lbl_hourly_hour18_wind
          text: !lambda |-
            if (std::isnan(id(weather_hourly_wind_speed)[17])) return std::string("--");
            char buf[16];
            snprintf(buf, sizeof(buf), "%.0f mph", id(weather_hourly_wind_speed)[17]);
            return std::string(buf);

      - lvgl.label.update:
          id: lbl_hourly_hour18_wind_dir
          text: !lambda 'return weather_helpers::bearing_to_direction(id(weather_hourly_wind_bearing)[17]);'

      - delay: 50ms
      - lambda: 'App.feed_wdt();'

      - delay: 50ms
      - lambda: 'App.feed_wdt();'
      - logger.log: "✓ Hourly page 6 (hours 16-18) updated successfully"


  # Update script for Page 7 (Hours 19-21)
  - id: update_hourly_page_7
    mode: single
    then:
      - lambda: 'App.feed_wdt();'
      - logger.log: "Updating hourly forecast page 7 (hours 19-21)..."
      # Update Hour 19
      - lvgl.label.update:
          id: lbl_hourly_hour19_header
          text: !lambda |-
            using namespace weather_helpers;
            if (id(weather_hourly_datetime)[18].empty()) return std::string("Hour +19");
            auto now = id(sntp_time).now();
            if (!now.is_valid()) return std::string("Hour +19");
            int hour = convert_to_local_hour(id(weather_hourly_datetime)[18], now.timezone_offset());
            return format_hour(hour);

      - lvgl.label.update:
          id: lbl_hourly_hour19_icon
          text: !lambda |-
            using namespace weather_helpers;
            return get_weather_icon(id(weather_hourly_condition)[18]);
          text_color: !lambda |-
            using namespace weather_helpers;
            return lv_color_hex(get_weather_icon_color(id(weather_hourly_condition)[18]));

      - lvgl.label.update:
          id: lbl_hourly_hour19_temp
          text: !lambda 'return weather_helpers::format_temp(id(weather_hourly_temp)[18]);'

      - lvgl.label.update:
          id: lbl_hourly_hour19_feels
          text: !lambda 'return weather_helpers::format_temp(id(weather_hourly_apparent_temp)[18]);'

      - lvgl.label.update:
          id: lbl_hourly_hour19_precip
          text: !lambda 'return weather_helpers::format_percent(id(weather_hourly_precip_prob)[18]);'

      - lvgl.label.update:
          id: lbl_hourly_hour19_humid
          text: !lambda 'return weather_helpers::format_percent(id(weather_hourly_humidity)[18]);'

      - lvgl.label.update:
          id: lbl_hourly_hour19_precip_amt
          text: !lambda 'return weather_helpers::format_precipitation(id(weather_hourly_precipitation)[18]);'

      - lvgl.label.update:
          id: lbl_hourly_hour19_pressure
          text: !lambda 'return weather_helpers::format_numeric(id(weather_hourly_pressure)[18]);'

      - lvgl.label.update:
          id: lbl_hourly_hour19_uv
          text: !lambda 'return weather_helpers::format_numeric(id(weather_hourly_uv_index)[18]);'

      - lvgl.label.update:
          id: lbl_hourly_hour19_wind
          text: !lambda |-
            if (std::isnan(id(weather_hourly_wind_speed)[18])) return std::string("--");
            char buf[16];
            snprintf(buf, sizeof(buf), "%.0f mph", id(weather_hourly_wind_speed)[18]);
            return std::string(buf);

      - lvgl.label.update:
          id: lbl_hourly_hour19_wind_dir
          text: !lambda 'return weather_helpers::bearing_to_direction(id(weather_hourly_wind_bearing)[18]);'

      - delay: 50ms
      - lambda: 'App.feed_wdt();'

      # Update Hour 20
      - lvgl.label.update:
          id: lbl_hourly_hour20_header
          text: !lambda |-
            using namespace weather_helpers;
            if (id(weather_hourly_datetime)[19].empty()) return std::string("Hour +20");
            auto now = id(sntp_time).now();
            if (!now.is_valid()) return std::string("Hour +20");
            int hour = convert_to_local_hour(id(weather_hourly_datetime)[19], now.timezone_offset());
            return format_hour(hour);

      - lvgl.label.update:
          id: lbl_hourly_hour20_icon
          text: !lambda |-
            using namespace weather_helpers;
            return get_weather_icon(id(weather_hourly_condition)[19]);
          text_color: !lambda |-
            using namespace weather_helpers;
            return lv_color_hex(get_weather_icon_color(id(weather_hourly_condition)[19]));

      - lvgl.label.update:
          id: lbl_hourly_hour20_temp
          text: !lambda 'return weather_helpers::format_temp(id(weather_hourly_temp)[19]);'

      - lvgl.label.update:
          id: lbl_hourly_hour20_feels
          text: !lambda 'return weather_helpers::format_temp(id(weather_hourly_apparent_temp)[19]);'

      - lvgl.label.update:
          id: lbl_hourly_hour20_precip
          text: !lambda 'return weather_helpers::format_percent(id(weather_hourly_precip_prob)[19]);'

      - lvgl.label.update:
          id: lbl_hourly_hour20_humid
          text: !lambda 'return weather_helpers::format_percent(id(weather_hourly_humidity)[19]);'

      - lvgl.label.update:
          id: lbl_hourly_hour20_precip_amt
          text: !lambda 'return weather_helpers::format_precipitation(id(weather_hourly_precipitation)[19]);'

      - lvgl.label.update:
          id: lbl_hourly_hour20_pressure
          text: !lambda 'return weather_helpers::format_numeric(id(weather_hourly_pressure)[19]);'

      - lvgl.label.update:
          id: lbl_hourly_hour20_uv
          text: !lambda 'return weather_helpers::format_numeric(id(weather_hourly_uv_index)[19]);'

      - lvgl.label.update:
          id: lbl_hourly_hour20_wind
          text: !lambda |-
            if (std::isnan(id(weather_hourly_wind_speed)[19])) return std::string("--");
            char buf[16];
            snprintf(buf, sizeof(buf), "%.0f mph", id(weather_hourly_wind_speed)[19]);
            return std::string(buf);

      - lvgl.label.update:
          id: lbl_hourly_hour20_wind_dir
          text: !lambda 'return weather_helpers::bearing_to_direction(id(weather_hourly_wind_bearing)[19]);'

      - delay: 50ms
      - lambda: 'App.feed_wdt();'

      # Update Hour 21
      - lvgl.label.update:
          id: lbl_hourly_hour21_header
          text: !lambda |-
            using namespace weather_helpers;
            if (id(weather_hourly_datetime)[20].empty()) return std::string("Hour +21");
            auto now = id(sntp_time).now();
            if (!now.is_valid()) return std::string("Hour +21");
            int hour = convert_to_local_hour(id(weather_hourly_datetime)[20], now.timezone_offset());
            return format_hour(hour);

      - lvgl.label.update:
          id: lbl_hourly_hour21_icon
          text: !lambda |-
            using namespace weather_helpers;
            return get_weather_icon(id(weather_hourly_condition)[20]);
          text_color: !lambda |-
            using namespace weather_helpers;
            return lv_color_hex(get_weather_icon_color(id(weather_hourly_condition)[20]));

      - lvgl.label.update:
          id: lbl_hourly_hour21_temp
          text: !lambda 'return weather_helpers::format_temp(id(weather_hourly_temp)[20]);'

      - lvgl.label.update:
          id: lbl_hourly_hour21_feels
          text: !lambda 'return weather_helpers::format_temp(id(weather_hourly_apparent_temp)[20]);'

      - lvgl.label.update:
          id: lbl_hourly_hour21_precip
          text: !lambda 'return weather_helpers::format_percent(id(weather_hourly_precip_prob)[20]);'

      - lvgl.label.update:
          id: lbl_hourly_hour21_humid
          text: !lambda 'return weather_helpers::format_percent(id(weather_hourly_humidity)[20]);'

      - lvgl.label.update:
          id: lbl_hourly_hour21_precip_amt
          text: !lambda 'return weather_helpers::format_precipitation(id(weather_hourly_precipitation)[20]);'

      - lvgl.label.update:
          id: lbl_hourly_hour21_pressure
          text: !lambda 'return weather_helpers::format_numeric(id(weather_hourly_pressure)[20]);'

      - lvgl.label.update:
          id: lbl_hourly_hour21_uv
          text: !lambda 'return weather_helpers::format_numeric(id(weather_hourly_uv_index)[20]);'

      - lvgl.label.update:
          id: lbl_hourly_hour21_wind
          text: !lambda |-
            if (std::isnan(id(weather_hourly_wind_speed)[20])) return std::string("--");
            char buf[16];
            snprintf(buf, sizeof(buf), "%.0f mph", id(weather_hourly_wind_speed)[20]);
            return std::string(buf);

      - lvgl.label.update:
          id: lbl_hourly_hour21_wind_dir
          text: !lambda 'return weather_helpers::bearing_to_direction(id(weather_hourly_wind_bearing)[20]);'

      - delay: 50ms
      - lambda: 'App.feed_wdt();'


      - delay: 50ms
      - lambda: 'App.feed_wdt();'
      - logger.log: "✓ Hourly page 7 (hours 19-21) updated successfully"


  # Update script for Page 8 (Hours 22-24)
  - id: update_hourly_page_8
    mode: single
    then:
      - lambda: 'App.feed_wdt();'
      - logger.log: "Updating hourly forecast page 8 (hours 22-24)..."
      # Update Hour 22
      - lvgl.label.update:
          id: lbl_hourly_hour22_header
          text: !lambda |-
            using namespace weather_helpers;
            if (id(weather_hourly_datetime)[21].empty()) return std::string("Hour +22");
            auto now = id(sntp_time).now();
            if (!now.is_valid()) return std::string("Hour +22");
            int hour = convert_to_local_hour(id(weather_hourly_datetime)[21], now.timezone_offset());
            return format_hour(hour);

      - lvgl.label.update:
          id: lbl_hourly_hour22_icon
          text: !lambda |-
            using namespace weather_helpers;
            return get_weather_icon(id(weather_hourly_condition)[21]);
          text_color: !lambda |-
            using namespace weather_helpers;
            return lv_color_hex(get_weather_icon_color(id(weather_hourly_condition)[21]));

      - lvgl.label.update:
          id: lbl_hourly_hour22_temp
          text: !lambda 'return weather_helpers::format_temp(id(weather_hourly_temp)[21]);'

      - lvgl.label.update:
          id: lbl_hourly_hour22_feels
          text: !lambda 'return weather_helpers::format_temp(id(weather_hourly_apparent_temp)[21]);'

      - lvgl.label.update:
          id: lbl_hourly_hour22_precip
          text: !lambda 'return weather_helpers::format_percent(id(weather_hourly_precip_prob)[21]);'

      - lvgl.label.update:
          id: lbl_hourly_hour22_humid
          text: !lambda 'return weather_helpers::format_percent(id(weather_hourly_humidity)[21]);'

      - lvgl.label.update:
          id: lbl_hourly_hour22_precip_amt
          text: !lambda 'return weather_helpers::format_precipitation(id(weather_hourly_precipitation)[21]);'

      - lvgl.label.update:
          id: lbl_hourly_hour22_pressure
          text: !lambda 'return weather_helpers::format_numeric(id(weather_hourly_pressure)[21]);'

      - lvgl.label.update:
          id: lbl_hourly_hour22_uv
          text: !lambda 'return weather_helpers::format_numeric(id(weather_hourly_uv_index)[21]);'

      - lvgl.label.update:
          id: lbl_hourly_hour22_wind
          text: !lambda |-
            if (std::isnan(id(weather_hourly_wind_speed)[21])) return std::string("--");
            char buf[16];
            snprintf(buf, sizeof(buf), "%.0f mph", id(weather_hourly_wind_speed)[21]);
            return std::string(buf);

      - lvgl.label.update:
          id: lbl_hourly_hour22_wind_dir
          text: !lambda 'return weather_helpers::bearing_to_direction(id(weather_hourly_wind_bearing)[21]);'

      - delay: 50ms
      - lambda: 'App.feed_wdt();'

      # Update Hour 23
      - lvgl.label.update:
          id: lbl_hourly_hour23_header
          text: !lambda |-
            using namespace weather_helpers;
            if (id(weather_hourly_datetime)[22].empty()) return std::string("Hour +23");
            auto now = id(sntp_time).now();
            if (!now.is_valid()) return std::string("Hour +23");
            int hour = convert_to_local_hour(id(weather_hourly_datetime)[22], now.timezone_offset());
            return format_hour(hour);

      - lvgl.label.update:
          id: lbl_hourly_hour23_icon
          text: !lambda |-
            using namespace weather_helpers;
            return get_weather_icon(id(weather_hourly_condition)[22]);
          text_color: !lambda |-
            using namespace weather_helpers;
            return lv_color_hex(get_weather_icon_color(id(weather_hourly_condition)[22]));

      - lvgl.label.update:
          id: lbl_hourly_hour23_temp
          text: !lambda 'return weather_helpers::format_temp(id(weather_hourly_temp)[22]);'

      - lvgl.label.update:
          id: lbl_hourly_hour23_feels
          text: !lambda 'return weather_helpers::format_temp(id(weather_hourly_apparent_temp)[22]);'

      - lvgl.label.update:
          id: lbl_hourly_hour23_precip
          text: !lambda 'return weather_helpers::format_percent(id(weather_hourly_precip_prob)[22]);'

      - lvgl.label.update:
          id: lbl_hourly_hour23_humid
          text: !lambda 'return weather_helpers::format_percent(id(weather_hourly_humidity)[22]);'

      - lvgl.label.update:
          id: lbl_hourly_hour23_precip_amt
          text: !lambda 'return weather_helpers::format_precipitation(id(weather_hourly_precipitation)[22]);'

      - lvgl.label.update:
          id: lbl_hourly_hour23_pressure
          text: !lambda 'return weather_helpers::format_numeric(id(weather_hourly_pressure)[22]);'

      - lvgl.label.update:
          id: lbl_hourly_hour23_uv
          text: !lambda 'return weather_helpers::format_numeric(id(weather_hourly_uv_index)[22]);'

      - lvgl.label.update:
          id: lbl_hourly_hour23_wind
          text: !lambda |-
            if (std::isnan(id(weather_hourly_wind_speed)[22])) return std::string("--");
            char buf[16];
            snprintf(buf, sizeof(buf), "%.0f mph", id(weather_hourly_wind_speed)[22]);
            return std::string(buf);

      - lvgl.label.update:
          id: lbl_hourly_hour23_wind_dir
          text: !lambda 'return weather_helpers::bearing_to_direction(id(weather_hourly_wind_bearing)[22]);'

      - delay: 50ms
      - lambda: 'App.feed_wdt();'

      # Update Hour 24
      - lvgl.label.update:
          id: lbl_hourly_hour24_header
          text: !lambda |-
            using namespace weather_helpers;
            if (id(weather_hourly_datetime)[23].empty()) return std::string("Hour +24");
            auto now = id(sntp_time).now();
            if (!now.is_valid()) return std::string("Hour +24");
            int hour = convert_to_local_hour(id(weather_hourly_datetime)[23], now.timezone_offset());
            return format_hour(hour);

      - lvgl.label.update:
          id: lbl_hourly_hour24_icon
          text: !lambda |-
            using namespace weather_helpers;
            return get_weather_icon(id(weather_hourly_condition)[23]);
          text_color: !lambda |-
            using namespace weather_helpers;
            return lv_color_hex(get_weather_icon_color(id(weather_hourly_condition)[23]));

      - lvgl.label.update:
          id: lbl_hourly_hour24_temp
          text: !lambda 'return weather_helpers::format_temp(id(weather_hourly_temp)[23]);'

      - lvgl.label.update:
          id: lbl_hourly_hour24_feels
          text: !lambda 'return weather_helpers::format_temp(id(weather_hourly_apparent_temp)[23]);'

      - lvgl.label.update:
          id: lbl_hourly_hour24_precip
          text: !lambda 'return weather_helpers::format_percent(id(weather_hourly_precip_prob)[23]);'

      - lvgl.label.update:
          id: lbl_hourly_hour24_humid
          text: !lambda 'return weather_helpers::format_percent(id(weather_hourly_humidity)[23]);'

      - lvgl.label.update:
          id: lbl_hourly_hour24_precip_amt
          text: !lambda 'return weather_helpers::format_precipitation(id(weather_hourly_precipitation)[23]);'

      - lvgl.label.update:
          id: lbl_hourly_hour24_pressure
          text: !lambda 'return weather_helpers::format_numeric(id(weather_hourly_pressure)[23]);'

      - lvgl.label.update:
          id: lbl_hourly_hour24_uv
          text: !lambda 'return weather_helpers::format_numeric(id(weather_hourly_uv_index)[23]);'

      - lvgl.label.update:
          id: lbl_hourly_hour24_wind
          text: !lambda |-
            if (std::isnan(id(weather_hourly_wind_speed)[23])) return std::string("--");
            char buf[16];
            snprintf(buf, sizeof(buf), "%.0f mph", id(weather_hourly_wind_speed)[23]);
            return std::string(buf);

      - lvgl.label.update:
          id: lbl_hourly_hour24_wind_dir
          text: !lambda 'return weather_helpers::bearing_to_direction(id(weather_hourly_wind_bearing)[23]);'

      - delay: 50ms
      - lambda: 'App.feed_wdt();'
      - logger.log: "✓ Hourly page 6 (hours 16-24) updated successfully"


      - delay: 50ms
      - lambda: 'App.feed_wdt();'
      - logger.log: "✓ Hourly page 8 (hours 22-24) updated successfully"

    mode: single
    then:
      - logger.log: "Old script called - redirecting to page 1 only"
      - script.execute: update_hourly_page_1

  # DEPRECATED: Old monolithic script - kept for reference, replaced by update_hourly_page_X scripts
  - id: update_hourly_forecast_display_OLD
    mode: single
    then:
      - logger.log: "WARNING: Old monolithic hourly update script called - this should not happen!"

      # Update Hour 4 - THIS IS NOW PART OF THE OLD DEPRECATED SCRIPT
      - lvgl.label.update:
          id: lbl_hourly_hour4_header
          text: !lambda |-
            using namespace weather_helpers;
            if (id(weather_hourly_datetime)[3].empty()) return std::string("Hour +4");
            auto now = id(sntp_time).now();
            if (!now.is_valid()) return std::string("Hour +4");
            int hour = convert_to_local_hour(id(weather_hourly_datetime)[3], now.timezone_offset());
            return format_hour(hour);

      - lvgl.label.update:
          id: lbl_hourly_hour4_icon
          text: !lambda |-
            using namespace weather_helpers;
            return get_weather_icon(id(weather_hourly_condition)[3]);
          text_color: !lambda |-
            using namespace weather_helpers;
            return lv_color_hex(get_weather_icon_color(id(weather_hourly_condition)[3]));

      - lvgl.label.update:
          id: lbl_hourly_hour4_temp
          text: !lambda 'return weather_helpers::format_temp(id(weather_hourly_temp)[3]);'

      - lvgl.label.update:
          id: lbl_hourly_hour4_feels
          text: !lambda 'return weather_helpers::format_temp(id(weather_hourly_apparent_temp)[3]);'

      - lvgl.label.update:
          id: lbl_hourly_hour4_precip
          text: !lambda 'return weather_helpers::format_percent(id(weather_hourly_precip_prob)[3]);'

      - lvgl.label.update:
          id: lbl_hourly_hour4_humid
          text: !lambda 'return weather_helpers::format_percent(id(weather_hourly_humidity)[3]);'

      - lvgl.label.update:
          id: lbl_hourly_hour4_precip_amt
          text: !lambda 'return weather_helpers::format_precipitation(id(weather_hourly_precipitation)[3]);'

      - lvgl.label.update:
          id: lbl_hourly_hour4_pressure
          text: !lambda 'return weather_helpers::format_numeric(id(weather_hourly_pressure)[3]);'

      - lvgl.label.update:
          id: lbl_hourly_hour4_uv
          text: !lambda 'return weather_helpers::format_numeric(id(weather_hourly_uv_index)[3]);'

      - lvgl.label.update:
          id: lbl_hourly_hour4_wind
          text: !lambda |-
            if (std::isnan(id(weather_hourly_wind_speed)[3])) return std::string("--");
            char buf[16];
            snprintf(buf, sizeof(buf), "%.0f mph", id(weather_hourly_wind_speed)[3]);
            return std::string(buf);

      - lvgl.label.update:
          id: lbl_hourly_hour4_wind_dir
          text: !lambda 'return weather_helpers::bearing_to_direction(id(weather_hourly_wind_bearing)[3]);'

      # Stack unwind: delay + watchdog feed to prevent overflow
      - delay: 50ms
      - lambda: 'App.feed_wdt();'

      # Update Hour 5
      - lvgl.label.update:
          id: lbl_hourly_hour5_header
          text: !lambda |-
            using namespace weather_helpers;
            if (id(weather_hourly_datetime)[4].empty()) return std::string("Hour +5");
            auto now = id(sntp_time).now();
            if (!now.is_valid()) return std::string("Hour +5");
            int hour = convert_to_local_hour(id(weather_hourly_datetime)[4], now.timezone_offset());
            return format_hour(hour);

      - lvgl.label.update:
          id: lbl_hourly_hour5_icon
          text: !lambda |-
            using namespace weather_helpers;
            return get_weather_icon(id(weather_hourly_condition)[4]);
          text_color: !lambda |-
            using namespace weather_helpers;
            return lv_color_hex(get_weather_icon_color(id(weather_hourly_condition)[4]));

      - lvgl.label.update:
          id: lbl_hourly_hour5_temp
          text: !lambda 'return weather_helpers::format_temp(id(weather_hourly_temp)[4]);'

      - lvgl.label.update:
          id: lbl_hourly_hour5_feels
          text: !lambda 'return weather_helpers::format_temp(id(weather_hourly_apparent_temp)[4]);'

      - lvgl.label.update:
          id: lbl_hourly_hour5_precip
          text: !lambda 'return weather_helpers::format_percent(id(weather_hourly_precip_prob)[4]);'

      - lvgl.label.update:
          id: lbl_hourly_hour5_humid
          text: !lambda 'return weather_helpers::format_percent(id(weather_hourly_humidity)[4]);'

      - lvgl.label.update:
          id: lbl_hourly_hour5_precip_amt
          text: !lambda 'return weather_helpers::format_precipitation(id(weather_hourly_precipitation)[4]);'

      - lvgl.label.update:
          id: lbl_hourly_hour5_pressure
          text: !lambda 'return weather_helpers::format_numeric(id(weather_hourly_pressure)[4]);'

      - lvgl.label.update:
          id: lbl_hourly_hour5_uv
          text: !lambda 'return weather_helpers::format_numeric(id(weather_hourly_uv_index)[4]);'

      - lvgl.label.update:
          id: lbl_hourly_hour5_wind
          text: !lambda |-
            if (std::isnan(id(weather_hourly_wind_speed)[4])) return std::string("--");
            char buf[16];
            snprintf(buf, sizeof(buf), "%.0f mph", id(weather_hourly_wind_speed)[4]);
            return std::string(buf);

      - lvgl.label.update:
          id: lbl_hourly_hour5_wind_dir
          text: !lambda 'return weather_helpers::bearing_to_direction(id(weather_hourly_wind_bearing)[4]);'

      # Small delay to prevent system overload
      - delay: 50ms

      # ========================================================================
      # Update Hour 6
      - lvgl.label.update:
          id: lbl_hourly_hour6_header
          text: !lambda |-
            using namespace weather_helpers;
            if (id(weather_hourly_datetime)[5].empty()) return std::string("Hour +6");
            auto now = id(sntp_time).now();
            if (!now.is_valid()) return std::string("Hour +6");
            int hour = convert_to_local_hour(id(weather_hourly_datetime)[5], now.timezone_offset());
            return format_hour(hour);

      - lvgl.label.update:
          id: lbl_hourly_hour6_icon
          text: !lambda |-
            using namespace weather_helpers;
            return get_weather_icon(id(weather_hourly_condition)[5]);
          text_color: !lambda |-
            using namespace weather_helpers;
            return lv_color_hex(get_weather_icon_color(id(weather_hourly_condition)[5]));

      - lvgl.label.update:
          id: lbl_hourly_hour6_temp
          text: !lambda 'return weather_helpers::format_temp(id(weather_hourly_temp)[5]);'

      - lvgl.label.update:
          id: lbl_hourly_hour6_feels
          text: !lambda 'return weather_helpers::format_temp(id(weather_hourly_apparent_temp)[5]);'

      - lvgl.label.update:
          id: lbl_hourly_hour6_precip
          text: !lambda 'return weather_helpers::format_percent(id(weather_hourly_precip_prob)[5]);'

      - lvgl.label.update:
          id: lbl_hourly_hour6_humid
          text: !lambda 'return weather_helpers::format_percent(id(weather_hourly_humidity)[5]);'

      - lvgl.label.update:
          id: lbl_hourly_hour6_precip_amt
          text: !lambda 'return weather_helpers::format_precipitation(id(weather_hourly_precipitation)[5]);'

      - lvgl.label.update:
          id: lbl_hourly_hour6_pressure
          text: !lambda 'return weather_helpers::format_numeric(id(weather_hourly_pressure)[5]);'

      - lvgl.label.update:
          id: lbl_hourly_hour6_uv
          text: !lambda 'return weather_helpers::format_numeric(id(weather_hourly_uv_index)[5]);'

      - lvgl.label.update:
          id: lbl_hourly_hour6_wind
          text: !lambda |-
            if (std::isnan(id(weather_hourly_wind_speed)[5])) return std::string("--");
            char buf[16];
            snprintf(buf, sizeof(buf), "%.0f mph", id(weather_hourly_wind_speed)[5]);
            return std::string(buf);

      - lvgl.label.update:
          id: lbl_hourly_hour6_wind_dir
          text: !lambda 'return weather_helpers::bearing_to_direction(id(weather_hourly_wind_bearing)[5]);'
      # Stack unwind: delay + watchdog feed to prevent overflow
      - delay: 50ms
      - lambda: 'App.feed_wdt();'

      # Update Hour 7
      - lvgl.label.update:
          id: lbl_hourly_hour7_header
          text: !lambda |-
            using namespace weather_helpers;
            if (id(weather_hourly_datetime)[6].empty()) return std::string("Hour +7");
            auto now = id(sntp_time).now();
            if (!now.is_valid()) return std::string("Hour +7");
            int hour = convert_to_local_hour(id(weather_hourly_datetime)[6], now.timezone_offset());
            return format_hour(hour);

      - lvgl.label.update:
          id: lbl_hourly_hour7_icon
          text: !lambda |-
            using namespace weather_helpers;
            return get_weather_icon(id(weather_hourly_condition)[6]);
          text_color: !lambda |-
            using namespace weather_helpers;
            return lv_color_hex(get_weather_icon_color(id(weather_hourly_condition)[6]));

      - lvgl.label.update:
          id: lbl_hourly_hour7_temp
          text: !lambda 'return weather_helpers::format_temp(id(weather_hourly_temp)[6]);'

      - lvgl.label.update:
          id: lbl_hourly_hour7_feels
          text: !lambda 'return weather_helpers::format_temp(id(weather_hourly_apparent_temp)[6]);'

      - lvgl.label.update:
          id: lbl_hourly_hour7_precip
          text: !lambda 'return weather_helpers::format_percent(id(weather_hourly_precip_prob)[6]);'

      - lvgl.label.update:
          id: lbl_hourly_hour7_humid
          text: !lambda 'return weather_helpers::format_percent(id(weather_hourly_humidity)[6]);'

      - lvgl.label.update:
          id: lbl_hourly_hour7_precip_amt
          text: !lambda 'return weather_helpers::format_precipitation(id(weather_hourly_precipitation)[6]);'

      - lvgl.label.update:
          id: lbl_hourly_hour7_pressure
          text: !lambda 'return weather_helpers::format_numeric(id(weather_hourly_pressure)[6]);'

      - lvgl.label.update:
          id: lbl_hourly_hour7_uv
          text: !lambda 'return weather_helpers::format_numeric(id(weather_hourly_uv_index)[6]);'

      - lvgl.label.update:
          id: lbl_hourly_hour7_wind
          text: !lambda |-
            if (std::isnan(id(weather_hourly_wind_speed)[6])) return std::string("--");
            char buf[16];
            snprintf(buf, sizeof(buf), "%.0f mph", id(weather_hourly_wind_speed)[6]);
            return std::string(buf);

      - lvgl.label.update:
          id: lbl_hourly_hour7_wind_dir
          text: !lambda 'return weather_helpers::bearing_to_direction(id(weather_hourly_wind_bearing)[6]);'
      # Stack unwind: delay + watchdog feed to prevent overflow
      - delay: 50ms
      - lambda: 'App.feed_wdt();'

      # Update Hour 8
      - lvgl.label.update:
          id: lbl_hourly_hour8_header
          text: !lambda |-
            using namespace weather_helpers;
            if (id(weather_hourly_datetime)[7].empty()) return std::string("Hour +8");
            auto now = id(sntp_time).now();
            if (!now.is_valid()) return std::string("Hour +8");
            int hour = convert_to_local_hour(id(weather_hourly_datetime)[7], now.timezone_offset());
            return format_hour(hour);

      - lvgl.label.update:
          id: lbl_hourly_hour8_icon
          text: !lambda |-
            using namespace weather_helpers;
            return get_weather_icon(id(weather_hourly_condition)[7]);
          text_color: !lambda |-
            using namespace weather_helpers;
            return lv_color_hex(get_weather_icon_color(id(weather_hourly_condition)[7]));

      - lvgl.label.update:
          id: lbl_hourly_hour8_temp
          text: !lambda 'return weather_helpers::format_temp(id(weather_hourly_temp)[7]);'

      - lvgl.label.update:
          id: lbl_hourly_hour8_feels
          text: !lambda 'return weather_helpers::format_temp(id(weather_hourly_apparent_temp)[7]);'

      - lvgl.label.update:
          id: lbl_hourly_hour8_precip
          text: !lambda 'return weather_helpers::format_percent(id(weather_hourly_precip_prob)[7]);'

      - lvgl.label.update:
          id: lbl_hourly_hour8_humid
          text: !lambda 'return weather_helpers::format_percent(id(weather_hourly_humidity)[7]);'

      - lvgl.label.update:
          id: lbl_hourly_hour8_precip_amt
          text: !lambda 'return weather_helpers::format_precipitation(id(weather_hourly_precipitation)[7]);'

      - lvgl.label.update:
          id: lbl_hourly_hour8_pressure
          text: !lambda 'return weather_helpers::format_numeric(id(weather_hourly_pressure)[7]);'

      - lvgl.label.update:
          id: lbl_hourly_hour8_uv
          text: !lambda 'return weather_helpers::format_numeric(id(weather_hourly_uv_index)[7]);'

      - lvgl.label.update:
          id: lbl_hourly_hour8_wind
          text: !lambda |-
            if (std::isnan(id(weather_hourly_wind_speed)[7])) return std::string("--");
            char buf[16];
            snprintf(buf, sizeof(buf), "%.0f mph", id(weather_hourly_wind_speed)[7]);
            return std::string(buf);

      - lvgl.label.update:
          id: lbl_hourly_hour8_wind_dir
          text: !lambda 'return weather_helpers::bearing_to_direction(id(weather_hourly_wind_bearing)[7]);'
      # Stack unwind: delay + watchdog feed to prevent overflow
      - delay: 50ms
      - lambda: 'App.feed_wdt();'

      # Hour 9 (index 8)
      - lvgl.label.update:
          id: lbl_hourly_hour9_header
          text: !lambda |-
            using namespace weather_helpers;
            if (id(weather_hourly_datetime)[8].empty()) return std::string("Hour +9");
            auto now = id(sntp_time).now();
            if (!now.is_valid()) return std::string("Hour +9");
            int hour = convert_to_local_hour(id(weather_hourly_datetime)[8], now.timezone_offset());
            return format_hour(hour);

      - lvgl.label.update:
          id: lbl_hourly_hour9_icon
          text: !lambda |-
            using namespace weather_helpers;
            return get_weather_icon(id(weather_hourly_condition)[8]);
          text_color: !lambda |-
            using namespace weather_helpers;
            return lv_color_hex(get_weather_icon_color(id(weather_hourly_condition)[8]));

      - lvgl.label.update:
          id: lbl_hourly_hour9_temp
          text: !lambda 'return weather_helpers::format_temp(id(weather_hourly_temp)[8]);'

      - lvgl.label.update:
          id: lbl_hourly_hour9_feels
          text: !lambda 'return weather_helpers::format_temp(id(weather_hourly_apparent_temp)[8]);'

      - lvgl.label.update:
          id: lbl_hourly_hour9_precip
          text: !lambda 'return weather_helpers::format_percent(id(weather_hourly_precip_prob)[8]);'

      - lvgl.label.update:
          id: lbl_hourly_hour9_humid
          text: !lambda 'return weather_helpers::format_percent(id(weather_hourly_humidity)[8]);'

      - lvgl.label.update:
          id: lbl_hourly_hour9_precip_amt
          text: !lambda 'return weather_helpers::format_precipitation(id(weather_hourly_precipitation)[8]);'

      - lvgl.label.update:
          id: lbl_hourly_hour9_pressure
          text: !lambda 'return weather_helpers::format_numeric(id(weather_hourly_pressure)[8]);'

      - lvgl.label.update:
          id: lbl_hourly_hour9_uv
          text: !lambda 'return weather_helpers::format_numeric(id(weather_hourly_uv_index)[8]);'

      - lvgl.label.update:
          id: lbl_hourly_hour9_wind
          text: !lambda |-
            if (std::isnan(id(weather_hourly_wind_speed)[8])) return std::string("--");
            char buf[16];
            snprintf(buf, sizeof(buf), "%.0f mph", id(weather_hourly_wind_speed)[8]);
            return std::string(buf);

      - lvgl.label.update:
          id: lbl_hourly_hour9_wind_dir
          text: !lambda 'return weather_helpers::bearing_to_direction(id(weather_hourly_wind_bearing)[8]);'

      # Small delay to prevent system overload
      - delay: 50ms

      - logger.log: "✓ Hourly forecast display updated (page 4)"

 
      # Detailed hourly cards 10..24 (indices 9..23)

      # Hour 10 (index 9)
      - lvgl.label.update:
          id: lbl_hourly_hour10_header
          text: !lambda |-
            using namespace weather_helpers;
            if (id(weather_hourly_datetime)[9].empty()) return std::string("Hour +10");
            auto now = id(sntp_time).now();
            if (!now.is_valid()) return std::string("Hour +10");
            int hour = convert_to_local_hour(id(weather_hourly_datetime)[9], now.timezone_offset());
            return format_hour(hour);

      - lvgl.label.update:
          id: lbl_hourly_hour10_icon
          text: !lambda |-
            using namespace weather_helpers;
            return get_weather_icon(id(weather_hourly_condition)[9]);
          text_color: !lambda |-
            using namespace weather_helpers;
            return lv_color_hex(get_weather_icon_color(id(weather_hourly_condition)[9]));

      - lvgl.label.update:
          id: lbl_hourly_hour10_temp
          text: !lambda 'return weather_helpers::format_temp(id(weather_hourly_temp)[9]);'

      - lvgl.label.update:
          id: lbl_hourly_hour10_feels
          text: !lambda 'return weather_helpers::format_temp(id(weather_hourly_apparent_temp)[9]);'

      - lvgl.label.update:
          id: lbl_hourly_hour10_precip
          text: !lambda 'return weather_helpers::format_percent(id(weather_hourly_precip_prob)[9]);'

      - lvgl.label.update:
          id: lbl_hourly_hour10_humid
          text: !lambda 'return weather_helpers::format_percent(id(weather_hourly_humidity)[9]);'

      - lvgl.label.update:
          id: lbl_hourly_hour10_precip_amt
          text: !lambda 'return weather_helpers::format_precipitation(id(weather_hourly_precipitation)[9]);'

      - lvgl.label.update:
          id: lbl_hourly_hour10_pressure
          text: !lambda 'return weather_helpers::format_numeric(id(weather_hourly_pressure)[9]);'

      - lvgl.label.update:
          id: lbl_hourly_hour10_uv
          text: !lambda 'return weather_helpers::format_numeric(id(weather_hourly_uv_index)[9]);'

      - lvgl.label.update:
          id: lbl_hourly_hour10_wind
          text: !lambda |-
            if (std::isnan(id(weather_hourly_wind_speed)[9])) return std::string("--");
            char buf[16];
            snprintf(buf, sizeof(buf), "%.0f mph", id(weather_hourly_wind_speed)[9]);
            return std::string(buf);

      - lvgl.label.update:
          id: lbl_hourly_hour10_wind_dir
          text: !lambda 'return weather_helpers::bearing_to_direction(id(weather_hourly_wind_bearing)[9]);'

      # Stack unwind: delay + watchdog feed to prevent overflow
      - delay: 50ms
      - lambda: 'App.feed_wdt();'

      # Hour 11 (index 10)
      - lvgl.label.update:
          id: lbl_hourly_hour11_header
          text: !lambda |-
            using namespace weather_helpers;
            if (id(weather_hourly_datetime)[10].empty()) return std::string("Hour +11");
            auto now = id(sntp_time).now();
            if (!now.is_valid()) return std::string("Hour +11");
            int hour = convert_to_local_hour(id(weather_hourly_datetime)[10], now.timezone_offset());
            return format_hour(hour);

      - lvgl.label.update:
          id: lbl_hourly_hour11_icon
          text: !lambda |-
            using namespace weather_helpers;
            return get_weather_icon(id(weather_hourly_condition)[10]);
          text_color: !lambda |-
            using namespace weather_helpers;
            return lv_color_hex(get_weather_icon_color(id(weather_hourly_condition)[10]));

      - lvgl.label.update:
          id: lbl_hourly_hour11_temp
          text: !lambda 'return weather_helpers::format_temp(id(weather_hourly_temp)[10]);'

      - lvgl.label.update:
          id: lbl_hourly_hour11_feels
          text: !lambda 'return weather_helpers::format_temp(id(weather_hourly_apparent_temp)[10]);'

      - lvgl.label.update:
          id: lbl_hourly_hour11_precip
          text: !lambda 'return weather_helpers::format_percent(id(weather_hourly_precip_prob)[10]);'

      - lvgl.label.update:
          id: lbl_hourly_hour11_humid
          text: !lambda 'return weather_helpers::format_percent(id(weather_hourly_humidity)[10]);'

      - lvgl.label.update:
          id: lbl_hourly_hour11_precip_amt
          text: !lambda 'return weather_helpers::format_precipitation(id(weather_hourly_precipitation)[10]);'

      - lvgl.label.update:
          id: lbl_hourly_hour11_pressure
          text: !lambda 'return weather_helpers::format_numeric(id(weather_hourly_pressure)[10]);'

      - lvgl.label.update:
          id: lbl_hourly_hour11_uv
          text: !lambda 'return weather_helpers::format_numeric(id(weather_hourly_uv_index)[10]);'

      - lvgl.label.update:
          id: lbl_hourly_hour11_wind
          text: !lambda |-
            if (std::isnan(id(weather_hourly_wind_speed)[10])) return std::string("--");
            char buf[16];
            snprintf(buf, sizeof(buf), "%.0f mph", id(weather_hourly_wind_speed)[10]);
            return std::string(buf);

      - lvgl.label.update:
          id: lbl_hourly_hour11_wind_dir
          text: !lambda 'return weather_helpers::bearing_to_direction(id(weather_hourly_wind_bearing)[10]);'

      # ========================================================================
      # Hour 12 - WATCHDOG FEED POINT
      # ========================================================================
      - lambda: 'App.feed_wdt();'

      # Hour 12 (index 11)
      - lvgl.label.update:
          id: lbl_hourly_hour12_header
          text: !lambda |-
            using namespace weather_helpers;
            if (id(weather_hourly_datetime)[11].empty()) return std::string("Hour +12");
            auto now = id(sntp_time).now();
            if (!now.is_valid()) return std::string("Hour +12");
            int hour = convert_to_local_hour(id(weather_hourly_datetime)[11], now.timezone_offset());
            return format_hour(hour);

      - lvgl.label.update:
          id: lbl_hourly_hour12_icon
          text: !lambda |-
            using namespace weather_helpers;
            return get_weather_icon(id(weather_hourly_condition)[11]);
          text_color: !lambda |-
            using namespace weather_helpers;
            return lv_color_hex(get_weather_icon_color(id(weather_hourly_condition)[11]));

      - lvgl.label.update:
          id: lbl_hourly_hour12_temp
          text: !lambda 'return weather_helpers::format_temp(id(weather_hourly_temp)[11]);'

      - lvgl.label.update:
          id: lbl_hourly_hour12_feels
          text: !lambda 'return weather_helpers::format_temp(id(weather_hourly_apparent_temp)[11]);'

      - lvgl.label.update:
          id: lbl_hourly_hour12_precip
          text: !lambda 'return weather_helpers::format_percent(id(weather_hourly_precip_prob)[11]);'

      - lvgl.label.update:
          id: lbl_hourly_hour12_humid
          text: !lambda 'return weather_helpers::format_percent(id(weather_hourly_humidity)[11]);'

      - lvgl.label.update:
          id: lbl_hourly_hour12_precip_amt
          text: !lambda 'return weather_helpers::format_precipitation(id(weather_hourly_precipitation)[11]);'

      - lvgl.label.update:
          id: lbl_hourly_hour12_pressure
          text: !lambda 'return weather_helpers::format_numeric(id(weather_hourly_pressure)[11]);'

      - lvgl.label.update:
          id: lbl_hourly_hour12_uv
          text: !lambda 'return weather_helpers::format_numeric(id(weather_hourly_uv_index)[11]);'

      - lvgl.label.update:
          id: lbl_hourly_hour12_wind
          text: !lambda |-
            if (std::isnan(id(weather_hourly_wind_speed)[11])) return std::string("--");
            char buf[16];
            snprintf(buf, sizeof(buf), "%.0f mph", id(weather_hourly_wind_speed)[11]);
            return std::string(buf);

      - lvgl.label.update:
          id: lbl_hourly_hour12_wind_dir
          text: !lambda 'return weather_helpers::bearing_to_direction(id(weather_hourly_wind_bearing)[11]);'

      # Stack unwind: delay + watchdog feed to prevent overflow
      - delay: 50ms
      - lambda: 'App.feed_wdt();'

      # Hour 13 (index 12)
      - lvgl.label.update:
          id: lbl_hourly_hour13_header
          text: !lambda |-
            using namespace weather_helpers;
            if (id(weather_hourly_datetime)[12].empty()) return std::string("Hour +13");
            auto now = id(sntp_time).now();
            if (!now.is_valid()) return std::string("Hour +13");
            int hour = convert_to_local_hour(id(weather_hourly_datetime)[12], now.timezone_offset());
            return format_hour(hour);

      - lvgl.label.update:
          id: lbl_hourly_hour13_icon
          text: !lambda |-
            using namespace weather_helpers;
            return get_weather_icon(id(weather_hourly_condition)[12]);
          text_color: !lambda |-
            using namespace weather_helpers;
            return lv_color_hex(get_weather_icon_color(id(weather_hourly_condition)[12]));

      - lvgl.label.update:
          id: lbl_hourly_hour13_temp
          text: !lambda 'return weather_helpers::format_temp(id(weather_hourly_temp)[12]);'

      - lvgl.label.update:
          id: lbl_hourly_hour13_feels
          text: !lambda 'return weather_helpers::format_temp(id(weather_hourly_apparent_temp)[12]);'

      - lvgl.label.update:
          id: lbl_hourly_hour13_precip
          text: !lambda 'return weather_helpers::format_percent(id(weather_hourly_precip_prob)[12]);'

      - lvgl.label.update:
          id: lbl_hourly_hour13_humid
          text: !lambda 'return weather_helpers::format_percent(id(weather_hourly_humidity)[12]);'

      - lvgl.label.update:
          id: lbl_hourly_hour13_precip_amt
          text: !lambda 'return weather_helpers::format_precipitation(id(weather_hourly_precipitation)[12]);'

      - lvgl.label.update:
          id: lbl_hourly_hour13_pressure
          text: !lambda 'return weather_helpers::format_numeric(id(weather_hourly_pressure)[12]);'

      - lvgl.label.update:
          id: lbl_hourly_hour13_uv
          text: !lambda 'return weather_helpers::format_numeric(id(weather_hourly_uv_index)[12]);'

      - lvgl.label.update:
          id: lbl_hourly_hour13_wind
          text: !lambda |-
            if (std::isnan(id(weather_hourly_wind_speed)[12])) return std::string("--");
            char buf[16];
            snprintf(buf, sizeof(buf), "%.0f mph", id(weather_hourly_wind_speed)[12]);
            return std::string(buf);

      - lvgl.label.update:
          id: lbl_hourly_hour13_wind_dir
          text: !lambda 'return weather_helpers::bearing_to_direction(id(weather_hourly_wind_bearing)[12]);'

      # Stack unwind: delay + watchdog feed to prevent overflow
      - delay: 50ms
      - lambda: 'App.feed_wdt();'

      # Hour 14 (index 13)
      - lvgl.label.update:
          id: lbl_hourly_hour14_header
          text: !lambda |-
            using namespace weather_helpers;
            if (id(weather_hourly_datetime)[13].empty()) return std::string("Hour +14");
            auto now = id(sntp_time).now();
            if (!now.is_valid()) return std::string("Hour +14");
            int hour = convert_to_local_hour(id(weather_hourly_datetime)[13], now.timezone_offset());
            return format_hour(hour);

      - lvgl.label.update:
          id: lbl_hourly_hour14_icon
          text: !lambda |-
            using namespace weather_helpers;
            return get_weather_icon(id(weather_hourly_condition)[13]);
          text_color: !lambda |-
            using namespace weather_helpers;
            return lv_color_hex(get_weather_icon_color(id(weather_hourly_condition)[13]));

      - lvgl.label.update:
          id: lbl_hourly_hour14_temp
          text: !lambda 'return weather_helpers::format_temp(id(weather_hourly_temp)[13]);'

      - lvgl.label.update:
          id: lbl_hourly_hour14_feels
          text: !lambda 'return weather_helpers::format_temp(id(weather_hourly_apparent_temp)[13]);'

      - lvgl.label.update:
          id: lbl_hourly_hour14_precip
          text: !lambda 'return weather_helpers::format_percent(id(weather_hourly_precip_prob)[13]);'

      - lvgl.label.update:
          id: lbl_hourly_hour14_humid
          text: !lambda 'return weather_helpers::format_percent(id(weather_hourly_humidity)[13]);'

      - lvgl.label.update:
          id: lbl_hourly_hour14_precip_amt
          text: !lambda 'return weather_helpers::format_precipitation(id(weather_hourly_precipitation)[13]);'

      - lvgl.label.update:
          id: lbl_hourly_hour14_pressure
          text: !lambda 'return weather_helpers::format_numeric(id(weather_hourly_pressure)[13]);'

      - lvgl.label.update:
          id: lbl_hourly_hour14_uv
          text: !lambda 'return weather_helpers::format_numeric(id(weather_hourly_uv_index)[13]);'

      - lvgl.label.update:
          id: lbl_hourly_hour14_wind
          text: !lambda |-
            if (std::isnan(id(weather_hourly_wind_speed)[13])) return std::string("--");
            char buf[16];
            snprintf(buf, sizeof(buf), "%.0f mph", id(weather_hourly_wind_speed)[13]);
            return std::string(buf);

      - lvgl.label.update:
          id: lbl_hourly_hour14_wind_dir
          text: !lambda 'return weather_helpers::bearing_to_direction(id(weather_hourly_wind_bearing)[13]);'

      # Stack unwind: delay + watchdog feed to prevent overflow
      - delay: 50ms
      - lambda: 'App.feed_wdt();'

      # Hour 15 (index 14)
      - lvgl.label.update:
          id: lbl_hourly_hour15_header
          text: !lambda |-
            using namespace weather_helpers;
            if (id(weather_hourly_datetime)[14].empty()) return std::string("Hour +15");
            auto now = id(sntp_time).now();
            if (!now.is_valid()) return std::string("Hour +15");
            int hour = convert_to_local_hour(id(weather_hourly_datetime)[14], now.timezone_offset());
            return format_hour(hour);

      - lvgl.label.update:
          id: lbl_hourly_hour15_icon
          text: !lambda |-
            using namespace weather_helpers;
            return get_weather_icon(id(weather_hourly_condition)[14]);
          text_color: !lambda |-
            using namespace weather_helpers;
            return lv_color_hex(get_weather_icon_color(id(weather_hourly_condition)[14]));

      - lvgl.label.update:
          id: lbl_hourly_hour15_temp
          text: !lambda 'return weather_helpers::format_temp(id(weather_hourly_temp)[14]);'

      - lvgl.label.update:
          id: lbl_hourly_hour15_feels
          text: !lambda 'return weather_helpers::format_temp(id(weather_hourly_apparent_temp)[14]);'

      - lvgl.label.update:
          id: lbl_hourly_hour15_precip
          text: !lambda 'return weather_helpers::format_percent(id(weather_hourly_precip_prob)[14]);'

      - lvgl.label.update:
          id: lbl_hourly_hour15_humid
          text: !lambda 'return weather_helpers::format_percent(id(weather_hourly_humidity)[14]);'

      - lvgl.label.update:
          id: lbl_hourly_hour15_precip_amt
          text: !lambda 'return weather_helpers::format_precipitation(id(weather_hourly_precipitation)[14]);'

      - lvgl.label.update:
          id: lbl_hourly_hour15_pressure
          text: !lambda 'return weather_helpers::format_numeric(id(weather_hourly_pressure)[14]);'

      - lvgl.label.update:
          id: lbl_hourly_hour15_uv
          text: !lambda 'return weather_helpers::format_numeric(id(weather_hourly_uv_index)[14]);'

      - lvgl.label.update:
          id: lbl_hourly_hour15_wind
          text: !lambda |-
            if (std::isnan(id(weather_hourly_wind_speed)[14])) return std::string("--");
            char buf[16];
            snprintf(buf, sizeof(buf), "%.0f mph", id(weather_hourly_wind_speed)[14]);
            return std::string(buf);

      - lvgl.label.update:
          id: lbl_hourly_hour15_wind_dir
          text: !lambda 'return weather_helpers::bearing_to_direction(id(weather_hourly_wind_bearing)[14]);'

      # Stack unwind: delay + watchdog feed to prevent overflow
      - delay: 50ms
      - lambda: 'App.feed_wdt();'

      # Hour 16 (index 15)
      - lvgl.label.update:
          id: lbl_hourly_hour16_header
          text: !lambda |-
            using namespace weather_helpers;
            if (id(weather_hourly_datetime)[15].empty()) return std::string("Hour +16");
            auto now = id(sntp_time).now();
            if (!now.is_valid()) return std::string("Hour +16");
            int hour = convert_to_local_hour(id(weather_hourly_datetime)[15], now.timezone_offset());
            return format_hour(hour);

      - lvgl.label.update:
          id: lbl_hourly_hour16_icon
          text: !lambda |-
            using namespace weather_helpers;
            return get_weather_icon(id(weather_hourly_condition)[15]);
          text_color: !lambda |-
            using namespace weather_helpers;
            return lv_color_hex(get_weather_icon_color(id(weather_hourly_condition)[15]));

      - lvgl.label.update:
          id: lbl_hourly_hour16_temp
          text: !lambda 'return weather_helpers::format_temp(id(weather_hourly_temp)[15]);'

      - lvgl.label.update:
          id: lbl_hourly_hour16_feels
          text: !lambda 'return weather_helpers::format_temp(id(weather_hourly_apparent_temp)[15]);'

      - lvgl.label.update:
          id: lbl_hourly_hour16_precip
          text: !lambda 'return weather_helpers::format_percent(id(weather_hourly_precip_prob)[15]);'

      - lvgl.label.update:
          id: lbl_hourly_hour16_humid
          text: !lambda 'return weather_helpers::format_percent(id(weather_hourly_humidity)[15]);'

      - lvgl.label.update:
          id: lbl_hourly_hour16_precip_amt
          text: !lambda 'return weather_helpers::format_precipitation(id(weather_hourly_precipitation)[15]);'

      - lvgl.label.update:
          id: lbl_hourly_hour16_pressure
          text: !lambda 'return weather_helpers::format_numeric(id(weather_hourly_pressure)[15]);'

      - lvgl.label.update:
          id: lbl_hourly_hour16_uv
          text: !lambda 'return weather_helpers::format_numeric(id(weather_hourly_uv_index)[15]);'

      - lvgl.label.update:
          id: lbl_hourly_hour16_wind
          text: !lambda |-
            if (std::isnan(id(weather_hourly_wind_speed)[15])) return std::string("--");
            char buf[16];
            snprintf(buf, sizeof(buf), "%.0f mph", id(weather_hourly_wind_speed)[15]);
            return std::string(buf);

      - lvgl.label.update:
          id: lbl_hourly_hour16_wind_dir
          text: !lambda 'return weather_helpers::bearing_to_direction(id(weather_hourly_wind_bearing)[15]);'

      # Stack unwind: delay + watchdog feed to prevent overflow
      - delay: 50ms
      - lambda: 'App.feed_wdt();'

      # Hour 17 (index 16)
      - lvgl.label.update:
          id: lbl_hourly_hour17_header
          text: !lambda |-
            using namespace weather_helpers;
            if (id(weather_hourly_datetime)[16].empty()) return std::string("Hour +17");
            auto now = id(sntp_time).now();
            if (!now.is_valid()) return std::string("Hour +17");
            int hour = convert_to_local_hour(id(weather_hourly_datetime)[16], now.timezone_offset());
            return format_hour(hour);

      - lvgl.label.update:
          id: lbl_hourly_hour17_icon
          text: !lambda |-
            using namespace weather_helpers;
            return get_weather_icon(id(weather_hourly_condition)[16]);
          text_color: !lambda |-
            using namespace weather_helpers;
            return lv_color_hex(get_weather_icon_color(id(weather_hourly_condition)[16]));

      - lvgl.label.update:
          id: lbl_hourly_hour17_temp
          text: !lambda 'return weather_helpers::format_temp(id(weather_hourly_temp)[16]);'

      - lvgl.label.update:
          id: lbl_hourly_hour17_feels
          text: !lambda 'return weather_helpers::format_temp(id(weather_hourly_apparent_temp)[16]);'

      - lvgl.label.update:
          id: lbl_hourly_hour17_precip
          text: !lambda 'return weather_helpers::format_percent(id(weather_hourly_precip_prob)[16]);'

      - lvgl.label.update:
          id: lbl_hourly_hour17_humid
          text: !lambda 'return weather_helpers::format_percent(id(weather_hourly_humidity)[16]);'

      - lvgl.label.update:
          id: lbl_hourly_hour17_precip_amt
          text: !lambda 'return weather_helpers::format_precipitation(id(weather_hourly_precipitation)[16]);'

      - lvgl.label.update:
          id: lbl_hourly_hour17_pressure
          text: !lambda 'return weather_helpers::format_numeric(id(weather_hourly_pressure)[16]);'

      - lvgl.label.update:
          id: lbl_hourly_hour17_uv
          text: !lambda 'return weather_helpers::format_numeric(id(weather_hourly_uv_index)[16]);'

      - lvgl.label.update:
          id: lbl_hourly_hour17_wind
          text: !lambda |-
            if (std::isnan(id(weather_hourly_wind_speed)[16])) return std::string("--");
            char buf[16];
            snprintf(buf, sizeof(buf), "%.0f mph", id(weather_hourly_wind_speed)[16]);
            return std::string(buf);

      - lvgl.label.update:
          id: lbl_hourly_hour17_wind_dir
          text: !lambda 'return weather_helpers::bearing_to_direction(id(weather_hourly_wind_bearing)[16]);'

      # ========================================================================
      # Hour 18 - WATCHDOG FEED POINT
      # ========================================================================
      - lambda: 'App.feed_wdt();'
      
      # Small delay to prevent system overload
      - delay: 50ms

      # Hour 18 (index 17)
      - lvgl.label.update:
          id: lbl_hourly_hour18_header
          text: !lambda |-
            using namespace weather_helpers;
            if (id(weather_hourly_datetime)[17].empty()) return std::string("Hour +18");
            auto now = id(sntp_time).now();
            if (!now.is_valid()) return std::string("Hour +18");
            int hour = convert_to_local_hour(id(weather_hourly_datetime)[17], now.timezone_offset());
            return format_hour(hour);

      - lvgl.label.update:
          id: lbl_hourly_hour18_icon
          text: !lambda |-
            using namespace weather_helpers;
            return get_weather_icon(id(weather_hourly_condition)[17]);
          text_color: !lambda |-
            using namespace weather_helpers;
            return lv_color_hex(get_weather_icon_color(id(weather_hourly_condition)[17]));

      - lvgl.label.update:
          id: lbl_hourly_hour18_temp
          text: !lambda 'return weather_helpers::format_temp(id(weather_hourly_temp)[17]);'

      - lvgl.label.update:
          id: lbl_hourly_hour18_feels
          text: !lambda 'return weather_helpers::format_temp(id(weather_hourly_apparent_temp)[17]);'

      - lvgl.label.update:
          id: lbl_hourly_hour18_precip
          text: !lambda 'return weather_helpers::format_percent(id(weather_hourly_precip_prob)[17]);'

      - lvgl.label.update:
          id: lbl_hourly_hour18_humid
          text: !lambda 'return weather_helpers::format_percent(id(weather_hourly_humidity)[17]);'

      - lvgl.label.update:
          id: lbl_hourly_hour18_precip_amt
          text: !lambda 'return weather_helpers::format_precipitation(id(weather_hourly_precipitation)[17]);'

      - lvgl.label.update:
          id: lbl_hourly_hour18_pressure
          text: !lambda 'return weather_helpers::format_numeric(id(weather_hourly_pressure)[17]);'

      - lvgl.label.update:
          id: lbl_hourly_hour18_uv
          text: !lambda 'return weather_helpers::format_numeric(id(weather_hourly_uv_index)[17]);'

      - lvgl.label.update:
          id: lbl_hourly_hour18_wind
          text: !lambda |-
            if (std::isnan(id(weather_hourly_wind_speed)[17])) return std::string("--");
            char buf[16];
            snprintf(buf, sizeof(buf), "%.0f mph", id(weather_hourly_wind_speed)[17]);
            return std::string(buf);

      - lvgl.label.update:
          id: lbl_hourly_hour18_wind_dir
          text: !lambda 'return weather_helpers::bearing_to_direction(id(weather_hourly_wind_bearing)[17]);'

      # Stack unwind: delay + watchdog feed to prevent overflow
      - delay: 50ms
      - lambda: 'App.feed_wdt();'

      # Hour 19 (index 18)
      - lvgl.label.update:
          id: lbl_hourly_hour19_header
          text: !lambda |-
            using namespace weather_helpers;
            if (id(weather_hourly_datetime)[18].empty()) return std::string("Hour +19");
            auto now = id(sntp_time).now();
            if (!now.is_valid()) return std::string("Hour +19");
            int hour = convert_to_local_hour(id(weather_hourly_datetime)[18], now.timezone_offset());
            return format_hour(hour);

      - lvgl.label.update:
          id: lbl_hourly_hour19_icon
          text: !lambda |-
            using namespace weather_helpers;
            return get_weather_icon(id(weather_hourly_condition)[18]);
          text_color: !lambda |-
            using namespace weather_helpers;
            return lv_color_hex(get_weather_icon_color(id(weather_hourly_condition)[18]));

      - lvgl.label.update:
          id: lbl_hourly_hour19_temp
          text: !lambda 'return weather_helpers::format_temp(id(weather_hourly_temp)[18]);'

      - lvgl.label.update:
          id: lbl_hourly_hour19_feels
          text: !lambda 'return weather_helpers::format_temp(id(weather_hourly_apparent_temp)[18]);'

      - lvgl.label.update:
          id: lbl_hourly_hour19_precip
          text: !lambda 'return weather_helpers::format_percent(id(weather_hourly_precip_prob)[18]);'

      - lvgl.label.update:
          id: lbl_hourly_hour19_humid
          text: !lambda 'return weather_helpers::format_percent(id(weather_hourly_humidity)[18]);'

      - lvgl.label.update:
          id: lbl_hourly_hour19_precip_amt
          text: !lambda 'return weather_helpers::format_precipitation(id(weather_hourly_precipitation)[18]);'

      - lvgl.label.update:
          id: lbl_hourly_hour19_pressure
          text: !lambda 'return weather_helpers::format_numeric(id(weather_hourly_pressure)[18]);'

      - lvgl.label.update:
          id: lbl_hourly_hour19_uv
          text: !lambda 'return weather_helpers::format_numeric(id(weather_hourly_uv_index)[18]);'

      - lvgl.label.update:
          id: lbl_hourly_hour19_wind
          text: !lambda |-
            if (std::isnan(id(weather_hourly_wind_speed)[18])) return std::string("--");
            char buf[16];
            snprintf(buf, sizeof(buf), "%.0f mph", id(weather_hourly_wind_speed)[18]);
            return std::string(buf);

      - lvgl.label.update:
          id: lbl_hourly_hour19_wind_dir
          text: !lambda 'return weather_helpers::bearing_to_direction(id(weather_hourly_wind_bearing)[18]);'

      # Stack unwind: delay + watchdog feed to prevent overflow
      - delay: 50ms
      - lambda: 'App.feed_wdt();'

      # Hour 20 (index 19)
      - lvgl.label.update:
          id: lbl_hourly_hour20_header
          text: !lambda |-
            using namespace weather_helpers;
            if (id(weather_hourly_datetime)[19].empty()) return std::string("Hour +20");
            auto now = id(sntp_time).now();
            if (!now.is_valid()) return std::string("Hour +20");
            int hour = convert_to_local_hour(id(weather_hourly_datetime)[19], now.timezone_offset());
            return format_hour(hour);

      - lvgl.label.update:
          id: lbl_hourly_hour20_icon
          text: !lambda |-
            using namespace weather_helpers;
            return get_weather_icon(id(weather_hourly_condition)[19]);
          text_color: !lambda |-
            using namespace weather_helpers;
            return lv_color_hex(get_weather_icon_color(id(weather_hourly_condition)[19]));

      - lvgl.label.update:
          id: lbl_hourly_hour20_temp
          text: !lambda 'return weather_helpers::format_temp(id(weather_hourly_temp)[19]);'

      - lvgl.label.update:
          id: lbl_hourly_hour20_feels
          text: !lambda 'return weather_helpers::format_temp(id(weather_hourly_apparent_temp)[19]);'

      - lvgl.label.update:
          id: lbl_hourly_hour20_precip
          text: !lambda 'return weather_helpers::format_percent(id(weather_hourly_precip_prob)[19]);'

      - lvgl.label.update:
          id: lbl_hourly_hour20_humid
          text: !lambda 'return weather_helpers::format_percent(id(weather_hourly_humidity)[19]);'

      - lvgl.label.update:
          id: lbl_hourly_hour20_precip_amt
          text: !lambda 'return weather_helpers::format_precipitation(id(weather_hourly_precipitation)[19]);'

      - lvgl.label.update:
          id: lbl_hourly_hour20_pressure
          text: !lambda 'return weather_helpers::format_numeric(id(weather_hourly_pressure)[19]);'

      - lvgl.label.update:
          id: lbl_hourly_hour20_uv
          text: !lambda 'return weather_helpers::format_numeric(id(weather_hourly_uv_index)[19]);'

      - lvgl.label.update:
          id: lbl_hourly_hour20_wind
          text: !lambda |-
            if (std::isnan(id(weather_hourly_wind_speed)[19])) return std::string("--");
            char buf[16];
            snprintf(buf, sizeof(buf), "%.0f mph", id(weather_hourly_wind_speed)[19]);
            return std::string(buf);

      - lvgl.label.update:
          id: lbl_hourly_hour20_wind_dir
          text: !lambda 'return weather_helpers::bearing_to_direction(id(weather_hourly_wind_bearing)[19]);'

      # Stack unwind: delay + watchdog feed to prevent overflow
      - delay: 50ms
      - lambda: 'App.feed_wdt();'

      # Hour 21 (index 20)
      - lvgl.label.update:
          id: lbl_hourly_hour21_header
          text: !lambda |-
            using namespace weather_helpers;
            if (id(weather_hourly_datetime)[20].empty()) return std::string("Hour +21");
            auto now = id(sntp_time).now();
            if (!now.is_valid()) return std::string("Hour +21");
            int hour = convert_to_local_hour(id(weather_hourly_datetime)[20], now.timezone_offset());
            return format_hour(hour);

      - lvgl.label.update:
          id: lbl_hourly_hour21_icon
          text: !lambda |-
            using namespace weather_helpers;
            return get_weather_icon(id(weather_hourly_condition)[20]);
          text_color: !lambda |-
            using namespace weather_helpers;
            return lv_color_hex(get_weather_icon_color(id(weather_hourly_condition)[20]));

      - lvgl.label.update:
          id: lbl_hourly_hour21_temp
          text: !lambda 'return weather_helpers::format_temp(id(weather_hourly_temp)[20]);'

      - lvgl.label.update:
          id: lbl_hourly_hour21_feels
          text: !lambda 'return weather_helpers::format_temp(id(weather_hourly_apparent_temp)[20]);'

      - lvgl.label.update:
          id: lbl_hourly_hour21_precip
          text: !lambda 'return weather_helpers::format_percent(id(weather_hourly_precip_prob)[20]);'

      - lvgl.label.update:
          id: lbl_hourly_hour21_humid
          text: !lambda 'return weather_helpers::format_percent(id(weather_hourly_humidity)[20]);'

      - lvgl.label.update:
          id: lbl_hourly_hour21_precip_amt
          text: !lambda 'return weather_helpers::format_precipitation(id(weather_hourly_precipitation)[20]);'

      - lvgl.label.update:
          id: lbl_hourly_hour21_pressure
          text: !lambda 'return weather_helpers::format_numeric(id(weather_hourly_pressure)[20]);'

      - lvgl.label.update:
          id: lbl_hourly_hour21_uv
          text: !lambda 'return weather_helpers::format_numeric(id(weather_hourly_uv_index)[20]);'

      - lvgl.label.update:
          id: lbl_hourly_hour21_wind
          text: !lambda |-
            if (std::isnan(id(weather_hourly_wind_speed)[20])) return std::string("--");
            char buf[16];
            snprintf(buf, sizeof(buf), "%.0f mph", id(weather_hourly_wind_speed)[20]);
            return std::string(buf);

      - lvgl.label.update:
          id: lbl_hourly_hour21_wind_dir
          text: !lambda 'return weather_helpers::bearing_to_direction(id(weather_hourly_wind_bearing)[20]);'

      # Stack unwind: delay + watchdog feed to prevent overflow
      - delay: 50ms
      - lambda: 'App.feed_wdt();'

      # Hour 22 (index 21)
      - lvgl.label.update:
          id: lbl_hourly_hour22_header
          text: !lambda |-
            using namespace weather_helpers;
            if (id(weather_hourly_datetime)[21].empty()) return std::string("Hour +22");
            auto now = id(sntp_time).now();
            if (!now.is_valid()) return std::string("Hour +22");
            int hour = convert_to_local_hour(id(weather_hourly_datetime)[21], now.timezone_offset());
            return format_hour(hour);

      - lvgl.label.update:
          id: lbl_hourly_hour22_icon
          text: !lambda |-
            using namespace weather_helpers;
            return get_weather_icon(id(weather_hourly_condition)[21]);
          text_color: !lambda |-
            using namespace weather_helpers;
            return lv_color_hex(get_weather_icon_color(id(weather_hourly_condition)[21]));

      - lvgl.label.update:
          id: lbl_hourly_hour22_temp
          text: !lambda 'return weather_helpers::format_temp(id(weather_hourly_temp)[21]);'

      - lvgl.label.update:
          id: lbl_hourly_hour22_feels
          text: !lambda 'return weather_helpers::format_temp(id(weather_hourly_apparent_temp)[21]);'

      - lvgl.label.update:
          id: lbl_hourly_hour22_precip
          text: !lambda 'return weather_helpers::format_percent(id(weather_hourly_precip_prob)[21]);'

      - lvgl.label.update:
          id: lbl_hourly_hour22_humid
          text: !lambda 'return weather_helpers::format_percent(id(weather_hourly_humidity)[21]);'

      - lvgl.label.update:
          id: lbl_hourly_hour22_precip_amt
          text: !lambda 'return weather_helpers::format_precipitation(id(weather_hourly_precipitation)[21]);'

      - lvgl.label.update:
          id: lbl_hourly_hour22_pressure
          text: !lambda 'return weather_helpers::format_numeric(id(weather_hourly_pressure)[21]);'

      - lvgl.label.update:
          id: lbl_hourly_hour22_uv
          text: !lambda 'return weather_helpers::format_numeric(id(weather_hourly_uv_index)[21]);'

      - lvgl.label.update:
          id: lbl_hourly_hour22_wind
          text: !lambda |-
            if (std::isnan(id(weather_hourly_wind_speed)[21])) return std::string("--");
            char buf[16];
            snprintf(buf, sizeof(buf), "%.0f mph", id(weather_hourly_wind_speed)[21]);
            return std::string(buf);

      - lvgl.label.update:
          id: lbl_hourly_hour22_wind_dir
          text: !lambda 'return weather_helpers::bearing_to_direction(id(weather_hourly_wind_bearing)[21]);'

      # Stack unwind: delay + watchdog feed to prevent overflow
      - delay: 50ms
      - lambda: 'App.feed_wdt();'

      # Hour 23 (index 22)
      - lvgl.label.update:
          id: lbl_hourly_hour23_header
          text: !lambda |-
            using namespace weather_helpers;
            if (id(weather_hourly_datetime)[22].empty()) return std::string("Hour +23");
            auto now = id(sntp_time).now();
            if (!now.is_valid()) return std::string("Hour +23");
            int hour = convert_to_local_hour(id(weather_hourly_datetime)[22], now.timezone_offset());
            return format_hour(hour);

      - lvgl.label.update:
          id: lbl_hourly_hour23_icon
          text: !lambda |-
            using namespace weather_helpers;
            return get_weather_icon(id(weather_hourly_condition)[22]);
          text_color: !lambda |-
            using namespace weather_helpers;
            return lv_color_hex(get_weather_icon_color(id(weather_hourly_condition)[22]));

      - lvgl.label.update:
          id: lbl_hourly_hour23_temp
          text: !lambda 'return weather_helpers::format_temp(id(weather_hourly_temp)[22]);'

      - lvgl.label.update:
          id: lbl_hourly_hour23_feels
          text: !lambda 'return weather_helpers::format_temp(id(weather_hourly_apparent_temp)[22]);'

      - lvgl.label.update:
          id: lbl_hourly_hour23_precip
          text: !lambda 'return weather_helpers::format_percent(id(weather_hourly_precip_prob)[22]);'

      - lvgl.label.update:
          id: lbl_hourly_hour23_humid
          text: !lambda 'return weather_helpers::format_percent(id(weather_hourly_humidity)[22]);'

      - lvgl.label.update:
          id: lbl_hourly_hour23_precip_amt
          text: !lambda 'return weather_helpers::format_precipitation(id(weather_hourly_precipitation)[22]);'

      - lvgl.label.update:
          id: lbl_hourly_hour23_pressure
          text: !lambda 'return weather_helpers::format_numeric(id(weather_hourly_pressure)[22]);'

      - lvgl.label.update:
          id: lbl_hourly_hour23_uv
          text: !lambda 'return weather_helpers::format_numeric(id(weather_hourly_uv_index)[22]);'

      - lvgl.label.update:
          id: lbl_hourly_hour23_wind
          text: !lambda |-
            if (std::isnan(id(weather_hourly_wind_speed)[22])) return std::string("--");
            char buf[16];
            snprintf(buf, sizeof(buf), "%.0f mph", id(weather_hourly_wind_speed)[22]);
            return std::string(buf);

      - lvgl.label.update:
          id: lbl_hourly_hour23_wind_dir
          text: !lambda 'return weather_helpers::bearing_to_direction(id(weather_hourly_wind_bearing)[22]);'

      # ========================================================================
      # Hour 24 - FINAL WATCHDOG FEED POINT
      # ========================================================================
      - lambda: 'App.feed_wdt();'

      # Hour 24 (index 23)
      - lvgl.label.update:
          id: lbl_hourly_hour24_header
          text: !lambda |-
            using namespace weather_helpers;
            if (id(weather_hourly_datetime)[23].empty()) return std::string("Hour +24");
            auto now = id(sntp_time).now();
            if (!now.is_valid()) return std::string("Hour +24");
            int hour = convert_to_local_hour(id(weather_hourly_datetime)[23], now.timezone_offset());
            return format_hour(hour);

      - lvgl.label.update:
          id: lbl_hourly_hour24_icon
          text: !lambda |-
            using namespace weather_helpers;
            return get_weather_icon(id(weather_hourly_condition)[23]);
          text_color: !lambda |-
            using namespace weather_helpers;
            return lv_color_hex(get_weather_icon_color(id(weather_hourly_condition)[23]));

      - lvgl.label.update:
          id: lbl_hourly_hour24_temp
          text: !lambda 'return weather_helpers::format_temp(id(weather_hourly_temp)[23]);'

      - lvgl.label.update:
          id: lbl_hourly_hour24_feels
          text: !lambda 'return weather_helpers::format_temp(id(weather_hourly_apparent_temp)[23]);'

      - lvgl.label.update:
          id: lbl_hourly_hour24_precip
          text: !lambda 'return weather_helpers::format_percent(id(weather_hourly_precip_prob)[23]);'

      - lvgl.label.update:
          id: lbl_hourly_hour24_humid
          text: !lambda 'return weather_helpers::format_percent(id(weather_hourly_humidity)[23]);'

      - lvgl.label.update:
          id: lbl_hourly_hour24_precip_amt
          text: !lambda 'return weather_helpers::format_precipitation(id(weather_hourly_precipitation)[23]);'

      - lvgl.label.update:
          id: lbl_hourly_hour24_pressure
          text: !lambda 'return weather_helpers::format_numeric(id(weather_hourly_pressure)[23]);'

      - lvgl.label.update:
          id: lbl_hourly_hour24_uv
          text: !lambda 'return weather_helpers::format_numeric(id(weather_hourly_uv_index)[23]);'

      - lvgl.label.update:
          id: lbl_hourly_hour24_wind
          text: !lambda |-
            if (std::isnan(id(weather_hourly_wind_speed)[23])) return std::string("--");
            char buf[16];
            snprintf(buf, sizeof(buf), "%.0f mph", id(weather_hourly_wind_speed)[23]);
            return std::string(buf);

      - lvgl.label.update:
          id: lbl_hourly_hour24_wind_dir
          text: !lambda 'return weather_helpers::bearing_to_direction(id(weather_hourly_wind_bearing)[23]);'

     # Update compact 12-hour summary (if summary page is active, these will be visible)
      - if:
          condition:
            lambda: 'return id(current_page_name) == "hourly_summary" || id(current_page_name) == "hourly_forecast";'
          then:
            # Loop-like unrolled updates for summary columns 1..12
            - lvgl.label.update:
                id: lbl_sum_hour1_time
                text: !lambda |-
                  if (id(weather_hourly_datetime)[0].empty()) return std::string("--:--");
                  std::string dt = id(weather_hourly_datetime)[0];
                  if (dt.length() >= 13) {
                    std::string hour_str = dt.substr(11,2);
                    int hour = std::stoi(hour_str);
                    int source_offset_hours = 0;
                    if (dt.length() >= 20) {
                      if (dt[19] == 'Z') source_offset_hours = 0;
                      else if (dt.length() >= 24 && (dt[19] == '+' || dt[19] == '-')) {
                        source_offset_hours = std::stoi(dt.substr(20,2));
                        if (dt[19] == '-') source_offset_hours = -source_offset_hours;
                      }
                    }
                    auto now = id(sntp_time).now();
                    if (now.is_valid()) {
                      int local_offset_hours = now.timezone_offset() / 3600;
                      int utc_hour_val = hour - source_offset_hours;
                      hour = utc_hour_val + local_offset_hours;
                      while (hour < 0) hour += 24;
                      while (hour >= 24) hour -= 24;
                    }
                    char buf[8]; snprintf(buf, sizeof(buf), "%02d:00", hour);
                    return std::string(buf);
                  }
                  return std::string("--:--");

            - lvgl.label.update:
                id: lbl_sum_hour1_icon
                text: !lambda |-
                  std::string condition = id(weather_hourly_condition)[0];
                  if (condition.empty()) return std::string("\U000F14E4");
                  if (condition == "clear-night") return std::string("\U000F0594");
                  if (condition == "cloudy") return std::string("\U000F0590");
                  if (condition == "exceptional") return std::string("\U000F0F2F");
                  if (condition == "fog") return std::string("\U000F0591");
                  if (condition == "hail") return std::string("\U000F0592");
                  if (condition == "lightning") return std::string("\U000F0593");
                  if (condition == "lightning-rainy") return std::string("\U000F067E");
                  if (condition == "partlycloudy") return std::string("\U000F0595");
                  if (condition == "pouring") return std::string("\U000F0596");
                  if (condition == "rainy") return std::string("\U000F0597");
                  if (condition == "snowy") return std::string("\U000F0598");
                  if (condition == "snowy-rainy") return std::string("\U000F067F");
                  if (condition == "sunny") return std::string("\U000F0599");
                  if (condition == "windy") return std::string("\U000F059D");
                  if (condition == "windy-variant") return std::string("\U000F059E");
                  return std::string("\U000F0599");

            - lvgl.label.update:
                id: lbl_sum_hour1_temp
                text: !lambda |-
                  if (isnan(id(weather_hourly_temp)[0])) return std::string("--°");
                  char buf[12]; snprintf(buf, sizeof(buf), "%.0f°", id(weather_hourly_temp)[0]); return std::string(buf);

            - lvgl.label.update:
                id: lbl_sum_hour1_precip
                text: !lambda |-
                  if (isnan(id(weather_hourly_precip_prob)[0])) return std::string("--%");
                  char buf[12]; snprintf(buf, sizeof(buf), "%.0f%%", id(weather_hourly_precip_prob)[0]); return std::string(buf);

            # Repeat for hours 2..12
            - lvgl.label.update:
                id: lbl_sum_hour2_time
                text: !lambda |-
                  if (id(weather_hourly_datetime)[1].empty()) return std::string("--:--");
                  std::string dt = id(weather_hourly_datetime)[1]; if (dt.length() < 13) return std::string("--:--"); std::string hour_str = dt.substr(11,2); int hour = std::stoi(hour_str); int source_offset_hours = 0; if (dt.length()>=20){ if (dt[19]=='Z') source_offset_hours=0; else if (dt.length()>=24 && (dt[19]=='+'||dt[19]=='-')){ source_offset_hours = std::stoi(dt.substr(20,2)); if (dt[19]=='-') source_offset_hours = -source_offset_hours; }} auto now = id(sntp_time).now(); if (now.is_valid()){ int local_offset_hours = now.timezone_offset()/3600; int utc_hour_val = hour - source_offset_hours; hour = utc_hour_val + local_offset_hours; while(hour<0) hour+=24; while(hour>=24) hour-=24;} char buf2[8]; snprintf(buf2,sizeof(buf2),"%02d:00",hour); return std::string(buf2);

            - lvgl.label.update:
                id: lbl_sum_hour2_icon
                text: !lambda |-
                  std::string condition = id(weather_hourly_condition)[1]; if (condition.empty()) return std::string("\U000F14E4"); if (condition=="clear-night") return std::string("\U000F0594"); if (condition=="cloudy") return std::string("\U000F0590"); if (condition=="exceptional") return std::string("\U000F0F2F"); if (condition=="fog") return std::string("\U000F0591"); if (condition=="hail") return std::string("\U000F0592"); if (condition=="lightning") return std::string("\U000F0593"); if (condition=="lightning-rainy") return std::string("\U000F067E"); if (condition=="partlycloudy") return std::string("\U000F0595"); if (condition=="pouring") return std::string("\U000F0596"); if (condition=="rainy") return std::string("\U000F0597"); if (condition=="snowy") return std::string("\U000F0598"); if (condition=="snowy-rainy") return std::string("\U000F067F"); if (condition=="sunny") return std::string("\U000F0599"); if (condition=="windy") return std::string("\U000F059D"); if (condition=="windy-variant") return std::string("\U000F059E"); return std::string("\U000F0599");

            - lvgl.label.update:
                id: lbl_sum_hour2_temp
                text: !lambda |-
                  if (isnan(id(weather_hourly_temp)[1])) return std::string("--°"); char buf[12]; snprintf(buf,sizeof(buf),"%.0f°",id(weather_hourly_temp)[1]); return std::string(buf);

            - lvgl.label.update:
                id: lbl_sum_hour2_precip
                text: !lambda |-
                  if (isnan(id(weather_hourly_precip_prob)[1])) return std::string("--%"); char buf[12]; snprintf(buf,sizeof(buf),"%.0f%%",id(weather_hourly_precip_prob)[1]); return std::string(buf);

            # For brevity repeat pattern for 3..12; use same logic but index shifted (3->2 .. 12->11)
            - lambda: |-
                (void)0;

            - lvgl.label.update:
                id: lbl_sum_hour3_time
                text: !lambda |-
                  if (id(weather_hourly_datetime)[2].empty()) return std::string("--:--"); std::string dt = id(weather_hourly_datetime)[2]; if (dt.length()<13) return std::string("--:--"); std::string hour_str = dt.substr(11,2); int hour = std::stoi(hour_str); int source_offset_hours=0; if (dt.length()>=20){ if (dt[19]=='Z') source_offset_hours=0; else if (dt.length()>=24 && (dt[19]=='+'||dt[19]=='-')){ source_offset_hours= std::stoi(dt.substr(20,2)); if (dt[19]=='-') source_offset_hours=-source_offset_hours; }} auto now = id(sntp_time).now(); if (now.is_valid()){ int local_offset_hours = now.timezone_offset()/3600; int utc_hour_val = hour - source_offset_hours; hour = utc_hour_val + local_offset_hours; while(hour<0) hour+=24; while(hour>=24) hour-=24;} char b3[8]; snprintf(b3,sizeof(b3),"%02d:00",hour); return std::string(b3);

            - lvgl.label.update:
                id: lbl_sum_hour3_icon
                text: !lambda |-
                  std::string condition = id(weather_hourly_condition)[2]; if (condition.empty()) return std::string("\U000F14E4"); if (condition=="clear-night") return std::string("\U000F0594"); if (condition=="cloudy") return std::string("\U000F0590"); if (condition=="exceptional") return std::string("\U000F0F2F"); if (condition=="fog") return std::string("\U000F0591"); if (condition=="hail") return std::string("\U000F0592"); if (condition=="lightning") return std::string("\U000F0593"); if (condition=="lightning-rainy") return std::string("\U000F067E"); if (condition=="partlycloudy") return std::string("\U000F0595"); if (condition=="pouring") return std::string("\U000F0596"); if (condition=="rainy") return std::string("\U000F0597"); if (condition=="snowy") return std::string("\U000F0598"); if (condition=="snowy-rainy") return std::string("\U000F067F"); if (condition=="sunny") return std::string("\U000F0599"); if (condition=="windy") return std::string("\U000F059D"); if (condition=="windy-variant") return std::string("\U000F059E"); return std::string("\U000F0599");

            - lvgl.label.update:
                id: lbl_sum_hour3_temp
                text: !lambda |-
                  if (isnan(id(weather_hourly_temp)[2])) return std::string("--°"); char buf[12]; snprintf(buf,sizeof(buf),"%.0f°",id(weather_hourly_temp)[2]); return std::string(buf);

            - lvgl.label.update:
                id: lbl_sum_hour3_precip
                text: !lambda |-
                  if (isnan(id(weather_hourly_precip_prob)[2])) return std::string("--%"); char buf[12]; snprintf(buf,sizeof(buf),"%.0f%%",id(weather_hourly_precip_prob)[2]); return std::string(buf);

            # hours 4..12 follow same pattern
            - lvgl.label.update:
                id: lbl_sum_hour4_time
                text: !lambda |-
                  if (id(weather_hourly_datetime)[3].empty()) return std::string("--:--"); std::string dt = id(weather_hourly_datetime)[3]; if (dt.length()<13) return std::string("--:--"); std::string hour_str = dt.substr(11,2); int hour = std::stoi(hour_str); int source_offset_hours=0; if (dt.length()>=20){ if (dt[19]=='Z') source_offset_hours=0; else if (dt.length()>=24 && (dt[19]=='+'||dt[19]=='-')){ source_offset_hours= std::stoi(dt.substr(20,2)); if (dt[19]=='-') source_offset_hours=-source_offset_hours; }} auto now = id(sntp_time).now(); if (now.is_valid()){ int local_offset_hours = now.timezone_offset()/3600; int utc_hour_val = hour - source_offset_hours; hour = utc_hour_val + local_offset_hours; while(hour<0) hour+=24; while(hour>=24) hour-=24;} char b4[8]; snprintf(b4,sizeof(b4),"%02d:00",hour); return std::string(b4);

            - lvgl.label.update:
                id: lbl_sum_hour4_icon
                text: !lambda |-
                  std::string condition = id(weather_hourly_condition)[3]; if (condition.empty()) return std::string("\U000F14E4"); if (condition=="clear-night") return std::string("\U000F0594"); if (condition=="cloudy") return std::string("\U000F0590"); if (condition=="exceptional") return std::string("\U000F0F2F"); if (condition=="fog") return std::string("\U000F0591"); if (condition=="hail") return std::string("\U000F0592"); if (condition=="lightning") return std::string("\U000F0593"); if (condition=="lightning-rainy") return std::string("\U000F067E"); if (condition=="partlycloudy") return std::string("\U000F0595"); if (condition=="pouring") return std::string("\U000F0596"); if (condition=="rainy") return std::string("\U000F0597"); if (condition=="snowy") return std::string("\U000F0598"); if (condition=="snowy-rainy") return std::string("\U000F067F"); if (condition=="sunny") return std::string("\U000F0599"); if (condition=="windy") return std::string("\U000F059D"); if (condition=="windy-variant") return std::string("\U000F059E"); return std::string("\U000F0599");

            - lvgl.label.update:
                id: lbl_sum_hour4_temp
                text: !lambda |-
                  if (isnan(id(weather_hourly_temp)[3])) return std::string("--°"); char buf[12]; snprintf(buf,sizeof(buf),"%.0f°",id(weather_hourly_temp)[3]); return std::string(buf);

            - lvgl.label.update:
                id: lbl_sum_hour4_precip
                text: !lambda |-
                  if (isnan(id(weather_hourly_precip_prob)[3])) return std::string("--%"); char buf[12]; snprintf(buf,sizeof(buf),"%.0f%%",id(weather_hourly_precip_prob)[3]); return std::string(buf);

            - lvgl.label.update:
                id: lbl_sum_hour5_time
                text: !lambda |-
                  if (id(weather_hourly_datetime)[4].empty()) return std::string("--:--"); std::string dt = id(weather_hourly_datetime)[4]; if (dt.length()<13) return std::string("--:--"); std::string hour_str = dt.substr(11,2); int hour = std::stoi(hour_str); int source_offset_hours=0; if (dt.length()>=20){ if (dt[19]=='Z') source_offset_hours=0; else if (dt.length()>=24 && (dt[19]=='+'||dt[19]=='-')){ source_offset_hours= std::stoi(dt.substr(20,2)); if (dt[19]=='-') source_offset_hours=-source_offset_hours; }} auto now = id(sntp_time).now(); if (now.is_valid()){ int local_offset_hours = now.timezone_offset()/3600; int utc_hour_val = hour - source_offset_hours; hour = utc_hour_val + local_offset_hours; while(hour<0) hour+=24; while(hour>=24) hour-=24;} char b5[8]; snprintf(b5,sizeof(b5),"%02d:00",hour); return std::string(b5);

            - lvgl.label.update:
                id: lbl_sum_hour5_icon
                text: !lambda |-
                  std::string condition = id(weather_hourly_condition)[4]; if (condition.empty()) return std::string("\U000F14E4"); if (condition=="clear-night") return std::string("\U000F0594"); if (condition=="cloudy") return std::string("\U000F0590"); if (condition=="exceptional") return std::string("\U000F0F2F"); if (condition=="fog") return std::string("\U000F0591"); if (condition=="hail") return std::string("\U000F0592"); if (condition=="lightning") return std::string("\U000F0593"); if (condition=="lightning-rainy") return std::string("\U000F067E"); if (condition=="partlycloudy") return std::string("\U000F0595"); if (condition=="pouring") return std::string("\U000F0596"); if (condition=="rainy") return std::string("\U000F0597"); if (condition=="snowy") return std::string("\U000F0598"); if (condition=="snowy-rainy") return std::string("\U000F067F"); if (condition=="sunny") return std::string("\U000F0599"); if (condition=="windy") return std::string("\U000F059D"); if (condition=="windy-variant") return std::string("\U000F059E"); return std::string("\U000F0599");

            - lvgl.label.update:
                id: lbl_sum_hour5_temp
                text: !lambda |-
                  if (isnan(id(weather_hourly_temp)[4])) return std::string("--°"); char buf[12]; snprintf(buf,sizeof(buf),"%.0f°",id(weather_hourly_temp)[4]); return std::string(buf);

            - lvgl.label.update:
                id: lbl_sum_hour5_precip
                text: !lambda |-
                  if (isnan(id(weather_hourly_precip_prob)[4])) return std::string("--%"); char buf[12]; snprintf(buf,sizeof(buf),"%.0f%%",id(weather_hourly_precip_prob)[4]); return std::string(buf);

            - lvgl.label.update:
                id: lbl_sum_hour6_time
                text: !lambda |-
                  if (id(weather_hourly_datetime)[5].empty()) return std::string("--:--"); std::string dt = id(weather_hourly_datetime)[5]; if (dt.length()<13) return std::string("--:--"); std::string hour_str = dt.substr(11,2); int hour = std::stoi(hour_str); int source_offset_hours=0; if (dt.length()>=20){ if (dt[19]=='Z') source_offset_hours=0; else if (dt.length()>=24 && (dt[19]=='+'||dt[19]=='-')){ source_offset_hours= std::stoi(dt.substr(20,2)); if (dt[19]=='-') source_offset_hours=-source_offset_hours; }} auto now = id(sntp_time).now(); if (now.is_valid()){ int local_offset_hours = now.timezone_offset()/3600; int utc_hour_val = hour - source_offset_hours; hour = utc_hour_val + local_offset_hours; while(hour<0) hour+=24; while(hour>=24) hour-=24;} char b6[8]; snprintf(b6,sizeof(b6),"%02d:00",hour); return std::string(b6);

            - lvgl.label.update:
                id: lbl_sum_hour6_icon
                text: !lambda |-
                  std::string condition = id(weather_hourly_condition)[5]; if (condition.empty()) return std::string("\U000F14E4"); if (condition=="clear-night") return std::string("\U000F0594"); if (condition=="cloudy") return std::string("\U000F0590"); if (condition=="exceptional") return std::string("\U000F0F2F"); if (condition=="fog") return std::string("\U000F0591"); if (condition=="hail") return std::string("\U000F0592"); if (condition=="lightning") return std::string("\U000F0593"); if (condition=="lightning-rainy") return std::string("\U000F067E"); if (condition=="partlycloudy") return std::string("\U000F0595"); if (condition=="pouring") return std::string("\U000F0596"); if (condition=="rainy") return std::string("\U000F0597"); if (condition=="snowy") return std::string("\U000F0598"); if (condition=="snowy-rainy") return std::string("\U000F067F"); if (condition=="sunny") return std::string("\U000F0599"); if (condition=="windy") return std::string("\U000F059D"); if (condition=="windy-variant") return std::string("\U000F059E"); return std::string("\U000F0599");

            - lvgl.label.update:
                id: lbl_sum_hour6_temp
                text: !lambda |-
                  if (isnan(id(weather_hourly_temp)[5])) return std::string("--°"); char buf[12]; snprintf(buf,sizeof(buf),"%.0f°",id(weather_hourly_temp)[5]); return std::string(buf);

            - lvgl.label.update:
                id: lbl_sum_hour6_precip
                text: !lambda |-
                  if (isnan(id(weather_hourly_precip_prob)[5])) return std::string("--%"); char buf[12]; snprintf(buf,sizeof(buf),"%.0f%%",id(weather_hourly_precip_prob)[5]); return std::string(buf);

            # hours 7..12

            - lvgl.label.update:
                id: lbl_sum_hour7_time
                text: !lambda |-
                  if (id(weather_hourly_datetime)[6].empty()) return std::string("--:--"); std::string dt = id(weather_hourly_datetime)[6]; if (dt.length()<13) return std::string("--:--"); std::string hour_str = dt.substr(11,2); int hour = std::stoi(hour_str); int source_offset_hours=0; if (dt.length()>=20){ if (dt[19]=='Z') source_offset_hours=0; else if (dt.length()>=24 && (dt[19]=='+'||dt[19]=='-')){ source_offset_hours= std::stoi(dt.substr(20,2)); if (dt[19]=='-') source_offset_hours=-source_offset_hours; }} auto now = id(sntp_time).now(); if (now.is_valid()){ int local_offset_hours = now.timezone_offset()/3600; int utc_hour_val = hour - source_offset_hours; hour = utc_hour_val + local_offset_hours; while(hour<0) hour+=24; while(hour>=24) hour-=24;} char b7[8]; snprintf(b7,sizeof(b7),"%02d:00",hour); return std::string(b7);

            - lvgl.label.update:
                id: lbl_sum_hour7_icon
                text: !lambda |-
                  std::string condition = id(weather_hourly_condition)[6]; if (condition.empty()) return std::string("\U000F14E4"); if (condition=="clear-night") return std::string("\U000F0594"); if (condition=="cloudy") return std::string("\U000F0590"); if (condition=="exceptional") return std::string("\U000F0F2F"); if (condition=="fog") return std::string("\U000F0591"); if (condition=="hail") return std::string("\U000F0592"); if (condition=="lightning") return std::string("\U000F0593"); if (condition=="lightning-rainy") return std::string("\U000F067E"); if (condition=="partlycloudy") return std::string("\U000F0595"); if (condition=="pouring") return std::string("\U000F0596"); if (condition=="rainy") return std::string("\U000F0597"); if (condition=="snowy") return std::string("\U000F0598"); if (condition=="snowy-rainy") return std::string("\U000F067F"); if (condition=="sunny") return std::string("\U000F0599"); if (condition=="windy") return std::string("\U000F059D"); if (condition=="windy-variant") return std::string("\U000F059E"); return std::string("\U000F0599");

            - lvgl.label.update:
                id: lbl_sum_hour7_temp
                text: !lambda |-
                  if (isnan(id(weather_hourly_temp)[6])) return std::string("--°"); char buf[12]; snprintf(buf,sizeof(buf),"%.0f°",id(weather_hourly_temp)[6]); return std::string(buf);

            - lvgl.label.update:
                id: lbl_sum_hour7_precip
                text: !lambda |-
                  if (isnan(id(weather_hourly_precip_prob)[6])) return std::string("--%"); char buf[12]; snprintf(buf,sizeof(buf),"%.0f%%",id(weather_hourly_precip_prob)[6]); return std::string(buf);

            - lvgl.label.update:
                id: lbl_sum_hour8_time
                text: !lambda |-
                  if (id(weather_hourly_datetime)[7].empty()) return std::string("--:--"); std::string dt = id(weather_hourly_datetime)[7]; if (dt.length()<13) return std::string("--:--"); std::string hour_str = dt.substr(11,2); int hour = std::stoi(hour_str); int source_offset_hours=0; if (dt.length()>=20){ if (dt[19]=='Z') source_offset_hours=0; else if (dt.length()>=24 && (dt[19]=='+'||dt[19]=='-')){ source_offset_hours= std::stoi(dt.substr(20,2)); if (dt[19]=='-') source_offset_hours=-source_offset_hours; }} auto now = id(sntp_time).now(); if (now.is_valid()){ int local_offset_hours = now.timezone_offset()/3600; int utc_hour_val = hour - source_offset_hours; hour = utc_hour_val + local_offset_hours; while(hour<0) hour+=24; while(hour>=24) hour-=24;} char b8[8]; snprintf(b8,sizeof(b8),"%02d:00",hour); return std::string(b8);

            - lvgl.label.update:
                id: lbl_sum_hour8_icon
                text: !lambda |-
                  std::string condition = id(weather_hourly_condition)[7]; if (condition.empty()) return std::string("\U000F14E4"); if (condition=="clear-night") return std::string("\U000F0594"); if (condition=="cloudy") return std::string("\U000F0590"); if (condition=="exceptional") return std::string("\U000F0F2F"); if (condition=="fog") return std::string("\U000F0591"); if (condition=="hail") return std::string("\U000F0592"); if (condition=="lightning") return std::string("\U000F0593"); if (condition=="lightning-rainy") return std::string("\U000F067E"); if (condition=="partlycloudy") return std::string("\U000F0595"); if (condition=="pouring") return std::string("\U000F0596"); if (condition=="rainy") return std::string("\U000F0597"); if (condition=="snowy") return std::string("\U000F0598"); if (condition=="snowy-rainy") return std::string("\U000F067F"); if (condition=="sunny") return std::string("\U000F0599"); if (condition=="windy") return std::string("\U000F059D"); if (condition=="windy-variant") return std::string("\U000F059E"); return std::string("\U000F0599");

            - lvgl.label.update:
                id: lbl_sum_hour8_temp
                text: !lambda |-
                  if (isnan(id(weather_hourly_temp)[7])) return std::string("--°"); char buf[12]; snprintf(buf,sizeof(buf),"%.0f°",id(weather_hourly_temp)[7]); return std::string(buf);

            - lvgl.label.update:
                id: lbl_sum_hour8_precip
                text: !lambda |-
                  if (isnan(id(weather_hourly_precip_prob)[7])) return std::string("--%"); char buf[12]; snprintf(buf,sizeof(buf),"%.0f%%",id(weather_hourly_precip_prob)[7]); return std::string(buf);

            - lvgl.label.update:
                id: lbl_sum_hour9_time
                text: !lambda |-
                  if (id(weather_hourly_datetime)[8].empty()) return std::string("--:--"); std::string dt = id(weather_hourly_datetime)[8]; if (dt.length()<13) return std::string("--:--"); std::string hour_str = dt.substr(11,2); int hour = std::stoi(hour_str); int source_offset_hours=0; if (dt.length()>=20){ if (dt[19]=='Z') source_offset_hours=0; else if (dt.length()>=24 && (dt[19]=='+'||dt[19]=='-')){ source_offset_hours= std::stoi(dt.substr(20,2)); if (dt[19]=='-') source_offset_hours=-source_offset_hours; }} auto now = id(sntp_time).now(); if (now.is_valid()){ int local_offset_hours = now.timezone_offset()/3600; int utc_hour_val = hour - source_offset_hours; hour = utc_hour_val + local_offset_hours; while(hour<0) hour+=24; while(hour>=24) hour-=24;} char b9[8]; snprintf(b9,sizeof(b9),"%02d:00",hour); return std::string(b9);

            - lvgl.label.update:
                id: lbl_sum_hour9_icon
                text: !lambda |-
                  std::string condition = id(weather_hourly_condition)[8]; if (condition.empty()) return std::string("\U000F14E4"); if (condition=="clear-night") return std::string("\U000F0594"); if (condition=="cloudy") return std::string("\U000F0590"); if (condition=="exceptional") return std::string("\U000F0F2F"); if (condition=="fog") return std::string("\U000F0591"); if (condition=="hail") return std::string("\U000F0592"); if (condition=="lightning") return std::string("\U000F0593"); if (condition=="lightning-rainy") return std::string("\U000F067E"); if (condition=="partlycloudy") return std::string("\U000F0595"); if (condition=="pouring") return std::string("\U000F0596"); if (condition=="rainy") return std::string("\U000F0597"); if (condition=="snowy") return std::string("\U000F0598"); if (condition=="snowy-rainy") return std::string("\U000F067F"); if (condition=="sunny") return std::string("\U000F0599"); if (condition=="windy") return std::string("\U000F059D"); if (condition=="windy-variant") return std::string("\U000F059E"); return std::string("\U000F0599");

            - lvgl.label.update:
                id: lbl_sum_hour9_temp
                text: !lambda |-
                  if (isnan(id(weather_hourly_temp)[8])) return std::string("--°"); char buf[12]; snprintf(buf,sizeof(buf),"%.0f°",id(weather_hourly_temp)[8]); return std::string(buf);

            - lvgl.label.update:
                id: lbl_sum_hour9_precip
                text: !lambda |-
                  if (isnan(id(weather_hourly_precip_prob)[8])) return std::string("--%"); char buf[12]; snprintf(buf,sizeof(buf),"%.0f%%",id(weather_hourly_precip_prob)[8]); return std::string(buf);

            - lvgl.label.update:
                id: lbl_sum_hour10_time
                text: !lambda |-
                  if (id(weather_hourly_datetime)[9].empty()) return std::string("--:--"); std::string dt = id(weather_hourly_datetime)[9]; if (dt.length()<13) return std::string("--:--"); std::string hour_str = dt.substr(11,2); int hour = std::stoi(hour_str); int source_offset_hours=0; if (dt.length()>=20){ if (dt[19]=='Z') source_offset_hours=0; else if (dt.length()>=24 && (dt[19]=='+'||dt[19]=='-')){ source_offset_hours= std::stoi(dt.substr(20,2)); if (dt[19]=='-') source_offset_hours=-source_offset_hours; }} auto now = id(sntp_time).now(); if (now.is_valid()){ int local_offset_hours = now.timezone_offset()/3600; int utc_hour_val = hour - source_offset_hours; hour = utc_hour_val + local_offset_hours; while(hour<0) hour+=24; while(hour>=24) hour-=24;} char b10[8]; snprintf(b10,sizeof(b10),"%02d:00",hour); return std::string(b10);

            - lvgl.label.update:
                id: lbl_sum_hour10_icon
                text: !lambda |-
                  std::string condition = id(weather_hourly_condition)[9]; if (condition.empty()) return std::string("\U000F14E4"); if (condition=="clear-night") return std::string("\U000F0594"); if (condition=="cloudy") return std::string("\U000F0590"); if (condition=="exceptional") return std::string("\U000F0F2F"); if (condition=="fog") return std::string("\U000F0591"); if (condition=="hail") return std::string("\U000F0592"); if (condition=="lightning") return std::string("\U000F0593"); if (condition=="lightning-rainy") return std::string("\U000F067E"); if (condition=="partlycloudy") return std::string("\U000F0595"); if (condition=="pouring") return std::string("\U000F0596"); if (condition=="rainy") return std::string("\U000F0597"); if (condition=="snowy") return std::string("\U000F0598"); if (condition=="snowy-rainy") return std::string("\U000F067F"); if (condition=="sunny") return std::string("\U000F0599"); if (condition=="windy") return std::string("\U000F059D"); if (condition=="windy-variant") return std::string("\U000F059E"); return std::string("\U000F0599");

            - lvgl.label.update:
                id: lbl_sum_hour10_temp
                text: !lambda |-
                  if (isnan(id(weather_hourly_temp)[9])) return std::string("--°"); char buf[12]; snprintf(buf,sizeof(buf),"%.0f°",id(weather_hourly_temp)[9]); return std::string(buf);

            - lvgl.label.update:
                id: lbl_sum_hour10_precip
                text: !lambda |-
                  if (isnan(id(weather_hourly_precip_prob)[9])) return std::string("--%"); char buf[12]; snprintf(buf,sizeof(buf),"%.0f%%",id(weather_hourly_precip_prob)[9]); return std::string(buf);

            - lvgl.label.update:
                id: lbl_sum_hour11_time
                text: !lambda |-
                  if (id(weather_hourly_datetime)[10].empty()) return std::string("--:--"); std::string dt = id(weather_hourly_datetime)[10]; if (dt.length()<13) return std::string("--:--"); std::string hour_str = dt.substr(11,2); int hour = std::stoi(hour_str); int source_offset_hours=0; if (dt.length()>=20){ if (dt[19]=='Z') source_offset_hours=0; else if (dt.length()>=24 && (dt[19]=='+'||dt[19]=='-')){ source_offset_hours= std::stoi(dt.substr(20,2)); if (dt[19]=='-') source_offset_hours=-source_offset_hours; }} auto now = id(sntp_time).now(); if (now.is_valid()){ int local_offset_hours = now.timezone_offset()/3600; int utc_hour_val = hour - source_offset_hours; hour = utc_hour_val + local_offset_hours; while(hour<0) hour+=24; while(hour>=24) hour-=24;} char b11[8]; snprintf(b11,sizeof(b11),"%02d:00",hour); return std::string(b11);

            - lvgl.label.update:
                id: lbl_sum_hour11_icon
                text: !lambda |-
                  std::string condition = id(weather_hourly_condition)[10]; if (condition.empty()) return std::string("\U000F14E4"); if (condition=="clear-night") return std::string("\U000F0594"); if (condition=="cloudy") return std::string("\U000F0590"); if (condition=="exceptional") return std::string("\U000F0F2F"); if (condition=="fog") return std::string("\U000F0591"); if (condition=="hail") return std::string("\U000F0592"); if (condition=="lightning") return std::string("\U000F0593"); if (condition=="lightning-rainy") return std::string("\U000F067E"); if (condition=="partlycloudy") return std::string("\U000F0595"); if (condition=="pouring") return std::string("\U000F0596"); if (condition=="rainy") return std::string("\U000F0597"); if (condition=="snowy") return std::string("\U000F0598"); if (condition=="snowy-rainy") return std::string("\U000F067F"); if (condition=="sunny") return std::string("\U000F0599"); if (condition=="windy") return std::string("\U000F059D"); if (condition=="windy-variant") return std::string("\U000F059E"); return std::string("\U000F0599");

            - lvgl.label.update:
                id: lbl_sum_hour11_temp
                text: !lambda |-
                  if (isnan(id(weather_hourly_temp)[10])) return std::string("--°"); char buf[12]; snprintf(buf,sizeof(buf),"%.0f°",id(weather_hourly_temp)[10]); return std::string(buf);

            - lvgl.label.update:
                id: lbl_sum_hour11_precip
                text: !lambda |-
                  if (isnan(id(weather_hourly_precip_prob)[10])) return std::string("--%"); char buf[12]; snprintf(buf,sizeof(buf),"%.0f%%",id(weather_hourly_precip_prob)[10]); return std::string(buf);

            - lvgl.label.update:
                id: lbl_sum_hour12_time
                text: !lambda |-
                  if (id(weather_hourly_datetime)[11].empty()) return std::string("--:--"); std::string dt = id(weather_hourly_datetime)[11]; if (dt.length()<13) return std::string("--:--"); std::string hour_str = dt.substr(11,2); int hour = std::stoi(hour_str); int source_offset_hours=0; if (dt.length()>=20){ if (dt[19]=='Z') source_offset_hours=0; else if (dt.length()>=24 && (dt[19]=='+'||dt[19]=='-')){ source_offset_hours= std::stoi(dt.substr(20,2)); if (dt[19]=='-') source_offset_hours=-source_offset_hours; }} auto now = id(sntp_time).now(); if (now.is_valid()){ int local_offset_hours = now.timezone_offset()/3600; int utc_hour_val = hour - source_offset_hours; hour = utc_hour_val + local_offset_hours; while(hour<0) hour+=24; while(hour>=24) hour-=24;} char b12[8]; snprintf(b12,sizeof(b12),"%02d:00",hour); return std::string(b12);

            - lvgl.label.update:
                id: lbl_sum_hour12_icon
                text: !lambda |-
                  std::string condition = id(weather_hourly_condition)[11]; if (condition.empty()) return std::string("\U000F14E4"); if (condition=="clear-night") return std::string("\U000F0594"); if (condition=="cloudy") return std::string("\U000F0590"); if (condition=="exceptional") return std::string("\U000F0F2F"); if (condition=="fog") return std::string("\U000F0591"); if (condition=="hail") return std::string("\U000F0592"); if (condition=="lightning") return std::string("\U000F0593"); if (condition=="lightning-rainy") return std::string("\U000F067E"); if (condition=="partlycloudy") return std::string("\U000F0595"); if (condition=="pouring") return std::string("\U000F0596"); if (condition=="rainy") return std::string("\U000F0597"); if (condition=="snowy") return std::string("\U000F0598"); if (condition=="snowy-rainy") return std::string("\U000F067F"); if (condition=="sunny") return std::string("\U000F0599"); if (condition=="windy") return std::string("\U000F059D"); if (condition=="windy-variant") return std::string("\U000F059E"); return std::string("\U000F0599");

            - lvgl.label.update:
                id: lbl_sum_hour12_temp
                text: !lambda |-
                  if (isnan(id(weather_hourly_temp)[11])) return std::string("--°"); char buf[12]; snprintf(buf,sizeof(buf),"%.0f°",id(weather_hourly_temp)[11]); return std::string(buf);

            - lvgl.label.update:
                id: lbl_sum_hour12_precip
                text: !lambda |-
                  if (isnan(id(weather_hourly_precip_prob)[11])) return std::string("--%"); char buf[12]; snprintf(buf,sizeof(buf),"%.0f%%",id(weather_hourly_precip_prob)[11]); return std::string(buf);

  # Script to update daily forecast pages
  - id: update_daily_forecast_display
    mode: single  # Queue if already running to prevent restart overhead
    then:
      # Skip if not on daily forecast page to reduce SPI traffic
      - if:
          condition:
            lambda: 'return id(current_page_name) != "daily_forecast";'
          then:
            - logger.log: "Skipping daily forecast update (not on daily forecast page)"
            - script.stop: update_daily_forecast_display
      # Feed watchdog before long LVGL operation
      - lambda: 'App.feed_wdt();'
      - logger.log: "Updating daily forecast display..."
      # Update Day 2
      - lvgl.label.update:
          id: lbl_forecast_day2_header
          text: !lambda |-
            if (id(weather_forecast_datetime)[1].empty()) return std::string("Day +2 (--/--)");
            // Parse datetime string (format: "2024-11-01T00:00:00+00:00")
            std::string dt = id(weather_forecast_datetime)[1];
            if (dt.length() >= 19) {
              // Parse the datetime components
              int year = std::stoi(dt.substr(0, 4));
              int month = std::stoi(dt.substr(5, 2));
              int day = std::stoi(dt.substr(8, 2));
              int hour = std::stoi(dt.substr(11, 2));
              
              // Parse timezone offset if present
              if (dt.length() >= 25 && (dt[19] == '+' || dt[19] == '-')) {
                int offset_hours = std::stoi(dt.substr(20, 2));
                if (dt[19] == '-') offset_hours = -offset_hours;
                
                // Get local timezone offset
                auto now = id(sntp_time).now();
                if (now.is_valid()) {
                  time_t utc_time = now.timestamp;
                  struct tm *utc_tm = gmtime(&utc_time);
                  struct tm *local_tm = localtime(&utc_time);
                  int utc_hour = utc_tm->tm_hour;
                  int local_hour = local_tm->tm_hour;
                  int local_offset = local_hour - utc_hour;
                  
                  // Handle day boundary crossing in offset calculation
                  if (local_offset > 12) local_offset -= 24;
                  if (local_offset < -12) local_offset += 24;
                  
                  // Adjust hour for timezone difference
                  hour += (local_offset - offset_hours);
                  
                  // Handle day boundary crossing
                  if (hour < 0) {
                    day--;
                    if (day < 1) {
                      month--;
                      if (month < 1) {
                        month = 12;
                        year--;
                      }
                      // Get days in previous month (simplified)
                      int days_in_month[] = {31,28,31,30,31,30,31,31,30,31,30,31};
                      if (month == 2 && (year % 4 == 0 && (year % 100 != 0 || year % 400 == 0))) {
                        day = 29;
                      } else {
                        day = days_in_month[month-1];
                      }
                    }
                  } else if (hour >= 24) {
                    day++;
                    int days_in_month[] = {31,28,31,30,31,30,31,31,30,31,30,31};
                    int max_days = days_in_month[month-1];
                    if (month == 2 && (year % 4 == 0 && (year % 100 != 0 || year % 400 == 0))) {
                      max_days = 29;
                    }
                    if (day > max_days) {
                      day = 1;
                      month++;
                      if (month > 12) {
                        month = 1;
                        year++;
                      }
                    }
                  }
                }
              }
              
              char buf[32];
              snprintf(buf, sizeof(buf), "Day +2 (%02d/%02d)", month, day);
              return std::string(buf);
            }
            return std::string("Day +2 (--/--)");
      - lvgl.label.update:
          id: lbl_forecast_day2_icon
          text: !lambda |-
            std::string condition = id(weather_forecast_condition)[1];
            if (condition.empty()) return std::string("\U000F14E4");  // question-mark-circle icon
            if (condition == "clear-night") return std::string("\U000F0594");
            if (condition == "cloudy") return std::string("\U000F0590");
            if (condition == "exceptional") return std::string("\U000F0F2F");
            if (condition == "fog") return std::string("\U000F0591");
            if (condition == "hail") return std::string("\U000F0592");
            if (condition == "lightning") return std::string("\U000F0593");
            if (condition == "lightning-rainy") return std::string("\U000F067E");
            if (condition == "partlycloudy") return std::string("\U000F0595");
            if (condition == "pouring") return std::string("\U000F0596");
            if (condition == "rainy") return std::string("\U000F0597");
            if (condition == "snowy") return std::string("\U000F0598");
            if (condition == "snowy-rainy") return std::string("\U000F067F");
            if (condition == "sunny") return std::string("\U000F0599");
            if (condition == "windy") return std::string("\U000F059D");
            if (condition == "windy-variant") return std::string("\U000F059E");
            return std::string("\U000F0599");
          text_color: !lambda |-
            std::string condition = id(weather_forecast_condition)[1];
            if (condition.find("clear-night") != std::string::npos) return lv_color_hex(0x6A5ACD);
            else if (condition.find("sunny") != std::string::npos || condition.find("clear") != std::string::npos) return lv_color_hex(0xFFD700);
            else if (condition.find("snowy-rainy") != std::string::npos) return lv_color_hex(0xAFEEEE);
            else if (condition.find("lightning-rainy") != std::string::npos || condition.find("lightning") != std::string::npos) return lv_color_hex(0xFF1493);
            else if (condition.find("partlycloudy") != std::string::npos) return lv_color_hex(0x87CEFA);
            else if (condition.find("cloudy") != std::string::npos) return lv_color_hex(0xA9A9A9);
            else if (condition.find("rainy") != std::string::npos || condition.find("pouring") != std::string::npos) return lv_color_hex(0x4169E1);
            else if (condition.find("snowy") != std::string::npos) return lv_color_hex(0xDCDCDC);
            else if (condition.find("fog") != std::string::npos) return lv_color_hex(0xB0C4DE);
            else if (condition.find("windy") != std::string::npos) return lv_color_hex(0x90EE90);
            else return lv_color_hex(0xFFFFFF);
      - lvgl.label.update:
          id: lbl_forecast_day2_temps
          text: !lambda |-
            char buf[64];
            float high = id(weather_forecast_temp_high)[1];
            float low = id(weather_forecast_temp_low)[1];
            if (isnan(high) || isnan(low)) {
              return std::string("H:--° L:--°");
            }
            snprintf(buf, sizeof(buf), "#FF0000 H:%.0f°# #00DFFF L:%.0f°#", high, low);
            return std::string(buf);
      - lvgl.label.update:
          id: lbl_forecast_day2_precip_prob
          text: !lambda |-
            if (isnan(id(weather_forecast_precip_prob)[1])) return std::string("Rain: --%");
            char buf[32];
            snprintf(buf, sizeof(buf), "Chance: %.0f%%", id(weather_forecast_precip_prob)[1]);
            return std::string(buf);
      - lvgl.label.update:
          id: lbl_forecast_day2_condition
          text: !lambda |-
            if (id(weather_forecast_condition)[1].empty()) return std::string("---");
            // Format condition text to be more readable
            std::string condition = id(weather_forecast_condition)[1];
            if (condition == "clear-night") return std::string("Clear Night");
            if (condition == "cloudy") return std::string("Cloudy");
            if (condition == "exceptional") return std::string("Exceptional");
            if (condition == "fog") return std::string("Fog");
            if (condition == "hail") return std::string("Hail");
            if (condition == "lightning") return std::string("Lightning");
            if (condition == "lightning-rainy") return std::string("Lightning & Rain");
            if (condition == "partlycloudy") return std::string("Partly Cloudy");
            if (condition == "pouring") return std::string("Pouring");
            if (condition == "rainy") return std::string("Rainy");
            if (condition == "snowy") return std::string("Snowy");
            if (condition == "snowy-rainy") return std::string("Sleet");
            if (condition == "sunny") return std::string("Sunny");
            if (condition == "windy") return std::string("Windy");
            if (condition == "windy-variant") return std::string("Windy Windy");
            // Return capitalized version if not matched
            if (!condition.empty()) {
              condition[0] = toupper(condition[0]);
            }
            return condition;

      # Small delay to prevent system overload
      - delay: 30ms

      # Update Day 3
      - lvgl.label.update:
          id: lbl_forecast_day3_header
          text: !lambda |-
            if (id(weather_forecast_datetime)[2].empty()) return std::string("Day +3 (--/--)");
            std::string dt = id(weather_forecast_datetime)[2];
            if (dt.length() >= 19) {
              int year = std::stoi(dt.substr(0, 4));
              int month = std::stoi(dt.substr(5, 2));
              int day = std::stoi(dt.substr(8, 2));
              int hour = std::stoi(dt.substr(11, 2));
              
              if (dt.length() >= 25 && (dt[19] == '+' || dt[19] == '-')) {
                int offset_hours = std::stoi(dt.substr(20, 2));
                if (dt[19] == '-') offset_hours = -offset_hours;
                
                auto now = id(sntp_time).now();
                if (now.is_valid()) {
                  time_t utc_time = now.timestamp;
                  struct tm *utc_tm = gmtime(&utc_time);
                  struct tm *local_tm = localtime(&utc_time);
                  int utc_hour = utc_tm->tm_hour;
                  int local_hour = local_tm->tm_hour;
                  int local_offset = local_hour - utc_hour;
                  
                  // Handle day boundary crossing in offset calculation
                  if (local_offset > 12) local_offset -= 24;
                  if (local_offset < -12) local_offset += 24;
                  hour += (local_offset - offset_hours);
                  
                  if (hour < 0) {
                    day--;
                    if (day < 1) {
                      month--;
                      if (month < 1) {
                        month = 12;
                        year--;
                      }
                      int days_in_month[] = {31,28,31,30,31,30,31,31,30,31,30,31};
                      if (month == 2 && (year % 4 == 0 && (year % 100 != 0 || year % 400 == 0))) {
                        day = 29;
                      } else {
                        day = days_in_month[month-1];
                      }
                    }
                  } else if (hour >= 24) {
                    day++;
                    int days_in_month[] = {31,28,31,30,31,30,31,31,30,31,30,31};
                    int max_days = days_in_month[month-1];
                    if (month == 2 && (year % 4 == 0 && (year % 100 != 0 || year % 400 == 0))) {
                      max_days = 29;
                    }
                    if (day > max_days) {
                      day = 1;
                      month++;
                      if (month > 12) {
                        month = 1;
                        year++;
                      }
                    }
                  }
                }
              }
              
              char buf[32];
              snprintf(buf, sizeof(buf), "Day +3 (%02d/%02d)", month, day);
              return std::string(buf);
            }
            return std::string("Day +3 (--/--)");
      - lvgl.label.update:
          id: lbl_forecast_day3_icon
          text: !lambda |-
            std::string condition = id(weather_forecast_condition)[2];
            if (condition.empty()) return std::string("\U000F14E4");  // question-mark-circle icon
            if (condition == "clear-night") return std::string("\U000F0594");
            if (condition == "cloudy") return std::string("\U000F0590");
            if (condition == "exceptional") return std::string("\U000F0F2F");
            if (condition == "fog") return std::string("\U000F0591");
            if (condition == "hail") return std::string("\U000F0592");
            if (condition == "lightning") return std::string("\U000F0593");
            if (condition == "lightning-rainy") return std::string("\U000F067E");
            if (condition == "partlycloudy") return std::string("\U000F0595");
            if (condition == "pouring") return std::string("\U000F0596");
            if (condition == "rainy") return std::string("\U000F0597");
            if (condition == "snowy") return std::string("\U000F0598");
            if (condition == "snowy-rainy") return std::string("\U000F067F");
            if (condition == "sunny") return std::string("\U000F0599");
            if (condition == "windy") return std::string("\U000F059D");
            if (condition == "windy-variant") return std::string("\U000F059E");
            return std::string("\U000F0599");
          text_color: !lambda |-
            std::string condition = id(weather_forecast_condition)[2];
            if (condition.find("clear-night") != std::string::npos) return lv_color_hex(0x6A5ACD);
            else if (condition.find("sunny") != std::string::npos || condition.find("clear") != std::string::npos) return lv_color_hex(0xFFD700);
            else if (condition.find("snowy-rainy") != std::string::npos) return lv_color_hex(0xAFEEEE);
            else if (condition.find("lightning-rainy") != std::string::npos || condition.find("lightning") != std::string::npos) return lv_color_hex(0xFF1493);
            else if (condition.find("partlycloudy") != std::string::npos) return lv_color_hex(0x87CEFA);
            else if (condition.find("cloudy") != std::string::npos) return lv_color_hex(0xA9A9A9);
            else if (condition.find("rainy") != std::string::npos || condition.find("pouring") != std::string::npos) return lv_color_hex(0x4169E1);
            else if (condition.find("snowy") != std::string::npos) return lv_color_hex(0xDCDCDC);
            else if (condition.find("fog") != std::string::npos) return lv_color_hex(0xB0C4DE);
            else if (condition.find("windy") != std::string::npos) return lv_color_hex(0x90EE90);
            else return lv_color_hex(0xFFFFFF);
      - lvgl.label.update:
          id: lbl_forecast_day3_temps
          text: !lambda |-
            char buf[64];
            float high = id(weather_forecast_temp_high)[2];
            float low = id(weather_forecast_temp_low)[2];
            if (isnan(high) || isnan(low)) {
              return std::string("H:--° L:--°");
            }
            snprintf(buf, sizeof(buf), "#FF0000 H:%.0f°# #00DFFF L:%.0f°#", high, low);
            return std::string(buf);
      - lvgl.label.update:
          id: lbl_forecast_day3_precip_prob
          text: !lambda |-
            if (isnan(id(weather_forecast_precip_prob)[2])) return std::string("Rain: --%");
            char buf[32];
            snprintf(buf, sizeof(buf), "Chance: %.0f%%", id(weather_forecast_precip_prob)[2]);
            return std::string(buf);
      - lvgl.label.update:
          id: lbl_forecast_day3_condition
          text: !lambda |-
            if (id(weather_forecast_condition)[2].empty()) return std::string("---");
            // Format condition text to be more readable
            std::string condition = id(weather_forecast_condition)[2];
            if (condition == "clear-night") return std::string("Clear Night");
            if (condition == "cloudy") return std::string("Cloudy");
            if (condition == "exceptional") return std::string("Exceptional");
            if (condition == "fog") return std::string("Fog");
            if (condition == "hail") return std::string("Hail");
            if (condition == "lightning") return std::string("Lightning");
            if (condition == "lightning-rainy") return std::string("Lightning & Rain");
            if (condition == "partlycloudy") return std::string("Partly Cloudy");
            if (condition == "pouring") return std::string("Pouring");
            if (condition == "rainy") return std::string("Rainy");
            if (condition == "snowy") return std::string("Snowy");
            if (condition == "snowy-rainy") return std::string("Sleet");
            if (condition == "sunny") return std::string("Sunny");
            if (condition == "windy") return std::string("Windy");
            if (condition == "windy-variant") return std::string("Windy Windy");
            // Return capitalized version if not matched
            if (!condition.empty()) {
              condition[0] = toupper(condition[0]);
            }
            return condition;

      - delay: 30ms
      # Update Day 4
      - lvgl.label.update:
          id: lbl_forecast_day4_header
          text: !lambda |-
            if (id(weather_forecast_datetime)[3].empty()) return std::string("Day +4 (--/--)");
            std::string dt = id(weather_forecast_datetime)[3];
            if (dt.length() >= 19) {
              int year = std::stoi(dt.substr(0, 4));
              int month = std::stoi(dt.substr(5, 2));
              int day = std::stoi(dt.substr(8, 2));
              int hour = std::stoi(dt.substr(11, 2));
              
              if (dt.length() >= 25 && (dt[19] == '+' || dt[19] == '-')) {
                int offset_hours = std::stoi(dt.substr(20, 2));
                if (dt[19] == '-') offset_hours = -offset_hours;
                
                auto now = id(sntp_time).now();
                if (now.is_valid()) {
                  time_t utc_time = now.timestamp;
                  struct tm *utc_tm = gmtime(&utc_time);
                  struct tm *local_tm = localtime(&utc_time);
                  int utc_hour = utc_tm->tm_hour;
                  int local_hour = local_tm->tm_hour;
                  int local_offset = local_hour - utc_hour;
                  
                  // Handle day boundary crossing in offset calculation
                  if (local_offset > 12) local_offset -= 24;
                  if (local_offset < -12) local_offset += 24;
                  hour += (local_offset - offset_hours);
                  
                  if (hour < 0) {
                    day--;
                    if (day < 1) {
                      month--;
                      if (month < 1) {
                        month = 12;
                        year--;
                      }
                      int days_in_month[] = {31,28,31,30,31,30,31,31,30,31,30,31};
                      if (month == 2 && (year % 4 == 0 && (year % 100 != 0 || year % 400 == 0))) {
                        day = 29;
                      } else {
                        day = days_in_month[month-1];
                      }
                    }
                  } else if (hour >= 24) {
                    day++;
                    int days_in_month[] = {31,28,31,30,31,30,31,31,30,31,30,31};
                    int max_days = days_in_month[month-1];
                    if (month == 2 && (year % 4 == 0 && (year % 100 != 0 || year % 400 == 0))) {
                      max_days = 29;
                    }
                    if (day > max_days) {
                      day = 1;
                      month++;
                      if (month > 12) {
                        month = 1;
                        year++;
                      }
                    }
                  }
                }
              }
              
              char buf[32];
              snprintf(buf, sizeof(buf), "Day +4 (%02d/%02d)", month, day);
              return std::string(buf);
            }
            return std::string("Day +4 (--/--)");
      - lvgl.label.update:
          id: lbl_forecast_day4_icon
          text: !lambda |-
            std::string condition = id(weather_forecast_condition)[3];
            if (condition.empty()) return std::string("\U000F14E4");  // question-mark-circle icon
            if (condition == "clear-night") return std::string("\U000F0594");
            if (condition == "cloudy") return std::string("\U000F0590");
            if (condition == "exceptional") return std::string("\U000F0F2F");
            if (condition == "fog") return std::string("\U000F0591");
            if (condition == "hail") return std::string("\U000F0592");
            if (condition == "lightning") return std::string("\U000F0593");
            if (condition == "lightning-rainy") return std::string("\U000F067E");
            if (condition == "partlycloudy") return std::string("\U000F0595");
            if (condition == "pouring") return std::string("\U000F0596");
            if (condition == "rainy") return std::string("\U000F0597");
            if (condition == "snowy") return std::string("\U000F0598");
            if (condition == "snowy-rainy") return std::string("\U000F067F");
            if (condition == "sunny") return std::string("\U000F0599");
            if (condition == "windy") return std::string("\U000F059D");
            if (condition == "windy-variant") return std::string("\U000F059E");
            return std::string("\U000F0599");
          text_color: !lambda |-
            std::string condition = id(weather_forecast_condition)[3];
            if (condition.find("clear-night") != std::string::npos) return lv_color_hex(0x6A5ACD);
            else if (condition.find("sunny") != std::string::npos || condition.find("clear") != std::string::npos) return lv_color_hex(0xFFD700);
            else if (condition.find("snowy-rainy") != std::string::npos) return lv_color_hex(0xAFEEEE);
            else if (condition.find("lightning-rainy") != std::string::npos || condition.find("lightning") != std::string::npos) return lv_color_hex(0xFF1493);
            else if (condition.find("partlycloudy") != std::string::npos) return lv_color_hex(0x87CEFA);
            else if (condition.find("cloudy") != std::string::npos) return lv_color_hex(0xA9A9A9);
            else if (condition.find("rainy") != std::string::npos || condition.find("pouring") != std::string::npos) return lv_color_hex(0x4169E1);
            else if (condition.find("snowy") != std::string::npos) return lv_color_hex(0xDCDCDC);
            else if (condition.find("fog") != std::string::npos) return lv_color_hex(0xB0C4DE);
            else if (condition.find("windy") != std::string::npos) return lv_color_hex(0x90EE90);
            else return lv_color_hex(0xFFFFFF);
      - lvgl.label.update:
          id: lbl_forecast_day4_temps
          text: !lambda |-
            char buf[64];
            float high = id(weather_forecast_temp_high)[3];
            float low = id(weather_forecast_temp_low)[3];
            if (isnan(high) || isnan(low)) {
              return std::string("H:--° L:--°");
            }
            snprintf(buf, sizeof(buf), "#FF0000 H:%.0f°# #00DFFF L:%.0f°#", high, low);
            return std::string(buf);
      - lvgl.label.update:
          id: lbl_forecast_day4_precip_prob
          text: !lambda |-
            if (isnan(id(weather_forecast_precip_prob)[3])) return std::string("Rain: --%");
            char buf[32];
            snprintf(buf, sizeof(buf), "Chance: %.0f%%", id(weather_forecast_precip_prob)[3]);
            return std::string(buf);
      - lvgl.label.update:
          id: lbl_forecast_day4_condition
          text: !lambda |-
            if (id(weather_forecast_condition)[3].empty()) return std::string("---");
            // Format condition text to be more readable
            std::string condition = id(weather_forecast_condition)[3];
            if (condition == "clear-night") return std::string("Clear Night");
            if (condition == "cloudy") return std::string("Cloudy");
            if (condition == "exceptional") return std::string("Exceptional");
            if (condition == "fog") return std::string("Fog");
            if (condition == "hail") return std::string("Hail");
            if (condition == "lightning") return std::string("Lightning");
            if (condition == "lightning-rainy") return std::string("Lightning & Rain");
            if (condition == "partlycloudy") return std::string("Partly Cloudy");
            if (condition == "pouring") return std::string("Pouring");
            if (condition == "rainy") return std::string("Rainy");
            if (condition == "snowy") return std::string("Snowy");
            if (condition == "snowy-rainy") return std::string("Sleet");
            if (condition == "sunny") return std::string("Sunny");
            if (condition == "windy") return std::string("Windy");
            if (condition == "windy-variant") return std::string("Windy Windy");
            // Return capitalized version if not matched
            if (!condition.empty()) {
              condition[0] = toupper(condition[0]);
            }
            return condition;

      - delay: 30ms
      # Update Day 5
      - lvgl.label.update:
          id: lbl_forecast_day5_header
          text: !lambda |-
            if (id(weather_forecast_datetime)[4].empty()) return std::string("Day +5 (--/--)");
            std::string dt = id(weather_forecast_datetime)[4];
            if (dt.length() >= 19) {
              int year = std::stoi(dt.substr(0, 4));
              int month = std::stoi(dt.substr(5, 2));
              int day = std::stoi(dt.substr(8, 2));
              int hour = std::stoi(dt.substr(11, 2));
              
              if (dt.length() >= 25 && (dt[19] == '+' || dt[19] == '-')) {
                int offset_hours = std::stoi(dt.substr(20, 2));
                if (dt[19] == '-') offset_hours = -offset_hours;
                
                auto now = id(sntp_time).now();
                if (now.is_valid()) {
                  time_t utc_time = now.timestamp;
                  struct tm *utc_tm = gmtime(&utc_time);
                  struct tm *local_tm = localtime(&utc_time);
                  int utc_hour = utc_tm->tm_hour;
                  int local_hour = local_tm->tm_hour;
                  int local_offset = local_hour - utc_hour;
                  
                  // Handle day boundary crossing in offset calculation
                  if (local_offset > 12) local_offset -= 24;
                  if (local_offset < -12) local_offset += 24;
                  hour += (local_offset - offset_hours);
                  
                  if (hour < 0) {
                    day--;
                    if (day < 1) {
                      month--;
                      if (month < 1) {
                        month = 12;
                        year--;
                      }
                      int days_in_month[] = {31,28,31,30,31,30,31,31,30,31,30,31};
                      if (month == 2 && (year % 4 == 0 && (year % 100 != 0 || year % 400 == 0))) {
                        day = 29;
                      } else {
                        day = days_in_month[month-1];
                      }
                    }
                  } else if (hour >= 24) {
                    day++;
                    int days_in_month[] = {31,28,31,30,31,30,31,31,30,31,30,31};
                    int max_days = days_in_month[month-1];
                    if (month == 2 && (year % 4 == 0 && (year % 100 != 0 || year % 400 == 0))) {
                      max_days = 29;
                    }
                    if (day > max_days) {
                      day = 1;
                      month++;
                      if (month > 12) {
                        month = 1;
                        year++;
                      }
                    }
                  }
                }
              }
              
              char buf[32];
              snprintf(buf, sizeof(buf), "Day +5 (%02d/%02d)", month, day);
              return std::string(buf);
            }
            return std::string("Day +5 (--/--)");
      - lvgl.label.update:
          id: lbl_forecast_day5_icon
          text: !lambda |-
            std::string condition = id(weather_forecast_condition)[4];
            if (condition.empty()) return std::string("\U000F14E4");  // question-mark-circle icon
            if (condition == "clear-night") return std::string("\U000F0594");
            if (condition == "cloudy") return std::string("\U000F0590");
            if (condition == "exceptional") return std::string("\U000F0F2F");
            if (condition == "fog") return std::string("\U000F0591");
            if (condition == "hail") return std::string("\U000F0592");
            if (condition == "lightning") return std::string("\U000F0593");
            if (condition == "lightning-rainy") return std::string("\U000F067E");
            if (condition == "partlycloudy") return std::string("\U000F0595");
            if (condition == "pouring") return std::string("\U000F0596");
            if (condition == "rainy") return std::string("\U000F0597");
            if (condition == "snowy") return std::string("\U000F0598");
            if (condition == "snowy-rainy") return std::string("\U000F067F");
            if (condition == "sunny") return std::string("\U000F0599");
            if (condition == "windy") return std::string("\U000F059D");
            if (condition == "windy-variant") return std::string("\U000F059E");
            return std::string("\U000F0599");
          text_color: !lambda |-
            std::string condition = id(weather_forecast_condition)[4];
            if (condition.find("clear-night") != std::string::npos) return lv_color_hex(0x6A5ACD);
            else if (condition.find("sunny") != std::string::npos || condition.find("clear") != std::string::npos) return lv_color_hex(0xFFD700);
            else if (condition.find("snowy-rainy") != std::string::npos) return lv_color_hex(0xAFEEEE);
            else if (condition.find("lightning-rainy") != std::string::npos || condition.find("lightning") != std::string::npos) return lv_color_hex(0xFF1493);
            else if (condition.find("partlycloudy") != std::string::npos) return lv_color_hex(0x87CEFA);
            else if (condition.find("cloudy") != std::string::npos) return lv_color_hex(0xA9A9A9);
            else if (condition.find("rainy") != std::string::npos || condition.find("pouring") != std::string::npos) return lv_color_hex(0x4169E1);
            else if (condition.find("snowy") != std::string::npos) return lv_color_hex(0xDCDCDC);
            else if (condition.find("fog") != std::string::npos) return lv_color_hex(0xB0C4DE);
            else if (condition.find("windy") != std::string::npos) return lv_color_hex(0x90EE90);
            else return lv_color_hex(0xFFFFFF);
      - lvgl.label.update:
          id: lbl_forecast_day5_temps
          text: !lambda |-
            char buf[64];
            float high = id(weather_forecast_temp_high)[4];
            float low = id(weather_forecast_temp_low)[4];
            if (isnan(high) || isnan(low)) {
              return std::string("H:--° L:--°");
            }
            snprintf(buf, sizeof(buf), "#FF0000 H:%.0f°# #00DFFF L:%.0f°#", high, low);
            return std::string(buf);
      - lvgl.label.update:
          id: lbl_forecast_day5_precip_prob
          text: !lambda |-
            if (isnan(id(weather_forecast_precip_prob)[4])) return std::string("Rain: --%");
            char buf[32];
            snprintf(buf, sizeof(buf), "Chance: %.0f%%", id(weather_forecast_precip_prob)[4]);
            return std::string(buf);
      - lvgl.label.update:
          id: lbl_forecast_day5_condition
          text: !lambda |-
            if (id(weather_forecast_condition)[4].empty()) return std::string("---");
            // Format condition text to be more readable
            std::string condition = id(weather_forecast_condition)[4];
            if (condition == "clear-night") return std::string("Clear Night");
            if (condition == "cloudy") return std::string("Cloudy");
            if (condition == "exceptional") return std::string("Exceptional");
            if (condition == "fog") return std::string("Fog");
            if (condition == "hail") return std::string("Hail");
            if (condition == "lightning") return std::string("Lightning");
            if (condition == "lightning-rainy") return std::string("Lightning & Rain");
            if (condition == "partlycloudy") return std::string("Partly Cloudy");
            if (condition == "pouring") return std::string("Pouring");
            if (condition == "rainy") return std::string("Rainy");
            if (condition == "snowy") return std::string("Snowy");
            if (condition == "snowy-rainy") return std::string("Sleet");
            if (condition == "sunny") return std::string("Sunny");
            if (condition == "windy") return std::string("Windy");
            if (condition == "windy-variant") return std::string("Windy Windy");
            // Return capitalized version if not matched
            if (!condition.empty()) {
              condition[0] = toupper(condition[0]);
            }
            return condition;

      - delay: 30ms
      # Update Day 6
      - lvgl.label.update:
          id: lbl_forecast_day6_header
          text: !lambda |-
            if (id(weather_forecast_datetime)[5].empty()) return std::string("Day +6 (--/--)");
            std::string dt = id(weather_forecast_datetime)[5];
            if (dt.length() >= 19) {
              int year = std::stoi(dt.substr(0, 4));
              int month = std::stoi(dt.substr(5, 2));
              int day = std::stoi(dt.substr(8, 2));
              int hour = std::stoi(dt.substr(11, 2));
              
              if (dt.length() >= 25 && (dt[19] == '+' || dt[19] == '-')) {
                int offset_hours = std::stoi(dt.substr(20, 2));
                if (dt[19] == '-') offset_hours = -offset_hours;
                
                auto now = id(sntp_time).now();
                if (now.is_valid()) {
                  time_t utc_time = now.timestamp;
                  struct tm *utc_tm = gmtime(&utc_time);
                  struct tm *local_tm = localtime(&utc_time);
                  int utc_hour = utc_tm->tm_hour;
                  int local_hour = local_tm->tm_hour;
                  int local_offset = local_hour - utc_hour;
                  
                  // Handle day boundary crossing in offset calculation
                  if (local_offset > 12) local_offset -= 24;
                  if (local_offset < -12) local_offset += 24;
                  hour += (local_offset - offset_hours);
                  
                  if (hour < 0) {
                    day--;
                    if (day < 1) {
                      month--;
                      if (month < 1) {
                        month = 12;
                        year--;
                      }
                      int days_in_month[] = {31,28,31,30,31,30,31,31,30,31,30,31};
                      if (month == 2 && (year % 4 == 0 && (year % 100 != 0 || year % 400 == 0))) {
                        day = 29;
                      } else {
                        day = days_in_month[month-1];
                      }
                    }
                  } else if (hour >= 24) {
                    day++;
                    int days_in_month[] = {31,28,31,30,31,30,31,31,30,31,30,31};
                    int max_days = days_in_month[month-1];
                    if (month == 2 && (year % 4 == 0 && (year % 100 != 0 || year % 400 == 0))) {
                      max_days = 29;
                    }
                    if (day > max_days) {
                      day = 1;
                      month++;
                      if (month > 12) {
                        month = 1;
                        year++;
                      }
                    }
                  }
                }
              }
              
              char buf[32];
              snprintf(buf, sizeof(buf), "Day +6 (%02d/%02d)", month, day);
              return std::string(buf);
            }
            return std::string("Day +6 (--/--)");
      - lvgl.label.update:
          id: lbl_forecast_day6_icon
          text: !lambda |-
            std::string condition = id(weather_forecast_condition)[5];
            if (condition.empty()) return std::string("\U000F14E4");  // question-mark-circle icon
            if (condition == "clear-night") return std::string("\U000F0594");
            if (condition == "cloudy") return std::string("\U000F0590");
            if (condition == "exceptional") return std::string("\U000F0F2F");
            if (condition == "fog") return std::string("\U000F0591");
            if (condition == "hail") return std::string("\U000F0592");
            if (condition == "lightning") return std::string("\U000F0593");
            if (condition == "lightning-rainy") return std::string("\U000F067E");
            if (condition == "partlycloudy") return std::string("\U000F0595");
            if (condition == "pouring") return std::string("\U000F0596");
            if (condition == "rainy") return std::string("\U000F0597");
            if (condition == "snowy") return std::string("\U000F0598");
            if (condition == "snowy-rainy") return std::string("\U000F067F");
            if (condition == "sunny") return std::string("\U000F0599");
            if (condition == "windy") return std::string("\U000F059D");
            if (condition == "windy-variant") return std::string("\U000F059E");
            return std::string("\U000F0599");
          text_color: !lambda |-
            std::string condition = id(weather_forecast_condition)[5];
            if (condition.find("clear-night") != std::string::npos) return lv_color_hex(0x6A5ACD);
            else if (condition.find("sunny") != std::string::npos || condition.find("clear") != std::string::npos) return lv_color_hex(0xFFD700);
            else if (condition.find("snowy-rainy") != std::string::npos) return lv_color_hex(0xAFEEEE);
            else if (condition.find("lightning-rainy") != std::string::npos || condition.find("lightning") != std::string::npos) return lv_color_hex(0xFF1493);
            else if (condition.find("partlycloudy") != std::string::npos) return lv_color_hex(0x87CEFA);
            else if (condition.find("cloudy") != std::string::npos) return lv_color_hex(0xA9A9A9);
            else if (condition.find("rainy") != std::string::npos || condition.find("pouring") != std::string::npos) return lv_color_hex(0x4169E1);
            else if (condition.find("snowy") != std::string::npos) return lv_color_hex(0xDCDCDC);
            else if (condition.find("fog") != std::string::npos) return lv_color_hex(0xB0C4DE);
            else if (condition.find("windy") != std::string::npos) return lv_color_hex(0x90EE90);
            else return lv_color_hex(0xFFFFFF);
      - lvgl.label.update:
          id: lbl_forecast_day6_temps
          text: !lambda |-
            char buf[64];
            float high = id(weather_forecast_temp_high)[5];
            float low = id(weather_forecast_temp_low)[5];
            if (isnan(high) || isnan(low)) {
              return std::string("H:--° L:--°");
            }
            snprintf(buf, sizeof(buf), "#FF0000 H:%.0f°# #00DFFF L:%.0f°#", high, low);
            return std::string(buf);
      - lvgl.label.update:
          id: lbl_forecast_day6_precip_prob
          text: !lambda |-
            if (isnan(id(weather_forecast_precip_prob)[5])) return std::string("Rain: --%");
            char buf[32];
            snprintf(buf, sizeof(buf), "Chance: %.0f%%", id(weather_forecast_precip_prob)[5]);
            return std::string(buf);
      - lvgl.label.update:
          id: lbl_forecast_day6_condition
          text: !lambda |-
            if (id(weather_forecast_condition)[5].empty()) return std::string("---");
            // Format condition text to be more readable
            std::string condition = id(weather_forecast_condition)[5];
            if (condition == "clear-night") return std::string("Clear Night");
            if (condition == "cloudy") return std::string("Cloudy");
            if (condition == "exceptional") return std::string("Exceptional");
            if (condition == "fog") return std::string("Fog");
            if (condition == "hail") return std::string("Hail");
            if (condition == "lightning") return std::string("Lightning");
            if (condition == "lightning-rainy") return std::string("Lightning & Rain");
            if (condition == "partlycloudy") return std::string("Partly Cloudy");
            if (condition == "pouring") return std::string("Pouring");
            if (condition == "rainy") return std::string("Rainy");
            if (condition == "snowy") return std::string("Snowy");
            if (condition == "snowy-rainy") return std::string("Sleet");
            if (condition == "sunny") return std::string("Sunny");
            if (condition == "windy") return std::string("Windy");
            if (condition == "windy-variant") return std::string("Windy Windy");
            // Return capitalized version if not matched
            if (!condition.empty()) {
              condition[0] = toupper(condition[0]);
            }
            return condition;

      - delay: 30ms
      # Update Day 7
      - lvgl.label.update:
          id: lbl_forecast_day7_header
          text: !lambda |-
            if (id(weather_forecast_datetime)[6].empty()) return std::string("Day +7 (--/--)");
            std::string dt = id(weather_forecast_datetime)[6];
            if (dt.length() >= 19) {
              int year = std::stoi(dt.substr(0, 4));
              int month = std::stoi(dt.substr(5, 2));
              int day = std::stoi(dt.substr(8, 2));
              int hour = std::stoi(dt.substr(11, 2));
              
              if (dt.length() >= 25 && (dt[19] == '+' || dt[19] == '-')) {
                int offset_hours = std::stoi(dt.substr(20, 2));
                if (dt[19] == '-') offset_hours = -offset_hours;
                
                auto now = id(sntp_time).now();
                if (now.is_valid()) {
                  time_t utc_time = now.timestamp;
                  struct tm *utc_tm = gmtime(&utc_time);
                  struct tm *local_tm = localtime(&utc_time);
                  int utc_hour = utc_tm->tm_hour;
                  int local_hour = local_tm->tm_hour;
                  int local_offset = local_hour - utc_hour;
                  
                  // Handle day boundary crossing in offset calculation
                  if (local_offset > 12) local_offset -= 24;
                  if (local_offset < -12) local_offset += 24;
                  hour += (local_offset - offset_hours);
                  
                  if (hour < 0) {
                    day--;
                    if (day < 1) {
                      month--;
                      if (month < 1) {
                        month = 12;
                        year--;
                      }
                      int days_in_month[] = {31,28,31,30,31,30,31,31,30,31,30,31};
                      if (month == 2 && (year % 4 == 0 && (year % 100 != 0 || year % 400 == 0))) {
                        day = 29;
                      } else {
                        day = days_in_month[month-1];
                      }
                    }
                  } else if (hour >= 24) {
                    day++;
                    int days_in_month[] = {31,28,31,30,31,30,31,31,30,31,30,31};
                    int max_days = days_in_month[month-1];
                    if (month == 2 && (year % 4 == 0 && (year % 100 != 0 || year % 400 == 0))) {
                      max_days = 29;
                    }
                    if (day > max_days) {
                      day = 1;
                      month++;
                      if (month > 12) {
                        month = 1;
                        year++;
                      }
                    }
                  }
                }
              }
              
              char buf[32];
              snprintf(buf, sizeof(buf), "Day +7 (%02d/%02d)", month, day);
              return std::string(buf);
            }
            return std::string("Day +7 (--/--)");
      - lvgl.label.update:
          id: lbl_forecast_day7_icon
          text: !lambda |-
            std::string condition = id(weather_forecast_condition)[6];
            if (condition.empty()) return std::string("\U000F14E4");  // question-mark-circle icon
            if (condition == "clear-night") return std::string("\U000F0594");
            if (condition == "cloudy") return std::string("\U000F0590");
            if (condition == "exceptional") return std::string("\U000F0F2F");
            if (condition == "fog") return std::string("\U000F0591");
            if (condition == "hail") return std::string("\U000F0592");
            if (condition == "lightning") return std::string("\U000F0593");
            if (condition == "lightning-rainy") return std::string("\U000F067E");
            if (condition == "partlycloudy") return std::string("\U000F0595");
            if (condition == "pouring") return std::string("\U000F0596");
            if (condition == "rainy") return std::string("\U000F0597");
            if (condition == "snowy") return std::string("\U000F0598");
            if (condition == "snowy-rainy") return std::string("\U000F067F");
            if (condition == "sunny") return std::string("\U000F0599");
            if (condition == "windy") return std::string("\U000F059D");
            if (condition == "windy-variant") return std::string("\U000F059E");
            return std::string("\U000F0599");
          text_color: !lambda |-
            std::string condition = id(weather_forecast_condition)[6];
            if (condition.find("clear-night") != std::string::npos) return lv_color_hex(0x6A5ACD);
            else if (condition.find("sunny") != std::string::npos || condition.find("clear") != std::string::npos) return lv_color_hex(0xFFD700);
            else if (condition.find("snowy-rainy") != std::string::npos) return lv_color_hex(0xAFEEEE);
            else if (condition.find("lightning-rainy") != std::string::npos || condition.find("lightning") != std::string::npos) return lv_color_hex(0xFF1493);
            else if (condition.find("partlycloudy") != std::string::npos) return lv_color_hex(0x87CEFA);
            else if (condition.find("cloudy") != std::string::npos) return lv_color_hex(0xA9A9A9);
            else if (condition.find("rainy") != std::string::npos || condition.find("pouring") != std::string::npos) return lv_color_hex(0x4169E1);
            else if (condition.find("snowy") != std::string::npos) return lv_color_hex(0xDCDCDC);
            else if (condition.find("fog") != std::string::npos) return lv_color_hex(0xB0C4DE);
            else if (condition.find("windy") != std::string::npos) return lv_color_hex(0x90EE90);
            else return lv_color_hex(0xFFFFFF);
      - lvgl.label.update:
          id: lbl_forecast_day7_temps
          text: !lambda |-
            char buf[64];
            float high = id(weather_forecast_temp_high)[6];
            float low = id(weather_forecast_temp_low)[6];
            if (isnan(high) || isnan(low)) {
              return std::string("H:--° L:--°");
            }
            snprintf(buf, sizeof(buf), "#FF0000 H:%.0f°# #00DFFF L:%.0f°#", high, low);
            return std::string(buf);
      - lvgl.label.update:
          id: lbl_forecast_day7_precip_prob
          text: !lambda |-
            if (isnan(id(weather_forecast_precip_prob)[6])) return std::string("Rain: --%");
            char buf[32];
            snprintf(buf, sizeof(buf), "Chance: %.0f%%", id(weather_forecast_precip_prob)[6]);
            return std::string(buf);
      - lvgl.label.update:
          id: lbl_forecast_day7_condition
          text: !lambda |-
            if (id(weather_forecast_condition)[6].empty()) return std::string("---");
            // Format condition text to be more readable
            std::string condition = id(weather_forecast_condition)[6];
            if (condition == "clear-night") return std::string("Clear Night");
            if (condition == "cloudy") return std::string("Cloudy");
            if (condition == "exceptional") return std::string("Exceptional");
            if (condition == "fog") return std::string("Fog");
            if (condition == "hail") return std::string("Hail");
            if (condition == "lightning") return std::string("Lightning");
            if (condition == "lightning-rainy") return std::string("Lightning & Rain");
            if (condition == "partlycloudy") return std::string("Partly Cloudy");
            if (condition == "pouring") return std::string("Pouring");
            if (condition == "rainy") return std::string("Rainy");
            if (condition == "snowy") return std::string("Snowy");
            if (condition == "snowy-rainy") return std::string("Sleet");
            if (condition == "sunny") return std::string("Sunny");
            if (condition == "windy") return std::string("Windy");
            if (condition == "windy-variant") return std::string("Windy Windy");
            // Return capitalized version if not matched
            if (!condition.empty()) {
              condition[0] = toupper(condition[0]);
            }
            return condition;

      - delay: 30ms
      # Update Day 8
      - lvgl.label.update:
          id: lbl_forecast_day8_header
          text: !lambda |-
            if (id(weather_forecast_datetime)[7].empty()) return std::string("Day +8 (--/--)");
            std::string dt = id(weather_forecast_datetime)[7];
            if (dt.length() >= 19) {
              int year = std::stoi(dt.substr(0, 4));
              int month = std::stoi(dt.substr(5, 2));
              int day = std::stoi(dt.substr(8, 2));
              int hour = std::stoi(dt.substr(11, 2));
              
              if (dt.length() >= 25 && (dt[19] == '+' || dt[19] == '-')) {
                int offset_hours = std::stoi(dt.substr(20, 2));
                if (dt[19] == '-') offset_hours = -offset_hours;
                
                auto now = id(sntp_time).now();
                if (now.is_valid()) {
                  time_t utc_time = now.timestamp;
                  struct tm *utc_tm = gmtime(&utc_time);
                  struct tm *local_tm = localtime(&utc_time);
                  int utc_hour = utc_tm->tm_hour;
                  int local_hour = local_tm->tm_hour;
                  int local_offset = local_hour - utc_hour;
                  
                  // Handle day boundary crossing in offset calculation
                  if (local_offset > 12) local_offset -= 24;
                  if (local_offset < -12) local_offset += 24;
                  hour += (local_offset - offset_hours);
                  
                  if (hour < 0) {
                    day--;
                    if (day < 1) {
                      month--;
                      if (month < 1) {
                        month = 12;
                        year--;
                      }
                      int days_in_month[] = {31,28,31,30,31,30,31,31,30,31,30,31};
                      if (month == 2 && (year % 4 == 0 && (year % 100 != 0 || year % 400 == 0))) {
                        day = 29;
                      } else {
                        day = days_in_month[month-1];
                      }
                    }
                  } else if (hour >= 24) {
                    day++;
                    int days_in_month[] = {31,28,31,30,31,30,31,31,30,31,30,31};
                    int max_days = days_in_month[month-1];
                    if (month == 2 && (year % 4 == 0 && (year % 100 != 0 || year % 400 == 0))) {
                      max_days = 29;
                    }
                    if (day > max_days) {
                      day = 1;
                      month++;
                      if (month > 12) {
                        month = 1;
                        year++;
                      }
                    }
                  }
                }
              }
              
              char buf[32];
              snprintf(buf, sizeof(buf), "Day +8 (%02d/%02d)", month, day);
              return std::string(buf);
            }
            return std::string("Day +8 (--/--)");
      - lvgl.label.update:
          id: lbl_forecast_day8_icon
          text: !lambda |-
            std::string condition = id(weather_forecast_condition)[7];
            if (condition.empty()) return std::string("\U000F14E4");  // question-mark-circle icon
            if (condition == "clear-night") return std::string("\U000F0594");
            if (condition == "cloudy") return std::string("\U000F0590");
            if (condition == "exceptional") return std::string("\U000F0F2F");
            if (condition == "fog") return std::string("\U000F0591");
            if (condition == "hail") return std::string("\U000F0592");
            if (condition == "lightning") return std::string("\U000F0593");
            if (condition == "lightning-rainy") return std::string("\U000F067E");
            if (condition == "partlycloudy") return std::string("\U000F0595");
            if (condition == "pouring") return std::string("\U000F0596");
            if (condition == "rainy") return std::string("\U000F0597");
            if (condition == "snowy") return std::string("\U000F0598");
            if (condition == "snowy-rainy") return std::string("\U000F067F");
            if (condition == "sunny") return std::string("\U000F0599");
            if (condition == "windy") return std::string("\U000F059D");
            if (condition == "windy-variant") return std::string("\U000F059E");
            return std::string("\U000F0599");
          text_color: !lambda |-
            std::string condition = id(weather_forecast_condition)[7];
            if (condition.find("clear-night") != std::string::npos) return lv_color_hex(0x6A5ACD);
            else if (condition.find("sunny") != std::string::npos || condition.find("clear") != std::string::npos) return lv_color_hex(0xFFD700);
            else if (condition.find("snowy-rainy") != std::string::npos) return lv_color_hex(0xAFEEEE);
            else if (condition.find("lightning-rainy") != std::string::npos || condition.find("lightning") != std::string::npos) return lv_color_hex(0xFF1493);
            else if (condition.find("partlycloudy") != std::string::npos) return lv_color_hex(0x87CEFA);
            else if (condition.find("cloudy") != std::string::npos) return lv_color_hex(0xA9A9A9);
            else if (condition.find("rainy") != std::string::npos || condition.find("pouring") != std::string::npos) return lv_color_hex(0x4169E1);
            else if (condition.find("snowy") != std::string::npos) return lv_color_hex(0xDCDCDC);
            else if (condition.find("fog") != std::string::npos) return lv_color_hex(0xB0C4DE);
            else if (condition.find("windy") != std::string::npos) return lv_color_hex(0x90EE90);
            else return lv_color_hex(0xFFFFFF);
      - lvgl.label.update:
          id: lbl_forecast_day8_temps
          text: !lambda |-
            char buf[64];
            float high = id(weather_forecast_temp_high)[7];
            float low = id(weather_forecast_temp_low)[7];
            if (isnan(high) || isnan(low)) {
              return std::string("H:--° L:--°");
            }
            snprintf(buf, sizeof(buf), "#FF0000 H:%.0f°# #00DFFF L:%.0f°#", high, low);
            return std::string(buf);
      - lvgl.label.update:
          id: lbl_forecast_day8_precip_prob
          text: !lambda |-
            if (isnan(id(weather_forecast_precip_prob)[7])) return std::string("Rain: --%");
            char buf[32];
            snprintf(buf, sizeof(buf), "Chance: %.0f%%", id(weather_forecast_precip_prob)[7]);
            return std::string(buf);
      - lvgl.label.update:
          id: lbl_forecast_day8_condition
          text: !lambda |-
            if (id(weather_forecast_condition)[7].empty()) return std::string("---");
            // Format condition text to be more readable
            std::string condition = id(weather_forecast_condition)[7];
            if (condition == "clear-night") return std::string("Clear Night");
            if (condition == "cloudy") return std::string("Cloudy");
            if (condition == "exceptional") return std::string("Exceptional");
            if (condition == "fog") return std::string("Fog");
            if (condition == "hail") return std::string("Hail");
            if (condition == "lightning") return std::string("Lightning");
            if (condition == "lightning-rainy") return std::string("Lightning & Rain");
            if (condition == "partlycloudy") return std::string("Partly Cloudy");
            if (condition == "pouring") return std::string("Pouring");
            if (condition == "rainy") return std::string("Rainy");
            if (condition == "snowy") return std::string("Snowy");
            if (condition == "snowy-rainy") return std::string("Sleet");
            if (condition == "sunny") return std::string("Sunny");
            if (condition == "windy") return std::string("Windy");
            if (condition == "windy-variant") return std::string("Windy Windy");
            // Return capitalized version if not matched
            if (!condition.empty()) {
              condition[0] = toupper(condition[0]);
            }
            return condition;

      - delay: 30ms
      # Update Day 9
      - lvgl.label.update:
          id: lbl_forecast_day9_header
          text: !lambda |-
            if (id(weather_forecast_datetime)[8].empty()) return std::string("Day +9 (--/--)");
            std::string dt = id(weather_forecast_datetime)[8];
            if (dt.length() >= 19) {
              int year = std::stoi(dt.substr(0, 4));
              int month = std::stoi(dt.substr(5, 2));
              int day = std::stoi(dt.substr(8, 2));
              int hour = std::stoi(dt.substr(11, 2));
              
              if (dt.length() >= 25 && (dt[19] == '+' || dt[19] == '-')) {
                int offset_hours = std::stoi(dt.substr(20, 2));
                if (dt[19] == '-') offset_hours = -offset_hours;
                
                auto now = id(sntp_time).now();
                if (now.is_valid()) {
                  time_t utc_time = now.timestamp;
                  struct tm *utc_tm = gmtime(&utc_time);
                  struct tm *local_tm = localtime(&utc_time);
                  int utc_hour = utc_tm->tm_hour;
                  int local_hour = local_tm->tm_hour;
                  int local_offset = local_hour - utc_hour;
                  
                  // Handle day boundary crossing in offset calculation
                  if (local_offset > 12) local_offset -= 24;
                  if (local_offset < -12) local_offset += 24;
                  hour += (local_offset - offset_hours);
                  
                  if (hour < 0) {
                    day--;
                    if (day < 1) {
                      month--;
                      if (month < 1) {
                        month = 12;
                        year--;
                      }
                      int days_in_month[] = {31,28,31,30,31,30,31,31,30,31,30,31};
                      if (month == 2 && (year % 4 == 0 && (year % 100 != 0 || year % 400 == 0))) {
                        day = 29;
                      } else {
                        day = days_in_month[month-1];
                      }
                    }
                  } else if (hour >= 24) {
                    day++;
                    int days_in_month[] = {31,28,31,30,31,30,31,31,30,31,30,31};
                    int max_days = days_in_month[month-1];
                    if (month == 2 && (year % 4 == 0 && (year % 100 != 0 || year % 400 == 0))) {
                      max_days = 29;
                    }
                    if (day > max_days) {
                      day = 1;
                      month++;
                      if (month > 12) {
                        month = 1;
                        year++;
                      }
                    }
                  }
                }
              }
              
              char buf[32];
              snprintf(buf, sizeof(buf), "Day +9 (%02d/%02d)", month, day);
              return std::string(buf);
            }
            return std::string("Day +9 (--/--)");
      - lvgl.label.update:
          id: lbl_forecast_day9_icon
          text: !lambda |-
            std::string condition = id(weather_forecast_condition)[8];
            if (condition.empty()) return std::string("\U000F14E4");  // question-mark-circle icon
            if (condition == "clear-night") return std::string("\U000F0594");
            if (condition == "cloudy") return std::string("\U000F0590");
            if (condition == "exceptional") return std::string("\U000F0F2F");
            if (condition == "fog") return std::string("\U000F0591");
            if (condition == "hail") return std::string("\U000F0592");
            if (condition == "lightning") return std::string("\U000F0593");
            if (condition == "lightning-rainy") return std::string("\U000F067E");
            if (condition == "partlycloudy") return std::string("\U000F0595");
            if (condition == "pouring") return std::string("\U000F0596");
            if (condition == "rainy") return std::string("\U000F0597");
            if (condition == "snowy") return std::string("\U000F0598");
            if (condition == "snowy-rainy") return std::string("\U000F067F");
            if (condition == "sunny") return std::string("\U000F0599");
            if (condition == "windy") return std::string("\U000F059D");
            if (condition == "windy-variant") return std::string("\U000F059E");
            return std::string("\U000F0599");
          text_color: !lambda |-
            std::string condition = id(weather_forecast_condition)[8];
            if (condition.find("clear-night") != std::string::npos) return lv_color_hex(0x6A5ACD);
            else if (condition.find("sunny") != std::string::npos || condition.find("clear") != std::string::npos) return lv_color_hex(0xFFD700);
            else if (condition.find("snowy-rainy") != std::string::npos) return lv_color_hex(0xAFEEEE);
            else if (condition.find("lightning-rainy") != std::string::npos || condition.find("lightning") != std::string::npos) return lv_color_hex(0xFF1493);
            else if (condition.find("partlycloudy") != std::string::npos) return lv_color_hex(0x87CEFA);
            else if (condition.find("cloudy") != std::string::npos) return lv_color_hex(0xA9A9A9);
            else if (condition.find("rainy") != std::string::npos || condition.find("pouring") != std::string::npos) return lv_color_hex(0x4169E1);
            else if (condition.find("snowy") != std::string::npos) return lv_color_hex(0xDCDCDC);
            else if (condition.find("fog") != std::string::npos) return lv_color_hex(0xB0C4DE);
            else if (condition.find("windy") != std::string::npos) return lv_color_hex(0x90EE90);
            else return lv_color_hex(0xFFFFFF);
      - lvgl.label.update:
          id: lbl_forecast_day9_temps
          text: !lambda |-
            char buf[64];
            float high = id(weather_forecast_temp_high)[8];
            float low = id(weather_forecast_temp_low)[8];
            if (isnan(high) || isnan(low)) {
              return std::string("H:--° L:--°");
            }
            snprintf(buf, sizeof(buf), "#FF0000 H:%.0f°# #00DFFF L:%.0f°#", high, low);
            return std::string(buf);
      - lvgl.label.update:
          id: lbl_forecast_day9_precip_prob
          text: !lambda |-
            if (isnan(id(weather_forecast_precip_prob)[8])) return std::string("Rain: --%");
            char buf[32];
            snprintf(buf, sizeof(buf), "Chance: %.0f%%", id(weather_forecast_precip_prob)[8]);
            return std::string(buf);
      - lvgl.label.update:
          id: lbl_forecast_day9_condition
          text: !lambda |-
            if (id(weather_forecast_condition)[8].empty()) return std::string("---");
            // Format condition text to be more readable
            std::string condition = id(weather_forecast_condition)[8];
            if (condition == "clear-night") return std::string("Clear Night");
            if (condition == "cloudy") return std::string("Cloudy");
            if (condition == "exceptional") return std::string("Exceptional");
            if (condition == "fog") return std::string("Fog");
            if (condition == "hail") return std::string("Hail");
            if (condition == "lightning") return std::string("Lightning");
            if (condition == "lightning-rainy") return std::string("Lightning & Rain");
            if (condition == "partlycloudy") return std::string("Partly Cloudy");
            if (condition == "pouring") return std::string("Pouring");
            if (condition == "rainy") return std::string("Rainy");
            if (condition == "snowy") return std::string("Snowy");
            if (condition == "snowy-rainy") return std::string("Sleet");
            if (condition == "sunny") return std::string("Sunny");
            if (condition == "windy") return std::string("Windy");
            if (condition == "windy-variant") return std::string("Windy Windy");
            // Return capitalized version if not matched
            if (!condition.empty()) {
              condition[0] = toupper(condition[0]);
            }
            return condition;

      # Update Day 10
      - lvgl.label.update:
          id: lbl_forecast_day10_header
          text: !lambda |-
            if (id(weather_forecast_datetime)[9].empty()) return std::string("Day +10 (--/--)");
            std::string dt = id(weather_forecast_datetime)[9];
            if (dt.length() >= 10) {
              std::string month_str = dt.substr(5, 2);
              std::string day_str = dt.substr(8, 2);
              char buf[32];
              snprintf(buf, sizeof(buf), "Day +10 (%s/%s)", month_str.c_str(), day_str.c_str());
              return std::string(buf);
            }
            return std::string("Day +10 (--/--)");
      - lvgl.label.update:
          id: lbl_forecast_day10_icon
          text: !lambda |-
            std::string condition = id(weather_forecast_condition)[9];
            if (condition.empty()) return std::string("\U000F14E4");  // question-mark-circle icon
            if (condition == "clear-night") return std::string("\U000F0594");
            if (condition == "cloudy") return std::string("\U000F0590");
            if (condition == "exceptional") return std::string("\U000F0F2F");
            if (condition == "fog") return std::string("\U000F0591");
            if (condition == "hail") return std::string("\U000F0592");
            if (condition == "lightning") return std::string("\U000F0593");
            if (condition == "lightning-rainy") return std::string("\U000F067E");
            if (condition == "partlycloudy") return std::string("\U000F0595");
            if (condition == "pouring") return std::string("\U000F0596");
            if (condition == "rainy") return std::string("\U000F0597");
            if (condition == "snowy") return std::string("\U000F0598");
            if (condition == "snowy-rainy") return std::string("\U000F067F");
            if (condition == "sunny") return std::string("\U000F0599");
            if (condition == "windy") return std::string("\U000F059D");
            if (condition == "windy-variant") return std::string("\U000F059E");
            return std::string("\U000F0599");
          text_color: !lambda |-
            std::string condition = id(weather_forecast_condition)[9];
            if (condition.find("clear-night") != std::string::npos) return lv_color_hex(0x6A5ACD);
            else if (condition.find("sunny") != std::string::npos || condition.find("clear") != std::string::npos) return lv_color_hex(0xFFD700);
            else if (condition.find("snowy-rainy") != std::string::npos) return lv_color_hex(0xAFEEEE);
            else if (condition.find("lightning-rainy") != std::string::npos || condition.find("lightning") != std::string::npos) return lv_color_hex(0xFF1493);
            else if (condition.find("partlycloudy") != std::string::npos) return lv_color_hex(0x87CEFA);
            else if (condition.find("cloudy") != std::string::npos) return lv_color_hex(0xA9A9A9);
            else if (condition.find("rainy") != std::string::npos || condition.find("pouring") != std::string::npos) return lv_color_hex(0x4169E1);
            else if (condition.find("snowy") != std::string::npos) return lv_color_hex(0xDCDCDC);
            else if (condition.find("fog") != std::string::npos) return lv_color_hex(0xB0C4DE);
            else if (condition.find("windy") != std::string::npos) return lv_color_hex(0x90EE90);
            else return lv_color_hex(0xFFFFFF);
      - lvgl.label.update:
          id: lbl_forecast_day10_temps
          text: !lambda |-
            char buf[64];
            float high = id(weather_forecast_temp_high)[9];
            float low = id(weather_forecast_temp_low)[9];
            if (isnan(high) || isnan(low)) {
              return std::string("H:--° L:--°");
            }
            snprintf(buf, sizeof(buf), "#FF0000 H:%.0f°# #00DFFF L:%.0f°#", high, low);
            return std::string(buf);
      - lvgl.label.update:
          id: lbl_forecast_day10_precip_prob
          text: !lambda |-
            if (isnan(id(weather_forecast_precip_prob)[9])) return std::string("Rain: --%");
            char buf[32];
            snprintf(buf, sizeof(buf), "Chance: %.0f%%", id(weather_forecast_precip_prob)[9]);
            return std::string(buf);
      - lvgl.label.update:
          id: lbl_forecast_day10_condition
          text: !lambda |-
            if (id(weather_forecast_condition)[9].empty()) return std::string("---");
            // Format condition text to be more readable
            std::string condition = id(weather_forecast_condition)[9];
            if (condition == "clear-night") return std::string("Clear Night");
            if (condition == "cloudy") return std::string("Cloudy");
            if (condition == "exceptional") return std::string("Exceptional");
            if (condition == "fog") return std::string("Fog");
            if (condition == "hail") return std::string("Hail");
            if (condition == "lightning") return std::string("Lightning");
            if (condition == "lightning-rainy") return std::string("Lightning & Rain");
            if (condition == "partlycloudy") return std::string("Partly Cloudy");
            if (condition == "pouring") return std::string("Pouring");
            if (condition == "rainy") return std::string("Rainy");
            if (condition == "snowy") return std::string("Snowy");
            if (condition == "snowy-rainy") return std::string("Sleet");
            if (condition == "sunny") return std::string("Sunny");
            if (condition == "windy") return std::string("Windy");
            if (condition == "windy-variant") return std::string("Windy Windy");
            // Return capitalized version if not matched
            if (!condition.empty()) {
              condition[0] = toupper(condition[0]);
            }
            return condition;

      - logger.log: "✓ Daily forecast display updated (page 5)"

  - id: time_update
    mode: restart
    then:
      - lambda: |-
          id(time_update_last_started) = millis();
          id(time_update_needs_render) = false;
      - lambda: |-
          auto now = id(wireguard_enabled).state ? id(sntp_time).now() : id(ha_time).now();
          if (!now.is_valid()) {
            ESP_LOGW("time_update", "Time source unavailable, skipping label update");
            return;
          }
          bool is_pm = now.hour >= 12;
          int hour_12 = now.hour % 12;
          if (hour_12 == 0) {
            hour_12 = 12;
          }
          char time_buf[17];
          if (id(time_format).state) {
            snprintf(time_buf, sizeof(time_buf), "%02d:%02d", now.hour, now.minute);
          } else {
            snprintf(time_buf, sizeof(time_buf), "%2d:%02d%s", hour_12, now.minute, is_pm ? "PM" : "AM");
          }
          std::string new_text(time_buf);
          if (new_text != id(time_update_last_text)) {
            id(time_update_last_text) = new_text;
            id(time_update_needs_render) = true;
          }
      - if:
          condition:
            lambda: 'return id(time_update_needs_render) && id(current_page_name) == "airq";'
          then:
            - lvgl.label.update:
                id: timeVal
                text: !lambda 'return id(time_update_last_text);'
      - if:
          condition:
            lambda: 'return id(time_update_needs_render) && id(current_page_name) == "vertical_clock";'
          then:
            - lvgl.label.update:
                id: vclock_hours
                text: !lambda |-
                  auto now = id(wireguard_enabled).state ? id(sntp_time).now() : id(ha_time).now();
                  if (!now.is_valid()) return std::string("--");
                  bool is_pm = now.hour >= 12;
                  int hour_12 = now.hour % 12;
                  if (hour_12 == 0) hour_12 = 12;
                  char buf[3];
                  if (id(time_format).state) {
                    snprintf(buf, sizeof(buf), "%02d", now.hour);
                  } else {
                    snprintf(buf, sizeof(buf), "%2d", hour_12);
                  }
                  return std::string(buf);
            - lvgl.label.update:
                id: vclock_minutes
                text: !lambda |-
                  auto now = id(wireguard_enabled).state ? id(sntp_time).now() : id(ha_time).now();
                  if (!now.is_valid()) return std::string("--");
                  char buf[3];
                  snprintf(buf, sizeof(buf), "%02d", now.minute);
                  return std::string(buf);
            - lvgl.label.update:
                id: vclock_ampm
                text: !lambda |-
                  auto now = id(wireguard_enabled).state ? id(sntp_time).now() : id(ha_time).now();
                  if (!now.is_valid()) return std::string("");
                  if (id(time_format).state) return std::string("");
                  bool is_pm = now.hour >= 12;
                  return std::string(is_pm ? "PM" : "AM");
            - lvgl.label.update:
                id: vclock_date
                text: !lambda |-
                  auto now = id(wireguard_enabled).state ? id(sntp_time).now() : id(ha_time).now();
                  if (!now.is_valid()) return std::string("--");
                  static const char* months[] = {"Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"};
                  char buf[20];
                  snprintf(buf, sizeof(buf), "%s %d", months[now.month - 1], now.day_of_month);
                  return std::string(buf);
            - lvgl.label.update:
                id: vclock_day_top
                text: !lambda |-
                  auto now = id(wireguard_enabled).state ? id(sntp_time).now() : id(ha_time).now();
                  if (!now.is_valid()) return std::string("--");
                  static const char* days[] = {"Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"};
                  return std::string(days[now.day_of_week - 1]);
      - script.execute: update_colon_widget
      - lambda: |-
          const uint32_t now = millis();
          const uint32_t elapsed = now - id(time_update_last_started);
          id(time_update_last_duration) = elapsed;
          // Removed publish_state to prevent TCP buffer overflow - store in global instead
          // id(time_update_duration_sensor).publish_state(elapsed);
          const bool rendered = id(time_update_needs_render);

          // Update watchdog timer ONLY if we actually rendered something
          if (rendered) {
            id(last_display_update_time) = now;
            ESP_LOGV("time_update", "Display watchdog updated (rendered)");
          }

          if (elapsed > 40) {
            ESP_LOGW("time_update", "time_update took %u ms (rendered=%s)", elapsed, rendered ? "true" : "false");
          } else {
            ESP_LOGD("time_update", "time_update took %u ms (rendered=%s)", elapsed, rendered ? "true" : "false");
          }
          id(time_update_needs_render) = false;

number:
  - platform: template
    name: "Auto Page Rotation Interval"
    id: page_rotation_interval
    icon: mdi:timer
    restore_value: true
    initial_value: 30
    min_value: 5
    max_value: 300
    entity_category: "config"
    unit_of_measurement: "s"
    optimistic: true
    step: 1
    mode: box
    on_value:
      - lambda: 'id(auto_page_rotation_interval) = (int)x;'
      - logger.log:
          format: "Page rotation interval changed to %d seconds"
          args: ['(int)x']

  # Page rotation order numbers (1-6, lower numbers show first)
  # Note: "Page Order: Vertical Clock Page" number is defined in vertical-clock-core.yaml
  # Note: "Page Order: AirQ Page" number is defined in airq-core.yaml
  # Note: "Page Order: WiFi Page" number is defined in wifi-core.yaml
  # Note: SEN55 Temperature/Humidity Offset numbers are defined in airq-core.yaml

  # Page rotation order numbers (1-6, lower numbers show first)
  - platform: template
    name: "Page Order: Vertical Clock Page"
    id: page_order_vertical_clock
    icon: mdi:numeric
    restore_value: true
    initial_value: 6
    min_value: 1
    max_value: 6
    entity_category: "config"
    optimistic: true
    step: 1
    mode: box
    on_value:
      - lambda: 'id(page_rotation_vertical_clock_order) = (int)x;'
      - logger.log:
          format: "Vertical clock page order set to %d"
          args: ['(int)x']

  - platform: template
    name: "Page Order: Weather Page"
    id: page_order_weather
    icon: mdi:numeric
    restore_value: true
    initial_value: 3
    min_value: 1
    max_value: 6
    entity_category: "config"
    optimistic: true
    step: 1
    mode: box
    on_value:
      - lambda: 'id(page_rotation_weather_order) = (int)x;'
      - logger.log:
          format: "Weather page order set to %d"
          args: ['(int)x']
      # Force immediate display update when page order changes
      - if:
          condition:
            lambda: 'return id(current_page_name) == "weather";'
          then:
            - script.execute: update_weather_icon_color

  - platform: template
    name: "Page Order: Daily Forecast Page"
    id: page_order_daily_forecast
    icon: mdi:numeric
    restore_value: true
    initial_value: 4
    min_value: 1
    max_value: 6
    entity_category: "config"
    optimistic: true
    step: 1
    mode: box
    on_value:
      - lambda: 'id(page_rotation_daily_forecast_order) = (int)x;'
      - logger.log:
          format: "Daily forecast page order set to %d"
          args: ['(int)x']
      # Force immediate display update when page order changes
      - if:
          condition:
            lambda: 'return id(current_page_name) == "daily_forecast";'
          then:
            - script.execute: update_weather_icon_color

  - platform: template
    name: "Page Order: Hourly Forecast Page"
    id: page_order_hourly_forecast
    icon: mdi:numeric
    restore_value: true
    initial_value: 5
    min_value: 1
    max_value: 6
    entity_category: "config"
    optimistic: true
    step: 1
    mode: box
    on_value:
      - lambda: 'id(page_rotation_hourly_forecast_order) = (int)x;'
      - logger.log:
          format: "Hourly forecast page order set to %d"
          args: ['(int)x']
      # Force immediate display update when page order changes
      - if:
          condition:
            lambda: 'return id(current_page_name) == "hourly_forecast";'
          then:
            - script.execute: update_weather_icon_color

  # Weather gauge control (for weather page needle)
  - platform: template
    name: "Weather Gauge Value"
    id: weather_gauge_value
    min_value: 0
    max_value: 100
    step: 1
    mode: box
    optimistic: true
    entity_category: config
    icon: mdi:gauge
    unit_of_measurement: "%"
    on_value:
      - lvgl.indicator.update:
          id: weather_temp_needle
          value: !lambda 'return (int)x;'

  - platform: template
    name: "Page Order: AirQ Page"
    id: page_order_AirQ
    icon: mdi:numeric
    restore_value: true
    initial_value: 1
    min_value: 1
    max_value: 6
    entity_category: "config"
    optimistic: true
    step: 1
    mode: box
    on_value:
      - lambda: 'id(page_rotation_AirQ_order) = (int)x;'
      - logger.log:
          format: "AirQ page order set to %d"
          args: ['(int)x']
      # Force immediate display refresh when on AirQ page (simple version - just execute time_update)
      - if:
          condition:
            lambda: 'return id(current_page_name) == "airq";'
          then:
            - script.execute: time_update

  - platform: template
    name: SEN55 Temperature Offset
    id: sen55_temperature_offset
    restore_value: true
    initial_value: 6.0
    min_value: -70.0
    max_value: 70.0
    entity_category: "CONFIG"
    unit_of_measurement: "°C"
    optimistic: true
    update_interval: never
    step: 0.1
    mode: box
  - platform: template
    name: SEN55 Humidity Offset
    id: sen55_humidity_offset
    restore_value: true
    initial_value: 0
    min_value: -70.0
    max_value: 70.0
    entity_category: "CONFIG"
    unit_of_measurement: "%"
    optimistic: true
    update_interval: never
    step: 0.1
    mode: box

  # Page rotation order numbers (1-6, lower numbers show first)
  - platform: template
    name: "Page Order: WiFi Page"
    id: page_order_wifi
    icon: mdi:numeric
    restore_value: true
    initial_value: 2
    min_value: 1
    max_value: 6
    entity_category: "config"
    optimistic: true
    step: 1
    mode: box
    on_value:
      - lambda: 'id(page_rotation_wifi_order) = (int)x;'
      - logger.log:
          format: "WiFi page order set to %d"
          args: ['(int)x']
      # Force immediate display update when page order changes
      - if:
          condition:
            lambda: 'return id(current_page_name) == "wifi";'
          then:
            - lambda: |-
                id(wifi_signal_needs_render) = true;
                id(wifi_signal_bar_needs_render) = true;
                id(wifi_ssid_needs_render) = true;
                id(wifi_ip_needs_render) = true;
                id(ha_status_needs_render) = true;

binary_sensor:
  - platform: status
    name: Online
    id: ink_ha_connected

  - platform: template
    name: "Display Backlight Active"
    id: display_backlight_state
    entity_category: "diagnostic"
    lambda: 'return id(display_backlight_is_on);'

  - platform: wireguard
    wireguard_id: wg0
    status:
      name: "WireGuard Status"
      id: wireguard_status
    enabled:
      name: "WireGuard Enabled"
      id: wireguard_enabled_sensor

sensor:
  # Display refresh rate monitor
  - platform: template
    name: "Display Refresh Count"
    id: display_refresh_counter
    internal: true
    update_interval: never
    entity_category: "diagnostic"

  - platform: uptime
    name: Uptime
    id: sys_uptime
    update_interval: 60s

  # Import current temperature from Home Assistant weather integration
  - platform: homeassistant
    id: ha_current_temp
    entity_id: ${current_temp_sensor}
    internal: true
    on_value:
      then:
        - lambda: |-
            // Always store the value (needed for calculations)
            id(weather_current_temp) = x;
            ESP_LOGD("weather", "Current temp updated: %.1f°F", x);
            
            // Only trigger display update if on weather page (reduces LVGL overhead)
            if (id(current_page_name) == "weather") {
              // Trigger weather display update script
              id(update_weather_display).execute();
            }

  # Import apparent temperature from Home Assistant weather integration
  - platform: homeassistant
    id: ha_apparent_temp
    entity_id: ${apparent_temp_sensor}
    internal: true
    on_value:
      then:
        - lambda: |-
            // Always store the value (needed for gauge calculations)
            id(weather_current_apparent_temp) = x;
            ESP_LOGD("weather", "Apparent temp updated: %.1f°F", x);
            
            // Only trigger display update if on weather page (reduces LVGL overhead)
            if (id(current_page_name) == "weather") {
              // Trigger weather display update script
              id(update_weather_display).execute();
            }

  - platform: homeassistant
    id: wind_speed_sensor
    entity_id: ${wind_speed_sensor}
    internal: true
    on_value:
      then:
        # Wind data updates frequently - only trigger full weather page update if viewing it
        - if:
            condition:
              lambda: 'return id(current_page_name) == "weather";'
            then:
              # Call the complete weather display update (includes all wind labels + gauge)
              - script.execute: update_weather_display

  - platform: homeassistant
    id: wind_direction_sensor
    entity_id: ${wind_direction_sensor}
    internal: true
    on_value:
      then:
        # Wind direction updates - only trigger full weather page update if viewing it
        - if:
            condition:
              lambda: 'return id(current_page_name) == "weather";'
            then:
              # Call the complete weather display update (includes wind compass + labels)
              - script.execute: update_weather_display


  - platform: template
    name: "Time Update Duration"
    id: time_update_duration_sensor
    internal: true  # Don't send to Home Assistant - internal diagnostic only
    unit_of_measurement: "ms"
    accuracy_decimals: 0
    icon: "mdi:timer-outline"
    entity_category: "diagnostic"
    update_interval: never

  # ============================================================================
  # Performance Monitoring Sensors
  # ============================================================================
  # Track timing of UI update operations to identify performance bottlenecks
  # ============================================================================

  - platform: template
    name: "Weather Icon Update Duration"
    id: weather_icon_duration_sensor
    internal: true  # Don't send to Home Assistant - internal diagnostic only
    unit_of_measurement: "ms"
    accuracy_decimals: 0
    icon: "mdi:weather-lightning"
    entity_category: "diagnostic"
    update_interval: never

  # Internal heap monitoring
  - platform: template
    name: "Free Heap"
    lambda: return heap_caps_get_free_size(MALLOC_CAP_INTERNAL);
    unit_of_measurement: "bytes"
    update_interval: 15s
    entity_category: "diagnostic"
    filters:
      - delta: 5000.0       # Only send if changes by ±5KB
      - heartbeat: 60s      # Force update every 60s (reduced from 300s)

  - platform: template
    name: "Largest Free Block"
    lambda: return heap_caps_get_largest_free_block(MALLOC_CAP_INTERNAL);
    unit_of_measurement: "bytes"
    update_interval: 15s
    entity_category: "diagnostic"
    filters:
      - delta: 5000.0       # Only send if changes by ±5KB
      - heartbeat: 60s      # Force update every 60s (reduced from 300s)

  - platform: template
    name: "Heap Fragmentation"
    lambda: |-
      size_t free_heap = heap_caps_get_free_size(MALLOC_CAP_INTERNAL);
      size_t largest_block = heap_caps_get_largest_free_block(MALLOC_CAP_INTERNAL);
      if (free_heap > 0) {
        return ((float)(free_heap - largest_block) / free_heap) * 100.0;
      }
      return 0.0;
    unit_of_measurement: "%"
    accuracy_decimals: 1
    update_interval: 15s
    entity_category: "diagnostic"
    filters:
      - delta: 2.0          # Only send if fragmentation changes by ±2%
      - heartbeat: 60s      # Force update every 60s (reduced from 300s)

  # DMA-capable memory monitoring
  - platform: template
    name: "DMA Capable Heap Free"
    lambda: return heap_caps_get_free_size(MALLOC_CAP_DMA);
    unit_of_measurement: "bytes"
    update_interval: 15s
    entity_category: "diagnostic"
    filters:
      - delta: 5000.0       # Only send if changes by ±5KB
      - heartbeat: 60s      # Force update every 60s (reduced from 300s)

  - platform: template
    name: "DMA Capable Largest Block"
    lambda: return heap_caps_get_largest_free_block(MALLOC_CAP_DMA);
    unit_of_measurement: "bytes"
    update_interval: 15s
    entity_category: "diagnostic"
    filters:
      - delta: 5000.0       # Only send if changes by ±5KB
      - heartbeat: 60s      # Force update every 60s (reduced from 300s)

  # PSRAM monitoring (if available)
  - platform: template
    name: "PSRAM Free"
    lambda: |-
      size_t psram_free = heap_caps_get_free_size(MALLOC_CAP_SPIRAM);
      if (psram_free > 0) {
        return psram_free;
      }
      return 0;  // No PSRAM available
    unit_of_measurement: "bytes"
    update_interval: 30s
    entity_category: "diagnostic"
    filters:
      - delta: 50000.0      # Only send if PSRAM changes by ±50KB
      - heartbeat: 120s     # Force update every 2 minutes (reduced from 300s)

  # Total free heap across all memory types
  - platform: template
    name: "Total Free Heap (All)"
    lambda: return heap_caps_get_free_size(MALLOC_CAP_8BIT);
    unit_of_measurement: "bytes"
    update_interval: 30s
    entity_category: "diagnostic"
    filters:
      - delta: 50000.0      # Only send if total heap changes by ±50KB
      - heartbeat: 120s     # Force update every 2 minutes (reduced from 300s)

  # Minimum free heap since boot (indicates worst-case memory pressure)
  - platform: template
    name: "Min Free Heap Ever"
    lambda: return heap_caps_get_minimum_free_size(MALLOC_CAP_INTERNAL);
    unit_of_measurement: "bytes"
    update_interval: 15s
    entity_category: "diagnostic"
    filters:
      - delta: 1000.0       # Only send if min heap changes by ±1KB (important metric)
      - heartbeat: 60s      # Force update every 60s (reduced from 300s)

  # Display Activity Monitor - shows seconds since last display update
  - platform: template
    name: "Display Last Update"
    id: display_last_update_sensor
    lambda: |-
      if (id(last_display_update_time) == 0) return 0;
      return (millis() - id(last_display_update_time)) / 1000.0;
    unit_of_measurement: "s"
    accuracy_decimals: 0
    update_interval: 10s
    entity_category: "diagnostic"
    icon: "mdi:monitor-dashboard"

  - platform: template
    name: "Computed AQI"
    id: computed_halo_aqi
    unit_of_measurement: ""
    accuracy_decimals: 0
    device_class: "aqi"
    state_class: "measurement"
    update_interval: never  # We'll update it manually
    on_value:
      then:
        # Update LED effect when AQI changes if "AQI Color" effect is selected
        - if:
            condition:
              lambda: 'return id(led_effect_select).state == "AQI Color";'
            then:
              - lambda: |-
                  float aqi = x;
                  if (std::isnan(aqi) || aqi <= 50) {
                    auto call = id(rgb_light).turn_off();
                    call.perform();
                  } else {
                    Color color;
                    if (aqi <= 100) color = Color(255, 255, 0);       // yellow
                    else if (aqi <= 150) color = Color(255, 165, 0);  // orange
                    else if (aqi <= 200) color = Color(255, 0, 0);    // red
                    else if (aqi <= 300) color = Color(128, 0, 128);  // purple
                    else color = Color(128, 0, 0);                    // maroon
                    auto call = id(rgb_light).turn_on();
                    call.set_rgb(color.red / 255.0f, color.green / 255.0f, color.blue / 255.0f);
                    call.perform();
                  }

  - platform: scd4x
    id: scd40
    co2:
      name: "CO2"
      id: "co2"
      filters:
        - throttle_average: 2s
        - delta: 10.0         # Only send to HA if CO2 changes by ±10 ppm
        - heartbeat: 120s     # Force update every 2 minutes even if no change
      on_value:
        then:
          - lvgl.label.update:
              id: co2_value
              text: !lambda |-
                static char buffer[10];
                snprintf(buffer, sizeof(buffer), "%d", (int)x);
                return buffer;
          - if:
              condition:
                lambda: "return x <= 600;"
              then:
                - lvgl.label.update:
                    id: co2_value
                    text_color: my_green                     
              else:
                - if:
                    condition:
                      lambda: "return x <= 1000;"
                    then:
                      - lvgl.label.update:
                          id: co2_value
                          text_color: my_yellow                         
                    else:
                      - if:
                          condition:
                            lambda: "return x <= 1500;"
                          then:
                            - lvgl.label.update:
                                id: co2_value
                                text_color: my_orange                                 
                          else:
                            - lvgl.label.update:
                                id: co2_value
                                text_color: my_red                                                                              
    automatic_self_calibration: false
    update_interval: 30s  # Increased from 10s to reduce I2C blocking frequency
    measurement_mode: "periodic"
    i2c_id: lily_i2c
    ambient_pressure_compensation_source: bme280pressure

  - platform: mics_4514
    id: mics4514
    nitrogen_dioxide:
      name: Nitrogen Dioxide
      id: "no2"
      filters:
      - offset: -0.16
      - throttle_average: 2s
      - delta: 0.01         # Only send if NO2 changes by ±0.01 ppm
      - heartbeat: 120s     # Force update every 2 minutes
      on_value:
        then:
          - lvgl.label.update:
              id: no2_value
              text: !lambda |-
                static char buffer[10];
                snprintf(buffer, sizeof(buffer), "%.02f", x);
                return buffer;
          - if:
              condition:
                lambda: "return x <= 0.03;"  # Safe level typical indoors (ppm)
              then:
                - lvgl.label.update:
                    id: no2_value
                    text_color: my_green
              else:
                - if:
                    condition:
                      lambda: "return x <= 0.06;"  # Slightly elevated level (ppm)
                    then:
                      - lvgl.label.update:
                          id: no2_value
                          text_color: my_yellow
                    else:
                      - if:
                          condition:
                            lambda: "return x <= 0.1;"  # Moderately high level (ppm)
                          then:
                            - lvgl.label.update:
                                id: no2_value
                                text_color: my_orange
                          else:
                            - lvgl.label.update:
                                id: no2_value
                                text_color: my_red  # High level, unsafe indoors (ppm)                          
    carbon_monoxide:
      name: Carbon Monoxide
      id: "co"
      filters:
        - throttle_average: 2s
        - delta: 1.0          # Only send if CO changes by ±1 ppm
        - heartbeat: 120s     # Force update every 2 minutes
      on_value:
        then:
          - lvgl.label.update:
              id: co_value
              text: !lambda |-
                static char buffer[10];
                snprintf(buffer, sizeof(buffer), "%.02f", x);
                return buffer;
          - if:
              condition:
                lambda: "return x <= 15;"
              then:
                - lvgl.label.update:
                    id: co_value
                    text_color: my_green
              else:
                - if:
                    condition:
                      lambda: "return x <= 30;"
                    then:
                      - lvgl.label.update:
                          id: co_value
                          text_color: my_yellow
                    else:
                      - if:
                          condition:
                            lambda: "return x <= 36;"
                          then:
                            - lvgl.label.update:
                                id: co_value
                                text_color: my_orange
                          else:
                            - lvgl.label.update:
                                id: co_value
                                text_color: my_red                      
    hydrogen:
      name: Hydrogen
      id: "h2"
      filters:
        - throttle_average: 2s
        - delta: 0.05         # Only send if H2 changes by ±0.05 ppm
        - heartbeat: 120s     # Force update every 2 minutes
      on_value:
        then:
          - lvgl.label.update:
              id: h2_value
              text: !lambda |-
                static char buffer[10];
                snprintf(buffer, sizeof(buffer), "%.02f", x);
                return buffer;
          - if:
              condition:
                lambda: "return x <= 0.4;"  # Safe level typical indoors
              then:
                - lvgl.label.update:
                    id: h2_value
                    text_color: my_green
              else:
                - if:
                    condition:
                      lambda: "return x <= 1.0;"  # Slightly elevated level
                    then:
                      - lvgl.label.update:
                          id: h2_value
                          text_color: my_yellow
                    else:
                      - if:
                          condition:
                            lambda: "return x <= 2.0;"  # Moderately high level
                          then:
                            - lvgl.label.update:
                                id: h2_value
                                text_color: my_orange
                          else:
                            - lvgl.label.update:
                                id: h2_value
                                text_color: my_red  # High level, unsafe indoors                       
    methane:
      name: Methane
      id: "ch4"
      filters:
        - throttle_average: 2s
        - delta: 10.0         # Only send if CH4 changes by ±10 ppm
        - heartbeat: 120s     # Force update every 2 minutes
      on_value:
        then:
          - lvgl.label.update:
              id: ch4_value
              text: !lambda |-
                static char buffer[10];
                snprintf(buffer, sizeof(buffer), "%.02f", x);
                return buffer;
          - if:
              condition:
                lambda: "return x <= 2.0;"  # Typical safe level
              then:
                - lvgl.label.update:
                    id: ch4_value
                    text_color: my_green
              else:
                - if:
                    condition:
                      lambda: "return x <= 10.0;"  # Elevated but not critical
                    then:
                      - lvgl.label.update:
                          id: ch4_value
                          text_color: my_yellow
                    else:
                      - lvgl.label.update:
                          id: ch4_value
                          text_color: my_red  # Critical level                                        
    ethanol:
      name: Ethanol
      id: "ethanol"
      filters:
        - throttle_average: 2s
        - delta: 0.1          # Only send if ethanol changes by ±0.1 ppm
        - heartbeat: 120s     # Force update every 2 minutes
      on_value:
        then:
          - lvgl.label.update:
              id: ethanol_value
              text: !lambda |-
                static char buffer[10];
                snprintf(buffer, sizeof(buffer), "%.02f", x);
                return buffer;
          - if:
              condition:
                lambda: "return x <= 0.5;"  # Safe level
              then:
                - lvgl.label.update:
                    id: ethanol_value
                    text_color: my_green
              else:
                - if:
                    condition:
                      lambda: "return x <= 1.5;"  # Slightly elevated
                    then:
                      - lvgl.label.update:
                          id: ethanol_value
                          text_color: my_yellow
                    else:
                      - if:
                          condition:
                            lambda: "return x <= 3.0;"  # Moderate level
                          then:
                            - lvgl.label.update:
                                id: ethanol_value
                                text_color: my_orange
                          else:
                            - lvgl.label.update:
                                id: ethanol_value
                                text_color: my_red  # High level                       
    ammonia:
      name: Ammonia
      id: "nh3"
      filters:
        - throttle_average: 2s
        - delta: 0.1          # Only send if ammonia changes by ±0.1 ppm
        - heartbeat: 120s     # Force update every 2 minutes
      on_value:
        then:
          - lvgl.label.update:
              id: nh3_value
              text: !lambda |-
                static char buffer[10];
                snprintf(buffer, sizeof(buffer), "%.02f", x);
                return buffer;
          - if:
              condition:
                lambda: "return x <= 0.5;"  # Safe level typical indoors
              then:
                - lvgl.label.update:
                    id: nh3_value
                    text_color: my_green
              else:
                - if:
                    condition:
                      lambda: "return x <= 1.0;"  # Slightly elevated level
                    then:
                      - lvgl.label.update:
                          id: nh3_value
                          text_color: my_yellow
                    else:
                      - if:
                          condition:
                            lambda: "return x <= 2.0;"  # Moderately high level
                          then:
                            - lvgl.label.update:
                                id: nh3_value
                                text_color: my_orange
                          else:
                            - lvgl.label.update:
                                id: nh3_value
                                text_color: my_red  # High level, unsafe indoors                            
    update_interval: 40s  # Increased from 12s to reduce I2C blocking frequency
    i2c_id: lily_i2c
    address: 0x75

  - platform: bme280_i2c
    i2c_id: lily_i2c
    temperature:
      name: "BME280 Temperature"
      oversampling: 2x
      # filters:
      #   - lambda: |-
      #       return x;  
    pressure:
      name: "BME280 Pressure"
      id: bme280pressure
    humidity:
      name: "BME280 Humidity"    

  - platform: sen5x
    id: sen55
    pm_1_0:
      name: "PM <1µm Weight concentration"
      id: pm_1_0
      accuracy_decimals: 1
      filters:
        - throttle_average: 2s
      on_value:
        then:
          - lvgl.label.update:
              id: pm1_value
              text: !lambda |-
                static char buffer[10];
                snprintf(buffer, sizeof(buffer), "%.01f", x);
                return buffer;          
    pm_2_5:
      name: "PM <2.5µm Weight concentration"
      id: pm_2_5
      accuracy_decimals: 1
      filters:
        - throttle_average: 2s
      on_value:
        then:
          - lvgl.label.update:
              id: pm25_value
              text: !lambda |-
                static char buffer[10];
                snprintf(buffer, sizeof(buffer), "%.01f", x);
                return buffer;
          - lvgl.label.update:
              id: aqi_value
              text: !lambda |-
                float val = x; // PM2.5 value
                float aqi = 0.0;

                if (val <= 9.0) {
                  aqi = ((50.0 - 0.0) / (9.0 - 0.0)) * (val - 0.0) + 0.0;
                } else if (val <= 35.4) {
                  aqi = ((100.0 - 51.0) / (35.4 - 9.1)) * (val - 9.1) + 51.0;
                } else if (val <= 55.4) {
                  aqi = ((150.0 - 101.0) / (55.4 - 35.5)) * (val - 35.5) + 101.0;
                } else if (val <= 125.4) {
                  aqi = ((200.0 - 151.0) / (125.4 - 55.5)) * (val - 55.5) + 151.0;
                } else if (val <= 225.4) {
                  aqi = ((300.0 - 201.0) / (225.4 - 125.5)) * (val - 125.5) + 201.0;
                } else if (val <= 500.4) {
                  aqi = ((500.0 - 301.0) / (500.4 - 250.5)) * (val - 250.5) + 301.0;
                } else {
                  return "EVAC";
                }

                static char buffer[10];
                snprintf(buffer, sizeof(buffer), " %d", (int)aqi);
                return buffer;

          - lvgl.widget.update:
              id: aqi_widget
              bg_color: !lambda |-
                float val = x; // PM2.5 value
                float aqi = 0.0;

                if (val <= 9.0) {
                  aqi = ((50.0 - 0.0) / (9.0 - 0.0)) * (val - 0.0) + 0.0;
                } else if (val <= 35.4) {
                  aqi = ((100.0 - 51.0) / (35.4 - 9.1)) * (val - 9.1) + 51.0;
                } else if (val <= 55.4) {
                  aqi = ((150.0 - 101.0) / (55.4 - 35.5)) * (val - 35.5) + 101.0;
                } else if (val <= 125.4) {
                  aqi = ((200.0 - 151.0) / (125.4 - 55.5)) * (val - 55.5) + 151.0;
                } else if (val <= 225.4) {
                  aqi = ((300.0 - 201.0) / (225.4 - 125.5)) * (val - 125.5) + 201.0;
                } else if (val <= 500.4) {
                  aqi = ((500.0 - 301.0) / (500.4 - 250.5)) * (val - 250.5) + 301.0;
                } else {
                  aqi = 500.0;
                }
                id(computed_halo_aqi).publish_state((int)aqi);

                // Return color based on AQI
                if (aqi <= 50) {
                  return lv_color_hex(0x76fa76); // Green
                } else if (aqi <= 100) {
                  return lv_color_hex(0xFFFF00); // Yellow
                } else if (aqi <= 150) {
                  return lv_color_hex(0xFFA500); // Orange
                } else if (aqi <= 200) {
                  return lv_color_hex(0xFF0000); // Red
                } else if (aqi <= 300) {
                  return lv_color_hex(0x800080); // Purple
                } else {
                  return lv_color_hex(0x800000); // Maroon
                }        

    pm_4_0:
      name: "PM <4µm Weight concentration"
      id: pm_4_0
      accuracy_decimals: 1
      filters:
        - throttle_average: 2s
      on_value:
        then:
          - lvgl.label.update:
              id: pm4_value
              text: !lambda |-
                static char buffer[10];
                snprintf(buffer, sizeof(buffer), "%.01f", x);
                return buffer;       
    pm_10_0:
      name: "PM <10µm Weight concentration"
      id: pm_10_0
      accuracy_decimals: 1
      filters:
        - throttle_average: 2s
      on_value:
        then:
          - lvgl.label.update:
              id: pm10_value
              text: !lambda |-
                static char buffer[10];
                snprintf(buffer, sizeof(buffer), "%.01f", x);
                return buffer;       
    temperature:
      name: "SEN55 Temperature"
      accuracy_decimals: 1
      filters:
        - offset: !lambda return -1.0 * id(sen55_temperature_offset).state;
        - throttle_average: 2s
      on_value:
        then:
          - if:
              condition:
                lambda: "return temp_unit_changed;"
              then:
                - lvgl.label.update:
                    id: temperature_units
                    text: !lambda |-
                      if(id(display_temperature_unit).state == "Fahrenheit")
                        return "\u00B0F";
                      else if(id(display_temperature_unit).state == "Kelvin")
                        return "K";
                      return "\u00B0C";
                - globals.set:
                    id: temp_unit_changed
                    value: "false"
          - lvgl.label.update:
              id: temperature_value
              text: !lambda |-
                static char buffer[10];
                if(id(display_temperature_unit).state == "Fahrenheit")
                  snprintf(buffer, sizeof(buffer), "%.01f", (x * 9.0 / 5.0) + 32.0);
                else if(id(display_temperature_unit).state == "Kelvin")
                  snprintf(buffer, sizeof(buffer), "%.01f", x + 273.15);
                else
                  snprintf(buffer, sizeof(buffer), "%.01f", x);
                return buffer;
          - if:
              condition:
                lambda: "return x >= 18 && x <= 24;"  # Comfortable temperature range (°C)
              then:
                - lvgl.label.update:
                    id: temperature_value
                    text_color: my_green
              else:
                - if:
                    condition:
                      lambda: "return (x > 24 && x <= 27) || (x >= 16 && x < 18);"  # Slightly uncomfortable (°C)
                    then:
                      - lvgl.label.update:
                          id: temperature_value
                          text_color: my_yellow
                    else:
                      - if:
                          condition:
                            lambda: "return (x > 27 && x <= 30) || (x >= 10 && x < 16);"  # Moderately uncomfortable (°C)
                          then:
                            - lvgl.label.update:
                                id: temperature_value
                                text_color: my_orange
                          else:
                            - lvgl.label.update:
                                id: temperature_value
                                text_color: my_red  # Extreme discomfort or unsafe (°C)
    humidity:
      name: "SEN55 Humidity"
      filters:
        - lambda: return x - id(sen55_humidity_offset).state;
      accuracy_decimals: 0
      on_value:
        then:
          - lvgl.label.update:
              id: rh_value
              text: !lambda |-
                static char buffer[10];
                snprintf(buffer, sizeof(buffer), "%d", (int)x);
                return buffer;
          - if:
              condition:
                lambda: "return x >= 30 && x <= 50;"  # Optimal indoor comfort range (%)
              then:
                - lvgl.label.update:
                    id: rh_value
                    text_color: my_green
              else:
                - if:
                    condition:
                      lambda: "return (x > 50 && x <= 60) || (x >= 20 && x < 30);"  # Slightly out of comfort range (%)
                    then:
                      - lvgl.label.update:
                          id: rh_value
                          text_color: my_yellow
                    else:
                      - if:
                          condition:
                            lambda: "return (x > 60 && x <= 70) || (x >= 10 && x < 20);"  # Moderately uncomfortable (%)
                          then:
                            - lvgl.label.update:
                                id: rh_value
                                text_color: my_orange
                          else:
                            - lvgl.label.update:
                                id: rh_value
                                text_color: my_red  # Very uncomfortable or potentially hazardous (%)                             
    voc:
      name: "SEN55 VOC"
      id: sen55_voc
      algorithm_tuning:
        #https://sensirion.com/media/documents/25AB572C/62B463AA/Sensirion_Engineering_Guidelines_SEN5x.pdf
        index_offset: 100
        learning_time_offset_hours: 72
        learning_time_gain_hours: 72
        gating_max_duration_minutes: 180
        std_initial: 50
        gain_factor: 230
      on_value:
        then:
          - lvgl.label.update:
              id: voc_value
              text: !lambda |-
                static char buffer[10];
                snprintf(buffer, sizeof(buffer), "%3d", (int)x);
                return buffer;
          - if:
              condition:
                lambda: "return x < 150;"
              then:
                - lvgl.label.update:
                    id: voc_value
                    text_color: my_green
              else:
                - if:
                    condition:
                      lambda: "return x <= 250;"
                    then:
                      - lvgl.label.update:
                          id: voc_value
                          text_color: my_yellow
                    else:
                      - if:
                          condition:
                            lambda: "return x <= 400;"
                          then:
                            - lvgl.label.update:
                                id: voc_value
                                text_color: my_orange
                          else:
                            - lvgl.label.update:
                                id: voc_value
                                text_color: my_red                      
    i2c_id: lily_i2c
    address: 0x69
    update_interval: 60s  # Increased from 14s - SEN55 blocks for 4+ seconds per read!

  - platform: wifi_signal
    name: RSSI
    id: wifi_signal_db
    update_interval: 60s
    entity_category: "diagnostic"

  - platform: wireguard
    wireguard_id: wg0
    latest_handshake:
      name: "WireGuard Latest Handshake"
      id: wireguard_handshake

  - platform: template
    name: "Display Recovery Count"
    id: display_recovery_count
    entity_category: diagnostic
    accuracy_decimals: 0
    
text_sensor:
  - platform: template
    name: "Time Value (Stub)"
    id: timeVal_stub
    internal: true
    update_interval: never

  - platform: wireguard
    wireguard_id: wg0
    address:
      name: "WireGuard Address"
      id: wireguard_address_text

# ============================================================================
# RGB LED Configuration
# ============================================================================
# Controls the addressable RGB LED for status indication and visual feedback
# Supports multiple effects including AQI-based color, weather-based color,
# and standard animation effects
# ============================================================================

light:
  # - platform: esp32_rmt_led_strip
  #   id: rgb_light
  #   name: "Halo"
  #   pin: GPIO47
  #   rgb_order: GRB
  #   default_transition_length: 2s
  #   chipset: SK6812
  #   num_leds: 11
  #   effects:
  #     - pulse:
  #         name: "Slow Pulse" 
  #         transition_length: 500ms
  #         update_interval: 500ms
  #         min_brightness: 10%
  #         max_brightness: 50%
  #     - addressable_rainbow:
  #         name: Rainbow Effect With Custom Values
  #         speed: 10
  #         width: 50

  - platform: esp32_rmt_led_strip
    name: Halo
    id: rgb_light
    rgb_order: GRB
    pin: GPIO47
    num_leds: 12
    use_dma: true  # Use DMA for better performance
    chipset: WS2812
    restore_mode: ALWAYS_OFF
    effects:
      - addressable_rainbow:
          name: Rainbow Effect With Custom Values
          speed: 10
          width: 50
      - addressable_rainbow:
          name: Addressable Rainbow
      - addressable_color_wipe:
          name: Color Wipe
      - addressable_scan:
          name: Scan
      - addressable_twinkle:
          name: Twinkle
      - addressable_fireworks:
          name: Fireworks
      - strobe:
          name: Strobe
      - addressable_random_twinkle:
          name: Random Twinkle
      # Weather-based LED effects using addressable_lambda
      - addressable_lambda:
          name: "Weather Condition"
          update_interval: 100ms
          lambda: |-
            std::string condition = id(weather_current_condition);
            std::transform(condition.begin(), condition.end(), condition.begin(), ::tolower);
            
            Color color = Color::WHITE;
            if (condition.find("clear-night") != std::string::npos) {
              color = Color(106, 90, 205);  // Slate Blue
            } else if (condition.find("sunny") != std::string::npos || condition.find("clear") != std::string::npos) {
              color = Color(255, 215, 0);  // Gold
            } else if (condition.find("snowy-rainy") != std::string::npos) {
              color = Color(175, 238, 238);  // Light Cyan
            } else if (condition.find("lightning-rainy") != std::string::npos || condition.find("lightning") != std::string::npos) {
              // Lightning: produce occasional short pink flashes (lightning-like)
              // Use a tiny state machine with esp_random() to trigger short flashes
              unsigned long now = millis();
              static unsigned long flash_until = 0;
              if (now < flash_until) {
                // Currently in a flash window
                color = Color(255, 20, 147);  // Deep Pink
              } else {
                // Small chance each update to start a new flash
                // Lambda runs every ~100ms; tune probability to make flashes occasional
                if ((esp_random() % 1000) < 12) {  // ~1.2% chance per call
                  // Flash lasts between 80ms and 300ms
                  flash_until = now + 80 + (esp_random() % 220);
                  color = Color(255, 20, 147);
                } else {
                  // Dark background between flashes
                  color = Color(0, 0, 0);
                }
              }
            } else if (condition.find("partlycloudy") != std::string::npos) {
              color = Color(135, 206, 250);  // Light Sky Blue
            } else if (condition.find("cloudy") != std::string::npos) {
              color = Color(169, 169, 169);  // Dark Gray
            } else if (condition.find("rainy") != std::string::npos) {
              color = Color(65, 105, 225);  // Royal Blue
            } else if (condition.find("snowy") != std::string::npos) {
              color = Color(220, 220, 220);  // Gainsboro
            } else if (condition.find("fog") != std::string::npos) {
              color = Color(176, 196, 222);  // Light Steel Blue
            } else if (condition.find("windy") != std::string::npos) {
              color = Color(144, 238, 144);  // Light Green
            }
            
            // Set all LEDs to the weather condition color
            it.all() = color;
      - addressable_lambda:
          name: "Pink Lightning"
          update_interval: 100ms
          lambda: |-
            // Always produce occasional short pink flashes for preview/testing
            unsigned long now = millis();
            static unsigned long flash_until_pink = 0;
            Color color = Color(0, 0, 0);
            if (now < flash_until_pink) {
              color = Color(255, 20, 147);  // Deep Pink during flash
            } else {
              // ~15% chance per update to start a flash
              if ((esp_random() % 1000) < 150) {
                flash_until_pink = now + 60 + (esp_random() % 340); // 60-400ms
                color = Color(255, 20, 147);
              } else {
                color = Color(0, 0, 0);
              }
            }
            it.all() = color;
      - addressable_lambda:
          name: "Auto Context"
          update_interval: 100ms
          lambda: |-
            // Auto Context: Show AQI color if AQI > 50, otherwise show weather condition
            float aqi = id(computed_halo_aqi).state;
            Color color = Color::WHITE;
            
            if (!std::isnan(aqi) && aqi > 50) {
              // Use AQI color logic (show on all pages)
              if (aqi <= 100) {
                color = Color(255, 255, 0);  // Yellow
              } else if (aqi <= 150) {
                color = Color(255, 165, 0);  // Orange
              } else if (aqi <= 200) {
                color = Color(255, 0, 0);  // Red
              } else if (aqi <= 300) {
                color = Color(128, 0, 128);  // Purple
              } else {
                color = Color(128, 0, 0);  // Maroon
              }
            } else {
              // Only show weather condition color on the current weather page
              // Turn off LEDs when on other pages if AQI <= 50
              if (id(current_page_name) != "weather") {
                it.all() = Color::BLACK;
                return;
              }
              
              // Use weather condition color logic
              std::string condition = id(weather_current_condition);
              std::transform(condition.begin(), condition.end(), condition.begin(), ::tolower);
              
              if (condition.find("clear-night") != std::string::npos) {
                color = Color(106, 90, 205);  // Slate Blue
              } else if (condition.find("sunny") != std::string::npos || condition.find("clear") != std::string::npos) {
                color = Color(255, 215, 0);  // Gold
              } else if (condition.find("snowy-rainy") != std::string::npos) {
                color = Color(175, 238, 238);  // Light Cyan
              } else if (condition.find("lightning-rainy") != std::string::npos || condition.find("lightning") != std::string::npos) {
                // Lightning: occasional short pink flashes while on weather page
                unsigned long now = millis();
                static unsigned long flash_until_auto = 0;
                if (now < flash_until_auto) {
                  color = Color(255, 20, 147);
                } else {
                  if ((esp_random() % 1000) < 12) {
                    flash_until_auto = now + 80 + (esp_random() % 220);
                    color = Color(255, 20, 147);
                  } else {
                    color = Color(0, 0, 0);
                  }
                }
              } else if (condition.find("partlycloudy") != std::string::npos) {
                color = Color(135, 206, 250);  // Light Sky Blue
              } else if (condition.find("cloudy") != std::string::npos) {
                color = Color(169, 169, 169);  // Dark Gray
              } else if (condition.find("rainy") != std::string::npos) {
                color = Color(65, 105, 225);  // Royal Blue
              } else if (condition.find("snowy") != std::string::npos) {
                color = Color(220, 220, 220);  // Gainsboro
              } else if (condition.find("fog") != std::string::npos) {
                color = Color(176, 196, 222);  // Light Steel Blue
              } else if (condition.find("windy") != std::string::npos) {
                color = Color(144, 238, 144);  // Light Green
              }
            }
            
            // Set all LEDs to the determined color
            it.all() = color;

  - platform: monochromatic
    output: backlight
    name: "Display Backlight"
    id: display_backlight
    restore_mode: ALWAYS_ON
    on_turn_on:
      - logger.log: "Display backlight turned ON"
      - lambda: 'id(display_backlight_is_on) = true;'
      - binary_sensor.template.publish:
          id: display_backlight_state
          state: ON
    on_turn_off:
      - logger.log: "Display backlight turned OFF"
      - lambda: 'id(display_backlight_is_on) = false;'
      - binary_sensor.template.publish:
          id: display_backlight_state
          state: OFF

lvgl:
  id: lvgl_main
  displays:
    - lily_display
  touchscreens:
    - lily_touch
  buffer_size: 50%  # Reduced from 75% to prevent memory exhaustion on complex pages
                    # Fixes reboot issues when navigating to hourly/weather forecast pages
                    # Trade-off: slightly more tearing, but stable operation
  # Use DMAable PSRAM for frame buffers (ESP32-S3 feature)
  # This combines DMA capability with external PSRAM for optimal performance
  byte_order: big_endian
  color_depth: 16
  
  disp_bg_color: 0x000000
  disp_bg_opa: COVER
  disp_bg_image: none
  log_level: WARN  # Reduce logging overhead

  # Gradient definitions used by WiFi pages
  gradients:
    - id: wifi_signal_gradient
      direction: hor
      dither: none
      stops:
        - color: 0xFF0000  # Red - weak signal
          position: 0
        - color: 0xFF8000  # Orange
          position: 64
        - color: 0xFFFF00  # Yellow
          position: 128
        - color: 0x80FF00  # Yellow-green
          position: 192
        - color: 0x00FF00  # Green - strong signal
          position: 255

  # IMPORTANT: Pages are now defined in device-specific configs
  # Include one of these packages in your device file:
  #   - lvgl-pages-full.yaml (all features)
  #   - lvgl-pages-airq-only.yaml (clock + AirQ)
  #   - lvgl-pages-weather.yaml (clock + weather)
  #   - lvgl-pages-clock-only.yaml (minimal clock)
  #
  # Example in device file:
  # packages:
  #   lvgl_pages:
  #     url: https://github.com/truffshuff/halo/
  #     ref: main
  #     files: [TFT_LCD/T-Display-Long/V1/Firmware/ESPHome/packages/lvgl-pages-airq-only.yaml]
  #     refresh: always
  pages:
    - id: vertical_clock_page
      bg_color: 0x000000
      bg_opa: COVER
      scrollbar_mode: "OFF"
      on_load:
        - script.execute: page_transition_cleanup
        - lambda: |-
            id(current_page_name) = "vertical_clock";
            id(time_update_last_text).clear();
            id(colon_blink_state) = true;  // Ensure colon is visible when page loads
        - script.execute: time_update
        - script.execute: update_colon_widget
      widgets:
        # Large time display vertically centered
        - label:
            id: vclock_hours
            align: CENTER
            text_font: montserrat_80
            text_color: my_white
            x: 0
            y: -120
            text: "12"

        - label:
            id: vclock_colon
            align: CENTER
            text_font: montserrat_80
            text_color: my_white
            x: 0
            y: -20
            text: ":"

        - label:
            id: vclock_minutes
            align: CENTER
            text_font: montserrat_80
            text_color: my_white
            x: 0
            y: 80
            text: "00"

        - label:
            id: vclock_ampm
            align: CENTER
            text_font: montserrat_50
            text_color: my_white
            x: 0
            y: 180
            text: "AM"

        # Date below time
        - label:
            id: vclock_date
            align: CENTER
            text_font: montserrat_24
            text_color: my_gray
            x: 0
            y: 250
            text: "Mon, Jan 1"

        # Day of week at top
        - label:
            id: vclock_day_top
            align: TOP_MID
            text_font: montserrat_24
            text_color: my_gray
            x: 0
            y: 20
            text: "Monday"

        # Navigation button (top right corner)
        - obj:
            id: nav_button_vclock
            align: TOP_RIGHT
            x: 0
            y: 0
            width: 180
            height: 150
            bg_opa: 0
            border_width: 0
            clickable: true
            on_release:
              - logger.log: "Vertical Clock page nav button RELEASED!"
              - lambda: |-
                  ESP_LOGI("touch", "Navigation button touched");
                  id(last_auto_rotation_time) = millis();
                  ESP_LOGD("touch", "Auto-rotation timer reset");
              - lvgl.page.next:
                  animation: OUT_LEFT
                  time: 300ms
                  
    # Weather Forecast Page (Page 3)
    # Main weather display with current conditions
    - id: weather_forecast_page
      bg_color: 0x000000
      bg_opa: COVER
      scrollbar_mode: "OFF"
      on_load:
        - script.execute: page_transition_cleanup
        - lambda: |-
            id(current_page_name) = "weather";
            id(weather_last_condition).clear();
            id(weather_on_weather_page) = true;
        - delay: 10ms  # Yield to prevent blocking warning
        # Always update display first with existing data (even if stale)
        - script.execute: update_weather_display
        - delay: 10ms  # Yield before icon color update
        - script.execute: update_weather_icon_color
        - delay: 10ms  # Yield to prevent blocking warning
        # Then check if we need to fetch fresh data
        - if:
            condition:
              lambda: |-
                // Check if daily forecast needs refresh (stale > 60 minutes)
                uint32_t time_since_update = millis() - id(weather_daily_last_update);
                bool is_stale = (id(weather_daily_last_update) == 0 || time_since_update > 3600000);
                
                if (is_stale) {
                  ESP_LOGI("weather", "Daily forecast is stale (age: %u minutes), fetching in background...",
                           id(weather_daily_last_update) == 0 ? 0 : time_since_update / 60000);
                  return true;
                } else {
                  ESP_LOGD("weather", "Daily forecast is fresh (updated %u minutes ago)", time_since_update / 60000);
                  return false;
                }
            then:
              # Fetch will update display when complete
              - script.execute: fetch_daily_forecast
      on_unload:
        - lambda: 'id(weather_on_weather_page) = false;'
      widgets:
        # Page Header
        - label:
            id: lbl_weather_today_header
            text: "Today"
            align: TOP_MID
            y: 5
            text_font: montserrat_18
            text_color: my_white
            text_align: CENTER
        
        # Large weather condition icon at top
        - label:
            text: "\U000F14E4"
            id: lbl_weather_forecast_condition_icon
            text_font: icons_100
            text_align: CENTER
            text_color: my_white
            align: TOP_MID
            x: 0
            y: 30

        # Condition name below icon
        - label:
            id: lbl_weather_forecast_condition_name
            text: !lambda |-
              if (id(weather_current_condition).empty()) {
                return std::string("Unknown");
              }
              // Format condition text to be more readable
              std::string condition = id(weather_current_condition);
              if (condition == "clear-night") return std::string("Clear Night");
              if (condition == "cloudy") return std::string("Cloudy");
              if (condition == "exceptional") return std::string("Exceptional");
              if (condition == "fog") return std::string("Fog");
              if (condition == "hail") return std::string("Hail");
              if (condition == "lightning") return std::string("Lightning");
              if (condition == "lightning-rainy") return std::string("Lightning & Rain");
              if (condition == "partlycloudy") return std::string("Partly Cloudy");
              if (condition == "pouring") return std::string("Pouring");
              if (condition == "rainy") return std::string("Rainy");
              if (condition == "snowy") return std::string("Snowy");
              if (condition == "snowy-rainy") return std::string("Sleet");
              if (condition == "sunny") return std::string("Sunny");
              if (condition == "windy") return std::string("Windy");
              if (condition == "windy-variant") return std::string("Windy");
              // Return capitalized version if not matched
              if (!condition.empty()) {
                condition[0] = toupper(condition[0]);
              }
              return condition;
            text_align: CENTER
            text_font: montserrat_20
            text_color: my_white
            align: TOP_MID
            x: 0
            y: 130

        # Semicircle meter gauge for apparent temperature
        - obj:
            align: CENTER
            x: 0
            y: 100
            width: 180
            height: 180
            bg_color: 0x000000
            border_width: 0
            pad_all: 10
            widgets:
              - meter:
                  id: weather_temp_gauge
                  height: 100%
                  width: 100%
                  border_width: 0
                  align: CENTER
                  bg_opa: TRANSP
                  scales:
                    - range_from: 0
                      range_to: 100
                      angle_range: 180
                      rotation: 180
                      ticks:
                        count: 51
                        width: 2
                        length: 10
                        color: 0x404040
                      indicators:
                        - tick_style:
                            start_value: 0
                            end_value: 100
                            color_start: 0x00FFFF
                            color_end: 0xFF0000
                    - range_from: 0
                      range_to: 100
                      angle_range: 180
                      rotation: 180
                      ticks:
                        count: 0
                      indicators:
                        - line:
                            id: weather_temp_needle
                            width: 8
                            r_mod: 2
                            value: 50
                            color: 0xFF0000
              - obj:
                  height: 100
                  width: 100
                  radius: 50
                  align: CENTER
                  border_width: 0
                  bg_color: 0x000000

        # Current apparent temperature in center of gauge
        - label:
            id: lbl_weather_today_tempap
            text: !lambda |-
              if (isnan(id(weather_current_apparent_temp))) {
                return std::string("--°");
              }
              char buf[16];
              snprintf(buf, sizeof(buf), "%.0f°", id(weather_current_apparent_temp));
              return std::string(buf);
            text_align: CENTER
            text_font: montserrat_28
            text_color: my_white
            align: CENTER
            x: 0
            y: 120

        # "Feels Like" label above temp
        - label:
            text: "Feels Like"
            text_align: CENTER
            text_font: montserrat_14
            text_color: my_gray
            align: CENTER
            x: 0
            y: 95

        # Low temp stacked above gauge
        - label:
            id: lbl_weather_forecast_templo
            text: !lambda |-
              if (isnan(id(weather_forecast_temp_low)[0])) {
                return std::string("L: --°");
              }
              char buf[16];
              snprintf(buf, sizeof(buf), "L: %.0f°", id(weather_forecast_temp_low)[0]);
              return std::string(buf);
            text_align: CENTER
            text_font: montserrat_28
            text_color: my_teal
            align: CENTER
            x: 0
            y: -35

        # High temp stacked above low temp
        - label:
            id: lbl_weather_forecast_temphi
            text: !lambda |-
              if (isnan(id(weather_forecast_temp_high)[0])) {
                return std::string("H: --°");
              }
              char buf[16];
              snprintf(buf, sizeof(buf), "H: %.0f°", id(weather_forecast_temp_high)[0]);
              return std::string(buf);
            text_align: CENTER
            text_font: montserrat_28
            text_color: my_red
            align: CENTER
            x: 0
            y: -70

        # Precipitation Chance
        - label:
            id: lbl_weather_today_dailyprecipprob
            text: !lambda |-
              if (isnan(id(weather_forecast_precip_prob)[0])) {
                return std::string("Chance: --%");
              }
              char buf[32];
              snprintf(buf, sizeof(buf), "Chance: %.0f%%", id(weather_forecast_precip_prob)[0]);
              return std::string(buf);
            text_align: CENTER
            text_font: montserrat_18
            text_color: my_teal
            align: BOTTOM_MID
            x: 0
            y: -55

        - obj:
            align: BOTTOM_MID
            x: 0
            y: -90    # moved higher so the compass is above the precip probability label
            width: 160
            height: 64
            bg_opa: 0
            border_width: 0
            widgets:
              - meter:
                  id: wind_compass_meter
                  align: LEFT_MID
                  width: 56
                  height: 56
                  border_width: 0
                  bg_opa: TRANSP
                  scales:
                    - range_from: 0
                      range_to: 360
                      angle_range: 360
                      rotation: 270
                      ticks:
                        count: 0
                      indicators:
                        - line:
                            id: wind_compass_needle
                            width: 3
                            r_mod: 2
                            value: 0
                            color: 0x00DFFF
              - label:
                  id: lbl_wind_speed
                  text: !lambda |-
                    if (std::isnan(id(wind_speed_sensor).state)) return std::string("-- mph");
                    char buf[24];
                    snprintf(buf, sizeof(buf), "%.0f mph", id(wind_speed_sensor).state);
                    return std::string(buf);
                  text_font: montserrat_16
                  text_color: my_white
                  align: RIGHT_MID
                  x: -6
                  y: -6
              - label:
                  id: lbl_wind_direction_text
                  text: !lambda |-
                    float b = id(wind_direction_sensor).state;
                    if (std::isnan(b)) return std::string("--");
                    const char* dir;
                    if (b >= 337.5 || b < 22.5) dir = "N";
                    else if (b >= 22.5 && b < 67.5) dir = "NE";
                    else if (b >= 67.5 && b < 112.5) dir = "E";
                    else if (b >= 112.5 && b < 157.5) dir = "SE";
                    else if (b >= 157.5 && b < 202.5) dir = "S";
                    else if (b >= 202.5 && b < 247.5) dir = "SW";
                    else if (b >= 247.5 && b < 292.5) dir = "W";
                    else dir = "NW";
                    return std::string(dir);
                  text_font: montserrat_14
                  text_color: my_gray
                  align: RIGHT_MID
                  x: -6
                  y: 12

        # Current temperature at bottom
        - label:
            text: "Now:"
            text_align: CENTER
            text_font: montserrat_14
            text_color: my_gray
            align: BOTTOM_MID
            x: 0
            y: -30

        - label:
            id: lbl_weather_today_outdoor_temp
            text: !lambda |-
              if (isnan(id(weather_current_temp))) {
                return std::string("--.- °F");
              }
              char buf[16];
              snprintf(buf, sizeof(buf), "%.1f °F", id(weather_current_temp));
              return std::string(buf);
            text_align: CENTER
            text_font: montserrat_20
            text_color: my_white
            align: BOTTOM_MID
            x: 0
            y: -5
        - obj:
            id: nav_button_weather
            align: TOP_RIGHT
            x: 0
            y: 0
            width: 180
            height: 150
            bg_opa: 0
            border_width: 0
            clickable: true
            on_release:
              - logger.log: "Weather page nav button RELEASED!"
              - lambda: |-
                  ESP_LOGI("touch", "Navigation button touched");
                  id(last_auto_rotation_time) = millis();
                  ESP_LOGD("touch", "Auto-rotation timer reset");
              - lvgl.page.next:
                  animation: OUT_LEFT
                  time: 300ms

    - id: AirQ_page
      bg_color: my_black
      scrollbar_mode: "OFF"
      on_load:
        - script.execute: page_transition_cleanup
        - lambda: |-
            id(current_page_name) = "airq";
            id(time_update_last_text).clear();
        - script.execute: time_update
        # Immediately update WiFi indicator when page loads
        - if:
            condition:
              wifi.connected:
            then:
              - lvgl.widget.update:
                  id: wifi_stat
                  text_color: my_green
              - lambda: 'id(airq_wifi_stat_connected_state) = true;'
            else:
              - lvgl.widget.update:
                  id: wifi_stat
                  text_color: my_red
              - lambda: 'id(airq_wifi_stat_connected_state) = false;'
        # Force immediate update of all sensor values on page load
        - if:
            condition:
              lambda: 'return id(co2).has_state();'
            then:
              - lvgl.label.update:
                  id: co2_value
                  text: !lambda |-
                    static char buffer[10];
                    snprintf(buffer, sizeof(buffer), "%d", (int)id(co2).state);
                    return buffer;
              - lvgl.label.update:
                  id: co2_value
                  text_color: !lambda |-
                    float co2_val = id(co2).state;
                    if (co2_val <= 600) return id(my_green);
                    else if (co2_val <= 1000) return id(my_yellow);
                    else if (co2_val <= 1500) return id(my_orange);
                    else return id(my_red);
        - if:
            condition:
              lambda: 'return id(no2).has_state();'
            then:
              - lvgl.label.update:
                  id: no2_value
                  text: !lambda |-
                    static char buffer[10];
                    snprintf(buffer, sizeof(buffer), "%.02f", id(no2).state);
                    return buffer;
              - lvgl.label.update:
                  id: no2_value
                  text_color: !lambda |-
                    float no2_val = id(no2).state;
                    if (no2_val <= 0.03) return id(my_green);
                    else if (no2_val <= 0.06) return id(my_yellow);
                    else if (no2_val <= 0.1) return id(my_orange);
                    else return id(my_red);
        - if:
            condition:
              lambda: 'return id(co).has_state();'
            then:
              - lvgl.label.update:
                  id: co_value
                  text: !lambda |-
                    static char buffer[10];
                    snprintf(buffer, sizeof(buffer), "%.02f", id(co).state);
                    return buffer;
              - lvgl.label.update:
                  id: co_value
                  text_color: !lambda |-
                    float co_val = id(co).state;
                    if (co_val <= 15) return id(my_green);
                    else if (co_val <= 30) return id(my_yellow);
                    else if (co_val <= 36) return id(my_orange);
                    else return id(my_red);
        - if:
            condition:
              lambda: 'return id(h2).has_state();'
            then:
              - lvgl.label.update:
                  id: h2_value
                  text: !lambda |-
                    static char buffer[10];
                    snprintf(buffer, sizeof(buffer), "%.02f", id(h2).state);
                    return buffer;
              - lvgl.label.update:
                  id: h2_value
                  text_color: !lambda |-
                    float h2_val = id(h2).state;
                    if (h2_val <= 0.4) return id(my_green);
                    else if (h2_val <= 1.0) return id(my_yellow);
                    else if (h2_val <= 2.0) return id(my_orange);
                    else return id(my_red);
        - if:
            condition:
              lambda: 'return id(ch4).has_state();'
            then:
              - lvgl.label.update:
                  id: ch4_value
                  text: !lambda |-
                    static char buffer[10];
                    snprintf(buffer, sizeof(buffer), "%.02f", id(ch4).state);
                    return buffer;
              - lvgl.label.update:
                  id: ch4_value
                  text_color: !lambda |-
                    float ch4_val = id(ch4).state;
                    if (ch4_val <= 2.0) return id(my_green);
                    else if (ch4_val <= 10.0) return id(my_yellow);
                    else return id(my_red);
        - if:
            condition:
              lambda: 'return id(ethanol).has_state();'
            then:
              - lvgl.label.update:
                  id: ethanol_value
                  text: !lambda |-
                    static char buffer[10];
                    snprintf(buffer, sizeof(buffer), "%.02f", id(ethanol).state);
                    return buffer;
              - lvgl.label.update:
                  id: ethanol_value
                  text_color: !lambda |-
                    float ethanol_val = id(ethanol).state;
                    if (ethanol_val <= 0.5) return id(my_green);
                    else if (ethanol_val <= 1.5) return id(my_yellow);
                    else if (ethanol_val <= 3.0) return id(my_orange);
                    else return id(my_red);
        - if:
            condition:
              lambda: 'return id(nh3).has_state();'
            then:
              - lvgl.label.update:
                  id: nh3_value
                  text: !lambda |-
                    static char buffer[10];
                    snprintf(buffer, sizeof(buffer), "%.02f", id(nh3).state);
                    return buffer;
              - lvgl.label.update:
                  id: nh3_value
                  text_color: !lambda |-
                    float nh3_val = id(nh3).state;
                    if (nh3_val <= 0.5) return id(my_green);
                    else if (nh3_val <= 1.0) return id(my_yellow);
                    else if (nh3_val <= 2.0) return id(my_orange);
                    else return id(my_red);
        - if:
            condition:
              lambda: 'return id(pm_1_0).has_state();'
            then:
              - lvgl.label.update:
                  id: pm1_value
                  text: !lambda |-
                    static char buffer[10];
                    snprintf(buffer, sizeof(buffer), "%.01f", id(pm_1_0).state);
                    return buffer;
        - if:
            condition:
              lambda: 'return id(pm_2_5).has_state();'
            then:
              - lvgl.label.update:
                  id: pm25_value
                  text: !lambda |-
                    static char buffer[10];
                    snprintf(buffer, sizeof(buffer), "%.01f", id(pm_2_5).state);
                    return buffer;
        - if:
            condition:
              lambda: 'return id(pm_4_0).has_state();'
            then:
              - lvgl.label.update:
                  id: pm4_value
                  text: !lambda |-
                    static char buffer[10];
                    snprintf(buffer, sizeof(buffer), "%.01f", id(pm_4_0).state);
                    return buffer;
        - if:
            condition:
              lambda: 'return id(pm_10_0).has_state();'
            then:
              - lvgl.label.update:
                  id: pm10_value
                  text: !lambda |-
                    static char buffer[10];
                    snprintf(buffer, sizeof(buffer), "%.01f", id(pm_10_0).state);
                    return buffer;
        - if:
            condition:
              lambda: 'return id(computed_halo_aqi).has_state();'
            then:
              - lvgl.label.update:
                  id: aqi_value
                  text: !lambda |-
                    static char buffer[10];
                    snprintf(buffer, sizeof(buffer), "%d", (int)id(computed_halo_aqi).state);
                    return buffer;
              - lvgl.widget.update:
                  id: aqi_widget
                  bg_color: !lambda |-
                    float aqi = id(computed_halo_aqi).state;
                    if (aqi <= 50) return id(my_green);
                    else if (aqi <= 100) return id(my_yellow);
                    else if (aqi <= 150) return id(my_orange);
                    else if (aqi <= 200) return id(my_red);
                    // For purple (300) and maroon (>300), use hex since they're not defined
                    else if (aqi <= 300) return lv_color_hex(0x800080);
                    else return lv_color_hex(0x800000);
        - logger.log: "Forced sensor UI update on AirQ page load"
      widgets:
        # Header: Logo, Time, WiFi Status
        - image:
            id: ym_image
            src: ym_logo
            align: CENTER
            x: 80
            y: -309
        - label:
            id: timeVal
            align: LEFT_MID
            text_font: montserrat_18
            text_color: my_white
            x: 2
            y: -309
            text: "00:00AM"
        - label:
            id: wifi_stat
            align: CENTER
            text_font: montserrat_18
            text_color: my_gray
            x: 42
            y: -309
            text: "\uF1EB"

        # AQI Widget (Color-coded banner)
        - obj:
            id: aqi_widget
            x: 0
            y: 24
            width: 180
            height: 42
            bg_color: 0x76fa76
            border_width: 0
        - label:
            id: aqi_label
            align: LEFT_MID
            text_font: montserrat_28
            text_color: my_black
            long_mode: WRAP
            x: 2
            y: -275
            text: "AQI:"
        - label:
            id: aqi_value
            align: LEFT_MID
            text_font: montserrat_28
            text_color: my_black
            long_mode: WRAP
            x: 90
            y: -275
            text: "000"

        # Temperature Section
        - label:
            id: temperature_label
            align: LEFT_MID
            text_font: montserrat_14
            text_color: my_white
            long_mode: WRAP
            x: 2
            y: -246
            text: "TEMP:"
        - label:
            id: temperature_value
            align: CENTER
            text_font: montserrat_28
            text_color: my_white
            long_mode: WRAP
            x: 0
            y: -234
            text: "000.0"
        - label:
            id: temperature_units
            align: RIGHT_MID
            text_font: montserrat_14
            text_color: my_white
            long_mode: WRAP
            x: -8
            y: -234
            text: "\u00B0F"
        - line:
            points:
              - 0, 106
              - 180, 106
            line_width: 1
            line_color: 0x00dfff

        # CO2 Section
        - label:
            id: co2_label
            align: LEFT_MID
            text_font: montserrat_14
            text_color: my_white
            long_mode: WRAP
            x: 2
            y: -205
            text: "CO2:"
        - label:
            id: co2_value
            align: CENTER
            text_font: montserrat_28
            text_color: my_white
            long_mode: WRAP
            x: 0
            y: -193
            text: "0000"
        - label:
            id: co2_units
            align: RIGHT_MID
            text_font: montserrat_14
            text_color: my_white
            long_mode: WRAP
            x: -2
            y: -193
            text: "PPM"
        - line:
            points:
              - 0, 147
              - 180, 147
            line_width: 1
            line_color: 0x00dfff

        # PM1.0 Section
        - label:
            id: pm1_label
            align: LEFT_MID
            text_font: montserrat_14
            text_color: my_white
            long_mode: WRAP
            x: 2
            y: -164
            text: "PM1:"
        - label:
            id: pm1_value
            align: RIGHT_MID
            text_font: montserrat_28
            text_color: my_white
            long_mode: WRAP
            x: -51
            y: -152
            text: "000.0"
        - label:
            id: pm1_units
            align: RIGHT_MID
            text_font: montserrat_14
            text_color: my_white
            long_mode: WRAP
            x: -2
            y: -152
            text: "ug/m3"
        - line:
            points:
              - 0, 188
              - 180, 188
            line_width: 1
            line_color: 0x00dfff

        # PM2.5 Section
        - label:
            id: pm25_label
            align: LEFT_MID
            text_font: montserrat_14
            text_color: my_white
            long_mode: WRAP
            x: 2
            y: -123
            text: "PM2.5:"
        - label:
            id: pm25_value
            align: RIGHT_MID
            text_font: montserrat_28
            text_color: my_white
            long_mode: WRAP
            x: -51
            y: -111
            text: "000.0"
        - label:
            id: pm25_units
            align: RIGHT_MID
            text_font: montserrat_14
            text_color: my_white
            long_mode: WRAP
            x: -2
            y: -111
            text: "ug/m3"
        - line:
            points:
              - 0, 229
              - 180, 229
            line_width: 1
            line_color: 0x00dfff

        # PM4.0 Section
        - label:
            id: pm4_label
            align: LEFT_MID
            text_font: montserrat_14
            text_color: my_white
            long_mode: WRAP
            x: 2
            y: -82
            text: "PM4:"
        - label:
            id: pm4_value
            align: RIGHT_MID
            text_font: montserrat_28
            text_color: my_white
            long_mode: WRAP
            x: -51
            y: -70
            text: "000.0"
        - label:
            id: pm4_units
            align: RIGHT_MID
            text_font: montserrat_14
            text_color: my_white
            long_mode: WRAP
            x: -2
            y: -70
            text: "ug/m3"
        - line:
            points:
              - 0, 270
              - 180, 270
            line_width: 1
            line_color: 0x00dfff

        # PM10 Section
        - label:
            id: pm10_label
            align: LEFT_MID
            text_font: montserrat_14
            text_color: my_white
            long_mode: WRAP
            x: 2
            y: -41
            text: "PM10:"
        - label:
            id: pm10_value
            align: RIGHT_MID
            text_font: montserrat_28
            text_color: my_white
            long_mode: WRAP
            x: -51
            y: -29
            text: "000.0"
        - label:
            id: pm10_units
            align: RIGHT_MID
            text_font: montserrat_14
            text_color: my_white
            long_mode: WRAP
            x: -2
            y: -29
            text: "ug/m3"
        - line:
            points:
              - 0, 311
              - 180, 311
            line_width: 1
            line_color: 0x00dfff

        # VOC Section
        - label:
            id: voc_label
            align: LEFT_MID
            text_font: montserrat_14
            text_color: my_white
            long_mode: WRAP
            x: 2
            y: 0
            text: "VOC:"
        - label:
            id: voc_value
            align: RIGHT_MID
            text_font: montserrat_28
            text_color: my_white
            long_mode: WRAP
            x: -51
            y: 12
            text: "000.0"
        - label:
            id: voc_units
            align: RIGHT_MID
            text_font: montserrat_14
            text_color: my_white
            long_mode: WRAP
            x: -2
            y: 12
            text: "IDX"
        - line:
            points:
              - 0, 352
              - 180, 352
            line_width: 1
            line_color: 0x00dfff

        # CO Section
        - label:
            id: co_label
            align: LEFT_MID
            text_font: montserrat_14
            text_color: my_white
            long_mode: WRAP
            x: 2
            y: 41
            text: "CO:"
        - label:
            id: co_value
            align: RIGHT_MID
            text_font: montserrat_28
            text_color: my_white
            long_mode: WRAP
            x: -51
            y: 53
            text: "000.0"
        - label:
            id: co_units
            align: RIGHT_MID
            text_font: montserrat_14
            text_color: my_white
            long_mode: WRAP
            x: -2
            y: 53
            text: "PPM"
        - line:
            points:
              - 0, 393
              - 180, 393
            line_width: 1
            line_color: 0x00dfff

        # Ethanol Section
        - label:
            id: ethanol_label
            align: LEFT_MID
            text_font: montserrat_14
            text_color: my_white
            long_mode: SCROLL
            width: 40
            x: 2
            y: 82
            text: "C2H5OH:"
        - label:
            id: ethanol_value
            align: RIGHT_MID
            text_font: montserrat_28
            text_color: my_white
            long_mode: WRAP
            x: -51
            y: 94
            text: "000.0"
        - label:
            id: ethanol_units
            align: RIGHT_MID
            text_font: montserrat_14
            text_color: my_white
            long_mode: WRAP
            x: -2
            y: 94
            text: "PPM"
        - line:
            points:
              - 0, 434
              - 180, 434
            line_width: 1
            line_color: 0x00dfff

        # Hydrogen Section
        - label:
            id: h2_label
            align: LEFT_MID
            text_font: montserrat_14
            text_color: my_white
            long_mode: WRAP
            x: 2
            y: 124
            text: "H2:"
        - label:
            id: h2_value
            align: RIGHT_MID
            text_font: montserrat_28
            text_color: my_white
            long_mode: WRAP
            x: -51
            y: 135
            text: "000.0"
        - label:
            id: h2_units
            align: RIGHT_MID
            text_font: montserrat_14
            text_color: my_white
            long_mode: WRAP
            x: -2
            y: 135
            text: "PPM"
        - line:
            points:
              - 0, 475
              - 180, 475
            line_width: 1
            line_color: 0x00dfff

        # NO2 Section
        - label:
            id: no2_label
            align: LEFT_MID
            text_font: montserrat_14
            text_color: my_white
            long_mode: WRAP
            x: 2
            y: 165
            text: "NO2:"
        - label:
            id: no2_value
            align: RIGHT_MID
            text_font: montserrat_28
            text_color: my_white
            long_mode: WRAP
            x: -51
            y: 176
            text: "000.0"
        - label:
            id: no2_units
            align: RIGHT_MID
            text_font: montserrat_14
            text_color: my_white
            long_mode: WRAP
            x: -2
            y: 176
            text: "PPM"
        - line:
            points:
              - 0, 516
              - 180, 516
            line_width: 1
            line_color: 0x00dfff

        # NH3 Section
        - label:
            id: nh3_label
            align: LEFT_MID
            text_font: montserrat_14
            text_color: my_white
            long_mode: WRAP
            x: 2
            y: 206
            text: "NH3:"
        - label:
            id: nh3_value
            align: RIGHT_MID
            text_font: montserrat_28
            text_color: my_white
            long_mode: WRAP
            x: -51
            y: 217
            text: "000.0"
        - label:
            id: nh3_units
            align: RIGHT_MID
            text_font: montserrat_14
            text_color: my_white
            long_mode: WRAP
            x: -2
            y: 217
            text: "PPM"
        - line:
            points:
              - 0, 557
              - 180, 557
            line_width: 1
            line_color: 0x00dfff

        # CH4 Section
        - label:
            id: ch4_label
            align: LEFT_MID
            text_font: montserrat_14
            text_color: my_white
            long_mode: WRAP
            x: 2
            y: 247
            text: "CH4:"
        - label:
            id: ch4_value
            align: RIGHT_MID
            text_font: montserrat_28
            text_color: my_white
            long_mode: WRAP
            x: -51
            y: 258
            text: "000.0"
        - label:
            id: ch4_units
            align: RIGHT_MID
            text_font: montserrat_14
            text_color: my_white
            long_mode: WRAP
            x: -2
            y: 258
            text: "PPM"
        - line:
            points:
              - 0, 598
              - 180, 598
            line_width: 1
            line_color: 0x00dfff

        # RH (Relative Humidity) Section
        - label:
            id: rh_label
            align: LEFT_MID
            text_font: montserrat_14
            text_color: my_white
            long_mode: WRAP
            x: 2
            y: 287
            text: "RH:"
        - label:
            id: rh_value
            align: RIGHT_MID
            text_font: montserrat_28
            text_color: my_white
            long_mode: WRAP
            x: -51
            y: 299
            text: "000.0"
        - label:
            id: rh_units
            align: RIGHT_MID
            text_font: montserrat_14
            text_color: my_white
            long_mode: WRAP
            x: -2
            y: 299
            text: "%"

        # Navigation Button (top-right corner touch area)
        - obj:
            id: nav_button_AirQ
            align: TOP_RIGHT
            x: 0
            y: 0
            width: 180
            height: 150
            bg_opa: 0
            border_width: 0
            clickable: true
            on_release:
              - logger.log: "AirQ page nav button RELEASED!"
              - lambda: |-
                  ESP_LOGI("touch", "Navigation button touched");
                  id(last_auto_rotation_time) = millis();
                  ESP_LOGD("touch", "Auto-rotation timer reset");
              - lvgl.page.next:
                  animation: OUT_LEFT
                  time: 300ms
        # Header: Logo, Time, WiFi Status
    - id: wifi_page
      bg_color: 0x000000
      bg_opa: COVER
      scrollbar_mode: "OFF"
      on_load:
        - script.execute: page_transition_cleanup
        - lambda: 'id(current_page_name) = "wifi";'
        # Trigger immediate WiFi display updates when page loads
        - lambda: |-
            id(wifi_signal_needs_render) = true;
            id(wifi_signal_bar_needs_render) = true;
            id(wifi_ssid_needs_render) = true;
            id(wifi_ip_needs_render) = true;
            id(ha_status_needs_render) = true;
            id(wg_status_needs_render) = true;
            id(wg_address_needs_render) = true;
            id(wg_handshake_needs_render) = true;
      widgets:
        - label:
            text: "WiFi & VPN \nStatistics"
            align: CENTER
            x: 0
            y: -300
            text_font: montserrat_20
            text_color: my_white
            text_align: CENTER
        - label:
            id: wifi_ssid_label
            text: "SSID: ...\n"
            align: LEFT_MID
            x: 10
            y: -250
            text_font: montserrat_18
            text_color: my_white
        - label:
            id: wifi_signal_label
            text: "Signal: ..."
            align: LEFT_MID
            x: 10
            y: -230
            text_font: montserrat_18
            text_color: my_white
        - bar:
            id: wifi_signal_bar
            align: CENTER
            x: 0
            y: -200
            width: 160
            height: 10
            min_value: -100
            max_value: -30
            value: -100
            bg_color: my_gray
            indicator:
              bg_grad: wifi_signal_gradient

        - label:
            id: wifi_ip_label
            text: "IP: ..."
            align: LEFT_MID
            x: 10
            y: -175
            text_font: montserrat_18
            text_color: my_white
        - label:
            text: "WireGuard"
            align: CENTER
            x: 0
            y: -100
            text_font: montserrat_20
            text_color: my_teal
        - label:
            id: wg_status_label
            text: "Status: Disabled"
            align: LEFT_MID
            x: 10
            y: -50
            text_font: montserrat_18
            text_color: my_gray
        - label:
            id: wg_address_label
            text: "VPN IP: ..."
            align: LEFT_MID
            x: 10
            y: 0
            text_font: montserrat_18
            text_color: my_white
        - label:
            id: wg_endpoint_label
            text: "Endpoint: ..."
            align: LEFT_MID
            x: 10
            y: 50
            text_font: montserrat_18
            text_color: my_white
        - label:
            id: wg_handshake_label
            text: "Last Handshake: ..."
            align: LEFT_MID
            x: 10
            y: 125
            text_font: montserrat_18
            text_color: my_white
            text_align: LEFT

        # Version number label
        - label:
            text: "${version}"
            align: BOTTOM_MID
            x: 0
            y: -5
            text_font: montserrat_14
            text_color: my_gray

        # Home Assistant connection status icon
        - label:
            id: ha_status_icon
            text: "\U000F07D0"  # Home Assistant icon (MDI)
            align: BOTTOM_MID
            x: 0
            y: -40
            text_font: icons_80
            text_color: my_gray  # Will be updated based on connection status

        - obj:
            id: nav_button_wifi
            align: TOP_RIGHT
            x: 0
            y: 0
            width: 180
            height: 150
            bg_opa: 0
            border_width: 0
            clickable: true
            on_release:
              - logger.log: "WiFi page nav button RELEASED!"
              - lambda: |-
                  ESP_LOGI("touch", "Navigation button touched");
                  id(last_auto_rotation_time) = millis();
                  ESP_LOGD("touch", "Auto-rotation timer reset");
              - lvgl.page.next:
                  animation: OUT_LEFT
                  time: 300ms

        # Summary Hourly Page (12-hour compact columns)
    
    - id: hourly_summary_page
      skip: true
      bg_color: 0x000000
      bg_opa: COVER
      scrollbar_mode: "OFF"
      on_load:
      - script.execute: page_transition_cleanup
      - lambda: 'id(current_page_name) = "hourly_summary";'
      - delay: 100ms  # Increased delay to allow memory to stabilize
      - lambda: |-
          ESP_LOGI("memory", "Before hourly summary page load - Free heap: %d bytes", esp_get_free_heap_size());
      - if:
          condition:
            lambda: |-
              uint32_t time_since_update = millis() - id(weather_hourly_last_update);
              bool is_stale = (id(weather_hourly_last_update) == 0 || time_since_update > 900000);
              return is_stale;
          then:
            - script.execute: fetch_hourly_forecast
          else:
            - delay: 50ms
            - script.execute: update_hourly_forecast_display
      widgets:
        - label:
            text: "12-Hour Summary"
            align: TOP_MID
            y: 5
            text_font: montserrat_18
            text_color: my_white
            text_align: CENTER

        - obj:
            width: 100%
            height: SIZE_CONTENT
            align: TOP_MID
            y: 35
            bg_opa: 0
            border_width: 0
            pad_all: 4
            layout:
              type: flex
              flex_flow: row
              flex_align_main: START
              flex_align_cross: START
              # flex_wrap: WRAP  # Not supported in current ESPHome LVGL version
              # gap: 6  # Not supported in current ESPHome LVGL version
            widgets:
              # Generate up to 12 compact hour columns (each is a small vertical stack)
              - obj:
                  id: hourly_col_1
                  width: 80
                  height: SIZE_CONTENT
                  bg_color: 0x101010
                  bg_opa: COVER
                  border_width: 0
                  radius: 6
                  pad_all: 6
                  layout:
                    type: flex
                    flex_flow: column
                    pad_row: 2
                  clickable: true
                  on_release:
                    - logger.log: "Hourly summary column 1 clicked"
                    - lambda: |-
                        id(last_auto_rotation_time) = millis();
                    - lvgl.page.show:
                        id: hourly_forecast_page
                        animation: OUT_LEFT
                        time: 300ms
                  widgets:
                    - label:
                        id: lbl_sum_hour1_time
                        text: "--:--"
                        text_font: montserrat_12
                        text_color: my_gray
                        text_align: CENTER
                    - label:
                        id: lbl_sum_hour1_icon
                        text: "\U000F14E4"
                        text_font: icons_28
                        text_color: my_white
                        text_align: CENTER
                    - label:
                        id: lbl_sum_hour1_temp
                        text: "--°"
                        text_font: montserrat_16
                        text_color: my_white
                        text_align: CENTER
                    - label:
                        id: lbl_sum_hour1_precip
                        text: "--%"
                        text_font: montserrat_12
                        text_color: my_teal
                        text_align: CENTER

              - obj:
                  id: hourly_col_2
                  width: 80
                  height: SIZE_CONTENT
                  bg_color: 0x101010
                  bg_opa: COVER
                  border_width: 0
                  radius: 6
                  pad_all: 6
                  layout:
                    type: flex
                    flex_flow: column
                    pad_row: 2
                  clickable: true
                  on_release:
                    - logger.log: "Hourly summary column 2 clicked"
                    - lambda: |-
                        id(last_auto_rotation_time) = millis();
                    - lvgl.page.show:
                        id: hourly_forecast_page
                        animation: OUT_LEFT
                        time: 300ms
                  widgets:
                    - label:
                        id: lbl_sum_hour2_time
                        text: "--:--"
                        text_font: montserrat_12
                        text_color: my_gray
                        text_align: CENTER
                    - label:
                        id: lbl_sum_hour2_icon
                        text: "\U000F14E4"
                        text_font: icons_28
                        text_color: my_white
                        text_align: CENTER
                    - label:
                        id: lbl_sum_hour2_temp
                        text: "--°"
                        text_font: montserrat_16
                        text_color: my_white
                        text_align: CENTER
                    - label:
                        id: lbl_sum_hour2_precip
                        text: "--%"
                        text_font: montserrat_12
                        text_color: my_teal
                        text_align: CENTER

              - obj:
                  id: hourly_col_3
                  width: 80
                  height: SIZE_CONTENT
                  bg_color: 0x101010
                  bg_opa: COVER
                  border_width: 0
                  radius: 6
                  pad_all: 6
                  layout:
                    type: flex
                    flex_flow: column
                    pad_row: 2
                  clickable: true
                  on_release:
                    - logger.log: "Hourly summary column 3 clicked"
                    - lambda: |-
                        id(last_auto_rotation_time) = millis();
                    - lvgl.page.show:
                        id: hourly_forecast_page
                        animation: OUT_LEFT
                        time: 300ms
                  widgets:
                    - label:
                        id: lbl_sum_hour3_time
                        text: "--:--"
                        text_font: montserrat_12
                        text_color: my_gray
                        text_align: CENTER
                    - label:
                        id: lbl_sum_hour3_icon
                        text: "\U000F14E4"
                        text_font: icons_28
                        text_color: my_white
                        text_align: CENTER
                    - label:
                        id: lbl_sum_hour3_temp
                        text: "--°"
                        text_font: montserrat_16
                        text_color: my_white
                        text_align: CENTER
                    - label:
                        id: lbl_sum_hour3_precip
                        text: "--%"
                        text_font: montserrat_12
                        text_color: my_teal
                        text_align: CENTER

              - obj:
                  id: hourly_col_4
                  width: 80
                  height: SIZE_CONTENT
                  bg_color: 0x101010
                  bg_opa: COVER
                  border_width: 0
                  radius: 6
                  pad_all: 6
                  layout:
                    type: flex
                    flex_flow: column
                    pad_row: 2
                  clickable: true
                  on_release:
                    - logger.log: "Hourly summary column 4 clicked"
                    - lambda: |-
                        id(last_auto_rotation_time) = millis();
                    - lvgl.page.show:
                        id: hourly_forecast_page
                        animation: OUT_LEFT
                        time: 300ms
                  widgets:
                    - label:
                        id: lbl_sum_hour4_time
                        text: "--:--"
                        text_font: montserrat_12
                        text_color: my_gray
                        text_align: CENTER
                    - label:
                        id: lbl_sum_hour4_icon
                        text: "\U000F14E4"
                        text_font: icons_28
                        text_color: my_white
                        text_align: CENTER
                    - label:
                        id: lbl_sum_hour4_temp
                        text: "--°"
                        text_font: montserrat_16
                        text_color: my_white
                        text_align: CENTER
                    - label:
                        id: lbl_sum_hour4_precip
                        text: "--%"
                        text_font: montserrat_12
                        text_color: my_teal
                        text_align: CENTER
              - obj:
                  id: hourly_col_5
                  width: 80
                  height: SIZE_CONTENT
                  bg_color: 0x101010
                  bg_opa: COVER
                  border_width: 0
                  radius: 6
                  pad_all: 6
                  layout:
                    type: flex
                    flex_flow: column
                    pad_row: 2
                  clickable: true
                  on_release:
                    - logger.log: "Hourly summary column 5 clicked"
                    - lambda: |-
                        id(last_auto_rotation_time) = millis();
                    - lvgl.page.show:
                        id: hourly_forecast_page
                        animation: OUT_LEFT
                        time: 300ms
                  widgets:
                    - label:
                        id: lbl_sum_hour5_time
                        text: "--:--"
                        text_font: montserrat_12
                        text_color: my_gray
                        text_align: CENTER
                    - label:
                        id: lbl_sum_hour5_icon
                        text: "\U000F14E4"
                        text_font: icons_28
                        text_color: my_white
                        text_align: CENTER
                    - label:
                        id: lbl_sum_hour5_temp
                        text: "--°"
                        text_font: montserrat_16
                        text_color: my_white
                        text_align: CENTER
                    - label:
                        id: lbl_sum_hour5_precip
                        text: "--%"
                        text_font: montserrat_12
                        text_color: my_teal
                        text_align: CENTER
              - obj:
                  id: hourly_col_6
                  width: 80
                  height: SIZE_CONTENT
                  bg_color: 0x101010
                  bg_opa: COVER
                  border_width: 0
                  radius: 6
                  pad_all: 6
                  layout:
                    type: flex
                    flex_flow: column
                    pad_row: 2
                  clickable: true
                  on_release:
                    - logger.log: "Hourly summary column 6 clicked"
                    - lambda: |-
                        id(last_auto_rotation_time) = millis();
                    - lvgl.page.show:
                        id: hourly_forecast_page
                        animation: OUT_LEFT
                        time: 300ms
                  widgets:
                    - label:
                        id: lbl_sum_hour6_time
                        text: "--:--"
                        text_font: montserrat_12
                        text_color: my_gray
                        text_align: CENTER
                    - label:
                        id: lbl_sum_hour6_icon
                        text: "\U000F14E4"
                        text_font: icons_28
                        text_color: my_white
                        text_align: CENTER
                    - label:
                        id: lbl_sum_hour6_temp
                        text: "--°"
                        text_font: montserrat_16
                        text_color: my_white
                        text_align: CENTER
                    - label:
                        id: lbl_sum_hour6_precip
                        text: "--%"
                        text_font: montserrat_12
                        text_color: my_teal
                        text_align: CENTER
              - obj:
                  id: hourly_col_7
                  width: 80
                  height: SIZE_CONTENT
                  bg_color: 0x101010
                  bg_opa: COVER
                  border_width: 0
                  radius: 6
                  pad_all: 6
                  layout:
                    type: flex
                    flex_flow: column
                    pad_row: 2
                  clickable: true
                  on_release:
                    - logger.log: "Hourly summary column 7 clicked"
                    - lambda: |-
                        id(last_auto_rotation_time) = millis();
                    - lvgl.page.show:
                        id: hourly_forecast_page
                        animation: OUT_LEFT
                        time: 300ms
                  widgets:
                    - label:
                        id: lbl_sum_hour7_time
                        text: "--:--"
                        text_font: montserrat_12
                        text_color: my_gray
                        text_align: CENTER
                    - label:
                        id: lbl_sum_hour7_icon
                        text: "\U000F14E4"
                        text_font: icons_28
                        text_color: my_white
                        text_align: CENTER
                    - label:
                        id: lbl_sum_hour7_temp
                        text: "--°"
                        text_font: montserrat_16
                        text_color: my_white
                        text_align: CENTER
                    - label:
                        id: lbl_sum_hour7_precip
                        text: "--%"
                        text_font: montserrat_12
                        text_color: my_teal
                        text_align: CENTER
              - obj:
                  id: hourly_col_8
                  width: 80
                  height: SIZE_CONTENT
                  bg_color: 0x101010
                  bg_opa: COVER
                  border_width: 0
                  radius: 6
                  pad_all: 6
                  layout:
                    type: flex
                    flex_flow: column
                    pad_row: 2
                  clickable: true
                  on_release:
                    - logger.log: "Hourly summary column 8 clicked"
                    - lambda: |-
                        id(last_auto_rotation_time) = millis();
                    - lvgl.page.show:
                        id: hourly_forecast_page
                        animation: OUT_LEFT
                        time: 300ms
                  widgets:
                    - label:
                        id: lbl_sum_hour8_time
                        text: "--:--"
                        text_font: montserrat_12
                        text_color: my_gray
                        text_align: CENTER
                    - label:
                        id: lbl_sum_hour8_icon
                        text: "\U000F14E4"
                        text_font: icons_28
                        text_color: my_white
                        text_align: CENTER
                    - label:
                        id: lbl_sum_hour8_temp
                        text: "--°"
                        text_font: montserrat_16
                        text_color: my_white
                        text_align: CENTER
                    - label:
                        id: lbl_sum_hour8_precip
                        text: "--%"
                        text_font: montserrat_12
                        text_color: my_teal
                        text_align: CENTER
              - obj:
                  id: hourly_col_9
                  width: 80
                  height: SIZE_CONTENT
                  bg_color: 0x101010
                  bg_opa: COVER
                  border_width: 0
                  radius: 6
                  pad_all: 6
                  layout:
                    type: flex
                    flex_flow: column
                    pad_row: 2
                  clickable: true
                  on_release:
                    - logger.log: "Hourly summary column 9 clicked"
                    - lambda: |-
                        id(last_auto_rotation_time) = millis();
                    - lvgl.page.show:
                        id: hourly_forecast_page
                        animation: OUT_LEFT
                        time: 300ms
                  widgets:
                    - label:
                        id: lbl_sum_hour9_time
                        text: "--:--"
                        text_font: montserrat_12
                        text_color: my_gray
                        text_align: CENTER
                    - label:
                        id: lbl_sum_hour9_icon
                        text: "\U000F14E4"
                        text_font: icons_28
                        text_color: my_white
                        text_align: CENTER
                    - label:
                        id: lbl_sum_hour9_temp
                        text: "--°"
                        text_font: montserrat_16
                        text_color: my_white
                        text_align: CENTER
                    - label:
                        id: lbl_sum_hour9_precip
                        text: "--%"
                        text_font: montserrat_12
                        text_color: my_teal
                        text_align: CENTER
              - obj:
                  id: hourly_col_10
                  width: 80
                  height: SIZE_CONTENT
                  bg_color: 0x101010
                  bg_opa: COVER
                  border_width: 0
                  radius: 6
                  pad_all: 6
                  layout:
                    type: flex
                    flex_flow: column
                    pad_row: 2
                  clickable: true
                  on_release:
                    - logger.log: "Hourly summary column 10 clicked"
                    - lambda: |-
                        id(last_auto_rotation_time) = millis();
                    - lvgl.page.show:
                        id: hourly_forecast_page
                        animation: OUT_LEFT
                        time: 300ms
                  widgets:
                    - label:
                        id: lbl_sum_hour10_time
                        text: "--:--"
                        text_font: montserrat_12
                        text_color: my_gray
                        text_align: CENTER
                    - label:
                        id: lbl_sum_hour10_icon
                        text: "\U000F14E4"
                        text_font: icons_28
                        text_color: my_white
                        text_align: CENTER
                    - label:
                        id: lbl_sum_hour10_temp
                        text: "--°"
                        text_font: montserrat_16
                        text_color: my_white
                        text_align: CENTER
                    - label:
                        id: lbl_sum_hour10_precip
                        text: "--%"
                        text_font: montserrat_12
                        text_color: my_teal
                        text_align: CENTER
              - obj:
                  id: hourly_col_11
                  width: 80
                  height: SIZE_CONTENT
                  bg_color: 0x101010
                  bg_opa: COVER
                  border_width: 0
                  radius: 6
                  pad_all: 6
                  layout:
                    type: flex
                    flex_flow: column
                    pad_row: 2
                  clickable: true
                  on_release:
                    - logger.log: "Hourly summary column 11 clicked"
                    - lambda: |-
                        id(last_auto_rotation_time) = millis();
                    - lvgl.page.show:
                        id: hourly_forecast_page
                        animation: OUT_LEFT
                        time: 300ms
                  widgets:
                    - label:
                        id: lbl_sum_hour11_time
                        text: "--:--"
                        text_font: montserrat_12
                        text_color: my_gray
                        text_align: CENTER
                    - label:
                        id: lbl_sum_hour11_icon
                        text: "\U000F14E4"
                        text_font: icons_28
                        text_color: my_white
                        text_align: CENTER
                    - label:
                        id: lbl_sum_hour11_temp
                        text: "--°"
                        text_font: montserrat_16
                        text_color: my_white
                        text_align: CENTER
                    - label:
                        id: lbl_sum_hour11_precip
                        text: "--%"
                        text_font: montserrat_12
                        text_color: my_teal
                        text_align: CENTER
              - obj:
                  id: hourly_col_12
                  width: 80
                  height: SIZE_CONTENT
                  bg_color: 0x101010
                  bg_opa: COVER
                  border_width: 0
                  radius: 6
                  pad_all: 6
                  layout:
                    type: flex
                    flex_flow: column
                    pad_row: 2
                  clickable: true
                  on_release:
                    - logger.log: "Hourly summary column 12 clicked"
                    - lambda: |-
                        id(last_auto_rotation_time) = millis();
                    - lvgl.page.show:
                        id: hourly_forecast_page
                        animation: OUT_LEFT
                        time: 300ms
                  widgets:
                    - label:
                        id: lbl_sum_hour12_time
                        text: "--:--"
                        text_font: montserrat_12
                        text_color: my_gray
                        text_align: CENTER
                    - label:
                        id: lbl_sum_hour12_icon
                        text: "\U000F14E4"
                        text_font: icons_28
                        text_color: my_white
                        text_align: CENTER
                    - label:
                        id: lbl_sum_hour12_temp
                        text: "--°"
                        text_font: montserrat_16
                        text_color: my_white
                        text_align: CENTER
                    - label:
                        id: lbl_sum_hour12_precip
                        text: "--%"
                        text_font: montserrat_12
                        text_color: my_teal
                        text_align: CENTER

    - id: hourly_forecast_page
      bg_color: 0x000000
      bg_opa: COVER
      scrollbar_mode: "OFF"
      on_load:
        - script.execute: page_transition_cleanup
        - lambda: 'id(current_page_name) = "hourly_forecast";'
        - delay: 100ms  # Increased delay to allow memory to stabilize after cleanup
        # Force garbage collection to free up memory before rendering
        - lambda: |-
            ESP_LOGI("memory", "Before hourly page load - Free heap: %d bytes", esp_get_free_heap_size());
        # Check if we have data and if it needs refresh
        - if:
            condition:
              lambda: |-
                // Check if hourly forecast needs refresh (stale > 15 minutes)
                uint32_t time_since_update = millis() - id(weather_hourly_last_update);
                bool is_stale = (id(weather_hourly_last_update) == 0 || time_since_update > 900000);
                
                if (is_stale) {
                  ESP_LOGI("weather", "Hourly forecast is stale (age: %u minutes), fetching in background...",
                           id(weather_hourly_last_update) == 0 ? 0 : time_since_update / 60000);
                  return true;
                } else {
                  ESP_LOGD("weather", "Hourly forecast is fresh (updated %u minutes ago)", time_since_update / 60000);
                  return false;
                }
            then:
              # Fetch will update display when complete (no need to call update_hourly_forecast_display here)
              - script.execute: fetch_hourly_forecast
            else:
              # Data is fresh, update display with existing data
              - delay: 50ms  # Additional delay before rendering
              - script.execute: update_hourly_page_1  # Lazy loading: only update hours 1-3
      widgets:
        # Page Header
        - label:
            text: "6-Hour Forecast"
            align: TOP_MID
            y: 5
            text_font: montserrat_18
            text_color: my_white
            text_align: CENTER

        # Hour 1 Card
        - obj:
            width: 170
            height: SIZE_CONTENT
            align: TOP_MID
            y: 35
            bg_color: 0x101010
            bg_opa: COVER
            border_width: 0
            radius: 8
            pad_all: 6
            scrollbar_mode: "OFF"
            layout:
              type: flex
              flex_flow: column
              pad_row: 2
            widgets:
              - label:
                  id: lbl_hourly_hour1_header
                  text: "Hour +1"
                  text_font: montserrat_14
                  text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        id: lbl_hourly_hour1_icon
                        text: "\U000F14E4"
                        text_font: icons_40
                        text_color: my_white
                    - label:
                        id: lbl_hourly_hour1_temp
                        text: "--°"
                        text_font: montserrat_24
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Feels:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour1_feels
                        text: "--°"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Humid:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour1_humid
                        text: "--%"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Precip:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour1_precip
                        text: "--%"
                        text_font: montserrat_10
                        text_color: my_teal
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Amt:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour1_precip_amt
                        text: "-- in"
                        text_font: montserrat_10
                        text_color: my_teal
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Pressure:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour1_pressure
                        text: "-- mb"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "UV:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour1_uv
                        text: "--"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Wind:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour1_wind
                        text: "-- mph"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Direction:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour1_wind_dir
                        text: "--"
                        text_font: montserrat_10
                        text_color: my_white

        # Hour 2 Card
        - obj:
            width: 170
            height: SIZE_CONTENT
            align: TOP_MID
            y: 245
            bg_color: 0x101010
            bg_opa: COVER
            border_width: 0
            radius: 8
            pad_all: 6
            scrollbar_mode: "OFF"
            layout:
              type: flex
              flex_flow: column
              pad_row: 2
            widgets:
              - label:
                  id: lbl_hourly_hour2_header
                  text: "Hour +2"
                  text_font: montserrat_14
                  text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        id: lbl_hourly_hour2_icon
                        text: "\U000F14E4"
                        text_font: icons_40
                        text_color: my_white
                    - label:
                        id: lbl_hourly_hour2_temp
                        text: "--°"
                        text_font: montserrat_24
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Feels:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour2_feels
                        text: "--°"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Humid:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour2_humid
                        text: "--%"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Precip:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour2_precip
                        text: "--%"
                        text_font: montserrat_10
                        text_color: my_teal
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Amt:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour2_precip_amt
                        text: "-- in"
                        text_font: montserrat_10
                        text_color: my_teal
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Pressure:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour2_pressure
                        text: "-- mb"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "UV:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour2_uv
                        text: "--"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Wind:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour2_wind
                        text: "-- mph"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Direction:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour2_wind_dir
                        text: "--"
                        text_font: montserrat_10
                        text_color: my_white

        # Hour 3 Card
        - obj:
            width: 170
            height: SIZE_CONTENT
            align: TOP_MID
            y: 455
            bg_color: 0x101010
            bg_opa: COVER
            border_width: 0
            radius: 8
            pad_all: 6
            scrollbar_mode: "OFF"
            layout:
              type: flex
              flex_flow: column
              pad_row: 2
            widgets:
              - label:
                  id: lbl_hourly_hour3_header
                  text: "Hour +3"
                  text_font: montserrat_14
                  text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        id: lbl_hourly_hour3_icon
                        text: "\U000F14E4"
                        text_font: icons_40
                        text_color: my_white
                    - label:
                        id: lbl_hourly_hour3_temp
                        text: "--°"
                        text_font: montserrat_24
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Feels:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour3_feels
                        text: "--°"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Humid:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour3_humid
                        text: "--%"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Precip:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour3_precip
                        text: "--%"
                        text_font: montserrat_10
                        text_color: my_teal
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Amt:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour3_precip_amt
                        text: "-- in"
                        text_font: montserrat_10
                        text_color: my_teal
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Pressure:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour3_pressure
                        text: "-- mb"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "UV:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour3_uv
                        text: "--"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Wind:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour3_wind
                        text: "-- mph"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Direction:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour3_wind_dir
                        text: "--"
                        text_font: montserrat_10
                        text_color: my_white

        # Center navigation button - click to go to hours 4-6
        - obj:
            id: nav_button_hourly_center
            align: CENTER
            width: 150
            height: 150
            bg_opa: 0
            border_width: 0
            clickable: true
            on_release:
              - logger.log: "Hourly page 1 CENTER button RELEASED - going to page 2!"
              - lambda: |-
                  ESP_LOGI("touch", "Navigation button touched");
                  id(last_auto_rotation_time) = millis();
                  ESP_LOGD("touch", "Auto-rotation timer reset");
              - lvgl.page.show:
                  id: hourly_forecast_page_2
                  animation: OUT_LEFT
                  time: 300ms

        # Top-right navigation button - normal page rotation
        - obj:
            id: nav_button_hourly
            align: TOP_RIGHT
            x: 0
            y: 0
            width: 180
            height: 150
            bg_opa: 0
            border_width: 0
            clickable: true
            on_release:
              - logger.log: "Hourly Forecast page nav button RELEASED!"
              - lambda: |-
                  ESP_LOGI("touch", "Navigation button touched");
                  id(last_auto_rotation_time) = millis();
                  ESP_LOGD("touch", "Auto-rotation timer reset");
              - lvgl.page.next:
                  animation: OUT_LEFT
                  time: 300ms

    # Hourly Forecast Page 2 (Hours 4-6)
    - id: hourly_forecast_page_2
      skip: true
      bg_color: 0x000000
      bg_opa: COVER
      scrollbar_mode: "OFF"
      on_load:
        - script.execute: page_transition_cleanup
        - lambda: 'id(current_page_name) = "hourly_forecast";'
        - delay: 10ms
        - if:
            condition:
              lambda: |-
                uint32_t time_since_update = millis() - id(weather_hourly_last_update);
                bool is_stale = (id(weather_hourly_last_update) == 0 || time_since_update > 900000);
                return is_stale;
            then:
              - script.execute: fetch_hourly_forecast
            else:
              - delay: 50ms
              - script.execute: update_hourly_page_2  # Lazy loading: only update hours 4-6
      widgets:
        - label:
            text: "6-Hour Forecast"
            align: TOP_MID
            y: 5
            text_font: montserrat_18
            text_color: my_white
            text_align: CENTER

        # Hour 4 Card
        - obj:
            width: 170
            height: SIZE_CONTENT
            align: TOP_MID
            y: 35
            bg_color: 0x101010
            bg_opa: COVER
            border_width: 0
            radius: 8
            pad_all: 6
            scrollbar_mode: "OFF"
            layout:
              type: flex
              flex_flow: column
              pad_row: 2
            widgets:
              - label:
                  id: lbl_hourly_hour4_header
                  text: "Hour +4"
                  text_font: montserrat_14
                  text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        id: lbl_hourly_hour4_icon
                        text: "\U000F14E4"
                        text_font: icons_40
                        text_color: my_white
                    - label:
                        id: lbl_hourly_hour4_temp
                        text: "--°"
                        text_font: montserrat_24
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Feels:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour4_feels
                        text: "--°"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Humid:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour4_humid
                        text: "--%"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Precip:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour4_precip
                        text: "--%"
                        text_font: montserrat_10
                        text_color: my_teal
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Amt:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour4_precip_amt
                        text: "-- in"
                        text_font: montserrat_10
                        text_color: my_teal
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Pressure:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour4_pressure
                        text: "-- mb"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "UV:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour4_uv
                        text: "--"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Wind:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour4_wind
                        text: "-- mph"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Direction:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour4_wind_dir
                        text: "--"
                        text_font: montserrat_10
                        text_color: my_white

        # Hour 5 Card
        - obj:
            width: 170
            height: SIZE_CONTENT
            align: TOP_MID
            y: 245
            bg_color: 0x101010
            bg_opa: COVER
            border_width: 0
            radius: 8
            pad_all: 6
            scrollbar_mode: "OFF"
            layout:
              type: flex
              flex_flow: column
              pad_row: 2
            widgets:
              - label:
                  id: lbl_hourly_hour5_header
                  text: "Hour +5"
                  text_font: montserrat_14
                  text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        id: lbl_hourly_hour5_icon
                        text: "\U000F14E4"
                        text_font: icons_40
                        text_color: my_white
                    - label:
                        id: lbl_hourly_hour5_temp
                        text: "--°"
                        text_font: montserrat_24
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Feels:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour5_feels
                        text: "--°"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Humid:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour5_humid
                        text: "--%"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Precip:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour5_precip
                        text: "--%"
                        text_font: montserrat_10
                        text_color: my_teal
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Amt:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour5_precip_amt
                        text: "-- in"
                        text_font: montserrat_10
                        text_color: my_teal
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Pressure:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour5_pressure
                        text: "-- mb"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "UV:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour5_uv
                        text: "--"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Wind:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour5_wind
                        text: "-- mph"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Direction:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour5_wind_dir
                        text: "--"
                        text_font: montserrat_10
                        text_color: my_white

        # Hour 6 Card
        - obj:
            width: 170
            height: SIZE_CONTENT
            align: TOP_MID
            y: 455
            bg_color: 0x101010
            bg_opa: COVER
            border_width: 0
            radius: 8
            pad_all: 6
            scrollbar_mode: "OFF"
            layout:
              type: flex
              flex_flow: column
              pad_row: 2
            widgets:
              - label:
                  id: lbl_hourly_hour6_header
                  text: "Hour +6"
                  text_font: montserrat_14
                  text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        id: lbl_hourly_hour6_icon
                        text: "\U000F14E4"
                        text_font: icons_40
                        text_color: my_white
                    - label:
                        id: lbl_hourly_hour6_temp
                        text: "--°"
                        text_font: montserrat_24
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Feels:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour6_feels
                        text: "--°"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Humid:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour6_humid
                        text: "--%"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Precip:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour6_precip
                        text: "--%"
                        text_font: montserrat_10
                        text_color: my_teal
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Amt:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour6_precip_amt
                        text: "-- in"
                        text_font: montserrat_10
                        text_color: my_teal
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Pressure:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour6_pressure
                        text: "-- mb"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "UV:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour6_uv
                        text: "--"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Wind:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour6_wind
                        text: "-- mph"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Direction:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour6_wind_dir
                        text: "--"
                        text_font: montserrat_10
                        text_color: my_white

        # Center navigation button - click to go back to hours 1-3
        - obj:
            id: nav_button_hourly_page2_center
            align: CENTER
            width: 150
            height: 150
            bg_opa: 0
            border_width: 0
            clickable: true
            on_release:
              - logger.log: "Hourly page 2 CENTER button RELEASED - going to page 3!"
              - lambda: |-
                  ESP_LOGI("touch", "Navigation button touched");
                  id(last_auto_rotation_time) = millis();
                  ESP_LOGD("touch", "Auto-rotation timer reset");
              - lvgl.page.show:
                  id: hourly_forecast_page_3
                  animation: OUT_LEFT
                  time: 300ms

        # Top-right navigation button - normal page rotation
        - obj:
            id: nav_button_hourly_page2
            align: TOP_RIGHT
            x: 0
            y: 0
            width: 180
            height: 150
            bg_opa: 0
            border_width: 0
            clickable: true
            on_release:
              - logger.log: "Hourly Forecast page 2 nav button RELEASED!"
              - lambda: |-
                  ESP_LOGI("touch", "Navigation button touched");
                  id(last_auto_rotation_time) = millis();
                  ESP_LOGD("touch", "Auto-rotation timer reset");
              - lvgl.page.next:
                  animation: OUT_LEFT
                  time: 300ms

    - id: hourly_forecast_page_3
      skip: true
      bg_color: 0x000000
      bg_opa: COVER
      scrollbar_mode: "OFF"
      on_load:
        - script.execute: page_transition_cleanup
        - lambda: 'id(current_page_name) = "hourly_forecast";'
        - delay: 10ms
        - if:
            condition:
              lambda: |-
                uint32_t time_since_update = millis() - id(weather_hourly_last_update);
                bool is_stale = (id(weather_hourly_last_update) == 0 || time_since_update > 900000);
                return is_stale;
            then:
              - script.execute: fetch_hourly_forecast
            else:
              - delay: 50ms
              - script.execute: update_hourly_page_3  # Lazy loading: only update hours 7-9
      widgets:
        - label:
            text: "6-Hour Forecast"
            align: TOP_MID
            y: 5
            text_font: montserrat_18
            text_color: my_white
            text_align: CENTER

        # Hour 7 Card
        - obj:
            width: 170
            height: SIZE_CONTENT
            align: TOP_MID
            y: 35
            bg_color: 0x101010
            bg_opa: COVER
            border_width: 0
            radius: 8
            pad_all: 6
            scrollbar_mode: "OFF"
            layout:
              type: flex
              flex_flow: column
              pad_row: 2
            widgets:
              - label:
                  id: lbl_hourly_hour7_header
                  text: "Hour +7"
                  text_font: montserrat_14
                  text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        id: lbl_hourly_hour7_icon
                        text: "\U000F14E4"
                        text_font: icons_40
                        text_color: my_white
                    - label:
                        id: lbl_hourly_hour7_temp
                        text: "--°"
                        text_font: montserrat_24
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Feels:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour7_feels
                        text: "--°"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Humid:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour7_humid
                        text: "--%"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Precip:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour7_precip
                        text: "--%"
                        text_font: montserrat_10
                        text_color: my_teal
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Amt:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour7_precip_amt
                        text: "-- in"
                        text_font: montserrat_10
                        text_color: my_teal
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Pressure:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour7_pressure
                        text: "-- mb"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "UV:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour7_uv
                        text: "--"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Wind:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour7_wind
                        text: "-- mph"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Dir:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour7_wind_dir
                        text: "--"
                        text_font: montserrat_10
                        text_color: my_white

        # Hour 8 Card
        - obj:
            width: 170
            height: SIZE_CONTENT
            align: TOP_MID
            y: 245
            bg_color: 0x101010
            bg_opa: COVER
            border_width: 0
            radius: 8
            pad_all: 6
            scrollbar_mode: "OFF"
            layout:
              type: flex
              flex_flow: column
              pad_row: 2
            widgets:
              - label:
                  id: lbl_hourly_hour8_header
                  text: "Hour +8"
                  text_font: montserrat_14
                  text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        id: lbl_hourly_hour8_icon
                        text: "\U000F14E4"
                        text_font: icons_40
                        text_color: my_white
                    - label:
                        id: lbl_hourly_hour8_temp
                        text: "--°"
                        text_font: montserrat_24
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Feels:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour8_feels
                        text: "--°"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Humid:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour8_humid
                        text: "--%"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Precip:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour8_precip
                        text: "--%"
                        text_font: montserrat_10
                        text_color: my_teal
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Amt:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour8_precip_amt
                        text: "-- in"
                        text_font: montserrat_10
                        text_color: my_teal
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Pressure:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour8_pressure
                        text: "-- mb"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "UV:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour8_uv
                        text: "--"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Wind:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour8_wind
                        text: "-- mph"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Dir:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour8_wind_dir
                        text: "--"
                        text_font: montserrat_10
                        text_color: my_white

        # Hour 9 Card
        - obj:
            width: 170
            height: SIZE_CONTENT
            align: TOP_MID
            y: 455
            bg_color: 0x101010
            bg_opa: COVER
            border_width: 0
            radius: 8
            pad_all: 6
            scrollbar_mode: "OFF"
            layout:
              type: flex
              flex_flow: column
              pad_row: 2
            widgets:
              - label:
                  id: lbl_hourly_hour9_header
                  text: "Hour +9"
                  text_font: montserrat_14
                  text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        id: lbl_hourly_hour9_icon
                        text: "\U000F14E4"
                        text_font: icons_40
                        text_color: my_white
                    - label:
                        id: lbl_hourly_hour9_temp
                        text: "--°"
                        text_font: montserrat_24
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Feels:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour9_feels
                        text: "--°"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Humid:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour9_humid
                        text: "--%"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Precip:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour9_precip
                        text: "--%"
                        text_font: montserrat_10
                        text_color: my_teal
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Amt:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour9_precip_amt
                        text: "-- in"
                        text_font: montserrat_10
                        text_color: my_teal
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Pressure:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour9_pressure
                        text: "-- mb"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "UV:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour9_uv
                        text: "--"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Wind:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour9_wind
                        text: "-- mph"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Dir:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour9_wind_dir
                        text: "--"
                        text_font: montserrat_10
                        text_color: my_white

        # Center nav to page 4
        - obj:
            id: nav_button_hourly_page3_center
            align: CENTER
            width: 150
            height: 150
            bg_opa: 0
            border_width: 0
            clickable: true
            on_release:
              - logger.log: "Hourly page 3 CENTER button RELEASED - going to page 4!"
              - lambda: |-
                  id(last_auto_rotation_time) = millis();
              - lvgl.page.show:
                  id: hourly_forecast_page_4
                  animation: OUT_LEFT
                  time: 300ms

        # Top-right nav back/next
        - obj:
            id: nav_button_hourly_page3
            align: TOP_RIGHT
            x: 0
            y: 0
            width: 180
            height: 150
            bg_opa: 0
            border_width: 0
            clickable: true
            on_release:
              - logger.log: "Hourly Forecast page 3 nav button RELEASED!"
              - lambda: |-
                  id(last_auto_rotation_time) = millis();
              - lvgl.page.next:
                  animation: OUT_LEFT
                  time: 300ms

    - id: hourly_forecast_page_4
      skip: true
      bg_color: 0x000000
      bg_opa: COVER
      scrollbar_mode: "OFF"
      on_load:
        - script.execute: page_transition_cleanup
        - lambda: 'id(current_page_name) = "hourly_forecast";'
        - delay: 10ms
        - if:
            condition:
              lambda: |-
                uint32_t time_since_update = millis() - id(weather_hourly_last_update);
                bool is_stale = (id(weather_hourly_last_update) == 0 || time_since_update > 900000);
                return is_stale;
            then:
              - script.execute: fetch_hourly_forecast
            else:
              - delay: 50ms
              - script.execute: update_hourly_page_4  # Lazy loading: only update hours 10-12
      widgets:
        - label:
            text: "6-Hour Forecast"
            align: TOP_MID
            y: 5
            text_font: montserrat_18
            text_color: my_white
            text_align: CENTER
        # Hour 10 Card (index 9)
        - obj:
            width: 170
            height: SIZE_CONTENT
            align: TOP_MID
            y: 35
            bg_color: 0x101010
            bg_opa: COVER
            border_width: 0
            radius: 8
            pad_all: 6
            scrollbar_mode: "OFF"
            layout:
              type: flex
              flex_flow: column
              pad_row: 2
            widgets:
              - label:
                  id: lbl_hourly_hour10_header
                  text: "Hour +10"
                  text_font: montserrat_14
                  text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        id: lbl_hourly_hour10_icon
                        text: "\U000F14E4"
                        text_font: icons_40
                        text_color: my_white
                    - label:
                        id: lbl_hourly_hour10_temp
                        text: "--°"
                        text_font: montserrat_24
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Feels:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour10_feels
                        text: "--°"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Humid:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour10_humid
                        text: "--%"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Precip:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour10_precip
                        text: "--%"
                        text_font: montserrat_10
                        text_color: my_teal
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Amt:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour10_precip_amt
                        text: "-- in"
                        text_font: montserrat_10
                        text_color: my_teal
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Pressure:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour10_pressure
                        text: "-- mb"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "UV:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour10_uv
                        text: "--"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Wind:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour10_wind
                        text: "-- mph"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Dir:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour10_wind_dir
                        text: "--"
                        text_font: montserrat_10
                        text_color: my_white

        # Hour 11 Card (index 10)
        - obj:
            width: 170
            height: SIZE_CONTENT
            align: TOP_MID
            y: 245
            bg_color: 0x101010
            bg_opa: COVER
            border_width: 0
            radius: 8
            pad_all: 6
            scrollbar_mode: "OFF"
            layout:
              type: flex
              flex_flow: column
              pad_row: 2
            widgets:
              - label:
                  id: lbl_hourly_hour11_header
                  text: "Hour +11"
                  text_font: montserrat_14
                  text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        id: lbl_hourly_hour11_icon
                        text: "\U000F14E4"
                        text_font: icons_40
                        text_color: my_white
                    - label:
                        id: lbl_hourly_hour11_temp
                        text: "--°"
                        text_font: montserrat_24
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Feels:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour11_feels
                        text: "--°"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Humid:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour11_humid
                        text: "--%"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Precip:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour11_precip
                        text: "--%"
                        text_font: montserrat_10
                        text_color: my_teal
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Amt:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour11_precip_amt
                        text: "-- in"
                        text_font: montserrat_10
                        text_color: my_teal
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Pressure:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour11_pressure
                        text: "-- mb"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "UV:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour11_uv
                        text: "--"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Wind:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour11_wind
                        text: "-- mph"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Dir:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour11_wind_dir
                        text: "--"
                        text_font: montserrat_10
                        text_color: my_white

        # Hour 12 Card (index 11)
        - obj:
            width: 170
            height: SIZE_CONTENT
            align: TOP_MID
            y: 455
            bg_color: 0x101010
            bg_opa: COVER
            border_width: 0
            radius: 8
            pad_all: 6
            scrollbar_mode: "OFF"
            layout:
              type: flex
              flex_flow: column
              pad_row: 2
            widgets:
              - label:
                  id: lbl_hourly_hour12_header
                  text: "Hour +12"
                  text_font: montserrat_14
                  text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        id: lbl_hourly_hour12_icon
                        text: "\U000F14E4"
                        text_font: icons_40
                        text_color: my_white
                    - label:
                        id: lbl_hourly_hour12_temp
                        text: "--°"
                        text_font: montserrat_24
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Feels:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour12_feels
                        text: "--°"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Humid:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour12_humid
                        text: "--%"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Precip:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour12_precip
                        text: "--%"
                        text_font: montserrat_10
                        text_color: my_teal
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Amt:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour12_precip_amt
                        text: "-- in"
                        text_font: montserrat_10
                        text_color: my_teal
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Pressure:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour12_pressure
                        text: "-- mb"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "UV:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour12_uv
                        text: "--"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Wind:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour12_wind
                        text: "-- mph"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Dir:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour12_wind_dir
                        text: "--"
                        text_font: montserrat_10
                        text_color: my_white

        # Center navigation button - click to go to page 5
        - obj:
            id: nav_button_hourly_page4_center
            align: CENTER
            width: 150
            height: 150
            bg_opa: 0
            border_width: 0
            clickable: true
            on_release:
              - logger.log: "Hourly page 4 CENTER button RELEASED - going to page 5!"
              - lambda: |-
                  id(last_auto_rotation_time) = millis();
              - lvgl.page.show:
                  id: hourly_forecast_page_5
                  animation: OUT_LEFT
                  time: 300ms

        # Top-right navigation button - normal page rotation
        - obj:
            id: nav_button_hourly_page4
            align: TOP_RIGHT
            x: 0
            y: 0
            width: 180
            height: 150
            bg_opa: 0
            border_width: 0
            clickable: true
            on_release:
              - logger.log: "Hourly Forecast page 4 nav button RELEASED!"
              - lambda: |-
                  id(last_auto_rotation_time) = millis();
              - lvgl.page.next:
                  animation: OUT_LEFT
                  time: 300ms
  
    - id: hourly_forecast_page_5
      skip: true
      bg_color: 0x000000
      bg_opa: COVER
      scrollbar_mode: "OFF"
      on_load:
        - script.execute: page_transition_cleanup
        - lambda: 'id(current_page_name) = "hourly_forecast";'
        - delay: 10ms
        - if:
            condition:
              lambda: |-
                uint32_t time_since_update = millis() - id(weather_hourly_last_update);
                bool is_stale = (id(weather_hourly_last_update) == 0 || time_since_update > 900000);
                return is_stale;
            then:
              - script.execute: fetch_hourly_forecast
            else:
              - delay: 50ms
              - script.execute: update_hourly_page_5  # Lazy loading: only update hours 13-15
      widgets:
        - label:
            text: "6-Hour Forecast"
            align: TOP_MID
            y: 5
            text_font: montserrat_18
            text_color: my_white
            text_align: CENTER
        # Hour 13 card
        - obj:
            width: 170
            height: SIZE_CONTENT
            align: TOP_MID
            y: 35
            bg_color: 0x101010
            bg_opa: COVER
            border_width: 0
            radius: 8
            pad_all: 6
            scrollbar_mode: "OFF"
            layout:
              type: flex
              flex_flow: column
              pad_row: 2
            widgets:
              - label:
                  id: lbl_hourly_hour13_header
                  text: "Hour +13"
                  text_font: montserrat_14
                  text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        id: lbl_hourly_hour13_icon
                        text: "\U000F14E4"
                        text_font: icons_40
                        text_color: my_white
                    - label:
                        id: lbl_hourly_hour13_temp
                        text: "--°"
                        text_font: montserrat_24
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Feels:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour13_feels
                        text: "--°"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Humid:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour13_humid
                        text: "--%"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Precip:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour13_precip
                        text: "--%"
                        text_font: montserrat_10
                        text_color: my_teal
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Amt:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour13_precip_amt
                        text: "-- in"
                        text_font: montserrat_10
                        text_color: my_teal
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Pressure:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour13_pressure
                        text: "-- mb"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "UV:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour13_uv
                        text: "--"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Wind:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour13_wind
                        text: "-- mph"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Dir:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour13_wind_dir
                        text: "--"
                        text_font: montserrat_10
                        text_color: my_white

        # Hour 14 Card (index 13)
        - obj:
            width: 170
            height: SIZE_CONTENT
            align: TOP_MID
            y: 245
            bg_color: 0x101010
            bg_opa: COVER
            border_width: 0
            radius: 8
            pad_all: 6
            scrollbar_mode: "OFF"
            layout:
              type: flex
              flex_flow: column
              pad_row: 2
            widgets:
              - label:
                  id: lbl_hourly_hour14_header
                  text: "Hour +14"
                  text_font: montserrat_14
                  text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        id: lbl_hourly_hour14_icon
                        text: "\U000F14E4"
                        text_font: icons_40
                        text_color: my_white
                    - label:
                        id: lbl_hourly_hour14_temp
                        text: "--°"
                        text_font: montserrat_24
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Feels:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour14_feels
                        text: "--°"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Humid:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour14_humid
                        text: "--%"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Precip:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour14_precip
                        text: "--%"
                        text_font: montserrat_10
                        text_color: my_teal
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Amt:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour14_precip_amt
                        text: "-- in"
                        text_font: montserrat_10
                        text_color: my_teal
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Pressure:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour14_pressure
                        text: "-- mb"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "UV:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour14_uv
                        text: "--"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Wind:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour14_wind
                        text: "-- mph"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Dir:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour14_wind_dir
                        text: "--"
                        text_font: montserrat_10
                        text_color: my_white

        # Hour 15 Card (index 14)
        - obj:
            width: 170
            height: SIZE_CONTENT
            align: TOP_MID
            y: 455
            bg_color: 0x101010
            bg_opa: COVER
            border_width: 0
            radius: 8
            pad_all: 6
            scrollbar_mode: "OFF"
            layout:
              type: flex
              flex_flow: column
              pad_row: 2
            widgets:
              - label:
                  id: lbl_hourly_hour15_header
                  text: "Hour +15"
                  text_font: montserrat_14
                  text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        id: lbl_hourly_hour15_icon
                        text: "\U000F14E4"
                        text_font: icons_40
                        text_color: my_white
                    - label:
                        id: lbl_hourly_hour15_temp
                        text: "--°"
                        text_font: montserrat_24
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Feels:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour15_feels
                        text: "--°"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Humid:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour15_humid
                        text: "--%"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Precip:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour15_precip
                        text: "--%"
                        text_font: montserrat_10
                        text_color: my_teal
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Amt:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour15_precip_amt
                        text: "-- in"
                        text_font: montserrat_10
                        text_color: my_teal
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Pressure:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour15_pressure
                        text: "-- mb"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "UV:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour15_uv
                        text: "--"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Wind:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour15_wind
                        text: "-- mph"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Dir:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour15_wind_dir
                        text: "--"
                        text_font: montserrat_10
                        text_color: my_white

        # Center navigation button - click to go to page 6
        - obj:
            id: nav_button_hourly_page5_center
            align: CENTER
            width: 150
            height: 150
            bg_opa: 0
            border_width: 0
            clickable: true
            on_release:
              - logger.log: "Hourly page 5 CENTER button RELEASED - going to page 6!"
              - lambda: |-
                  id(last_auto_rotation_time) = millis();
              - lvgl.page.show:
                  id: hourly_forecast_page_6
                  animation: OUT_LEFT
                  time: 300ms

        # Top-right navigation button - normal page rotation
        - obj:
            id: nav_button_hourly_page5
            align: TOP_RIGHT
            x: 0
            y: 0
            width: 180
            height: 150
            bg_opa: 0
            border_width: 0
            clickable: true
            on_release:
              - logger.log: "Hourly Forecast page 5 nav button RELEASED!"
              - lambda: |-
                  id(last_auto_rotation_time) = millis();
              - lvgl.page.next:
                  animation: OUT_LEFT
                  time: 300ms

    - id: hourly_forecast_page_6
      skip: true
      bg_color: 0x000000
      bg_opa: COVER
      scrollbar_mode: "OFF"
      on_load:
        - script.execute: page_transition_cleanup
        - lambda: 'id(current_page_name) = "hourly_forecast";'
        - delay: 10ms
        - if:
            condition:
              lambda: |-
                uint32_t time_since_update = millis() - id(weather_hourly_last_update);
                bool is_stale = (id(weather_hourly_last_update) == 0 || time_since_update > 900000);
                return is_stale;
            then:
              - script.execute: fetch_hourly_forecast
            else:
              - delay: 50ms
              - script.execute: update_hourly_page_6  # Lazy loading: only update hours 16-24
      widgets:
        - label:
            text: "6-Hour Forecast"
            align: TOP_MID
            y: 5
            text_font: montserrat_18
            text_color: my_white
            text_align: CENTER

        # Hour 16 Card (index 15)
        - obj:
            width: 170
            height: SIZE_CONTENT
            align: TOP_MID
            y: 35
            bg_color: 0x101010
            bg_opa: COVER
            border_width: 0
            radius: 8
            pad_all: 6
            scrollbar_mode: "OFF"
            layout:
              type: flex
              flex_flow: column
              pad_row: 2
            widgets:
              - label:
                  id: lbl_hourly_hour16_header
                  text: "Hour +16"
                  text_font: montserrat_14
                  text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        id: lbl_hourly_hour16_icon
                        text: "\U000F14E4"
                        text_font: icons_40
                        text_color: my_white
                    - label:
                        id: lbl_hourly_hour16_temp
                        text: "--°"
                        text_font: montserrat_24
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Feels:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour16_feels
                        text: "--°"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Humid:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour16_humid
                        text: "--%"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Precip:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour16_precip
                        text: "--%"
                        text_font: montserrat_10
                        text_color: my_teal
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Amt:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour16_precip_amt
                        text: "-- in"
                        text_font: montserrat_10
                        text_color: my_teal
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Pressure:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour16_pressure
                        text: "-- mb"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "UV:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour16_uv
                        text: "--"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Wind:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour16_wind
                        text: "-- mph"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Dir:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour16_wind_dir
                        text: "--"
                        text_font: montserrat_10
                        text_color: my_white

        # Hour 17 Card (index 16)
        - obj:
            width: 170
            height: SIZE_CONTENT
            align: TOP_MID
            y: 245
            bg_color: 0x101010
            bg_opa: COVER
            border_width: 0
            radius: 8
            pad_all: 6
            scrollbar_mode: "OFF"
            layout:
              type: flex
              flex_flow: column
              pad_row: 2
            widgets:
              - label:
                  id: lbl_hourly_hour17_header
                  text: "Hour +17"
                  text_font: montserrat_14
                  text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        id: lbl_hourly_hour17_icon
                        text: "\U000F14E4"
                        text_font: icons_40
                        text_color: my_white
                    - label:
                        id: lbl_hourly_hour17_temp
                        text: "--°"
                        text_font: montserrat_24
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Feels:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour17_feels
                        text: "--°"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Humid:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour17_humid
                        text: "--%"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Precip:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour17_precip
                        text: "--%"
                        text_font: montserrat_10
                        text_color: my_teal
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Amt:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour17_precip_amt
                        text: "-- in"
                        text_font: montserrat_10
                        text_color: my_teal
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Pressure:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour17_pressure
                        text: "-- mb"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "UV:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour17_uv
                        text: "--"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Wind:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour17_wind
                        text: "-- mph"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Dir:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour17_wind_dir
                        text: "--"
                        text_font: montserrat_10
                        text_color: my_white

        # Hour 18 Card (index 17)
        - obj:
            width: 170
            height: SIZE_CONTENT
            align: TOP_MID
            y: 455
            bg_color: 0x101010
            bg_opa: COVER
            border_width: 0
            radius: 8
            pad_all: 6
            scrollbar_mode: "OFF"
            layout:
              type: flex
              flex_flow: column
              pad_row: 2
            widgets:
              - label:
                  id: lbl_hourly_hour18_header
                  text: "Hour +18"
                  text_font: montserrat_14
                  text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        id: lbl_hourly_hour18_icon
                        text: "\U000F14E4"
                        text_font: icons_40
                        text_color: my_white
                    - label:
                        id: lbl_hourly_hour18_temp
                        text: "--°"
                        text_font: montserrat_24
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Feels:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour18_feels
                        text: "--°"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Humid:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour18_humid
                        text: "--%"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Precip:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour18_precip
                        text: "--%"
                        text_font: montserrat_10
                        text_color: my_teal
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Amt:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour18_precip_amt
                        text: "-- in"
                        text_font: montserrat_10
                        text_color: my_teal
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Pressure:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour18_pressure
                        text: "-- mb"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "UV:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour18_uv
                        text: "--"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Wind:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour18_wind
                        text: "-- mph"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Dir:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour18_wind_dir
                        text: "--"
                        text_font: montserrat_10
                        text_color: my_white
        

        # Center navigation button - click to go to page 7
        - obj:
            id: nav_button_hourly_page6_center
            align: CENTER
            width: 150
            height: 150
            bg_opa: 0
            border_width: 0
            clickable: true
            on_release:
              - logger.log: "Hourly page 6 CENTER button RELEASED - going to page 7!"
              - lambda: |-
                  id(last_auto_rotation_time) = millis();
              - lvgl.page.show:
                  id: hourly_forecast_page_7
                  animation: OUT_LEFT
                  time: 300ms

        # Top-right navigation button - normal page rotation
        - obj:
            id: nav_button_hourly_page6
            align: TOP_RIGHT
            x: 0
            y: 0
            width: 180
            height: 150
            bg_opa: 0
            border_width: 0
            clickable: true
            on_release:
              - logger.log: "Hourly Forecast page 6 nav button RELEASED!"
              - lambda: |-
                  id(last_auto_rotation_time) = millis();
              - lvgl.page.next:
                  animation: OUT_LEFT
                  time: 300ms


    - id: hourly_forecast_page_7
      skip: true
      bg_color: 0x000000
      bg_opa: COVER
      scrollbar_mode: "OFF"
      on_load:
        - script.execute: page_transition_cleanup
        - lambda: 'id(current_page_name) = "hourly_forecast";'
        - delay: 10ms
        - if:
            condition:
              lambda: |-
                uint32_t time_since_update = millis() - id(weather_hourly_last_update);
                bool is_stale = (id(weather_hourly_last_update) == 0 || time_since_update > 900000);
                return is_stale;
            then:
              - script.execute: fetch_hourly_forecast
            else:
              - delay: 50ms
              - script.execute: update_hourly_page_7  # Lazy loading: only update hours 19-21
      widgets:
        - label:
            text: "6-Hour Forecast"
            align: TOP_MID
            y: 5
            text_font: montserrat_18
            text_color: my_white
            text_align: CENTER

        # Hour 19 Card (index 18)
        - obj:
            width: 170
            height: SIZE_CONTENT
            align: TOP_MID
            y: 35
            bg_color: 0x101010
            bg_opa: COVER
            border_width: 0
            radius: 8
            pad_all: 6
            scrollbar_mode: "OFF"
            layout:
              type: flex
              flex_flow: column
              pad_row: 2
            widgets:
              - label:
                  id: lbl_hourly_hour19_header
                  text: "Hour +19"
                  text_font: montserrat_14
                  text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        id: lbl_hourly_hour19_icon
                        text: "\U000F14E4"
                        text_font: icons_40
                        text_color: my_white
                    - label:
                        id: lbl_hourly_hour19_temp
                        text: "--°"
                        text_font: montserrat_24
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Feels:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour19_feels
                        text: "--°"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Humid:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour19_humid
                        text: "--%"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Precip:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour19_precip
                        text: "--%"
                        text_font: montserrat_10
                        text_color: my_teal
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Amt:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour19_precip_amt
                        text: "-- in"
                        text_font: montserrat_10
                        text_color: my_teal
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Pressure:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour19_pressure
                        text: "-- mb"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "UV:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour19_uv
                        text: "--"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Wind:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour19_wind
                        text: "-- mph"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Dir:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour19_wind_dir
                        text: "--"
                        text_font: montserrat_10
                        text_color: my_white

        # Hour 20 Card (index 19)
        - obj:
            width: 170
            height: SIZE_CONTENT
            align: TOP_MID
            y: 245
            bg_color: 0x101010
            bg_opa: COVER
            border_width: 0
            radius: 8
            pad_all: 6
            scrollbar_mode: "OFF"
            layout:
              type: flex
              flex_flow: column
              pad_row: 2
            widgets:
              - label:
                  id: lbl_hourly_hour20_header
                  text: "Hour +20"
                  text_font: montserrat_14
                  text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        id: lbl_hourly_hour20_icon
                        text: "\U000F14E4"
                        text_font: icons_40
                        text_color: my_white
                    - label:
                        id: lbl_hourly_hour20_temp
                        text: "--°"
                        text_font: montserrat_24
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Feels:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour20_feels
                        text: "--°"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Humid:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour20_humid
                        text: "--%"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Precip:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour20_precip
                        text: "--%"
                        text_font: montserrat_10
                        text_color: my_teal
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Amt:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour20_precip_amt
                        text: "-- in"
                        text_font: montserrat_10
                        text_color: my_teal
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Pressure:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour20_pressure
                        text: "-- mb"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "UV:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour20_uv
                        text: "--"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Wind:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour20_wind
                        text: "-- mph"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Dir:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour20_wind_dir
                        text: "--"
                        text_font: montserrat_10
                        text_color: my_white

        # Hour 21 Card (index 20)
        - obj:
            width: 170
            height: SIZE_CONTENT
            align: TOP_MID
            y: 455
            bg_color: 0x101010
            bg_opa: COVER
            border_width: 0
            radius: 8
            pad_all: 6
            scrollbar_mode: "OFF"
            layout:
              type: flex
              flex_flow: column
              pad_row: 2
            widgets:
              - label:
                  id: lbl_hourly_hour21_header
                  text: "Hour +21"
                  text_font: montserrat_14
                  text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        id: lbl_hourly_hour21_icon
                        text: "\U000F14E4"
                        text_font: icons_40
                        text_color: my_white
                    - label:
                        id: lbl_hourly_hour21_temp
                        text: "--°"
                        text_font: montserrat_24
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Feels:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour21_feels
                        text: "--°"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Humid:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour21_humid
                        text: "--%"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Precip:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour21_precip
                        text: "--%"
                        text_font: montserrat_10
                        text_color: my_teal
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Amt:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour21_precip_amt
                        text: "-- in"
                        text_font: montserrat_10
                        text_color: my_teal
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Pressure:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour21_pressure
                        text: "-- mb"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "UV:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour21_uv
                        text: "--"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Wind:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour21_wind
                        text: "-- mph"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Dir:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour21_wind_dir
                        text: "--"
                        text_font: montserrat_10
                        text_color: my_white


        # Center navigation button - click to go to page 8
        - obj:
            id: nav_button_hourly_page7_center
            align: CENTER
            width: 150
            height: 150
            bg_opa: 0
            border_width: 0
            clickable: true
            on_release:
              - logger.log: "Hourly page 7 CENTER button RELEASED - going to page 8!"
              - lambda: |-
                  id(last_auto_rotation_time) = millis();
              - lvgl.page.show:
                  id: hourly_forecast_page_8
                  animation: OUT_LEFT
                  time: 300ms

        # Top-right navigation button - normal page rotation
        - obj:
            id: nav_button_hourly_page7
            align: TOP_RIGHT
            x: 0
            y: 0
            width: 180
            height: 150
            bg_opa: 0
            border_width: 0
            clickable: true
            on_release:
              - logger.log: "Hourly Forecast page 7 nav button RELEASED!"
              - lambda: |-
                  id(last_auto_rotation_time) = millis();
              - lvgl.page.next:
                  animation: OUT_LEFT
                  time: 300ms


    - id: hourly_forecast_page_8
      skip: true
      bg_color: 0x000000
      bg_opa: COVER
      scrollbar_mode: "OFF"
      on_load:
        - script.execute: page_transition_cleanup
        - lambda: 'id(current_page_name) = "hourly_forecast";'
        - delay: 10ms
        - if:
            condition:
              lambda: |-
                uint32_t time_since_update = millis() - id(weather_hourly_last_update);
                bool is_stale = (id(weather_hourly_last_update) == 0 || time_since_update > 900000);
                return is_stale;
            then:
              - script.execute: fetch_hourly_forecast
            else:
              - delay: 50ms
              - script.execute: update_hourly_page_8  # Lazy loading: only update hours 22-24
      widgets:
        - label:
            text: "6-Hour Forecast"
            align: TOP_MID
            y: 5
            text_font: montserrat_18
            text_color: my_white
            text_align: CENTER

        # Hour 22 Card (index 21)
        - obj:
            width: 170
            height: SIZE_CONTENT
            align: TOP_MID
            y: 35
            bg_color: 0x101010
            bg_opa: COVER
            border_width: 0
            radius: 8
            pad_all: 6
            scrollbar_mode: "OFF"
            layout:
              type: flex
              flex_flow: column
              pad_row: 2
            widgets:
              - label:
                  id: lbl_hourly_hour22_header
                  text: "Hour +22"
                  text_font: montserrat_14
                  text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        id: lbl_hourly_hour22_icon
                        text: "\U000F14E4"
                        text_font: icons_40
                        text_color: my_white
                    - label:
                        id: lbl_hourly_hour22_temp
                        text: "--°"
                        text_font: montserrat_24
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Feels:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour22_feels
                        text: "--°"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Humid:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour22_humid
                        text: "--%"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Precip:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour22_precip
                        text: "--%"
                        text_font: montserrat_10
                        text_color: my_teal
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Amt:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour22_precip_amt
                        text: "-- in"
                        text_font: montserrat_10
                        text_color: my_teal
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Pressure:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour22_pressure
                        text: "-- mb"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "UV:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour22_uv
                        text: "--"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Wind:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour22_wind
                        text: "-- mph"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Dir:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour22_wind_dir
                        text: "--"
                        text_font: montserrat_10
                        text_color: my_white

        # Hour 23 Card (index 22)
        - obj:
            width: 170
            height: SIZE_CONTENT
            align: TOP_MID
            y: 245
            bg_color: 0x101010
            bg_opa: COVER
            border_width: 0
            radius: 8
            pad_all: 6
            scrollbar_mode: "OFF"
            layout:
              type: flex
              flex_flow: column
              pad_row: 2
            widgets:
              - label:
                  id: lbl_hourly_hour23_header
                  text: "Hour +23"
                  text_font: montserrat_14
                  text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        id: lbl_hourly_hour23_icon
                        text: "\U000F14E4"
                        text_font: icons_40
                        text_color: my_white
                    - label:
                        id: lbl_hourly_hour23_temp
                        text: "--°"
                        text_font: montserrat_24
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Feels:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour23_feels
                        text: "--°"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Humid:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour23_humid
                        text: "--%"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Precip:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour23_precip
                        text: "--%"
                        text_font: montserrat_10
                        text_color: my_teal
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Amt:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour23_precip_amt
                        text: "-- in"
                        text_font: montserrat_10
                        text_color: my_teal
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Pressure:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour23_pressure
                        text: "-- mb"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "UV:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour23_uv
                        text: "--"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Wind:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour23_wind
                        text: "-- mph"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Dir:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour23_wind_dir
                        text: "--"
                        text_font: montserrat_10
                        text_color: my_white

        # Hour 24 Card (index 23)
        - obj:
            width: 170
            height: SIZE_CONTENT
            align: TOP_MID
            y: 455
            bg_color: 0x101010
            bg_opa: COVER
            border_width: 0
            radius: 8
            pad_all: 6
            scrollbar_mode: "OFF"
            layout:
              type: flex
              flex_flow: column
              pad_row: 2
            widgets:
              - label:
                  id: lbl_hourly_hour24_header
                  text: "Hour +24"
                  text_font: montserrat_14
                  text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        id: lbl_hourly_hour24_icon
                        text: "\U000F14E4"
                        text_font: icons_40
                        text_color: my_white
                    - label:
                        id: lbl_hourly_hour24_temp
                        text: "--°"
                        text_font: montserrat_24
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Feels:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour24_feels
                        text: "--°"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Humid:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour24_humid
                        text: "--%"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Precip:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour24_precip
                        text: "--%"
                        text_font: montserrat_10
                        text_color: my_teal
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Amt:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour24_precip_amt
                        text: "-- in"
                        text_font: montserrat_10
                        text_color: my_teal
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Pressure:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour24_pressure
                        text: "-- mb"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "UV:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour24_uv
                        text: "--"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Wind:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour24_wind
                        text: "-- mph"
                        text_font: montserrat_10
                        text_color: my_white
              - obj:
                  width: 100%
                  height: SIZE_CONTENT
                  bg_opa: 0
                  border_width: 0
                  pad_all: 0
                  layout:
                    type: flex
                    flex_flow: row
                    flex_align_main: SPACE_BETWEEN
                  widgets:
                    - label:
                        text: "Dir:"
                        text_font: montserrat_10
                        text_color: my_gray
                    - label:
                        id: lbl_hourly_hour24_wind_dir
                        text: "--"
                        text_font: montserrat_10
                        text_color: my_white


        # Center navigation button - click to go back to page 1
        - obj:
            id: nav_button_hourly_page8_center
            align: CENTER
            width: 150
            height: 150
            bg_opa: 0
            border_width: 0
            clickable: true
            on_release:
              - logger.log: "Hourly page 8 CENTER button RELEASED - going back to page 1!"
              - lambda: |-
                  id(last_auto_rotation_time) = millis();
              - lvgl.page.show:
                  id: hourly_forecast_page
                  animation: OUT_RIGHT
                  time: 300ms

        # Top-right navigation button - normal page rotation
        - obj:
            id: nav_button_hourly_page8
            align: TOP_RIGHT
            x: 0
            y: 0
            width: 180
            height: 150
            bg_opa: 0
            border_width: 0
            clickable: true
            on_release:
              - logger.log: "Hourly Forecast page 8 nav button RELEASED!"
              - lambda: |-
                  id(last_auto_rotation_time) = millis();
              - lvgl.page.next:
                  animation: OUT_LEFT
                  time: 300ms

    - id: daily_forecast_page
      bg_color: 0x000000
      bg_opa: COVER
      scrollbar_mode: "OFF"
      on_load:
        - script.execute: page_transition_cleanup
        - lambda: 'id(current_page_name) = "daily_forecast";'
        - delay: 100ms  # Increased delay to allow memory to stabilize after cleanup
        # Force garbage collection to free up memory before rendering
        - lambda: |-
            ESP_LOGI("memory", "Before daily forecast page load - Free heap: %d bytes", esp_get_free_heap_size());
        # Check if we have data and if it needs refresh
        - if:
            condition:
              lambda: |-
                // Check if daily forecast needs refresh (stale > 60 minutes)
                uint32_t time_since_update = millis() - id(weather_daily_last_update);
                bool is_stale = (id(weather_daily_last_update) == 0 || time_since_update > 3600000);
                
                if (is_stale) {
                  ESP_LOGI("weather", "Daily forecast is stale (age: %u minutes), fetching in background...",
                           id(weather_daily_last_update) == 0 ? 0 : time_since_update / 60000);
                  return true;
                } else {
                  ESP_LOGD("weather", "Daily forecast is fresh (updated %u minutes ago)", time_since_update / 60000);
                  return false;
                }
            then:
              # Fetch will update display when complete (no need to call update_daily_forecast_display here)
              - script.execute: fetch_daily_forecast
            else:
              # Data is fresh, update display with existing data
              - delay: 50ms  # Additional delay before rendering
              - script.execute: update_daily_forecast_display
      widgets:
        # Page Header
        - label:
            text: "9-Day Forecast"
            align: TOP_MID
            y: 5
            text_font: montserrat_18
            text_color: my_white
            text_align: CENTER

        # Day 2 Card
        - obj:
            width: 170
            height: SIZE_CONTENT
            align: TOP_MID
            y: 40
            bg_color: 0x101010
            bg_opa: COVER
            border_width: 0
            radius: 12
            pad_all: 12
            scrollbar_mode: "OFF"
            layout:
              type: flex
              flex_flow: column
              pad_row: 6
            widgets:
              - label:
                  id: lbl_forecast_day2_header
                  text: "Day +2 (--/--)"
                  text_font: montserrat_18
                  text_color: my_white
              - label:
                  id: lbl_forecast_day2_icon
                  text: "\U000F14E4"
                  text_font: icons_80
                  text_color: my_white
              - label:
                  id: lbl_forecast_day2_condition
                  text: "---"
                  text_font: montserrat_18
                  text_color: my_white
                  long_mode: SCROLL_CIRCULAR
              - label:
                  id: lbl_forecast_day2_temps
                  text: "H:--° L:--°"
                  text_font: montserrat_18
                  text_color: my_white
                  recolor: true
              - label:
                  id: lbl_forecast_day2_precip_prob
                  text: "Chance: --%"
                  text_font: montserrat_16
                  text_color: my_white

        # Day 3 Card
        - obj:
            width: 170
            height: SIZE_CONTENT
            align: TOP_MID
            y: 340
            bg_color: 0x101010
            bg_opa: COVER
            border_width: 0
            radius: 12
            pad_all: 12
            scrollbar_mode: "OFF"
            layout:
              type: flex
              flex_flow: column
              pad_row: 6
            widgets:
              - label:
                  id: lbl_forecast_day3_header
                  text: "Day +3 (--/--)"
                  text_font: montserrat_18
                  text_color: my_white
              - label:
                  id: lbl_forecast_day3_icon
                  text: "\U000F14E4"
                  text_font: icons_80
                  text_color: my_white
              - label:
                  id: lbl_forecast_day3_condition
                  text: "---"
                  text_font: montserrat_18
                  text_color: my_white
              - label:
                  id: lbl_forecast_day3_temps
                  text: "H:--° L:--°"
                  text_font: montserrat_18
                  text_color: my_white
                  recolor: true
              - label:
                  id: lbl_forecast_day3_precip_prob
                  text: "Chance: --%"
                  text_font: montserrat_16
                  text_color: my_white

        # Navigation button to access extended forecast (Days 4-10)
        - label:
            text: "More >"
            align: BOTTOM_MID
            y: -5
            text_font: montserrat_18
            text_color: my_gray
            text_align: CENTER

        - obj:
            id: nav_button_extended_forecast
            align: BOTTOM_MID
            x: 0
            y: 0
            width: 100
            height: 60
            bg_opa: 0
            border_width: 0
            clickable: true
            on_release:
              - logger.log: "Extended forecast 'More' button RELEASED!"
              - lvgl.page.show:
                  id: forecast_days_4_5_page
                  animation: OUT_LEFT
                  time: 300ms

        - obj:
            id: nav_button_forecast
            align: TOP_RIGHT
            x: 0
            y: 0
            width: 180
            height: 150
            bg_opa: 0
            border_width: 0
            clickable: true
            on_release:
              - logger.log: "3-Day Forecast page nav button RELEASED!"
              - lambda: |-
                  ESP_LOGI("touch", "Navigation button touched");
                  id(last_auto_rotation_time) = millis();
                  ESP_LOGD("touch", "Auto-rotation timer reset");
              - lvgl.page.next:
                  animation: OUT_LEFT
                  time: 300ms

    - id: forecast_days_4_5_page
      bg_color: 0x000000
      bg_opa: COVER
      scrollbar_mode: "OFF"
      skip: true
      on_load:
        - script.execute: page_transition_cleanup
      widgets:
        - label:
            text: "Extended Forecast"
            align: TOP_MID
            y: 5
            text_font: montserrat_18
            text_color: my_white
            text_align: CENTER

        # Day 4 Card
        - obj:
            width: 170
            height: SIZE_CONTENT
            align: TOP_MID
            y: 40
            bg_color: 0x101010
            bg_opa: COVER
            border_width: 0
            radius: 12
            pad_all: 12
            scrollbar_mode: "OFF"
            layout:
              type: flex
              flex_flow: column
              pad_row: 6
            widgets:
              - label:
                  id: lbl_forecast_day4_header
                  text: "Day +4 (--/--)"
                  text_font: montserrat_18
                  text_color: my_white
              - label:
                  id: lbl_forecast_day4_icon
                  text: "\U000F14E4"
                  text_font: icons_80
                  text_color: my_white
              - label:
                  id: lbl_forecast_day4_condition
                  text: "---"
                  text_font: montserrat_18
                  text_color: my_white
                  long_mode: SCROLL_CIRCULAR
              - label:
                  id: lbl_forecast_day4_temps
                  text: "H:--° L:--°"
                  text_font: montserrat_18
                  text_color: my_white
                  recolor: true
              - label:
                  id: lbl_forecast_day4_precip_prob
                  text: "Chance: --%"
                  text_font: montserrat_16
                  text_color: my_white

        # Day 5 Card
        - obj:
            width: 170
            height: SIZE_CONTENT
            align: TOP_MID
            y: 340
            bg_color: 0x101010
            bg_opa: COVER
            border_width: 0
            radius: 12
            pad_all: 12
            scrollbar_mode: "OFF"
            layout:
              type: flex
              flex_flow: column
              pad_row: 6
            widgets:
              - label:
                  id: lbl_forecast_day5_header
                  text: "Day +5 (--/--)"
                  text_font: montserrat_18
                  text_color: my_white
              - label:
                  id: lbl_forecast_day5_icon
                  text: "\U000F14E4"
                  text_font: icons_80
                  text_color: my_white
              - label:
                  id: lbl_forecast_day5_condition
                  text: "---"
                  text_font: montserrat_18
                  text_color: my_white
                  long_mode: SCROLL_CIRCULAR
              - label:
                  id: lbl_forecast_day5_temps
                  text: "H:--° L:--°"
                  text_font: montserrat_18
                  text_color: my_white
                  recolor: true
              - label:
                  id: lbl_forecast_day5_precip_prob
                  text: "Chance: --%"
                  text_font: montserrat_16
                  text_color: my_white

        # Top-right button for main page navigation
        - obj:
            id: nav_button_top_45
            align: TOP_RIGHT
            x: 0
            y: 0
            width: 180
            height: 150
            bg_opa: 0
            border_width: 0
            clickable: true
            on_release:
              - logger.log: "Days 4-5 top-right button RELEASED!"
              - lvgl.page.next:
                  animation: OUT_LEFT
                  time: 300ms

        - label:
            text: "More >"
            align: BOTTOM_MID
            y: -5
            text_font: montserrat_18
            text_color: my_gray
            text_align: CENTER

        # # Navigation button (center of screen) - must be LAST to render on top
        # - obj:
        #     id: nav_button_forecast_45
        #     align: CENTER
        #     x: 0
        #     y: 0
        #     width: 150
        #     height: 150
        #     bg_opa: 0
        #     border_width: 0
        #     clickable: true
        #     on_release:
        #       - logger.log: "Days 4-5 CENTER button RELEASED - going to 6-7!"
        #       - lvgl.page.show:
        #           id: forecast_days_6_7_page
        #           animation: OUT_LEFT
        #           time: 300ms

        # Navigation button (bottom of screen) - must be LAST to render on top
        - obj:
            id: nav_button_extended_forecast_45
            align: BOTTOM_MID
            x: 0
            y: 0
            width: 100
            height: 60
            bg_opa: 0
            border_width: 0
            clickable: true
            on_release:
              - logger.log: "Extended forecast 'More' button on 4-5 RELEASED! going to 6-7!"
              - lambda: |-
                  ESP_LOGI("touch", "Navigation button touched");
                  id(last_auto_rotation_time) = millis();
                  ESP_LOGD("touch", "Auto-rotation timer reset");
              - lvgl.page.show:
                  id: forecast_days_6_7_page
                  animation: OUT_LEFT
                  time: 300ms

    - id: forecast_days_6_7_page
      bg_color: 0x000000
      bg_opa: COVER
      scrollbar_mode: "OFF"
      skip: true
      on_load:
        - script.execute: page_transition_cleanup
      widgets:
        - label:
            text: "Extended Forecast"
            align: TOP_MID
            y: 5
            text_font: montserrat_18
            text_color: my_white
            text_align: CENTER

        # Day 6 Card
        - obj:
            width: 170
            height: SIZE_CONTENT
            align: TOP_MID
            y: 40
            bg_color: 0x101010
            bg_opa: COVER
            border_width: 0
            radius: 12
            pad_all: 12
            scrollbar_mode: "OFF"
            layout:
              type: flex
              flex_flow: column
              pad_row: 6
            widgets:
              - label:
                  id: lbl_forecast_day6_header
                  text: "Day +6 (--/--)"
                  text_font: montserrat_18
                  text_color: my_white
              - label:
                  id: lbl_forecast_day6_icon
                  text: "\U000F14E4"
                  text_font: icons_80
                  text_color: my_white
              - label:
                  id: lbl_forecast_day6_condition
                  text: "---"
                  text_font: montserrat_18
                  text_color: my_white
                  long_mode: SCROLL_CIRCULAR
              - label:
                  id: lbl_forecast_day6_temps
                  text: "H:--° L:--°"
                  text_font: montserrat_18
                  text_color: my_white
                  recolor: true
              - label:
                  id: lbl_forecast_day6_precip_prob
                  text: "Chance: --%"
                  text_font: montserrat_16
                  text_color: my_white

        # Day 7 Card
        - obj:
            width: 170
            height: SIZE_CONTENT
            align: TOP_MID
            y: 340
            bg_color: 0x101010
            bg_opa: COVER
            border_width: 0
            radius: 12
            pad_all: 12
            scrollbar_mode: "OFF"
            layout:
              type: flex
              flex_flow: column
              pad_row: 6
            widgets:
              - label:
                  id: lbl_forecast_day7_header
                  text: "Day +7 (--/--)"
                  text_font: montserrat_18
                  text_color: my_white
              - label:
                  id: lbl_forecast_day7_icon
                  text: "\U000F14E4"
                  text_font: icons_80
                  text_color: my_white
              - label:
                  id: lbl_forecast_day7_condition
                  text: "---"
                  text_font: montserrat_18
                  text_color: my_white
                  long_mode: SCROLL_CIRCULAR
              - label:
                  id: lbl_forecast_day7_temps
                  text: "H:--° L:--°"
                  text_font: montserrat_18
                  text_color: my_white
                  recolor: true
              - label:
                  id: lbl_forecast_day7_precip_prob
                  text: "Chance: --%"
                  text_font: montserrat_16
                  text_color: my_white

        # Top-right button for main page navigation
        - obj:
            id: nav_button_top_67
            align: TOP_RIGHT
            x: 0
            y: 0
            width: 180
            height: 150
            bg_opa: 0
            border_width: 0
            clickable: true
            on_release:
              - logger.log: "Days 6-7 top-right button RELEASED!"
              - lvgl.page.next:
                  animation: OUT_LEFT
                  time: 300ms

        - label:
            text: "More >"
            align: BOTTOM_MID
            y: -5
            text_font: montserrat_18
            text_color: my_gray
            text_align: CENTER

        # # Navigation button (center of screen) - must be LAST to render on top
        # - obj:
        #     id: nav_button_forecast_67
        #     align: CENTER
        #     x: 0
        #     y: 0
        #     width: 150
        #     height: 150
        #     bg_opa: 0
        #     border_width: 0
        #     clickable: true
        #     on_release:
        #       - logger.log: "Days 6-7 CENTER button RELEASED - going to 8-9!"
        #       - lvgl.page.show:
        #           id: forecast_days_8_9_page
        #           animation: OUT_LEFT
        #           time: 300ms

        # Navigation button (bottom of screen) - must be LAST to render on top
        - obj:
            id: nav_button_extended_forecast_67
            align: BOTTOM_MID
            x: 0
            y: 0
            width: 100
            height: 60
            bg_opa: 0
            border_width: 0
            clickable: true
            on_release:
              - logger.log: "Extended forecast 'More' button on 6-7 RELEASED! going to 8-9!"
              - lambda: |-
                  ESP_LOGI("touch", "Navigation button touched");
                  id(last_auto_rotation_time) = millis();
                  ESP_LOGD("touch", "Auto-rotation timer reset");
              - lvgl.page.show:
                  id: forecast_days_8_9_page
                  animation: OUT_LEFT
                  time: 300ms

    - id: forecast_days_8_9_page
      bg_color: 0x000000
      bg_opa: COVER
      scrollbar_mode: "OFF"
      skip: true
      on_load:
        - script.execute: page_transition_cleanup
      widgets:
        - label:
            text: "Extended Forecast"
            align: TOP_MID
            y: 5
            text_font: montserrat_18
            text_color: my_white
            text_align: CENTER

        # Day 8 Card
        - obj:
            width: 170
            height: SIZE_CONTENT
            align: TOP_MID
            y: 40
            bg_color: 0x101010
            bg_opa: COVER
            border_width: 0
            radius: 12
            pad_all: 12
            scrollbar_mode: "OFF"
            layout:
              type: flex
              flex_flow: column
              pad_row: 6
            widgets:
              - label:
                  id: lbl_forecast_day8_header
                  text: "Day +8 (--/--)"
                  text_font: montserrat_18
                  text_color: my_white
              - label:
                  id: lbl_forecast_day8_icon
                  text: "\U000F14E4"
                  text_font: icons_80
                  text_color: my_white
              - label:
                  id: lbl_forecast_day8_condition
                  text: "---"
                  text_font: montserrat_18
                  text_color: my_white
                  long_mode: SCROLL_CIRCULAR
              - label:
                  id: lbl_forecast_day8_temps
                  text: "H:--° L:--°"
                  text_font: montserrat_18
                  text_color: my_white
                  recolor: true
              - label:
                  id: lbl_forecast_day8_precip_prob
                  text: "Chance: --%"
                  text_font: montserrat_16
                  text_color: my_white

        # Day 9 Card
        - obj:
            width: 170
            height: SIZE_CONTENT
            align: TOP_MID
            y: 340
            bg_color: 0x101010
            bg_opa: COVER
            border_width: 0
            radius: 12
            pad_all: 12
            scrollbar_mode: "OFF"
            layout:
              type: flex
              flex_flow: column
              pad_row: 6
            widgets:
              - label:
                  id: lbl_forecast_day9_header
                  text: "Day +9 (--/--)"
                  text_font: montserrat_18
                  text_color: my_white
              - label:
                  id: lbl_forecast_day9_icon
                  text: "\U000F14E4"
                  text_font: icons_80
                  text_color: my_white
              - label:
                  id: lbl_forecast_day9_condition
                  text: "---"
                  text_font: montserrat_18
                  text_color: my_white
                  long_mode: SCROLL_CIRCULAR
              - label:
                  id: lbl_forecast_day9_temps
                  text: "H:--° L:--°"
                  text_font: montserrat_18
                  text_color: my_white
                  recolor: true
              - label:
                  id: lbl_forecast_day9_precip_prob
                  text: "Chance: --%"
                  text_font: montserrat_16
                  text_color: my_white

        # Top-right button for main page navigation
        - obj:
            id: nav_button_top_89
            align: TOP_RIGHT
            x: 0
            y: 0
            width: 180
            height: 150
            bg_opa: 0
            border_width: 0
            clickable: true
            on_release:
              - logger.log: "Days 8-9 top-right button RELEASED!"
              - lvgl.page.next:
                  animation: OUT_LEFT
                  time: 300ms

        - label:
            text: "More >"
            align: BOTTOM_MID
            y: -5
            text_font: montserrat_18
            text_color: my_gray
            text_align: CENTER

        # # Navigation button (center of screen) - must be LAST to render on top
        # - obj:
        #     id: nav_button_forecast_89
        #     align: CENTER
        #     x: 0
        #     y: 0
        #     width: 150
        #     height: 150
        #     bg_opa: 0
        #     border_width: 0
        #     clickable: true
        #     on_release:
        #       - logger.log: "Days 8-9 CENTER button RELEASED - going to Day 10!"
        #       - lvgl.page.show:
        #           id: forecast_day_10_page
        #           animation: OUT_LEFT
        #           time: 300ms

        # Navigation button (bottom of screen) - must be LAST to render on top
        - obj:
            id: nav_button_extended_forecast_89
            align: BOTTOM_MID
            x: 0
            y: 0
            width: 100
            height: 60
            bg_opa: 0
            border_width: 0
            clickable: true
            on_release:
              - logger.log: "Extended forecast 'More' button on 8-9 RELEASED! going to 10!"
              - lambda: |-
                  ESP_LOGI("touch", "Navigation button touched");
                  id(last_auto_rotation_time) = millis();
                  ESP_LOGD("touch", "Auto-rotation timer reset");
              - lvgl.page.show:
                  id: forecast_day_10_page
                  animation: OUT_LEFT
                  time: 300ms

    - id: forecast_day_10_page
      bg_color: 0x000000
      bg_opa: COVER
      scrollbar_mode: "OFF"
      skip: true
      on_load:
        - script.execute: page_transition_cleanup
      widgets:
        - label:
            text: "Extended Forecast"
            align: TOP_MID
            y: 5
            text_font: montserrat_18
            text_color: my_white
            text_align: CENTER

        # Day 10 Card (centered on page)
        - obj:
            width: 170
            height: SIZE_CONTENT
            align: CENTER
            y: 0
            bg_color: 0x101010
            bg_opa: COVER
            border_width: 0
            radius: 12
            pad_all: 12
            scrollbar_mode: "OFF"
            layout:
              type: flex
              flex_flow: column
              pad_row: 6
            widgets:
              - label:
                  id: lbl_forecast_day10_header
                  text: "Day +10 (--/--)"
                  text_font: montserrat_18
                  text_color: my_white
              - label:
                  id: lbl_forecast_day10_icon
                  text: "\U000F14E4"
                  text_font: icons_80
                  text_color: my_white
              - label:
                  id: lbl_forecast_day10_condition
                  text: "---"
                  text_font: montserrat_18
                  text_color: my_white
                  long_mode: SCROLL_CIRCULAR
              - label:
                  id: lbl_forecast_day10_temps
                  text: "H:--° L:--°"
                  text_font: montserrat_18
                  text_color: my_white
                  recolor: true
              - label:
                  id: lbl_forecast_day10_precip_prob
                  text: "Chance: --%"
                  text_font: montserrat_16
                  text_color: my_white


        - label:
            text: "Beginning >"
            align: BOTTOM_MID
            y: -5
            text_font: montserrat_18
            text_color: my_gray
            text_align: CENTER

        # Navigation button (center bottom) - goes back to Days 2-3
        - obj:
            id: nav_button_forecast_10
            align: BOTTOM_MID
            x: 0
            y: 0
            width: 100
            height: 60
            bg_opa: 0
            border_width: 0
            clickable: true
            on_release:
              - logger.log: "Day 10 BOTTOM button RELEASED - going back to 2/3-day!"
              - lvgl.page.show:
                  id: daily_forecast_page
                  animation: OUT_RIGHT
                  time: 300ms

        # Top-right button for main page navigation
        - obj:
            id: nav_button_top_10
            align: TOP_RIGHT
            x: 0
            y: 0
            width: 180
            height: 150
            bg_opa: 0
            border_width: 0
            clickable: true
            on_release:
              - logger.log: "Day 10 top-right button RELEASED!"
              - lvgl.page.next:
                  animation: OUT_LEFT
                  time: 300ms

button:
  - platform: restart
    icon: mdi:power-cycle
    name: "ESP Reboot"
    id: esp_reboot_button

  - platform: factory_reset
    disabled_by_default: True
    name: "Factory Reset ESP"
    id: factory_reset_all

  - platform: template
    name: "Clear Improv WiFi Credentials"
    id: clear_improv_wifi
    icon: mdi:wifi-off
    entity_category: config
    on_press:
      - lambda: |-
          // Clear only the Improv WiFi credentials from NVS (key: 0x9B5A7C21)
          auto pref = global_preferences->make_preference<uint8_t>(0x9B5A7C21);
          uint8_t dummy = 0;
          pref.save(&dummy);
          ESP_LOGI("main", "Cleared Improv WiFi credentials from NVS");
      - logger.log: "Improv WiFi credentials cleared. Device will use YAML WiFi config on next boot."

  - platform: template
    name: "Refresh Weather"
    id: btn_refresh_weather
    on_press:
      - script.execute: fetch_weather_data

  # SCD40 CO2 Sensor Calibration to Outdoor Air
  # ⚠️ WARNING: Use ONLY outdoors or in well-ventilated area!
  #
  # PROCEDURE:
  #   1. Take device outside (outdoor CO2 is ~400-420ppm)
  #   2. Wait 5 minutes for sensor to stabilize
  #   3. Press this button in Home Assistant
  #   4. Calibration permanently affects sensor accuracy
  #
  # DO NOT use indoors - indoor CO2 is typically 600-1000ppm!
  # Incorrect calibration will give wrong readings permanently.
  #
  # To calibrate to custom value, use esphome.halo_calibrate_co2_value service
  # - platform: template
  #   name: "Calibrate SCD40 To 420ppm (OUTDOOR ONLY!)"
  #   id: set_SCD40_calibrate
  #   entity_category: config
  #   on_press:
  #     - scd4x.perform_forced_calibration:
  #         value: 420  # Typical outdoor CO2 concentration
  #         id: scd40
  - platform: template
    name: "Start CO2 Calibration (Requires Confirmation)"
    id: start_co2_calibration
    entity_category: config
    on_press:
      - logger.log:
          format: "CO2 calibration requested. Device must be outdoors. Press confirm button within 60 seconds."
          level: WARN
      - lambda: id(calibration_confirm_time) = millis();
      - globals.set:
          id: calibration_pending
          value: 'true'

  - platform: template
    name: "CONFIRM CO2 Calibration to 420ppm"
    id: confirm_co2_calibration
    entity_category: config
    disabled_by_default: true  # Hidden unless needed
    on_press:
      - if:
          condition:
            lambda: |-
              if (!id(calibration_pending)) {
                ESP_LOGW("calibration", "No calibration pending!");
                return false;
              }
              // Check if within 60-second confirmation window
              uint32_t elapsed = millis() - id(calibration_confirm_time);
              if (elapsed > 60000) {
                ESP_LOGW("calibration", "Confirmation timeout (>60s)");
                id(calibration_pending) = false;
                return false;
              }
              return true;
          then:
            - logger.log: "CO2 calibration confirmed. Calibrating to 420ppm..."
            - scd4x.perform_forced_calibration:
                value: 420
                id: scd40
            - logger.log: "CO2 calibration complete!"
            - globals.set:
                id: calibration_pending
                value: 'false'

  # SEN55 Fan Cleaning Cycle
  # Runs fan at high speed for 10 seconds to blow dust off PM sensor
  # WHEN TO USE: If PM readings seem stuck or abnormally high
  # SAFE TO USE: Can be run anytime, won't damage sensor
  - platform: template
    name: "Clean SEN55"
    id: clean_sen55
    entity_category: config
    on_press:
      - sen5x.start_fan_autoclean: sen55

  # Display Recovery Button - AGGRESSIVE RESET
  # Use this when display goes black but backlight is still on
  # Performs complete hardware reset of display controller and LVGL
  - platform: template
    name: "Recover Display (Hard Reset)"
    id: recover_display
    icon: mdi:monitor-refresh
    on_press:
      - logger.log: "=== PERFORMING DISPLAY RECOVERY ==="
      - logger.log: "Step 1: Turning backlight OFF..."
      - output.turn_off: backlight
      - delay: 500ms
      
      - logger.log: "Step 2: Pausing LVGL..."
      - lvgl.pause:
      - delay: 300ms

      - logger.log: "Step 3: Resetting and re-initializing display controller..."
      - lambda: |-
          ESP_LOGI("display_reset", "Resetting and re-initializing display hardware...");
          auto *display = id(lily_display);
          if (display != nullptr) {
            display->setup();  // This re-initializes the display controller completely
          }
      - delay: 500ms

      - logger.log: "Step 4: Resuming LVGL..."
      - lvgl.resume:
      - delay: 300ms
      
      - logger.log: "Step 5: Turning backlight ON..."
      - output.turn_on: backlight
      - delay: 200ms
      
      - logger.log: "Step 6: Updating watchdog timestamp and recovery counter..."
      - lambda: |-
          // Update watchdog timestamp
          id(last_display_update_time) = millis();

          // Increment recovery counter
          static int recoveries = 0;
          recoveries++;
          id(display_recovery_count).publish_state(recoveries);

          ESP_LOGI("display_reset", "=== DISPLAY RECOVERY COMPLETE === (Recovery #%d)", recoveries);

      - logger.log: "Display recovery complete!"

  # ============================================================================
  # Go-To Page Buttons
  # ============================================================================
  # These buttons allow users to directly navigate to any page from Home Assistant
  # without waiting for auto-rotation. Useful for quick access to specific info.
  # ============================================================================
  
  - platform: template
    name: "Go to Clock Page"
    id: goto_clock_page
    icon: mdi:clock-outline
    on_press:
      - logger.log: "Navigating to Clock page"
      - lambda: |-
          id(current_page_name) = "vertical_clock";
          id(last_auto_rotation_time) = millis();
      - lvgl.page.show:
          id: vertical_clock_page
          animation: OUT_LEFT
          time: 300ms

  - platform: template
    name: "Go to Air Quality Page"
    id: goto_airq_page
    icon: mdi:air-filter
    on_press:
      - logger.log: "Navigating to Air Quality page"
      - lambda: |-
          id(current_page_name) = "airq";
          id(last_auto_rotation_time) = millis();
      - lvgl.page.show:
          id: AirQ_page
          animation: OUT_LEFT
          time: 300ms

  - platform: template
    name: "Go to WiFi Page"
    id: goto_wifi_page
    icon: mdi:wifi
    on_press:
      - logger.log: "Navigating to WiFi page"
      - lambda: |-
          id(current_page_name) = "wifi";
          id(last_auto_rotation_time) = millis();
      - lvgl.page.show:
          id: wifi_page
          animation: OUT_LEFT
          time: 300ms

  - platform: template
    name: "Go to Weather Page"
    id: goto_weather_page
    icon: mdi:weather-partly-cloudy
    on_press:
      - logger.log: "Navigating to Weather page"
      - lambda: |-
          id(current_page_name) = "weather";
          id(last_auto_rotation_time) = millis();
      - lvgl.page.show:
          id: weather_forecast_page
          animation: OUT_LEFT
          time: 300ms

  - platform: template
    name: "Go to Hourly Forecast Page"
    id: goto_hourly_forecast_page
    icon: mdi:clock-time-four-outline
    on_press:
      - logger.log: "Navigating to Hourly Forecast page"
      - lambda: |-
          id(current_page_name) = "hourly_forecast";
          id(last_auto_rotation_time) = millis();
      - lvgl.page.show:
          id: hourly_forecast_page
          animation: OUT_LEFT
          time: 300ms

  - platform: template
    name: "Go to Daily Forecast Page"
    id: goto_daily_forecast_page
    icon: mdi:calendar-week
    on_press:
      - logger.log: "Navigating to Daily Forecast page"
      - lambda: |-
          id(current_page_name) = "daily_forecast";
          id(last_auto_rotation_time) = millis();
      - lvgl.page.show:
          id: daily_forecast_page
          animation: OUT_LEFT
          time: 300ms
  
# ============================================================================
# WiFi Configuration
# ============================================================================
# CREDENTIALS: Define in device-specific file (e.g., halo-v1-79e384.yaml)
#   wifi_ssid: "YourNetworkName"
#   wifi_password: "YourNetworkPassword"
#
# SECURITY: WiFi credentials are stored in plaintext in compiled firmware
#           Use WPA2/WPA3 encryption on your access point
#           Consider using secrets file for sensitive deployments
# ============================================================================
wifi:
  ssid: ${wifi_ssid}
  password: ${wifi_password}

  # Reset startup light blink when WiFi disconnects
  # This allows the rainbow effect to restart when connection is lost
  on_disconnect:
    - lambda: |-
        id(cycleCounter) = 0;
        ESP_LOGI("wifi", "WiFi disconnected - resetting startup blink counter");

  # Ensure startup blink stops when WiFi reconnects
  on_connect:
    - lambda: |-
        if (id(cycleCounter) < 30) {
          id(cycleCounter) = 30;
          ESP_LOGI("wifi", "WiFi connected - stopping startup blink");
        }

# ============================================================================
# WireGuard VPN Configuration
# ============================================================================
# Provides encrypted tunnel to home network when away from home WiFi
#
# CREDENTIALS: Stored in secrets.yaml (never commit to git!)
#   wg_address: VPN IP address (e.g., 10.6.0.3)
#   wg_netmask: VPN subnet mask (e.g., 255.255.255.0)
#   wg_prikey: Device private key (generate with: wg genkey)
#   wg_peerport: VPN server port (typically 51820)
#   wg_peerendpt: VPN server hostname or IP
#   wg_pubkey: VPN server public key
#   wg_shrdkey: Pre-shared key for additional security (optional)
#
# ALLOWED IPs: Traffic destined for these networks goes through VPN tunnel
#   192.168.1.0/24: Home LAN
#   10.6.0.1/32: VPN server gateway
#   10.6.0.2/32: Additional VPN peer (optional)
#
# KEEPALIVE: 25s - Maintains NAT mappings for reliable connection
# require_connection_to_proceed: false - Device boots even if VPN fails
# ============================================================================
wireguard:
  id: wg0
  address: !secret wg_address
  netmask: !secret wg_netmask
  private_key: !secret wg_prikey
  peer_port: !secret wg_peerport
  peer_endpoint: !secret wg_peerendpt
  peer_public_key: !secret wg_pubkey
  peer_preshared_key: !secret wg_shrdkey
  peer_allowed_ips: !secret wg_allowed_ips
  peer_persistent_keepalive: 25s
  require_connection_to_proceed: false  # Non-blocking boot

# ============================================================================
# ESPHome Boot Sequence Configuration
# ============================================================================
# ESPHOME BOOT PRIORITIES (higher numbers run first):
#   800-900: Very early init (before WiFi/components)
#   600-700: Component initialization
#   250:     WiFi connection
#   100:     Sensor setup
#   50:      Application logic
#   -100:    Late initialization (after everything loaded)
#
# Our boot stages:
#   1. Priority 800: Show initial page before components load
#   2. Priority 50: Enable WireGuard after BLE stabilizes (20s delay)
#   3. Priority -100: Set default page and complete boot
# ============================================================================

# ============================================================================
# NIMBLE BLUETOOTH PROXY
# ============================================================================
# Custom NimBLE-based Bluetooth proxy for Home Assistant
# Uses NimBLE stack instead of Bluedroid for better performance and lower RAM
# 
# Benefits:
# - ~55KB RAM savings vs Bluedroid
# - Better WiFi coexistence
# - Lower power consumption
# - Faster connection handling
# ============================================================================

# Stub bluetooth_proxy component (NOT the native ESPHome one)
# This ONLY provides header files and USE_BLUETOOTH_PROXY define for API types
# It contains NO Bluedroid code - just enables the protobuf message types
bluetooth_proxy:

# Custom nimble_proxy - the actual BLE proxy implementation using NimBLE stack
# ESPHome's native bluetooth_proxy uses Bluedroid which we're NOT using
nimble_proxy:
  active: true
  max_connections: 3

# ESP32 Improv Configuration (Optional)
# Allows WiFi provisioning via BLE using the Improv standard
# Useful for initial device setup without hardcoded credentials
# DISABLED: Requires BLE tracker
# esp32_improv:
#   authorizer: none

# API Integration - Dynamic BLE Scanning
# Automatically start/stop BLE scanning based on Home Assistant connection
# This saves power and reduces heap usage when HA is disconnected

esphome:
  name: ${name}
  
  # ============================================================================
  # C++ Helper Functions - Reusable Code to Reduce Duplication
  # ============================================================================
  # NOTE: Helper functions temporarily removed to fix compilation.
  # Will be added back once basic compilation is verified.
  # See weather_helpers.h in repository for the helper code.
  # ============================================================================

  libraries:
    # No additional libraries needed - using standard C++ and ESP-IDF
  
  on_boot:
    # -------------------------------------------------------------------------
    # Boot Stage 1: Early Display Initialization (Priority 800)
    # -------------------------------------------------------------------------
    # Runs before WiFi and sensors to show something on screen immediately
    # 50ms delay allows LVGL to complete basic initialization
    - priority: 800
      then:
        - delay: 50ms
        - lambda: 'id(last_display_update_time) = millis();'  # Initialize watchdog timer
        - lvgl.page.show: vertical_clock_page
        - logger.log: "Set initial page to Vertical Clock"

    # -------------------------------------------------------------------------
    # Boot Stage 2: WireGuard Delayed Start (Priority 50)
    # -------------------------------------------------------------------------
    # DELAY RATIONALE: BLE initialization consumes significant memory
    #   - Without delay: WireGuard + BLE can cause OOM crash
    #   - With 20s delay: BLE stabilizes, memory usage predictable
    #   - Timing chosen empirically through testing
    #
    # Runs after sensors (priority 100) but before late init
    - priority: 50
      then:
        - delay: 20s  # Allow BLE to fully initialize and stabilize memory
        - lambda: |-
            ESP_LOGI("wireguard_delayed", "Checking WireGuard enable state after 20s delay...");
            ESP_LOGI("wireguard_delayed", "Free internal heap: %d bytes", heap_caps_get_free_size(MALLOC_CAP_INTERNAL));
            ESP_LOGI("wireguard_delayed", "WireGuard switch state: %s", id(wireguard_enabled).state ? "ON" : "OFF");
        - if:
            condition:
              lambda: 'return id(wireguard_enabled).state;'
            then:
              - wireguard.enable:
                  id: wg0
              - logger.log: "✓ WireGuard enabled successfully"
            else:
              - logger.log: "WireGuard switch is OFF, not enabling at boot"

    # -------------------------------------------------------------------------
    # Boot Stage 3: Default Page Selection (Priority -100)
    # -------------------------------------------------------------------------
    # Runs last after all components initialized
    # Reads user's default page preference and navigates to it
    # Note: RGB light control is handled by startup_light_blink interval
    - priority: -100
      then:
        - logger.log: "Boot sequence starting (priority -100)"
        - delay: 1s  # Brief delay for LVGL page system to be ready

        # Map user's text selection to page index number
        - lambda: |-
            const std::string &choice = id(default_page_select_boot).state;
            // Core pages
            if (choice == "Vertical Clock") {
              id(default_page_index) = 0;  // vertical_clock_page
            } else if (choice == "AirQ") {  // Comment out if AirQ disabled
              id(default_page_index) = 1;  // AirQ_page
            } else if (choice == "WiFi") {
              id(default_page_index) = 2;  // wifi_page
            // Weather page mappings (comment out if weather packages are disabled)
            } else if (choice == "Weather") {
              id(default_page_index) = 3;  // weather_forecast_page
            } else if (choice == "Daily Forecast") {
              id(default_page_index) = 4;  // daily_forecast_page
            } else if (choice == "Hourly Forecast") {
              id(default_page_index) = 5;  // hourly_forecast_page
            } else {
              id(default_page_index) = 0;  // Default to vertical clock if unknown
            }
        - logger.log:
            format: "Setting default page (index: %d)"
            args: ['id(default_page_index)']
        # Note: Boot sequence only handles Vertical Clock in Core
        # Device files should override on_boot to handle their specific pages
        - logger.log: "Boot: Showing Vertical Clock page (Core default)"
        - lvgl.page.show: vertical_clock_page
        - logger.log: "Boot sequence complete"
